<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes">
  <title>Trinity Bot</title>
  <link rel="icon" href="logo.jpg">
  <link rel="apple-touch-icon" href="logo.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- üÜï V10.0: TradingView Lightweight Charts for Trade Detail Modal -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <!-- DEMO MODE: Mock data layer ‚Äî intercepts all API calls -->
  <script src="mock-data.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    /* TAI Phase Timeline tooltips */
    /* TAI Phase Timeline */
    .tai-timeline{display:flex;border-radius:12px;overflow:visible;position:relative}
    .tai-timeline > .tai-phase:first-child{border-radius:12px 0 0 12px}
    .tai-timeline > .tai-phase:last-child{border-radius:0 12px 12px 0}
    .tai-phase{position:relative;cursor:pointer}
    .tai-phase .tai-tip{display:none;position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);z-index:100;min-width:240px;max-width:300px;padding:14px;background:#141925;border:1px solid rgba(255,255,255,.2);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.7);text-align:left;pointer-events:none}
    .tai-phase:hover .tai-tip{display:block}
    .tai-phase .tai-tip::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:6px solid rgba(255,255,255,.2)}
    .tai-phase:first-child .tai-tip{left:0;transform:none}
    .tai-phase:first-child .tai-tip::before{left:20px;transform:none}
    .tai-phase:last-child .tai-tip{left:auto;right:0;transform:none}
    .tai-phase:last-child .tai-tip::before{left:auto;right:20px;transform:none}
    html,body{overflow-x:hidden;overflow-y:visible}
    body{font-family:'Inter',sans-serif;transition:background .3s,color .3s}
    body.dark{background:#0b0f19;color:#e2e8f0}
    body.light{background:#f8fafc;color:#1e293b}
    
    /* ‚òÄÔ∏è V6.1 - LIGHT MODE FIXES */
    body.light .header-container,
    body.light .nav-container,
    body.light .tabs-wrapper{background:#ffffff !important;border-color:#e2e8f0 !important}
    body.light .nav-tabs{background:#f1f5f9 !important}
    body.light .nav-tab{color:#334155 !important}
    body.light .nav-tab:hover{background:#e2e8f0 !important}
    body.light .nav-tab.active{background:#3b82f6 !important;color:#fff !important}
    body.light .card-section{background:#ffffff !important;border-color:#e2e8f0 !important}
    body.light .bg-card{background:#ffffff !important}
    body.light .text-secondary{color:#64748b !important}
    body.light input,body.light select{background:#f8fafc !important;border-color:#cbd5e1 !important;color:#1e293b !important}
    body.light .badge-basic{background:#94a3b8;color:#1e293b}
    
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:#1a1f2e}
    ::-webkit-scrollbar-thumb{background:#3b4558;border-radius:3px}

    /* ‚ïê‚ïê‚ïê MATRIX THEME ‚Äî Cinematic Effects V2 ‚ïê‚ïê‚ïê */
    body.matrix{
      background:
        repeating-linear-gradient(0deg,transparent,transparent 119px,rgba(0,255,65,0.08) 119px,rgba(0,255,65,0.08) 120px),
        repeating-linear-gradient(90deg,transparent,transparent 159px,rgba(0,255,65,0.08) 159px,rgba(0,255,65,0.08) 160px),
        radial-gradient(ellipse at 20% 50%,rgba(0,255,65,0.04) 0%,transparent 50%),
        radial-gradient(ellipse at 80% 50%,rgba(0,255,65,0.04) 0%,transparent 50%),
        #000000;
      color:#d8fde0;font-family:'Share Tech Mono','Inter',monospace}
    body.matrix *{font-family:inherit}
    body.matrix input,body.matrix select,body.matrix textarea,body.matrix button{font-family:'Share Tech Mono','Inter',monospace}

    /* Matrix Rain Canvas ‚Äî visible on sides, faded in center */
    body.matrix #matrix-rain{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.75}
    body.matrix #matrix-center-mask{position:fixed;inset:0;z-index:1;pointer-events:none;
      background:radial-gradient(ellipse 42% 100% at center,rgba(0,0,0,0.92) 0%,rgba(0,0,0,0.85) 60%,rgba(0,0,0,0.3) 85%,transparent 100%)}
    body.matrix #root{position:relative;z-index:2}
    body.matrix main{background:rgba(0,3,0,0.65);border-radius:16px;margin-left:auto;margin-right:auto;
      border:1px solid rgba(0,255,65,0.08);box-shadow:0 0 40px rgba(0,255,65,0.03)}

    /* Scanlines ‚Äî reduced for readability */
    body.matrix::after{content:'';position:fixed;inset:0;z-index:10000;pointer-events:none;
      background:repeating-linear-gradient(0deg,transparent 0px,transparent 3px,rgba(0,0,0,0.06) 3px,rgba(0,0,0,0.06) 4px);
      opacity:0.35}

    /* CRT vignette ‚Äî subtle */
    body.matrix::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
      background:radial-gradient(ellipse at center,transparent 55%,rgba(0,0,0,0.3) 100%)}

    /* Glowing cards */
    body.matrix .card-section,
    body.matrix [style*="background"][style*="border"]{
      backdrop-filter:blur(8px) !important;
      border-color:rgba(0,255,65,0.2) !important;
      box-shadow:0 0 20px rgba(0,255,65,0.08),inset 0 1px 0 rgba(0,255,65,0.1) !important}
    body.matrix .card-section:hover{
      border-color:rgba(0,255,65,0.35) !important;
      box-shadow:0 0 30px rgba(0,255,65,0.15),inset 0 1px 0 rgba(0,255,65,0.2) !important}
    /* Kill backdrop-filter on chart containers + ALL their children (LightweightCharts internals) */
    body.matrix [data-chart],
    body.matrix [data-chart] *,
    body.matrix [id*="chart-"],
    body.matrix [id*="chart-"] *{
      backdrop-filter:none !important;
      box-shadow:none !important}

    /* Header glass */
    body.matrix .header-container,
    body.matrix header{
      background:rgba(0,8,0,0.94) !important;
      border-color:rgba(0,255,65,0.25) !important;
      box-shadow:0 2px 30px rgba(0,255,65,0.1) !important;
      backdrop-filter:blur(16px) !important}

    /* Nav glass */
    body.matrix .nav-container,
    body.matrix nav{
      background:rgba(0,8,0,0.94) !important;
      border-color:rgba(0,255,65,0.2) !important;
      backdrop-filter:blur(16px) !important;
      box-shadow:0 1px 15px rgba(0,255,65,0.06) !important}
    body.matrix .nav-tab{color:#5dff7a !important;letter-spacing:1.5px !important;text-transform:uppercase !important;font-size:12px !important}
    body.matrix .nav-tab:hover{background:rgba(0,255,65,0.1) !important;text-shadow:0 0 10px rgba(0,255,65,0.6) !important}
    body.matrix .nav-tab.active,
    body.matrix button[style*="border-bottom: 2px solid"]{
      text-shadow:0 0 12px rgba(0,255,65,0.7),0 0 20px rgba(0,255,65,0.3) !important;
      color:#00FF41 !important}

    /* Scrollbar */
    body.matrix ::-webkit-scrollbar-track{background:#000 !important}
    body.matrix ::-webkit-scrollbar-thumb{background:#004400 !important;border:1px solid rgba(0,255,65,0.3) !important}
    body.matrix ::-webkit-scrollbar-thumb:hover{background:#006600 !important;box-shadow:0 0 6px rgba(0,255,65,0.4) !important}

    /* Headers glow */
    body.matrix h1,body.matrix h2,body.matrix h3,
    body.matrix [style*="font-weight: 800"],
    body.matrix [style*="font-weight: 700"]{text-shadow:0 0 8px rgba(0,255,65,0.3),0 0 16px rgba(0,255,65,0.1)}

    /* Accent green glow */
    body.matrix [style*="color: rgb(0, 255, 65)"],
    body.matrix [style*="color:#00FF41"]{text-shadow:0 0 10px rgba(0,255,65,0.5),0 0 20px rgba(0,255,65,0.2)}

    /* Large numbers / values ‚Äî enhanced glow */
    body.matrix [style*="fontSize:24"],body.matrix [style*="fontSize:28"],
    body.matrix [style*="fontSize:36"],body.matrix [style*="fontSize:56"],
    body.matrix [style*="font-size:24"],body.matrix [style*="font-size:28"],
    body.matrix [style*="font-size:36"],body.matrix [style*="font-size:56"]{
      text-shadow:0 0 12px rgba(0,255,65,0.4),0 0 24px rgba(0,255,65,0.15) !important}

    /* Buttons */
    body.matrix button{transition:all 0.2s ease !important}
    body.matrix button:hover{box-shadow:0 0 15px rgba(0,255,65,0.2) !important}

    /* Badges */
    body.matrix .badge-premium{box-shadow:0 0 12px rgba(0,255,65,0.4)}
    body.matrix .badge-advanced{background:linear-gradient(135deg,#003B00,#00FF41) !important;box-shadow:0 0 12px rgba(0,255,65,0.4)}

    /* Progress bars */
    body.matrix .progress-sl-tp{box-shadow:0 0 8px rgba(0,255,65,0.25)}

    /* Trade cards */
    body.matrix .trade-card-pro{border:1px solid rgba(0,255,65,0.15) !important}
    body.matrix .trade-card-pro:hover{
      border-color:rgba(0,255,65,0.4) !important;
      box-shadow:0 0 25px rgba(0,255,65,0.12),0 4px 20px rgba(0,0,0,.3) !important}

    /* Inputs */
    body.matrix input,body.matrix select,body.matrix textarea{
      background:rgba(0,12,0,0.85) !important;
      border:1px solid rgba(0,255,65,0.25) !important;
      color:#d8fde0 !important;
      caret-color:#00FF41 !important}
    body.matrix input:focus,body.matrix select:focus,body.matrix textarea:focus{
      border-color:#00FF41 !important;
      box-shadow:0 0 12px rgba(0,255,65,0.3) !important;
      outline:none !important}

    /* Live pulse */
    body.matrix [style*="livePulse"]{animation-name:matrixLivePulse !important}
    @keyframes matrixLivePulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,65,.5)}70%{box-shadow:0 0 0 8px rgba(0,255,65,0)}}

    /* Status dot pulse */
    @keyframes matrixDotPulse{0%,100%{box-shadow:0 0 4px #00FF41}50%{box-shadow:0 0 10px #00FF41,0 0 20px rgba(0,255,65,0.4)}}
    body.matrix [style*="border-radius: 50%"][style*="background: rgb(0, 255, 65)"]{animation:matrixDotPulse 2s ease infinite}

    /* Logo glow */
    body.matrix img[src*="logo"]{box-shadow:0 0 20px rgba(0,255,65,0.4),0 0 40px rgba(0,255,65,0.15) !important;
      border:2px solid rgba(0,255,65,0.4) !important}

    /* Subtle flicker */
    @keyframes matrixFlicker{0%,97%,100%{opacity:1}98%{opacity:0.98}99%{opacity:0.99}}
    body.matrix main{animation:matrixFlicker 10s infinite}

    /* Chart glow */
    body.matrix canvas{box-shadow:0 0 12px rgba(0,255,65,0.06)}

    /* Red values (losses) ‚Äî enhanced red glow for contrast */
    body.matrix [style*="color: rgb(255, 0, 60)"],
    body.matrix [style*="color:#FF003C"]{text-shadow:0 0 8px rgba(255,0,60,0.4),0 0 16px rgba(255,0,60,0.15)}

    /* Yellow warnings glow */
    body.matrix [style*="color: rgb(255, 255, 0)"],
    body.matrix [style*="color:#ffff00"]{text-shadow:0 0 8px rgba(255,255,0,0.3)}

    /* Table/grid rows ‚Äî subtle hover */
    body.matrix [style*="borderBottom"][style*="padding"]:hover{background:rgba(0,255,65,0.03) !important}
    /* üé® V4.5 - Enhanced pulse animations for visibility */
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(0.9)}}
    @keyframes livePulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}70%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
    @keyframes pulseGlow{0%,100%{box-shadow:0 0 4px currentColor}50%{box-shadow:0 0 8px currentColor,0 0 12px currentColor}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    
    /* üéØ V5.0 - PRO TERMINAL STYLES */
    /* Strategy Badges */
    .badge-premium{background:linear-gradient(135deg,#9333ea,#f59e0b);color:#fff;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.3)}
    .badge-advanced{background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;font-weight:700}
    .badge-signal{background:linear-gradient(135deg,#f97316,#eab308);color:#000;font-weight:700}
    .badge-basic{background:#4b5563;color:#fff}
    
    /* Progress Bar SL ‚Üí TP */
    .progress-sl-tp{position:relative;height:6px;border-radius:3px;background:linear-gradient(90deg,#ef4444 0%,#eab308 50%,#22c55e 100%);overflow:hidden}
    .progress-marker{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;background:#fff;border:2px solid currentColor;border-radius:50%;box-shadow:0 0 6px rgba(0,0,0,.4);z-index:10}
    .progress-entry{position:absolute;top:50%;transform:translate(-50%,-50%);width:4px;height:10px;background:#fff;border-radius:2px;opacity:.7}
    
    /* Accordion Animation */
    .trade-accordion{max-height:0;overflow:hidden;transition:max-height .3s ease-out,padding .3s ease-out,opacity .3s ease-out;opacity:0}
    .trade-accordion.open{max-height:300px;opacity:1;padding-top:12px}
    .trade-card-pro{transition:transform .15s ease,box-shadow .15s ease}
    .trade-card-pro:hover{transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,.3)}
    
    /* Fees indicator */
    .fee-tag{font-size:9px;color:#f97316;opacity:.8}

    /* V2.3: Pull-to-refresh indicator */
    .pull-refresh-indicator{position:fixed;top:0;left:50%;transform:translateX(-50%) translateY(-60px);z-index:9999;background:rgba(59,130,246,0.95);color:#fff;padding:10px 24px;border-radius:0 0 16px 16px;font-size:13px;font-weight:600;transition:transform .3s ease;pointer-events:none;backdrop-filter:blur(8px)}
    .pull-refresh-indicator.visible{transform:translateX(-50%) translateY(0)}

    /* V2.3: Market transition animation */
    .market-fade-enter{animation:marketFadeIn .25s ease-out}
    @keyframes marketFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* V2.3: Swipe hint animation */
    @keyframes swipeHint{0%{opacity:0;transform:translateX(0)}50%{opacity:1}100%{opacity:0;transform:translateX(-20px)}}

    /* ‚ïê‚ïê‚ïê RESPONSIVE DESIGN ‚ïê‚ïê‚ïê */
    /* Mobile first approach */
    
    /* Navigation tabs */
    
    .nav-tabs{display:flex;gap:4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:8px}
    .nav-tabs::-webkit-scrollbar{display:none}
    .nav-tab{white-space:nowrap;flex-shrink:0}
    
    /* Grid layouts */
    .grid-responsive{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr}
    .grid-3{grid-template-columns:1fr}
    .grid-4{grid-template-columns:repeat(2,1fr)}
    
    /* Cards */
    .card-responsive{padding:12px}
    
    /* Stats row */
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    
    /* Tablet (768px+) */
    @media (min-width:768px){
      .grid-2{grid-template-columns:repeat(2,1fr)}
      .grid-3{grid-template-columns:repeat(2,1fr)}
      .grid-4{grid-template-columns:repeat(4,1fr)}
      .card-responsive{padding:16px}
      .stats-grid{grid-template-columns:repeat(4,1fr)}
    }
    
    /* Desktop (1024px+) */
    @media (min-width:1024px){
      .grid-3{grid-template-columns:repeat(3,1fr)}
      .card-responsive{padding:20px}
    }
    
    /* Large desktop (1280px+) */
    @media (min-width:1280px){
      .grid-4{grid-template-columns:repeat(4,1fr)}
    }
    
    /* Mobile specific */
    @media (max-width:767px){
      .hide-mobile{display:none !important}
      .mobile-full{width:100% !important}
      .mobile-stack{flex-direction:column !important}
      .mobile-text-sm{font-size:12px !important}
      .mobile-text-xs{font-size:10px !important}
      .mobile-p-sm{padding:8px !important}
      .mobile-gap-sm{gap:8px !important}
      /* üÜï V10.10.4: Overflow prevention on mobile */
      html,body{overflow-x:hidden !important}
      main{overflow-x:hidden !important;max-width:100vw !important;box-sizing:border-box !important}
      main *{box-sizing:border-box !important}
      main div[style*="grid"]{overflow-x:auto !important}
    }

    /* Touch friendly ‚Äî 44px minimum for all interactive elements */
    @media (hover:none) and (pointer:coarse){
      button,select,input,textarea{min-height:44px}
      .touch-target{min-width:44px;min-height:44px}
    }
    
    /* Header mobile */
    .header-mobile{display:none}
    @media (max-width:767px){
      .header-desktop{display:none !important}
      .header-mobile{display:flex !important}
    }
    
    /* Menu hamburger */
    .hamburger{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px}
    .hamburger span{display:block;width:24px;height:2px;background:currentColor;transition:transform .3s}
    @media (max-width:767px){
      .hamburger{display:flex}
    }
    
    /* Mobile menu overlay */
    .mobile-menu{position:fixed;top:0;left:-100%;width:80%;max-width:300px;height:100vh;background:var(--card-bg);z-index:9999;transition:left .3s ease;overflow-y:auto;padding:20px}
    .mobile-menu.open{left:0}
    .mobile-menu-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9998;opacity:0;visibility:hidden;transition:opacity .3s}
    .mobile-menu-overlay.open{opacity:1;visibility:visible}
    
    /* ‚ïê‚ïê‚ïê MOBILE HEADER FIX ‚ïê‚ïê‚ïê */
    /* Hide crypto prices bar and other desktop elements on mobile */
    @media (max-width:767px){
      .crypto-prices-bar{display:none !important}
      .desktop-streak-pills{display:none !important}
      .desktop-nav-tabs{display:none !important}
      .desktop-header-right{display:none !important}
      .header-crypto-prices{display:none !important}
      .sticky-nav{top:108px !important}
      main{padding-top:120px !important}
    }
    
    /* Tablet adjustments */
    @media (min-width:768px) and (max-width:1023px){
      .sticky-nav{top:110px !important}
      main{padding-top:190px !important}
    }

    /* Desktop adjustments - V2.1: 2-row header */
    @media (min-width:1024px){
      .sticky-nav{top:110px !important}
      main{padding-top:190px !important}
    }
    
    /* Mobile bottom nav enhancement */
    @media (max-width:767px){
      .mobile-bottom-nav{
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        z-index:1000;
        background:var(--card-bg);
        border-top:1px solid var(--border);
        padding:8px 4px env(safe-area-inset-bottom);
        display:flex;
        justify-content:space-around;
      }
      body{padding-bottom:70px}
    }

    /* üêá V17.3 - THE CONSTRUCT (Matrix Theme) */
    body.trinity {
      background: #000000;
      color: #20C20E;
      font-family: 'Fira Code', 'Share Tech Mono', 'Courier New', monospace;
    }
    body.trinity::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15),
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      z-index: 9998;
      opacity: 0.3;
    }
    body.trinity .card-section,
    body.trinity .bg-card {
      background: #050505 !important;
      border: 1px solid #003B00 !important;
      box-shadow: 0 0 5px rgba(32, 194, 14, 0.3) !important;
    }
    body.trinity .text-glow,
    body.trinity [class*="pnl"],
    body.trinity .total-pnl {
      text-shadow: 0 0 10px rgba(66, 255, 0, 0.5);
    }
    body.trinity button {
      border: 1px solid #20C20E !important;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    body.trinity button:hover {
      background: #20C20E !important;
      color: #000 !important;
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    /* V2.0 Phase 3: Logs Panel */
    .logs-panel { position:fixed; top:0; right:-360px; width:340px; height:100vh; z-index:1100; transition:right .3s ease; box-shadow:-4px 0 20px rgba(0,0,0,.3); }
    .logs-panel.open { right:0; }
    @media(max-width:768px) { .logs-panel { right:-100vw; width:100vw; top:auto; bottom:0; height:65vh; border-radius:16px 16px 0 0; } .logs-panel.open { right:0; } }
    /* V2.0 Phase 3: Panic Button */
    @keyframes panicPulse { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.6);} 50%{box-shadow:0 0 0 12px rgba(239,68,68,0);} }
    .panic-slider-track { position:relative; height:52px; border-radius:26px; overflow:hidden; touch-action:none; }
    .panic-slider-thumb { position:absolute; left:0; top:2px; width:48px; height:48px; border-radius:24px; display:flex; align-items:center; justify-content:center; cursor:grab; touch-action:none; transition:left 0s; z-index:2; }
    .panic-slider-thumb:active { cursor:grabbing; }
    .panic-slider-fill { position:absolute; left:0; top:0; height:100%; border-radius:26px; transition:width 0s; }
    /* V2.0 Phase 4: Satoshi Watermark (Bitcoin theme) */
    body.bitcoin #root::after {
      content:'‚Çø';
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:min(50vw,400px); font-weight:900; color:rgba(247,147,26,.03);
      pointer-events:none; z-index:0; line-height:1;
    }
    @media(max-width:767px) { body.bitcoin #root::after { font-size:60vw; } }
    /* V2.0 Phase 4: Keyboard hints tooltip */
    .kb-hint { position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; padding:8px 16px; border-radius:8px; font-size:11px; z-index:9999; pointer-events:none; animation:fadeInOut 2s forwards; }
    @keyframes fadeInOut { 0%{opacity:0;transform:translateX(-50%) translateY(8px);} 15%{opacity:1;transform:translateX(-50%) translateY(0);} 85%{opacity:1;} 100%{opacity:0;} }
  </style>
</head>
<body class="dark">
<div id="root"></div>
<script>
var h = React.createElement;
var useState = React.useState;
var useEffect = React.useEffect;
var useCallback = React.useCallback;
var useRef = React.useRef;
var useMemo = React.useMemo;

var DEMO_MODE = true;
var CONFIG = {
  API_BASE_URL: 'http://demo-api:9100',
  HIP3_API_BASE_URL: 'http://demo-api:9300',
  API_USER: 'demo',
  API_PASS: 'demo',
  LIVE_START: '2026-01-01',
  DAILY_R_GOAL: 3,
  VERSION: 'v2.3 DEMO',
  MONITOR_API_URL: 'http://demo-api:9200',
  FUNDING_API_URL: 'http://demo-api:9400'
};

// Theme colors
var THEMES = {
  dark: {
    bg:'#0b0f19',card:'#111827',border:'#1e293b',text:'#e2e8f0',textS:'#94a3b8',textM:'#64748b',
    accent:'#22c55e',accentL:'rgba(34,197,94,.15)',
    pos:'#22c55e',posL:'rgba(34,197,94,.15)',
    neg:'#ef4444',negL:'rgba(239,68,68,.15)',
    warn:'#f59e0b',warnL:'rgba(245,158,11,.15)',
    info:'#3b82f6',infoL:'rgba(59,130,246,.15)',
    live:'#ef4444',liveL:'rgba(239,68,68,.2)',
    bull:'#22c55e',bear:'#ef4444',range:'#f59e0b',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2'
  },
  light: {
    bg:'#f8fafc',card:'#ffffff',border:'#e2e8f0',text:'#1e293b',textS:'#64748b',textM:'#94a3b8',
    accent:'#16a34a',accentL:'rgba(22,163,74,.1)',
    pos:'#16a34a',posL:'rgba(22,163,74,.1)',
    neg:'#dc2626',negL:'rgba(220,38,38,.1)',
    warn:'#d97706',warnL:'rgba(217,119,6,.1)',
    info:'#2563eb',infoL:'rgba(37,99,235,.1)',
    live:'#dc2626',liveL:'rgba(220,38,38,.15)',
    bull:'#16a34a',bear:'#dc2626',range:'#d97706',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2'
  },
  trinity: {
    bg:"#000000",card:"#050505",border:"#003B00",text:"#20C20E",textS:"#008F11",textM:"#003B00",
    accent:"#00FF41",accentL:"rgba(0,255,65,.2)",
    pos:"#42FF00",posL:"rgba(66,255,0,.25)",
    neg:"#FF003C",negL:"rgba(255,0,60,.2)",
    warn:"#ffff00",warnL:"rgba(255,255,0,.2)",
    info:"#20C20E",infoL:"rgba(32,194,14,.15)",
    live:"#FF003C",liveL:"rgba(255,0,60,.2)",
    bull:"#42FF00",bear:"#FF003C",range:"#ffff00",
    btc:"#f7931a",eth:"#627eea",sol:"#00d18c",link:"#2a5ada",sei:"#9c1aff",doge:"#c2a633",sui:"#4da2ff",tw:"#20C20E",
    mono:true,glow:true
  },
  deepspace: {
    bg:'#0F172A',card:'#1e293b',border:'#334155',text:'#e2e8f0',textS:'#94a3b8',textM:'#64748b',
    accent:'#22D3EE',accentL:'rgba(34,211,238,.15)',
    pos:'#22D3EE',posL:'rgba(34,211,238,.15)',
    neg:'#FB7185',negL:'rgba(251,113,133,.15)',
    warn:'#FBBF24',warnL:'rgba(251,191,36,.15)',
    info:'#60A5FA',infoL:'rgba(96,165,250,.15)',
    live:'#FB7185',liveL:'rgba(251,113,133,.2)',
    bull:'#22D3EE',bear:'#FB7185',range:'#FBBF24',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2'
  },
  cyberpunk: {
    bg:'#120326',card:'#1a0a30',border:'#2d1b4e',text:'#f0e6ff',textS:'#c9b8e8',textM:'#8b7aa8',
    accent:'#FF00FF',accentL:'rgba(255,0,255,.2)',
    pos:'#00FFFF',posL:'rgba(0,255,255,.2)',
    neg:'#FF00FF',negL:'rgba(255,0,255,.2)',
    warn:'#FFFF00',warnL:'rgba(255,255,0,.2)',
    info:'#00FFFF',infoL:'rgba(0,255,255,.15)',
    live:'#FF00FF',liveL:'rgba(255,0,255,.25)',
    bull:'#00FFFF',bear:'#FF00FF',range:'#FFFF00',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2'
  },
  paper: {
    bg:'#F8F9FA',card:'#FFFFFF',border:'#E5E7EB',text:'#1F2937',textS:'#4B5563',textM:'#9CA3AF',
    accent:'#1E40AF',accentL:'rgba(30,64,175,.1)',
    pos:'#047857',posL:'rgba(4,120,87,.1)',
    neg:'#B91C1C',negL:'rgba(185,28,28,.1)',
    warn:'#D97706',warnL:'rgba(217,119,6,.1)',
    info:'#1E40AF',infoL:'rgba(30,64,175,.1)',
    live:'#B91C1C',liveL:'rgba(185,28,28,.1)',
    bull:'#047857',bear:'#B91C1C',range:'#D97706',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2'
  },
  gold: {
    bg:'#18181b',card:'#27272a',border:'#3f3f46',text:'#fafafa',textS:'#a1a1aa',textM:'#71717a',
    accent:'#D4AF37',accentL:'rgba(212,175,55,.2)',
    pos:'#D4AF37',posL:'rgba(212,175,55,.2)',
    neg:'#ef4444',negL:'rgba(239,68,68,.15)',
    warn:'#D4AF37',warnL:'rgba(212,175,55,.15)',
    info:'#D4AF37',infoL:'rgba(212,175,55,.15)',
    live:'#D4AF37',liveL:'rgba(212,175,55,.25)',
    bull:'#D4AF37',bear:'#ef4444',range:'#D4AF37',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#1da1f2' },
  bitcoin: {
    bg:'#111111',card:'#1A1A1A',border:'#333333',text:'#F0F0F0',textS:'#999999',textM:'#666666',
    accent:'#F7931A',accentL:'rgba(247,147,26,.2)',
    pos:'#F7931A',posL:'rgba(247,147,26,.2)',
    neg:'#ef4444',negL:'rgba(239,68,68,.15)',
    warn:'#FFB140',warnL:'rgba(255,177,64,.2)',
    info:'#F7931A',infoL:'rgba(247,147,26,.15)',
    live:'#F7931A',liveL:'rgba(247,147,26,.25)',
    bull:'#F7931A',bear:'#ef4444',range:'#FFB140',
    btc:'#F7931A',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#F7931A'
  },
  matrix: {
    bg:'#000000',card:'rgba(0,20,4,0.9)',border:'rgba(0,255,65,0.25)',text:'#d8fde0',textS:'#5dff7a',textM:'#2a7a3a',
    accent:'#00FF41',accentL:'rgba(0,255,65,.2)',
    pos:'#00FF41',posL:'rgba(0,255,65,.25)',
    neg:'#FF003C',negL:'rgba(255,0,60,.18)',
    warn:'#ffff00',warnL:'rgba(255,255,0,.18)',
    info:'#00FF41',infoL:'rgba(0,255,65,.12)',
    live:'#FF003C',liveL:'rgba(255,0,60,.2)',
    bull:'#00FF41',bear:'#FF003C',range:'#ffff00',
    btc:'#f7931a',eth:'#627eea',sol:'#00d18c',link:'#2a5ada',sei:'#9c1aff',doge:'#c2a633',sui:'#4da2ff',tw:'#00FF41',
    mono:true,glow:true,matrix:true
  }
};
// üïê V17.1: Force UTC parsing for timestamps from DB (stored without Z suffix)
var ensureUTC = function(ts) { if (!ts) return ''; ts = String(ts); if (ts.endsWith('Z') || ts.includes('+') || /[-+]\d{2}:\d{2}$/.test(ts)) return ts; return ts.replace(' ', 'T') + 'Z'; };

var T = {
  en:{overview:'Overview',trades:'Trades',analytics:'Analytics',insights:'Insights',achievements:'Achievements',botControl:'Bot Control',journal:'Journal',social:'Social',export:'Export',online:'Online',offline:'Offline',liveNow:'LIVE NOW',currentStreak:'CURRENT STREAK',bestStreak:'Best Streak',dailyRGoal:'Daily R Goal',weeklyRGoal:'Weekly R Goal',privateStrategy:'Private Strategy',balance:'BALANCE',totalPnl:'TOTAL PNL',winRate:'WIN RATE',totalR:'TOTAL R',profitFactor:'PROFIT FACTOR',maxDrawdown:'MAX DRAWDOWN',liveDrawdown:'Live Drawdown',max:'Max',balanceEvolution:'Balance Evolution',share:'Share',live:'LIVE',cumulative:'Cumulative',week:'Week',month:'Month',year:'Year',all:'All',prevWeek:'Prev Week',day:'Day',cumulativeR:'Cumulative R',today:'Today',positionType:'Position Type',long:'Long',short:'Short',wr:'WR',pairDistribution:'Pair Distribution',distribution:'Distribution',win:'Win',loss:'Loss',be:'BE',recentTrades:'Recent Trades',clickForDetails:'click for details',entry:'Entry',exit:'Exit',regime:'Regime',current:'Current',unrealizedR:'Unrealized R',confidence:'Confidence',shareThisTrade:'Share this trade',liveSince:'Live since',noTrades:'No trades',noData:'No data',start:'Start',stop:'Stop',restart:'Restart',emergencyStop:'EMERGENCY STOP',botRunning:'Bot Running',botStopped:'Bot Stopped',health:'Health',logs:'Logs',wallet:'Wallet',openWallet:'Open Exchange',connected:'Connected',mon:'Mon',tue:'Tue',wed:'Wed',thu:'Thu',fri:'Fri',sat:'Sat',sun:'Sun',jan:'Jan',feb:'Feb',mar:'Mar',apr:'Apr',may:'May',jun:'Jun',jul:'Jul',aug:'Aug',sep:'Sep',oct:'Oct',nov:'Nov',dec:'Dec',settings:'Settings',appearance:'Appearance',darkMode:'Dark Mode',goals:'Goals',ddAlertThreshold:'DD Alert Threshold',social:'Social',soundEffects:'Sound Effects',twitterIntegration:'Twitter/X Integration',configure:'Configure',discord:'Discord',discordWebhook:'Discord Webhook URL',testWebhook:'Test Webhook',save:'Save',privateStrategyDesc:'Proprietary indicators. Details not shared.',autoPosting:'Auto-posting',autoPostingDesc:'Automatic posting on X',postOnOpen:'Post on open',postOnClose:'Post on close',postAchievements:'Post achievements',postMilestones:'Post milestones',hideAmountsInPosts:'Hide $ in posts',hashtags:'Hashtags',comingSoon:'Coming Soon',confirm:'Confirm?',confirmBtn:'CONFIRM',cancel:'Cancel',mode:'Mode',tradesCount:'Trades',waitingLogs:'Waiting for logs...',webhookOk:'Webhook OK!',webhookFailed:'Webhook failed',w:'W',l:'L',date:'Date',symbol:'Symbol',side:'Side',pnl:'PnL',score:'Score',openTrades:'Open Trades',sortBy:'Sort by',dateDesc:'Newest first',dateAsc:'Oldest first',rDesc:'Best R first',rAsc:'Worst R first',pnlDesc:'Best PnL first',pnlAsc:'Worst PnL first',search:'Search',searchPlaceholder:'Search by symbol, date...',exportCsv:'Export CSV',bestTrade:'Best Trade',worstTrade:'Worst',quickTrade:'Quick',longHold:'Long Hold',tradeDetails:'Trade Details',entryTime:'Entry Time',exitTime:'Exit Time',duration:'Duration',close:'Close',page:'Page',of:'of',noResults:'No results found',allSymbols:'All Symbols',allRegimes:'All Regimes',period:'Period',filters:'Filters',stats:'Stats',goodMorning:'Good morning',goodAfternoon:'Good afternoon',goodEvening:'Good evening',welcomeBack:'Welcome back',youHave:'You have',openPosition:'open position',openPositions:'open positions',todaySoFar:'today so far',noOpenPositions:'No open positions',avgRPerTrade:'Avg R/Trade',bestToday:'Best Today',worstToday:'Worst Today',timeInMarket:'Time in Market',expectancy:'Expectancy',ddAlert:'DRAWDOWN ALERT',ddAlertMsg:'Drawdown exceeds threshold',goalProgress:'Goal Progress',daily:'Daily',weekly:'Weekly',achieved:'Achieved',regimeHistory:'Regime History',since:'since',perfByRegime:'Performance by Regime',tradesHeatmap:'Trades Heatmap',winningDay:'Winning day',losingDay:'Losing day',noTradesDay:'No trades',activityFeed:'Activity Feed',opened:'Opened',closed:'Closed',regimeChanged:'Regime changed to',ago:'ago',justNow:'just now',minutesAgo:'min ago',hoursAgo:'h ago',daysAgo:'d ago',perfComparison:'Performance Comparison',thisWeek:'This Week',lastWeek:'Last Week',thisMonth:'This Month',lastMonth:'Last Month',vsBacktest:'vs Backtest',livePerf:'LIVE Performance',backtestPerf:'Backtest',noActivity:'No recent activity',streakAtRisk:'Streak at risk',considerReducing:'Consider reducing position size',approaching:'approaching',resistance:'resistance',support:'support',perfLiveSimulation:'Performance LIVE & Historical Simulation',liveRealSince:'LIVE = Real since',simulationHistorical:'Simulation = Strategy tested on historical data',simulation:'SIMULATION',heatmap24h:'24h Heatmap',pnlCalendar:'PnL Calendar',advanced:'Advanced',sharpeRatio:'Sharpe Ratio',recoveryFactor:'Recovery Factor',avgRR:'Avg R:R',milestones:'Milestones',basedOnLive:'Based only on real LIVE trades',simulationComplete:'Complete Simulation',roiEvolution:'ROI Evolution',totalTrades:'Total Trades',avgR:'Avg R',roi:'ROI',dd:'DD',sortinoRatio:'Sortino Ratio',calmarRatio:'Calmar Ratio',bestHour:'Best Hour',worstHour:'Worst Hour',bestDay:'Best Day',worstDay:'Worst Day',rDistribution:'R Distribution',streakAnalysis:'Streak Analysis',currentStreakLabel:'Current',bestWinStreak:'Best Win Streak',bestLossStreak:'Worst Loss Streak',liveVsBacktest:'LIVE vs Backtest',outperformance:'Outperformance',underperformance:'Underperformance',perfBySymbol:'Performance by Symbol',autoInsights:'Auto Insights',noInsights:'No insights yet',tradesAtR:'trades at',bestWorstLive:'Best / Worst (LIVE)',advancedInsightsLive:'Advanced Insights (LIVE)',perfByRegimeLive:'Performance by Regime (LIVE)',currentSeries:'Current series',wins:'wins',rPerWeek:'R/Week',hourlyHeatmap:'Hourly Heatmap',topTrades:'Top Trades',top3Best:'Top 3 Best',top3Worst:'Top 3 Worst',consistencyScore:'Consistency Score',riskMetrics:'Risk Metrics',maxConsecLosses:'Max Consec. Losses',maxDDDuration:'Max DD Duration',days:'days',symbolInsights:'Symbol Insights',bestSymbol:'Best Symbol',sessionPerf:'Session Performance',asiaSession:'Asia',euSession:'Europe',usSession:'US',scoreDistribution:'Score Distribution',trinityScore:'Trinity Score',avgScore:'Avg Score',highScore:'High Score',lowScore:'Low Score',noLiveTrades:'No LIVE trades yet',startTrading:'Start trading to see insights',longVsShort:'Long vs Short',avgDuration:'Avg Duration',hours:'hours',minutes:'min',weeklyProgress:'Weekly Progress',vsLastWeek:'vs last week',improvement:'Improvement',decline:'Decline',smartAlerts:'Smart Alerts',alertLowWR:'Win rate below 50%',alertNegStreak:'Negative streak detected',alertHighDD:'Drawdown above threshold',alertNoTrades:'No trades this week',noAlerts:'All metrics healthy',losses:'losses',unlocked:'Unlocked',locked:'Locked',shareOnX:'Share on X',newAchievement:'New Achievement Unlocked!',achievementUnlocked:'Achievement unlocked',firstTradeLive:'First LIVE trade',consecWinsLive:'consecutive wins LIVE',pfAboveLive:'Profit Factor above',wrAboveLive:'Win Rate above',ddBelowLive:'Max DD below',tradesNoRiskLive:'trades without risky loss LIVE',inOneDayLive:'in one day LIVE',inOneWeekLive:'in one week LIVE',inOneMonthLive:'in one month LIVE',winningTradesLive:'winning trades LIVE',winAfter:'win after',lossStreak:'loss streak',tradeAfter:'winning trade after',tradeWonBefore:'trade won before',tradeWonAfter:'trade won after',tradeWonWeekend:'winning trade on weekend',perfectScoreTrade:'trade with perfect score',common:'Common',rare:'Rare',epic:'Epic',legendary:'Legendary',mythic:'Mythic',streaksCategory:'Streaks',milestonesCategory:'Milestones',volumeCategory:'Volume',performanceCategory:'Performance',timeCategory:'Time-based',symbolCategory:'Symbol Mastery',specialCategory:'Special',recentlyUnlocked:'Recently Unlocked',allAchievements:'All Achievements',progress:'Progress',totalPoints:'Total Points',nextAchievement:'Next Achievement',autoShareNew:'Auto-share new achievements',shareAll:'Share All',botStatus:'Bot Status',systemStats:'System Stats',uptime:'Uptime',cpu:'CPU',memory:'Memory',disk:'Disk',lastUpdate:'Last Update',liveLogs:'Live Logs',autoScroll:'Auto-scroll',clearLogs:'Clear',pauseLogs:'Pause',resumeLogs:'Resume',noLogsYet:'No logs yet',connecting:'Connecting...',disconnected:'Disconnected',actionSuccess:'Action successful',actionFailed:'Action failed',startingBot:'Starting bot...',stoppingBot:'Stopping bot...',restartingBot:'Restarting bot...',emergencyStopMsg:'Emergency stop triggered!',serverTime:'Server Time',container:'Container',dockerStatus:'Docker Status',networkLatency:'Latency',lastTrade:'Last Trade',botVersion:'Version',tradingPair:'Trading Pair',leverage:'Leverage',riskPerTrade:'Risk/Trade',filterAll:'All',filterInfo:'Info',filterWarning:'Warning',filterError:'Error',filterDebug:'Debug',filterSuccess:'Success',servicesStatus:'Services',forceScan:'Force Scan',pauseTrading:'Pause Trading',resumeTrading:'Resume Trading',actionHistory:'Action History',exportLogs:'Export Logs',logTheme:'Log Theme',defaultTheme:'Default',matrixTheme:'Matrix',lightTheme:'Light',soundOnError:'Sound on Error',lastScanAgo:'Last Scan',secondsAgo:'s ago',forceScanning:'Scanning...',paused:'Paused',servicesOk:'All services OK',serviceDown:'Service down',noActionYet:'No actions yet',postgres:'PostgreSQL',redis:'Redis',hyperliquid:'Exchange',configLive:'Config Live',scanInterval:'Scan Interval',seconds:'seconds',networkMs:'Network',ms:'ms',cpuMemHistory:'CPU/Memory (60s)',copied:'Copied!',downloadLogs:'Download',telegramNotif:'Telegram',pushNotif:'Push Notifications',journalTitle:'Trading Journal',journalPrivacyNote:'Strategy details below are private and will never be shared',strategyDetails:'Strategy Details (private)',fibLevel:'Signal Level',channelSignal:'Channel Signal',gapSignal:'Gap',confluence:'Confluence',setupNote:'Setup Note',shareSafe:'Share (safe)',generateImage:'Generate Image',perfectSetup:'Perfect setup',cleanEntry:'Clean entry',gapFill:'Gap fill',strongBullish:'Strong Bullish',bullish:'Bullish',bearish:'Bearish',strongBearish:'Strong Bearish',below:'Below',above:'Above',neutral:'Neutral',addNote:'Add note...',editNote:'Edit note',saveNote:'Save',noNotesYet:'No notes yet',tradeNotes:'Trade Notes',journalFilters:'Filters',showAll:'Show All',showWins:'Wins Only',showLosses:'Losses Only',todayTrades:'Today',weekTrades:'This Week',monthTrades:'This Month',allTrades:'All Trades',journalStats:'Journal Stats',avgSetupScore:'Avg Setup Score',bestSetup:'Best Setup',mostTradedPair:'Most Traded',journalEmpty:'No trades in your journal yet',startTradingJournal:'Start trading to build your journal',exportJournal:'Export Journal',setupAnalysis:'Setup Analysis',fibStats:'Signal Level Stats',channelStats:'Channel Stats',timelineView:'Timeline',cardView:'Cards',entryReason:'Entry Reason',exitReason:'Exit Reason',marketConditions:'Market Conditions',lessons:'Lessons Learned',tags:'Tags',addTag:'Add tag',riskTaken:'Risk Taken',plannedR:'Planned R',actualR:'Actual R',executionScore:'Execution',setupQuality:'Setup Quality',emotionalState:'Emotional State',calm:'Calm',confident:'Confident',anxious:'Anxious',fomo:'FOMO',revenge:'Revenge',tradeReview:'Trade Review',preTradeChecklist:'Pre-trade Checklist',postTradeAnalysis:'Post-trade Analysis',searchTrades:'Search trades...',setupStats:'Setup Analysis',wrBySetup:'Win Rate by Setup',wrByScore:'Win Rate by Score',wrBySide:'Win Rate Long vs Short',wrBySymbol:'Win Rate by Symbol',noDataYet:'Not enough data yet',allTrades2:'All',tradesCount2:'trades',winRate2:'WR',avgR2:'Avg R',addTagPlaceholder:'Add tag...',suggestedTags:'Suggested',tagRevenge:'revenge',tagPerfect:'perfect',tagMissedTp:'missed-tp',tagEarlyExit:'early-exit',tagOversize:'oversize',tagFomo:'fomo',tagPatient:'patient',tagNews:'news',removeTag:'Remove',miniChart:'Price Action',entryPoint:'Entry',exitPoint:'Exit',stopLevel:'Stop',tpLevel:'TP',priceRange:'Range',timelineEmpty:'No trades to display',statsView:'Stats',socialHub:'Social Hub',shareCenter:'Share Center',postPreview:'Post Preview',tradeCard:'Trade Card',quickShare:'Quick Share',shareStats:'Share Stats',shareTrade:'Share Trade',selectTrade:'Select a trade to share',generateCard:'Generate Card',downloadCard:'Download Card',postToX:'Post to X',postToDiscord:'Post to Discord',postToTelegram:'Post to Telegram',templatesTitle:'Message Templates',createTemplate:'Create Template',editTemplate:'Edit Template',deleteTemplate:'Delete',templateName:'Template Name',templateContent:'Template Content',templateVars:'Available Variables',noTemplates:'No templates yet',defaultTemplates:'Default Templates',historyTitle:'Post History',noHistory:'No posts yet',postedOn:'Posted on',platform:'Platform',viewPost:'View',deleteHistory:'Clear History',telegramConfig:'Telegram Configuration',botToken:'Bot Token',chatId:'Chat ID',testTelegram:'Test Connection',telegramOk:'Telegram connected!',telegramFailed:'Connection failed',autoPostTitle:'Auto-posting Settings',autoPostEnabled:'Enable auto-posting',postOnWins:'Post winning trades',postOnLosses:'Post losing trades',minRToPost:'Minimum R to post',selectPlatforms:'Select platforms',filterByR:'Filter by R',onlyAbove:'Only above',socialStats:'Social Stats',postsThisMonth:'Posts this month',lastPost:'Last post',mostShared:'Most shared',neverPosted:'Never',previewTwitter:'Twitter Preview',previewDiscord:'Discord Preview',previewTelegram:'Telegram Preview',statsWeek:'Weekly Stats',statsMonth:'Monthly Stats',statsAllTime:'All-time Stats',backtestLive:'Backtest vs Live',privacyReminder:'Strategy details are never shared',copyToClipboard:'Copy to clipboard',characterCount:'characters',tweetLimit:'Tweet limit: 280 chars',templateSaved:'Template saved',templateDeleted:'Template deleted',postSent:'Post sent successfully',postFailed:'Failed to send post',confirmDelete:'Confirm deletion?',webhookConfigured:'Webhook configured',webhookNotConfigured:'Not configured',connectedStatus:'Connected',disconnectedStatus:'Disconnected',platformTwitter:'Twitter/X',platformDiscord:'Discord',platformTelegram:'Telegram',selectTradePrompt:'Choose a trade from the list',recentTradesShare:'Recent Trades',cardStyle:'Card Style',styleDark:'Dark',styleLight:'Light',styleNeon:'Neon',includeChart:'Include chart',includeLogo:'Include logo',tradeCardPreview:'Trade Card Preview',twitterViaIfttt:'Twitter/X (via IFTTT)',twitterWebhookDesc:'Discord webhook that IFTTT will relay to Twitter',iftttSetupGuide:'IFTTT Setup Guide',iftttStep1:'1. Create IFTTT account at ifttt.com',iftttStep2:'2. Connect your Twitter account to IFTTT',iftttStep3:'3. Create Applet: If Discord ‚Üí Then Tweet',iftttStep4:'4. Paste the Discord webhook URL below',iftttNote:'Messages posted to this webhook will be automatically relayed to Twitter via IFTTT',showGuide:'Show Guide',hideGuide:'Hide Guide',twitterEnabled:'Twitter relay enabled',twitterDisabled:'Twitter relay disabled',exportTitle:'Export Center',exportCsvTrades:'Export Trades CSV',exportJson:'Export JSON',exportPdf:'Performance Report',exportBackup:'Full Backup',importBackup:'Import Backup',exportByPeriod:'Export by Period',exportTax:'Tax Report',allTime:'All Time',last30:'Last 30 Days',last90:'Last 90 Days',thisYear:'This Year',customRange:'Custom Range',startDate:'Start Date',endDate:'End Date',generating:'Generating...',downloadReady:'Download Ready',exportSuccess:'Export successful',exportFailed:'Export failed',importSuccess:'Import successful',importFailed:'Import failed',selectFile:'Select File',dragDrop:'or drag and drop',backupIncludes:'Backup includes',tradesData:'Trades data',settingsData:'Settings',journalData:'Journal notes',socialData:'Social templates',confirmImport:'This will replace current data. Continue?',taxYear:'Tax Year',taxFormat:'Format',taxFrench:'French (Cerfa)',taxGeneric:'Generic',includeOpen:'Include open positions',includeClosed:'Include closed positions',exportOptions:'Export Options',strategyAttribution:'Strategy Attribution',analyticsSide:'Long vs Short',analyticsCost:'Cost Analysis',grossProfit:'Gross Profit',netProfit:'Net Profit',feesImpact:'Fees Impact',feesRatio:'Fees Ratio',feesExcellent:'Excellent - Fees < 5% of profits',feesModerate:'Moderate - Consider reducing frequency',feesHigh:'High - Fees eating into profits',longBias:'Long bias detected',shortBias:'Short bias detected',balancedPerf:'Balanced performance',durationVsPnl:'Duration vs PnL',durationHours:'Duration (hours)',shortTrades:'Short trades',mediumTrades:'Medium trades',longTrades:'Long duration',nextMilestone:'Next Goal',scatterWins:'Wins',scatterLosses:'Losses',quickWins:'Quick wins',longWins:'Long wins',apiWeight:'API Weight',rateLimitsOk:'Rate limits OK',rateLimitsModerate:'Moderate usage',rateLimitsHigh:'High - Reduce calls',systemEvents:'System Events',noEventsYet:'No events yet',wsConnected:'Websocket Connected',systemStarted:'System Started',regimeTo:'Regime ‚Üí',avgMs:'avg',used:'used',flatten:'Flatten',deposit:'Deposit',withdrawal:'Withdrawal',tradingPnl:'TRADING PNL',netCashFlow:'Net Cash Flow',totalDeposits:'Total Deposited',totalWithdrawals:'Total Withdrawn',capitalEvents:'Capital Events',autoDetected:'Auto-detected',fiscalTitle:'Tax & Compliance (DGFIP)',fiscalSubtitle:'Certified export for French tax authorities',fiscalPeriod:'Fiscal Period',fiscalYear:'Fiscal Year N-1',fiscalYtd:'Year to Date',fiscalLastMonth:'Last Month',fiscalCustom:'Custom Period',fiscalAggregate:'Aggregate Daily Funding',fiscalAggregateDesc:'Reduces volume by 95% by summing hourly micro-payments per day',fiscalGenerate:'GENERATE CERTIFIED EXPORT (.CSV)',fiscalFetching:'Fetching exchange data...',fiscalConverting:'EUR conversion (Oracle)...',fiscalSigning:'SHA-256 signature...',fiscalDone:'Export ready!',fiscalHistory:'Export History & Proof',fiscalDate:'Generation Date',fiscalPeriodCol:'Period',fiscalHash:'Security Hash (SHA-256)',fiscalAction:'Action',fiscalDownload:'Download',fiscalNoHistory:'No certified exports yet',fiscalDisclaimer:'CERTIFICATION: This document is algorithmically generated based on blockchain and exchange data. The SHA-256 signature guarantees it has not been altered after generation. Trinity does not replace a certified public accountant.',fiscalExpertMode:'Expert Mode',fiscalWalletId:'Wallet ID',monitor:'Monitor',monitorTitle:'Trinity Monitor',monitorCycle:'Cycle',monitorUptime:'Uptime',monitorCpu:'CPU',monitorRam:'RAM',monitorDisk:'Disk',monitorLatency:'API Latency',monitorErrorsH:'Errors/h',monitorPositions:'Positions',monitorHeartbeatOk:'Heartbeat OK',monitorBotFrozen:'Bot Frozen',monitorPosSync:'Positions Sync',monitorDriftAlert:'DRIFT!',monitorSlTpOk:'SL/TP OK',monitorOrdersIncomplete:'Incomplete Orders',monitorBalanceOk:'Balance OK',monitorBalanceDrift:'Balance Drift',monitorPosDrift:'Position Drift',monitorBotApi:'Bot API',monitorExchange:'Exchange',monitorPosSync2:'Positions perfectly synchronized',monitorLoading:'Loading...',monitorRecentAlerts:'Recent Alerts',monitorNoAlerts:'No alerts',monitorBalanceRecon:'Balance Reconciliation',monitorDeviation:'Deviation',monitorErrorConsole:'Error Console',monitorNoErrors:'> No recent errors. System nominal.',monitorKillSwitch:'Kill Switch',monitorKillDesc:'Type STOP then confirm to stop the bot',monitorEmergencyStop:'Emergency Stop',monitorConfirm:'CONFIRM',monitorCancel:'Cancel',monitorRestartBot:'Restart Bot',monitorRestartDesc:'Restarts the bot Docker container',monitorRestartBtn:'Restart the bot',monitorHip3Title:'HIP-3 Stocks Monitor',monitorHip3Heartbeat:'HIP-3 Alive',monitorHip3Dead:'HIP-3 Dead',monitorHip3PosSync:'HIP-3 Sync',monitorHip3Drift:'HIP-3 DRIFT!',monitorHip3OrdersOk:'HIP-3 SL/TP OK',monitorHip3OrdersBad:'HIP-3 Orders Bad',monitorHip3PosDrift:'HIP-3 Position Drift',monitorHip3BalanceRecon:'HIP-3 Balance Reconciliation',monitorHip3KillSwitch:'HIP-3 Kill Switch',monitorHip3KillDesc:'Type STOP then confirm to stop the HIP-3 bot',monitorHip3Restart:'Restart HIP-3 Bot',monitorHip3RestartDesc:'Restarts the HIP-3 bot Docker container',monitorHip3RestartBtn:'Restart HIP-3 bot',downloadCsv:'Download CSV',downloadJson:'Download JSON',generateReport:'Generate Report',downloadBackup:'Download Backup',exportCsvDesc:'Export all trades to CSV spreadsheet format',exportJsonDesc:'Export trades in JSON format for developers',exportPdfDesc:'Generate a printable performance report',structuredData:'Structured data',htmlReport:'HTML report',allSettings:'All settings',viewChart:'View Chart',hideChart:'Hide',chartBtn:'Chart',tradeHistory:'TRADE HISTORY',newPosOpened:'New position opened!',tradeClosed:'Trade closed',posOpenedEmoji:'New position opened!',hide:'Hide',show:'Show',onchain:'On-Chain',onchainTitle:'On-Chain Regime',onchainCompositeScore:'Composite Score',onchainCurrentRegime:'Current Regime',onchainMetrics:'Individual Metrics',onchainEffects:'Active Effects on Trading',onchainRiskMult:'Risk Multiplier',onchainTpMult:'TP Multiplier',onchainScoreBonus:'Score Bonus',onchainLastUpdate:'Last Update',onchainDisabled:'On-Chain module disabled',onchainNoData:'No on-chain data available',onchainInd1:'Composite Index',onchainInd2:'Sentiment Index',onchainInd3:'Valuation Metric',onchainInd4:'Profit Ratio',onchainInd5:'Unrealized P&L',onchainInd6:'Revenue Multiple',onchainInd7:'Risk Metric',onchainInd8b:'Flow Indicator',onchainInd9:'Short-term Metric',onchainInd10:'Accumulation Zone',onchainInd10Dist:'Distribution Zone',onchainNeutralDesc:'Strategy as normal',altseason:'Altseason Index',altseasonTitle:'Trinity Altseason Index (TAI)',altseasonScore:'TAI Score',altseasonPhase:'Current Phase',altseasonSignal:'Signal',altseasonConfidence:'Confidence',altseasonUrgency:'Urgency',altseasonIndicators:'Sub-Indicators Breakdown',altseasonExitWarnings:'Exit Warnings',altseasonLastUpdate:'Last Update',altseasonLoading:'Loading altseason data...',altseasonNoData:'No altseason data available',altseasonWeight:'Weight',altseasonRawValue:'Raw Value',altseasonSubScore:'Sub-Score',altseasonPhases:'Phase Timeline',altseasonBtcD:'Metric A',altseasonEthBtc:'Ratio D',altseasonTop50:'Top 50 vs BTC',altseasonCombinedD:'Combined Dominance',altseasonTotal2:'TOTAL2 Trend',altseasonStableShare:'Stablecoin Share',altseasonAltVol:'Alt Volume',altseasonMetricA:'Sentiment Index',altseasonSpx:'S&P 500 Proximity',altseasonVix:'VIX Level',altseasonDxy:'Dollar Index',altseasonNetLiq:'Net Liquidity',altseasonBtcDSlope:'Metric B',altseasonPhase1:'Deep Bear',altseasonPhase2:'Bitcoin Season',altseasonPhase3:'Pre-Transition',altseasonPhase4:'Early Altseason',altseasonPhase5:'Full Altseason',altseasonPhase6:'Euphoria',altseasonHistory:'Score History (24h)',onchainSubtitle:'BTC on-chain metrics as macro overlay for all crypto positions',onchainActive:'ACTIVE',onchainBuy:'BUY',onchainSell:'SELL',onchainScoreRange:'Range: -30 to +30',onchainFearLabel:'Fear',onchainGreedLabel:'Greed',onchainSizeBoosted:'Size boosted',onchainSizeReduced:'Size reduced',onchainTargetsExtended:'Targets extended',onchainTargetsTightened:'Targets tightened',onchainLongsFavored:'Longs favored',onchainLongsPenalized:'Longs penalized',onchainShortsFavored:'Shorts favored',onchainShortsPenalized:'Shorts penalized',onchainScoreFear:'FEAR',onchainScoreCautious:'Cautious',onchainScoreNeutral:'Neutral',onchainScoreWarm:'Warm',onchainScoreGreed:'GREED',onchainInd1Title:'Composite On-Chain Score',onchainInd1Desc:'Multi-factor composite index. Low = accumulation zone, High = distribution zone.',onchainBuyZone:'0 - Buy Zone',onchainNeutralZone:'50 - Neutral',onchainSellZone:'100 - Sell Zone',onchainInd8:'Cycle Indicator',onchainInd8History:'Historical cycle detection: High accuracy',onchainBtcPrice:'BTC Price',onchainGap:'Gap',onchainInd8Crossed:'0% ‚Äî CROSSED (Top Signal)',onchainInd8WarningZone:'5% ‚Äî Warning',onchainInd8Safe:'30%+ ‚Äî Safe',onchainInd8AlertCrossed:'CYCLE TOP SIGNAL ‚Äî Signal A crossed above Signal B ‚Äî Historical cycle top indicator!',onchainInd8AlertDanger:'Cycle indicator approaching crossover ‚Äî Consider reducing long exposure',onchainInd8AlertWarning:'Cycle indicator within warning zone ‚Äî Monitor closely',onchainEnableHint:'Enable with ONCHAIN_ENABLED=true in .env (pending backtest validation)',onchainDescInd1:'Multi-factor composite score',onchainDescInd2:'Market sentiment gauge',onchainDescInd3:'Market valuation ratio',onchainDescInd4:'On-chain profit tracking',onchainDescInd5:'Aggregate unrealized gains',onchainDescInd6:'Network revenue indicator',onchainDescInd7:'Risk-adjusted confidence',onchainDescInd8b:'Capital flow direction',onchainDescInd9:'Short-term valuation ratio',altseasonPlaybookTitle:'What To Do Now',altseasonBtcTrendFilter:'BTC Trend Filter (Multiplier)',altseasonBullBearScore:'Bull/Bear Score',altseasonMarketData:'Market Data',altseasonWeightsOpt:'Optimized weights',altseasonCoinScanner:'Coin Scanner',altseasonBuySignals:'BUY Signals',altseasonSellSignals:'SELL Signals',altseasonUrgencyLabel:'Urgency',altseasonBreakouts:'Individual Breakouts (uncorrelated to market)',altseasonTrending:'Trending on CoinGecko',altseasonSectors:'Sectors',altseasonBearLabel:'BEAR',altseasonAltLabel:'ALT',altseasonAthRecovery:'ATH Recovery',altseasonNextTarget:'Next',altseasonPriceDiscovery:'PRICE DISCOVERY',altseasonFooter:'Trinity Market Index v1.0 | Multi-factor analysis | CoinGecko + Market data',altseasonDescTop50:'% beating BTC 90d',altseasonDescTotal2:'Market cap ex-BTC',altseasonDescRs2k:'Small caps ratio',altseasonDescNetLiq:'Macro indicator 3mo delta',altseasonDescBtcDSlope:'30d slope proxy',funding:'Funding',fundingTitle:'Funding Harvester',fundingLoading:'Loading funding data...',fundingOffline:'Funding Harvester Offline',fundingServiceDown:'Service unavailable on',fundingStatus:'Status',fundingEarnings:'Earnings',fundingPosition:'Position',fundingRunning:'Running',fundingYes:'YES',fundingNo:'NO',fundingAvailCapital:'Available Capital',fundingTotalFunding:'Total Funding',fundingTotalFees:'Total Fees',fundingNetProfit:'Net Profit',fundingProjectedDay:'Projected /day',fundingProjectedMonth:'Projected /month',fundingAsset:'Asset',fundingSpot:'Spot',fundingPerp:'Perp',fundingNotional:'Notional',fundingEarned:'Funding Earned',fundingDuration:'Duration',fundingNegHours:'Neg Hours',fundingNoPosition:'No active position',fundingWaiting:'Waiting for positive funding rate',fundingLiveRates:'Live Funding Rates (Hourly)',fundingRateH:'Rate/h',fundingDirection:'Direction',fundingShortsRcv:'Shorts rcv',fundingLongsRcv:'Longs rcv',fundingToMarketOpen:'to market open',fundingMarketHours:'MARKET HOURS',fundingOffHours:'OFF-HOURS'},
  fr:{overview:'Vue d\'ensemble',trades:'Trades',analytics:'Analytique',insights:'Analyses',achievements:'Succ√®s',botControl:'Contr√¥le Bot',journal:'Journal',social:'Social',export:'Export',online:'En ligne',offline:'Hors ligne',liveNow:'EN DIRECT',currentStreak:'SERIE ACTUELLE',bestStreak:'Meilleure S√©rie',dailyRGoal:'Objectif R Jour',weeklyRGoal:'Objectif R Semaine',privateStrategy:'Strat√©gie Priv√©e',balance:'BALANCE',totalPnl:'PNL TOTAL',winRate:'WIN RATE',totalR:'R TOTAL',profitFactor:'PROFIT FACTOR',maxDrawdown:'MAX DRAWDOWN',liveDrawdown:'Drawdown Live',max:'Max',balanceEvolution:'Evolution Balance',share:'Partager',live:'LIVE',cumulative:'Cumulatif',week:'Semaine',month:'Mois',year:'Ann√©e',all:'Tout',prevWeek:'Sem. Pr√©c.',day:'Jour',cumulativeR:'R Cumulatif',today:'Aujourd\'hui',positionType:'Type Position',long:'Long',short:'Short',wr:'WR',pairDistribution:'R√©partition Paires',distribution:'Distribution',win:'Gain',loss:'Perte',be:'BE',recentTrades:'Trades R√©cents',clickForDetails:'cliquez pour d√©tails',entry:'Entr√©e',exit:'Sortie',regime:'Regime',current:'Actuel',unrealizedR:'R Non Realise',confidence:'Confiance',shareThisTrade:'Partager ce trade',liveSince:'Live depuis',noTrades:'Aucun trade',noData:'Aucune donn√©e',start:'D√©marrer',stop:'Arr√™ter',restart:'Red√©marrer',emergencyStop:'ARRET URGENCE',botRunning:'Bot Actif',botStopped:'Bot Arr√™t√©',health:'Sant√©',logs:'Logs',wallet:'Wallet',openWallet:'Ouvrir Exchange',connected:'Connect√©',mon:'Lun',tue:'Mar',wed:'Mer',thu:'Jeu',fri:'Ven',sat:'Sam',sun:'Dim',jan:'Jan',feb:'Fev',mar:'Mar',apr:'Avr',may:'Mai',jun:'Juin',jul:'Juil',aug:'Aout',sep:'Sep',oct:'Oct',nov:'Nov',dec:'Dec',settings:'Param√®tres',appearance:'Apparence',darkMode:'Mode Sombre',goals:'Objectifs',ddAlertThreshold:'Seuil Alerte DD',social:'Social',soundEffects:'Effets Sonores',twitterIntegration:'Integration Twitter/X',configure:'Configurer',discord:'Discord',discordWebhook:'URL Webhook Discord',testWebhook:'Tester Webhook',save:'Sauvegarder',privateStrategyDesc:'Indicateurs proprietaires. Details non partages.',autoPosting:'Publication Auto',autoPostingDesc:'Publication automatique sur X',postOnOpen:'Publier a l\'ouverture',postOnClose:'Publier a la fermeture',postAchievements:'Publier achievements',postMilestones:'Publier milestones',hideAmountsInPosts:'Masquer $ dans posts',hashtags:'Hashtags',comingSoon:'Bientot disponible',confirm:'Confirmer?',confirmBtn:'CONFIRMER',cancel:'Annuler',mode:'Mode',tradesCount:'Trades',waitingLogs:'En attente des logs...',webhookOk:'Webhook OK!',webhookFailed:'Webhook echoue',w:'G',l:'P',date:'Date',symbol:'Symbole',side:'Sens',pnl:'PnL',score:'Score',openTrades:'Positions Ouvertes',sortBy:'Trier par',dateDesc:'Plus recent',dateAsc:'Plus ancien',rDesc:'Meilleur R',rAsc:'Pire R',pnlDesc:'Meilleur PnL',pnlAsc:'Pire PnL',search:'Rechercher',searchPlaceholder:'Rechercher par symbole, date...',exportCsv:'Exporter CSV',bestTrade:'Meilleur Trade',worstTrade:'Pire',quickTrade:'Rapide',longHold:'Long Terme',tradeDetails:'Details du Trade',entryTime:'Heure Entr√©e',exitTime:'Heure de Sortie',duration:'Dur√©e',close:'Fermer',page:'Page',of:'sur',noResults:'Aucun resultat',allSymbols:'Tous Symboles',allRegimes:'Tous Regimes',period:'P√©riode',filters:'Filtres',stats:'Stats',goodMorning:'Bonjour',goodAfternoon:'Bon apres-midi',goodEvening:'Bonsoir',welcomeBack:'Content de vous revoir',youHave:'Vous avez',openPosition:'position ouverte',openPositions:'positions ouvertes',todaySoFar:'aujourd\'hui',noOpenPositions:'Aucune position ouverte',avgRPerTrade:'R Moyen/Trade',bestToday:'Meilleur Aujourdhui',worstToday:'Pire Aujourdhui',timeInMarket:'Temps en Position',expectancy:'Esp√©rance',ddAlert:'ALERTE DRAWDOWN',ddAlertMsg:'Le drawdown depasse le seuil',goalProgress:'Progression Objectifs',daily:'Jour',weekly:'Semaine',achieved:'Atteint',regimeHistory:'Historique Regime',since:'depuis',perfByRegime:'Performance par Regime',tradesHeatmap:'Heatmap Trades',winningDay:'Jour gagnant',losingDay:'Jour perdant',noTradesDay:'Pas de trades',activityFeed:'Activite Recente',opened:'Ouvert',closed:'Ferme',regimeChanged:'Regime passe a',ago:'il y a',justNow:'a l\'instant',minutesAgo:'min',hoursAgo:'h',daysAgo:'j',perfComparison:'Comparaison Performance',thisWeek:'Cette Semaine',lastWeek:'Semaine Derniere',thisMonth:'Ce Mois',lastMonth:'Mois Dernier',vsBacktest:'vs Backtest',livePerf:'Performance LIVE',backtestPerf:'Backtest',noActivity:'Aucune activite recente',streakAtRisk:'Serie en danger',considerReducing:'Reduire la taille de position',approaching:'approche',resistance:'resistance',support:'support',perfLiveSimulation:'Performance LIVE & Simulation Historique',liveRealSince:'LIVE = Reel depuis',simulationHistorical:'Simulation = Strategie testee sur donnees historiques',simulation:'SIMULATION',heatmap24h:'Heatmap 24h',pnlCalendar:'Calendrier PnL',advanced:'Avance',sharpeRatio:'Ratio Sharpe',recoveryFactor:'Facteur Recovery',avgRR:'R:R Moyen',milestones:'Milestones',basedOnLive:'Base uniquement sur trades LIVE reels',simulationComplete:'Simulation Complete',roiEvolution:'Evolution ROI',totalTrades:'Total Trades',avgR:'R Moyen',roi:'ROI',dd:'DD',sortinoRatio:'Ratio Sortino',calmarRatio:'Ratio Calmar',bestHour:'Meilleure Heure',worstHour:'Pire Heure',bestDay:'Meilleur Jour',worstDay:'Pire Jour',rDistribution:'Distribution R',streakAnalysis:'Analyse Series',currentStreakLabel:'Actuelle',bestWinStreak:'Meilleure Serie Gagnante',bestLossStreak:'Pire Serie Perdante',liveVsBacktest:'LIVE vs Backtest',outperformance:'Surperformance',underperformance:'Sous-performance',perfBySymbol:'Performance par Symbole',autoInsights:'Insights Auto',noInsights:'Pas encore d\'insights',tradesAtR:'trades a',bestWorstLive:'Meilleur / Pire (LIVE)',advancedInsightsLive:'Insights Avances (LIVE)',perfByRegimeLive:'Performance par Regime (LIVE)',currentSeries:'Serie actuelle',wins:'gains',rPerWeek:'R/Semaine',hourlyHeatmap:'Heatmap Horaire',topTrades:'Top Trades',top3Best:'Top 3 Meilleurs',top3Worst:'Top 3 Pires',consistencyScore:'Score Consistance',riskMetrics:'Metriques Risque',maxConsecLosses:'Max Pertes Consec.',maxDDDuration:'Duree Max DD',days:'jours',symbolInsights:'Insights par Symbole',bestSymbol:'Meilleur Symbole',sessionPerf:'Performance Sessions',asiaSession:'Asie',euSession:'Europe',usSession:'US',scoreDistribution:'Distribution Scores',trinityScore:'Score Trinity',avgScore:'Score Moyen',highScore:'Score Max',lowScore:'Score Min',noLiveTrades:'Aucun trade LIVE',startTrading:'Commencez a trader pour voir les insights',longVsShort:'Long vs Short',avgDuration:'Duree Moyenne',hours:'heures',minutes:'min',weeklyProgress:'Progression Hebdo',vsLastWeek:'vs semaine derniere',improvement:'Amelioration',decline:'Baisse',smartAlerts:'Alertes Intelligentes',alertLowWR:'Win rate inferieur a 50%',alertNegStreak:'Serie negative detectee',alertHighDD:'Drawdown au-dessus du seuil',alertNoTrades:'Aucun trade cette semaine',noAlerts:'Toutes les metriques sont saines',losses:'pertes',unlocked:'Debloques',locked:'Bloques',shareOnX:'Partager sur X',newAchievement:'Nouvel Achievement Debloque!',achievementUnlocked:'Achievement debloque',firstTradeLive:'Premier trade LIVE',consecWinsLive:'wins consecutifs LIVE',pfAboveLive:'Profit Factor superieur a',wrAboveLive:'Win Rate superieur a',ddBelowLive:'Max DD inferieur a',tradesNoRiskLive:'trades sans perte risquee LIVE',inOneDayLive:'en un jour LIVE',inOneWeekLive:'en une semaine LIVE',inOneMonthLive:'en un mois LIVE',winningTradesLive:'trades gagnants LIVE',winAfter:'win apres',lossStreak:'serie de pertes',tradeAfter:'trade gagnant apres',tradeWonBefore:'trade gagne avant',tradeWonAfter:'trade gagne apres',tradeWonWeekend:'trade gagnant le weekend',perfectScoreTrade:'trade avec score parfait',common:'Commun',rare:'Rare',epic:'Epique',legendary:'Legendaire',mythic:'Mythique',streaksCategory:'Series',milestonesCategory:'Milestones',volumeCategory:'Volume',performanceCategory:'Performance',timeCategory:'Temps',symbolCategory:'Maitrise Symboles',specialCategory:'Special',recentlyUnlocked:'Recemment Debloques',allAchievements:'Tous les Achievements',progress:'Progression',totalPoints:'Points Totaux',nextAchievement:'Prochain Achievement',autoShareNew:'Partage auto nouveaux achievements',shareAll:'Partager Tout',botStatus:'Statut Bot',systemStats:'Stats Systeme',uptime:'Uptime',cpu:'CPU',memory:'M√©moire',disk:'Disque',lastUpdate:'Derni√®re MAJ',liveLogs:'Logs Live',autoScroll:'D√©filement auto',clearLogs:'Effacer',pauseLogs:'Pause',resumeLogs:'Reprendre',noLogsYet:'Aucun log',connecting:'Connexion...',disconnected:'D√©connect√©',actionSuccess:'Action r√©ussie',actionFailed:'Action √©chou√©e',startingBot:'D√©marrage du bot...',stoppingBot:'Arr√™t du bot...',restartingBot:'Red√©marrage du bot...',emergencyStopMsg:'Arr√™t urgence d√©clench√©!',serverTime:'Heure Serveur',container:'Conteneur',dockerStatus:'Statut Docker',networkLatency:'Latence',lastTrade:'Dernier Trade',botVersion:'Version',tradingPair:'Paire Trading',leverage:'Levier',riskPerTrade:'Risque/Trade',filterAll:'Tout',filterInfo:'Info',filterWarning:'Warning',filterError:'Erreur',filterDebug:'Debug',filterSuccess:'Succ√®s',servicesStatus:'Services',forceScan:'Forcer Scan',pauseTrading:'Pause Trading',resumeTrading:'Reprendre Trading',actionHistory:'Historique Actions',exportLogs:'Exporter Logs',logTheme:'Theme Logs',defaultTheme:'Defaut',matrixTheme:'Matrix',lightTheme:'Clair',soundOnError:'Son sur Erreur',lastScanAgo:'Dernier Scan',secondsAgo:'s',forceScanning:'Scan en cours...',paused:'En pause',servicesOk:'Services OK',serviceDown:'Service down',noActionYet:'Aucune action',postgres:'PostgreSQL',redis:'Redis',hyperliquid:'Exchange',configLive:'Config Live',scanInterval:'Intervalle Scan',seconds:'secondes',networkMs:'Reseau',ms:'ms',cpuMemHistory:'CPU/Memoire (60s)',copied:'Copie!',downloadLogs:'T√©l√©charger',telegramNotif:'Telegram',pushNotif:'Notifications Push',journalTitle:'Journal de Trading',journalPrivacyNote:'Les details de strategie ci-dessous sont prives et ne seront jamais partages',strategyDetails:'Details Strategie (prive)',fibLevel:'Niveau Signal',channelSignal:'Signal Canal',gapSignal:'Gap',confluence:'Confluence',setupNote:'Note Setup',shareSafe:'Partager (safe)',generateImage:'G√©n√©rer Image',perfectSetup:'Setup parfait',cleanEntry:'Entr√©e propre',gapFill:'Comblement gap',strongBullish:'Tr√®s Haussier',bullish:'Haussier',bearish:'Baissier',strongBearish:'Tr√®s Baissier',below:'En dessous',above:'Au dessus',neutral:'Neutre',addNote:'Ajouter une note...',editNote:'Modifier la note',saveNote:'Sauvegarder',noNotesYet:'Pas encore de notes',tradeNotes:'Notes du Trade',journalFilters:'Filtres',showAll:'Tout afficher',showWins:'Gains seulement',showLosses:'Pertes seulement',todayTrades:'Aujourdhui',weekTrades:'Cette Semaine',monthTrades:'Ce Mois',allTrades:'Tous les Trades',journalStats:'Stats Journal',avgSetupScore:'Score Setup Moyen',bestSetup:'Meilleur Setup',mostTradedPair:'Plus Trade',journalEmpty:'Aucun trade dans votre journal',startTradingJournal:'Commencez a trader pour remplir votre journal',exportJournal:'Exporter Journal',setupAnalysis:'Analyse Setups',fibStats:'Stats Niveaux Signal',channelStats:'Stats Canal',timelineView:'Timeline',cardView:'Cartes',entryReason:'Raison Entree',exitReason:'Raison Sortie',marketConditions:'Conditions Marche',lessons:'Lecons Apprises',tags:'Tags',addTag:'Ajouter tag',riskTaken:'Risque Pris',plannedR:'R Planifie',actualR:'R Reel',executionScore:'Execution',setupQuality:'Qualite Setup',emotionalState:'Etat Emotionnel',calm:'Calme',confident:'Confiant',anxious:'Anxieux',fomo:'FOMO',revenge:'Revanche',tradeReview:'Review Trade',preTradeChecklist:'Checklist Pre-trade',postTradeAnalysis:'Analyse Post-trade',searchTrades:'Rechercher trades...',setupStats:'Analyse Setups',wrBySetup:'Win Rate par Setup',wrByScore:'Win Rate par Score',wrBySide:'Win Rate Long vs Short',wrBySymbol:'Win Rate par Symbole',noDataYet:'Pas assez de donnees',allTrades2:'Tous',tradesCount2:'trades',winRate2:'WR',avgR2:'R Moy',addTagPlaceholder:'Ajouter tag...',suggestedTags:'Suggestions',tagRevenge:'revenge',tagPerfect:'parfait',tagMissedTp:'tp-rate',tagEarlyExit:'sortie-tot',tagOversize:'surexpose',tagFomo:'fomo',tagPatient:'patient',tagNews:'news',removeTag:'Supprimer',miniChart:'Action Prix',entryPoint:'Entree',exitPoint:'Sortie',stopLevel:'Stop',tpLevel:'TP',priceRange:'Range',timelineEmpty:'Aucun trade a afficher',statsView:'Stats',socialHub:'Hub Social',shareCenter:'Centre de Partage',postPreview:'Apercu du Post',tradeCard:'Trade Card',quickShare:'Partage Rapide',shareStats:'Partager Stats',shareTrade:'Partager Trade',selectTrade:'S√©lectionnez un trade',generateCard:'G√©n√©rer Card',downloadCard:'T√©l√©charger Card',postToX:'Poster sur X',postToDiscord:'Poster sur Discord',postToTelegram:'Poster sur Telegram',templatesTitle:'Mod√®les de Messages',createTemplate:'Cr√©er Mod√®le',editTemplate:'Modifier Mod√®le',deleteTemplate:'Supprimer',templateName:'Nom du Mod√®le',templateContent:'Contenu du Modele',templateVars:'Variables Disponibles',noTemplates:'Aucun modele',defaultTemplates:'Mod√®les par D√©faut',historyTitle:'Historique Publications',noHistory:'Aucune publication',postedOn:'Publie le',platform:'Plateforme',viewPost:'Voir',deleteHistory:'Effacer Historique',telegramConfig:'Configuration Telegram',botToken:'Token du Bot',chatId:'Chat ID',testTelegram:'Tester Connexion',telegramOk:'Telegram connecte!',telegramFailed:'Connexion √©chou√©e',autoPostTitle:'Parametres Auto-posting',autoPostEnabled:'Activer auto-posting',postOnWins:'Poster les gains',postOnLosses:'Poster les pertes',minRToPost:'R minimum pour poster',selectPlatforms:'Selectionner plateformes',filterByR:'Filtrer par R',onlyAbove:'Uniquement au-dessus de',socialStats:'Stats Social',postsThisMonth:'Posts ce mois',lastPost:'Dernier post',mostShared:'Plus partage',neverPosted:'Jamais',previewTwitter:'Apercu Twitter',previewDiscord:'Apercu Discord',previewTelegram:'Apercu Telegram',statsWeek:'Stats Semaine',statsMonth:'Stats Mois',statsAllTime:'Stats Totales',backtestLive:'Backtest vs Live',privacyReminder:'Details strategie jamais partages',copyToClipboard:'Copier dans presse-papier',characterCount:'caracteres',tweetLimit:'Limite tweet: 280 car.',templateSaved:'Mod√®le sauvegard√©',templateDeleted:'Mod√®le supprim√©',postSent:'Post envoy√© avec succ√®s',postFailed:'√âchec envoi post',confirmDelete:'Confirmer suppression?',webhookConfigured:'Webhook configur√©',webhookNotConfigured:'Non configur√©',connectedStatus:'Connect√©',disconnectedStatus:'D√©connect√©',platformTwitter:'Twitter/X',platformDiscord:'Discord',platformTelegram:'Telegram',selectTradePrompt:'Choisissez un trade dans la liste',recentTradesShare:'Trades R√©cents',cardStyle:'Style de Card',styleDark:'Sombre',styleLight:'Clair',styleNeon:'Neon',includeChart:'Inclure graphique',includeLogo:'Inclure logo',tradeCardPreview:'Apercu Trade Card',twitterViaIfttt:'Twitter/X (via IFTTT)',twitterWebhookDesc:'Webhook Discord qui sera relaie vers Twitter par IFTTT',iftttSetupGuide:'Guide Configuration IFTTT',iftttStep1:'1. Creer un compte IFTTT sur ifttt.com',iftttStep2:'2. Connecter votre compte Twitter a IFTTT',iftttStep3:'3. Creer Applet: Si Discord alors Tweet',iftttStep4:'4. Coller le webhook Discord ci-dessous',iftttNote:'Les messages postes sur ce webhook seront automatiquement relayes vers Twitter via IFTTT',showGuide:'Afficher Guide',hideGuide:'Masquer Guide',twitterEnabled:'Relais Twitter activ√©',twitterDisabled:'Relais Twitter d√©sactiv√©',exportTitle:'Centre Export',exportCsvTrades:'Exporter Trades CSV',exportJson:'Exporter JSON',exportPdf:'Rapport Performance',exportBackup:'Backup Complet',importBackup:'Importer Backup',exportByPeriod:'Export par Periode',exportTax:'Rapport Fiscal',allTime:'Tout',last30:'30 Derniers Jours',last90:'90 Derniers Jours',thisYear:'Cette Annee',customRange:'Periode Personnalisee',startDate:'Date Debut',endDate:'Date Fin',generating:'G√©n√©ration...',downloadReady:'T√©l√©chargement Pr√™t',exportSuccess:'Export r√©ussi',exportFailed:'Export √©chou√©',importSuccess:'Import r√©ussi',importFailed:'Import √©chou√©',selectFile:'Choisir Fichier',dragDrop:'ou glisser-deposer',backupIncludes:'Le backup inclut',tradesData:'Donnees trades',settingsData:'Parametres',journalData:'Notes journal',socialData:'Modeles sociaux',confirmImport:'Ceci remplacera les donnees actuelles. Continuer?',taxYear:'Ann√©e Fiscale',taxFormat:'Format',taxFrench:'Fran√ßais (Cerfa)',taxGeneric:'G√©n√©rique',includeOpen:'Inclure positions ouvertes',includeClosed:'Inclure positions fermees',exportOptions:'Options Export',strategyAttribution:'Attribution Strategie',analyticsSide:'Long vs Short',analyticsCost:'Analyse des Couts',grossProfit:'Profit Brut',netProfit:'Profit Net',feesImpact:'Impact des Frais',feesRatio:'Ratio de Frais',feesExcellent:'Excellent - Frais < 5% des profits',feesModerate:'Modere - Reduire la frequence',feesHigh:'Eleve - Les frais impactent les profits',longBias:'Biais Long detecte',shortBias:'Biais Short detecte',balancedPerf:'Performance equilibree',durationVsPnl:'Duree vs PnL',durationHours:'Duree (heures)',shortTrades:'Trades courts',mediumTrades:'Trades moyens',longTrades:'Trades longs',nextMilestone:'Prochain Objectif',scatterWins:'Gains',scatterLosses:'Pertes',quickWins:'Gains rapides',longWins:'Gains longs',apiWeight:'Poids API',rateLimitsOk:'Rate limits OK',rateLimitsModerate:'Usage modere',rateLimitsHigh:'Eleve - Reduire appels',systemEvents:'Evenements Systeme',noEventsYet:'Aucun evenement',wsConnected:'Websocket Connecte',systemStarted:'Systeme Demarre',regimeTo:'Regime ‚Üí',avgMs:'moy',used:'utilise',flatten:'Flatten',deposit:'Depot',withdrawal:'Retrait',tradingPnl:'PNL TRADING',netCashFlow:'Flux Net',totalDeposits:'Total Depots',totalWithdrawals:'Total Retraits',capitalEvents:'Mouvements Capital',autoDetected:'Auto-detecte',fiscalTitle:'Fiscalite & Conformite (DGFIP)',fiscalSubtitle:'Export certifie pour administration fiscale francaise',fiscalPeriod:'Periode Fiscale',fiscalYear:'Annee Fiscale N-1',fiscalYtd:'Depuis Debut Annee',fiscalLastMonth:'Mois Dernier',fiscalCustom:'Periode Personnalisee',fiscalAggregate:'Agreger Funding Journalier',fiscalAggregateDesc:'Reduit le volume de 95% en sommant les micro-paiements horaires par jour',fiscalGenerate:'GENERER EXPORT CERTIFIE (.CSV)',fiscalFetching:'Recuperation des donnees...',fiscalConverting:'Conversion EUR (Oracle)...',fiscalSigning:'Signature SHA-256...',fiscalDone:'Export pret!',fiscalHistory:'Historique & Preuve',fiscalDate:'Date Generation',fiscalPeriodCol:'P√©riode',fiscalHash:'Hash Securite (SHA-256)',fiscalAction:'Action',fiscalDownload:'T√©l√©charger',fiscalNoHistory:'Aucun export certifie',fiscalDisclaimer:'CERTIFICATION: Ce document est genere algorithmiquement base sur la blockchain et les donnees exchange. La signature SHA-256 garantit qu il n a pas ete altere apres generation. Trinity ne remplace pas un expert-comptable agree.',fiscalExpertMode:'Mode Expert',fiscalWalletId:'ID Wallet',monitor:'Moniteur',monitorTitle:'Trinity Monitor',monitorCycle:'Cycle',monitorUptime:'Uptime',monitorCpu:'CPU',monitorRam:'RAM',monitorDisk:'Disque',monitorLatency:'Latence API',monitorErrorsH:'Erreurs/h',monitorPositions:'Positions',monitorHeartbeatOk:'Heartbeat OK',monitorBotFrozen:'Bot Fig√©',monitorPosSync:'Positions Sync',monitorDriftAlert:'DRIFT !',monitorSlTpOk:'SL/TP OK',monitorOrdersIncomplete:'Ordres Incomplets',monitorBalanceOk:'Balance OK',monitorBalanceDrift:'Ecart Balance',monitorPosDrift:'Drift Positions',monitorBotApi:'API Bot',monitorExchange:'Exchange',monitorPosSync2:'Positions parfaitement synchronis√©es',monitorLoading:'Chargement...',monitorRecentAlerts:'Alertes R√©centes',monitorNoAlerts:'Aucune alerte',monitorBalanceRecon:'R√©conciliation Balance',monitorDeviation:'Ecart',monitorErrorConsole:'Console Erreurs',monitorNoErrors:'> Aucune erreur r√©cente. Syst√®me nominal.',monitorKillSwitch:'Arr√™t d\'Urgence',monitorKillDesc:'Tapez STOP puis confirmez pour arr√™ter le bot',monitorEmergencyStop:'Arr√™t d\'urgence',monitorConfirm:'CONFIRMER',monitorCancel:'Annuler',monitorRestartBot:'Red√©marrer Bot',monitorRestartDesc:'Red√©marre le conteneur Docker du bot',monitorRestartBtn:'Red√©marrer le bot',monitorHip3Title:'Moniteur HIP-3 Stocks',monitorHip3Heartbeat:'HIP-3 Actif',monitorHip3Dead:'HIP-3 Mort',monitorHip3PosSync:'HIP-3 Sync',monitorHip3Drift:'HIP-3 DRIFT !',monitorHip3OrdersOk:'HIP-3 SL/TP OK',monitorHip3OrdersBad:'HIP-3 Ordres KO',monitorHip3PosDrift:'Drift Positions HIP-3',monitorHip3BalanceRecon:'Reconciliation Balance HIP-3',monitorHip3KillSwitch:'Arret Urgence HIP-3',monitorHip3KillDesc:'Tapez STOP puis confirmez pour arreter le bot HIP-3',monitorHip3Restart:'Redemarrer Bot HIP-3',monitorHip3RestartDesc:'Redemarre le conteneur Docker du bot HIP-3',monitorHip3RestartBtn:'Redemarrer le bot HIP-3',downloadCsv:'T√©l√©charger CSV',downloadJson:'T√©l√©charger JSON',generateReport:'G√©n√©rer Rapport',downloadBackup:'T√©l√©charger Sauvegarde',exportCsvDesc:'Exporter tous les trades en format CSV',exportJsonDesc:'Exporter les trades en format JSON',exportPdfDesc:'G√©n√©rer un rapport de performance imprimable',structuredData:'Donn√©es structur√©es',htmlReport:'Rapport HTML',allSettings:'Tous les param√®tres',viewChart:'Voir graphique',hideChart:'Masquer',chartBtn:'Graphique',tradeHistory:'HISTORIQUE DES TRADES',newPosOpened:'Nouvelle position ouverte !',tradeClosed:'Trade ferm√©',posOpenedEmoji:'Nouvelle position ouverte !',hide:'Masquer',show:'Afficher',onchain:'On-Chain',onchainTitle:'Regime On-Chain',onchainCompositeScore:'Score Composite',onchainCurrentRegime:'Regime Actuel',onchainMetrics:'Metriques Individuelles',onchainEffects:'Effets Actifs sur le Trading',onchainRiskMult:'Multiplicateur Risque',onchainTpMult:'Multiplicateur TP',onchainScoreBonus:'Bonus Score',onchainLastUpdate:'Derniere MAJ',onchainDisabled:'Module On-Chain desactive',onchainNoData:'Aucune donnee on-chain disponible',onchainInd1:'Indice Composite',onchainInd2:'Indice Sentiment',onchainInd3:'M√©trique Valorisation',onchainInd4:'Ratio Profit',onchainInd5:'P&L Non-r√©alis√©',onchainInd6:'Multiple Revenu',onchainInd7:'M√©trique Risque',onchainInd8b:'Indicateur Flux',onchainInd9:'M√©trique Court-terme',onchainInd10:'Zone d\'Accumulation',onchainInd10Dist:'Zone de Distribution',onchainNeutralDesc:'Strategie normale',altseason:'Indice Altseason',altseasonTitle:'Trinity Altseason Index (TAI)',altseasonScore:'Score TAI',altseasonPhase:'Phase Actuelle',altseasonSignal:'Signal',altseasonConfidence:'Confiance',altseasonUrgency:'Urgence',altseasonIndicators:'Detail des Sous-Indicateurs',altseasonExitWarnings:'Alertes de Sortie',altseasonLastUpdate:'Derniere MAJ',altseasonLoading:'Chargement des donnees altseason...',altseasonNoData:'Aucune donnee altseason disponible',altseasonWeight:'Poids',altseasonRawValue:'Valeur Brute',altseasonSubScore:'Sous-Score',altseasonPhases:'Timeline des Phases',altseasonBtcD:'Metric A',altseasonEthBtc:'Ratio D',altseasonTop50:'Top 50 vs BTC',altseasonCombinedD:'Dominance Combinee',altseasonTotal2:'Tendance TOTAL2',altseasonStableShare:'Part Stablecoins',altseasonAltVol:'Volume Alts',altseasonMetricA:'Indice Sentiment',altseasonSpx:'Proximite S&P 500',altseasonVix:'Niveau VIX',altseasonDxy:'Indice Dollar',altseasonNetLiq:'Liquidite Nette',altseasonBtcDSlope:'Metric B',altseasonPhase1:'Deep Bear',altseasonPhase2:'Saison Bitcoin',altseasonPhase3:'Pre-Transition',altseasonPhase4:'Altseason Precoce',altseasonPhase5:'Altseason Complete',altseasonPhase6:'Euphorie',altseasonHistory:'Historique Score (24h)',onchainSubtitle:'Metriques BTC on-chain comme overlay macro pour toutes les positions crypto',onchainActive:'ACTIF',onchainBuy:'ACHAT',onchainSell:'VENTE',onchainScoreRange:'Plage : -30 a +30',onchainFearLabel:'Peur',onchainGreedLabel:'Cupidite',onchainSizeBoosted:'Taille augmentee',onchainSizeReduced:'Taille reduite',onchainTargetsExtended:'Cibles etendues',onchainTargetsTightened:'Cibles resserrees',onchainLongsFavored:'Longs favorises',onchainLongsPenalized:'Longs penalises',onchainShortsFavored:'Shorts favorises',onchainShortsPenalized:'Shorts penalises',onchainScoreFear:'PEUR',onchainScoreCautious:'Prudent',onchainScoreNeutral:'Neutre',onchainScoreWarm:'Tiede',onchainScoreGreed:'CUPIDITE',onchainInd1Title:'Score Composite On-Chain',onchainInd1Desc:'Indice composite multi-facteurs. Bas = zone accumulation, Haut = zone distribution.',onchainBuyZone:'0 - Zone Achat',onchainNeutralZone:'50 - Neutre',onchainSellZone:'100 - Zone Vente',onchainInd8:'Indicateur Cycle',onchainInd8History:'Detection historique de cycle: Haute precision',onchainBtcPrice:'Prix BTC',onchainGap:'Ecart',onchainInd8Crossed:'0% ‚Äî CROISEMENT (Signal Sommet)',onchainInd8WarningZone:'5% ‚Äî Attention',onchainInd8Safe:'30%+ ‚Äî Sur',onchainInd8AlertCrossed:'SIGNAL SOMMET DE CYCLE ‚Äî Signal A a croise Signal B ‚Äî Indicateur historique de sommet de cycle !',onchainInd8AlertDanger:'Indicateur cycle approche du croisement ‚Äî Reduire l\'exposition long',onchainInd8AlertWarning:'Indicateur cycle dans la zone d\'alerte ‚Äî Surveillez attentivement',onchainEnableHint:'Activer avec ONCHAIN_ENABLED=true dans .env (en attente de validation backtest)',onchainDescInd1:'Score composite multi-facteurs',onchainDescInd2:'Jauge de sentiment du marche',onchainDescInd3:'Ratio de valorisation marche',onchainDescInd4:'Suivi de profit on-chain',onchainDescInd5:'Gains non realises agreges',onchainDescInd6:'Indicateur de revenu reseau',onchainDescInd7:'Confiance ajustee au risque',onchainDescInd8b:'Direction des flux de capitaux',onchainDescInd9:'Ratio valorisation court terme',altseasonPlaybookTitle:'Quoi Faire Maintenant',altseasonBtcTrendFilter:'Filtre Tendance BTC (Multiplicateur)',altseasonBullBearScore:'Score Bull/Bear',altseasonMarketData:'Donnees Marche',altseasonWeightsOpt:'Poids optimises',altseasonCoinScanner:'Scanner de Coins',altseasonBuySignals:'Signaux ACHAT',altseasonSellSignals:'Signaux VENTE',altseasonUrgencyLabel:'Urgence',altseasonBreakouts:'Breakouts Individuels (decorreles du marche)',altseasonTrending:'Trending sur CoinGecko',altseasonSectors:'Secteurs',altseasonBearLabel:'BEAR',altseasonAltLabel:'ALT',altseasonAthRecovery:'Recuperation ATH',altseasonNextTarget:'Prochain',altseasonPriceDiscovery:'DECOUVERTE DE PRIX',altseasonFooter:'Trinity Market Index v1.0 | Analyse multi-facteurs | CoinGecko + Donnees marche',altseasonDescTop50:'% battant BTC 90j',altseasonDescTotal2:'Cap. marche hors BTC',altseasonDescRs2k:'Ratio petites cap.',altseasonDescNetLiq:'Indicateur macro 3m',altseasonDescBtcDSlope:'Pente 30j proxy',funding:'Funding',fundingTitle:'Funding Harvester',fundingLoading:'Chargement des donnees funding...',fundingOffline:'Funding Harvester Hors Ligne',fundingServiceDown:'Service indisponible sur',fundingStatus:'Statut',fundingEarnings:'Revenus',fundingPosition:'Position',fundingRunning:'En cours',fundingYes:'OUI',fundingNo:'NON',fundingAvailCapital:'Capital Disponible',fundingTotalFunding:'Funding Total',fundingTotalFees:'Frais Totaux',fundingNetProfit:'Profit Net',fundingProjectedDay:'Projection /jour',fundingProjectedMonth:'Projection /mois',fundingAsset:'Actif',fundingSpot:'Spot',fundingPerp:'Perp',fundingNotional:'Notionnel',fundingEarned:'Funding Gagne',fundingDuration:'Duree',fundingNegHours:'Heures Neg.',fundingNoPosition:'Aucune position active',fundingWaiting:'En attente de funding rate positif',fundingLiveRates:'Taux de Funding Live (Horaire)',fundingRateH:'Taux/h',fundingDirection:'Direction',fundingShortsRcv:'Shorts recoivent',fundingLongsRcv:'Longs recoivent',fundingToMarketOpen:'avant ouverture',fundingMarketHours:'HEURES MARCHE',fundingOffHours:'HORS-MARCHE'}
};



function App() {
  // Theme state
  var themeState = useState(function(){ try { var saved = localStorage.getItem('trinity_theme'); if(saved) return saved; return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'; } catch(e) { return 'dark'; } });
  var theme = themeState[0], setTheme = themeState[1];
  
  var langState = useState('en');
  var lang = langState[0], setLang = langState[1];
  var tabState = useState('overview');
  var tab = tabState[0], setTab = tabState[1];
  var loadingState = useState(true);
  var loading = loadingState[0], setLoading = loadingState[1];
  var connectedState = useState(false);
  var connected = connectedState[0], setConnected = connectedState[1];
  var errorState = useState(null);
  var connError = errorState[0], setConnError = errorState[1];
  var lastUpdateState = useState(null);
  var lastUpdate = lastUpdateState[0], setLastUpdate = lastUpdateState[1];
  var hideState = useState(false);
  var hide = hideState[0], setHide = hideState[1];
  
  var botState = useState({running:false,mode:'LIVE',regime:'RANGE'});
  var bot = botState[0], setBot = botState[1];
  
  var statsState = useState({
    balance:0,initialBalance:0,totalPnl:0,totalPnlPercent:0,winRate:0,totalTrades:0,wins:0,losses:0,
    profitFactor:0,maxDrawdown:0,currentDrawdown:0,totalR:0,avgR:0,rPerWeek:0,todayR:0,weekR:0,monthR:0,
    currentStreak:0,bestStreak:0,expectancy:0,sharpeRatio:0,recoveryFactor:0
  });
  var stats = statsState[0], setStats = statsState[1];
  
  // üÜï V10.7: Accurate stats from exchange fills
  var accurateStatsState = useState(null);
  var accurateStats = accurateStatsState[0], setAccurateStats = accurateStatsState[1];
  
  // üÜï V10.10: Capital events (deposits/withdrawals) for cash flow isolation
  var capitalEventsState = useState({
    total_deposits: 0,
    total_withdrawals: 0,
    net_cash_flow: 0,
    events: [],
    trading_pnl: null,
    trading_roi: null,
    initial_balance: null  // üÜï V10.10.2
  });
  var capitalEvents = capitalEventsState[0], setCapitalEvents = capitalEventsState[1];
  
  var tradesState = useState([]);
  var trades = tradesState[0], setTrades = tradesState[1];
  var openPosState = useState([]);
  var openPos = openPosState[0], setOpenPos = openPosState[1];
  var logsState = useState([]);
  var logs = logsState[0], setLogs = logsState[1];
  var walletState = useState('');
  var wallet = walletState[0], setWallet = walletState[1];
  
  // V2.0 Analytics: comparison, sessions, equity-symbols
  var comparisonState = useState(null);
  var comparisonData = comparisonState[0], setComparisonData = comparisonState[1];
  var sessionsState = useState(null);
  var sessionsData = sessionsState[0], setSessionsData = sessionsState[1];
  var equitySymState = useState(null);
  var equitySymData = equitySymState[0], setEquitySymData = equitySymState[1];

  var balFilterState = useState('all');
  var balFilter = balFilterState[0], setBalFilter = balFilterState[1];

  var balScaleState = useState('linear');
  var balScale = balScaleState[0], setBalScale = balScaleState[1];
  var roiTypeState = useState('balance'); // üÜï V10.11: 'balance' or 'pnl'
  var roiType = roiTypeState[0], setRoiType = roiTypeState[1];
  var balHoverState = useState(-1); // hover index for crosshair (-1 = none)
  var balHover = balHoverState[0], setBalHover = balHoverState[1];
  var cumRFilterState = useState('week');
  var cumRFilter = cumRFilterState[0], setCumRFilter = cumRFilterState[1];
  
  // Trades tab states
  var tradeFilterState = useState('all');
  var tradeFilter = tradeFilterState[0], setTradeFilter = tradeFilterState[1];
  var tradeSymbolState = useState('all');
  var tradeSymbol = tradeSymbolState[0], setTradeSymbol = tradeSymbolState[1];
  var tradeRegimeState = useState('all');
  var tradeRegime = tradeRegimeState[0], setTradeRegime = tradeRegimeState[1];
  var tradePeriodState = useState('all');
  var tradePeriod = tradePeriodState[0], setTradePeriod = tradePeriodState[1];
  var tradeSortState = useState('dateDesc');
  var tradeSort = tradeSortState[0], setTradeSort = tradeSortState[1];
  var tradeSearchState = useState('');
  var tradeSearch = tradeSearchState[0], setTradeSearch = tradeSearchState[1];
  var tradePageState = useState(1);
  var tradePage = tradePageState[0], setTradePage = tradePageState[1];
  var tradeDetailState = useState(null);
  var tradeDetail = tradeDetailState[0], setTradeDetail = tradeDetailState[1];
  // V5.0.2 FIX: expandedTrades state moved to App level (hooks cannot be conditional)
  var expandedTradesState = useState({});
  var expandedTrades = expandedTradesState[0], setExpandedTrades = expandedTradesState[1];
  
  // üÜï V10.11: Inline chart states for Open Position cards
  var expandedChartsState = useState({});
  var expandedCharts = expandedChartsState[0], setExpandedCharts = expandedChartsState[1];
  var inlineChartDataState = useState({});
  var inlineChartData = inlineChartDataState[0], setInlineChartData = inlineChartDataState[1];
  var inlineChartLoadingState = useState({});
  var inlineChartLoading = inlineChartLoadingState[0], setInlineChartLoading = inlineChartLoadingState[1];
  
  // Analytics tab state
  var analyticsFilterState = useState('live');
  var analyticsFilter = analyticsFilterState[0], setAnalyticsFilter = analyticsFilterState[1];
  
  // Crypto prices state (BTC, ETH, SOL)
  var pricesState = useState({ BTC: 0, ETH: 0, SOL: 0, LINK: 0, SEI: 0, DOGE: 0, SUI: 0, btcChange: 0, ethChange: 0, solChange: 0, linkChange: 0, seiChange: 0, dogeChange: 0, suiChange: 0 });
  var prices = pricesState[0], setPrices = pricesState[1];
  // üÜï V2.0: HIP-3 Stock prices state
  var stockPricesState = useState({});
  var stockPrices = stockPricesState[0], setStockPrices = stockPricesState[1];
  
  var emergencyState = useState(false);
  var showEmergency = emergencyState[0], setShowEmergency = emergencyState[1];
  // V2.0 Phase 3: Logs Panel + Panic Button states
  var logsPanelState = useState(false);
  var showLogsPanel = logsPanelState[0], setShowLogsPanel = logsPanelState[1];
  var logsPanelSourceState = useState('all');
  var logsPanelSource = logsPanelSourceState[0], setLogsPanelSource = logsPanelSourceState[1];
  var panicModalState = useState(false);
  var showPanicModal = panicModalState[0], setShowPanicModal = panicModalState[1];
  var panicSliderState = useState(0);
  var panicSliderVal = panicSliderState[0], setPanicSliderVal = panicSliderState[1];
  var panicFiringState = useState(false);
  var panicFiring = panicFiringState[0], setPanicFiring = panicFiringState[1];
  var chartFullscreenState = useState(null);
  var chartFullscreen = chartFullscreenState[0], setChartFullscreen = chartFullscreenState[1];
  var notifsState = useState([]);
  var notifs = notifsState[0], setNotifs = notifsState[1];
  
  // Modal states
  var showSettingsState = useState(false);
  var showSettings = showSettingsState[0], setShowSettings = showSettingsState[1];
  var showThemePickerState = useState(false);
  var showThemePicker = showThemePickerState[0], setShowThemePicker = showThemePickerState[1];
  var showTwitterState = useState(false);
  var showTwitter = showTwitterState[0], setShowTwitter = showTwitterState[1];
  
  // üÜï V10.0: Chart Modal for Trade Detail with TradingView
  var showChartModalState = useState(false);
  var showChartModal = showChartModalState[0], setShowChartModal = showChartModalState[1];
  var chartTradeState = useState(null);
  var chartTrade = chartTradeState[0], setChartTrade = chartTradeState[1];
  var chartCandlesState = useState([]);
  var chartCandles = chartCandlesState[0], setChartCandles = chartCandlesState[1];
  var chartLoadingState = useState(false);
  var chartLoading = chartLoadingState[0], setChartLoading = chartLoadingState[1];

  // V2.3 Chart Enhancement states
  var chartTimeframeState = useState('15m');
  var chartTimeframe = chartTimeframeState[0], setChartTimeframe = chartTimeframeState[1];
  var chartShowEMAState = useState(true);
  var chartShowEMA = chartShowEMAState[0], setChartShowEMA = chartShowEMAState[1];
  var chartShowVolumeState = useState(true);
  var chartShowVolume = chartShowVolumeState[0], setChartShowVolume = chartShowVolumeState[1];

  // V2.3 Services Health states
  var servicesHealthState = useState({crypto:{},hip3:{}});
  var servicesHealth = servicesHealthState[0], setServicesHealth = servicesHealthState[1];
  var lastScanState = useState({crypto:null,hip3:null});
  var lastScan = lastScanState[0], setLastScan = lastScanState[1];

  // V2.3 Mobile UX states
  var pullRefreshState = useState({active:false,y:0});
  var pullRefresh = pullRefreshState[0], setPullRefresh = pullRefreshState[1];

  // Settings state (persisted to API)
  var settingsState = useState(function(){
    try {
      var saved = null; // Server has priority
      if (saved) return JSON.parse(saved);
    } catch(e) {}
    return {
      dailyRGoal: 3,
      weeklyRGoal: 15,
      ddAlertThreshold: 5,
      soundEffects: true,
      discordWebhook: '',
      refreshInterval: 5
    };
  });
  var settings = settingsState[0], setSettings = settingsState[1];
  
  // Twitter config state
  var twitterState = useState({
    autoPosting: true,
    postOnOpen: true,
    postOnClose: true,
    postAchievements: true,
    postMilestones: true,
    hideAmounts: true,
    hashtags: '#TrinityBot #Crypto #Trading'
  });
  var twitterConfig = twitterState[0], setTwitterConfig = twitterState[1];
  useEffect(function(){
    fetchApi("/api/twitter/config").then(function(d){
      if(d&&d.config&&Object.keys(d.config).length>0){
        setTwitterConfig(function(prev){return Object.assign({},prev,d.config);});
      }
    }).catch(function(e){console.warn('Twitter config load failed:',e);});
    // Also persist to localStorage as fallback
    var saved=localStorage.getItem('trinity_twitter_config');
    if(saved){try{setTwitterConfig(function(prev){return Object.assign({},prev,JSON.parse(saved));});}catch(e){}}
  },[]);
  
  // Monitor states
  var monitorStatusState = useState({ system_status: 'UNKNOWN', running: false, cycle_count: 0, last_metrics: {} });
  var monitorStatus = monitorStatusState[0], setMonitorStatus = monitorStatusState[1];
  var monitorAlertsState = useState([]);
  var monitorAlerts = monitorAlertsState[0], setMonitorAlerts = monitorAlertsState[1];
  var monitorDriftState = useState(null);
  var monitorDrift = monitorDriftState[0], setMonitorDrift = monitorDriftState[1];
  var monitorErrorsState = useState([]);
  var monitorErrors = monitorErrorsState[0], setMonitorErrors = monitorErrorsState[1];
  var killConfirmState = useState('');
  var killConfirm = killConfirmState[0], setKillConfirm = killConfirmState[1];
  var showKillState = useState(false);
  var showKill = showKillState[0], setShowKill = showKillState[1];
  var monitorHip3DriftState = useState(null);
  var monitorHip3Drift = monitorHip3DriftState[0], setMonitorHip3Drift = monitorHip3DriftState[1];
  var hip3KillConfirmState = useState('');
  var hip3KillConfirm = hip3KillConfirmState[0], setHip3KillConfirm = hip3KillConfirmState[1];
  var showHip3KillState = useState(false);
  var showHip3Kill = showHip3KillState[0], setShowHip3Kill = showHip3KillState[1];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï V2.0 COMMAND CENTER: Market selector + HIP-3 dual engine states
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var marketState = useState('crypto'); // 'crypto' | 'hip3' | 'unified'
  var market = marketState[0], setMarket = marketState[1];

  // HIP-3 Bot Data (mirrors crypto states)
  var hip3ConnectedState = useState(false);
  var hip3Connected = hip3ConnectedState[0], setHip3Connected = hip3ConnectedState[1];
  var hip3BotState = useState({running:false,mode:'LIVE',regime:'RANGE',market_open:false});
  var hip3Bot = hip3BotState[0], setHip3Bot = hip3BotState[1];
  var hip3StatsState = useState({
    balance:0,initialBalance:0,totalPnl:0,totalPnlPercent:0,winRate:0,totalTrades:0,wins:0,losses:0,
    profitFactor:0,maxDrawdown:0,currentDrawdown:0,totalR:0,avgR:0,rPerWeek:0,todayR:0,weekR:0,monthR:0,
    currentStreak:0,bestStreak:0,expectancy:0,asset_type:'HIP-3 Stocks',setup_breakdown:{}
  });
  var hip3Stats = hip3StatsState[0], setHip3Stats = hip3StatsState[1];
  var hip3TradesState = useState([]);
  var hip3Trades = hip3TradesState[0], setHip3Trades = hip3TradesState[1];
  var hip3OpenPosState = useState([]);
  var hip3OpenPos = hip3OpenPosState[0], setHip3OpenPos = hip3OpenPosState[1];
  var hip3LogsState = useState([]);
  var hip3Logs = hip3LogsState[0], setHip3Logs = hip3LogsState[1];
  var hip3WalletState = useState('');
  var hip3Wallet = hip3WalletState[0], setHip3Wallet = hip3WalletState[1];

  // Bot Control enhanced states
  var logFilterState = useState('ALL');
  var logFilter = logFilterState[0], setLogFilter = logFilterState[1];
  var logsPausedState = useState(false);
  var logsPaused = logsPausedState[0], setLogsPaused = logsPausedState[1];
  var actionHistoryState = useState([]);
  var actionHistory = actionHistoryState[0], setActionHistory = actionHistoryState[1];
  var botPausedState = useState(false);
  var botPaused = botPausedState[0], setBotPaused = botPausedState[1];
  var servicesState = useState({postgres:true,redis:true,hyperliquid:true,discord:true});
  var services = servicesState[0], setServices = servicesState[1];
  var cpuHistoryState = useState([]);
  var cpuHistory = cpuHistoryState[0], setCpuHistory = cpuHistoryState[1];
  var memHistoryState = useState([]);
  var memHistory = memHistoryState[0], setMemHistory = memHistoryState[1];
  var latencyHistoryState = useState([]);
  var latencyHistory = latencyHistoryState[0], setLatencyHistory = latencyHistoryState[1];
  var lastScanState = useState(null);
  var lastScan = lastScanState[0], setLastScan = lastScanState[1];
  var networkLatencyState = useState(0);
  var networkLatency = networkLatencyState[0], setNetworkLatency = networkLatencyState[1];
  var serverTimeState = useState(new Date());
  var serverTime = serverTimeState[0], setServerTime = serverTimeState[1];
  var soundEnabledState = useState(true);
  var soundEnabled = soundEnabledState[0], setSoundEnabled = soundEnabledState[1];
  var logThemeState = useState('default');
  var logTheme = logThemeState[0], setLogTheme = logThemeState[1];
  
  // Journal tab states
  var journalFilterState = useState('all'); // all, wins, losses
  var journalFilter = journalFilterState[0], setJournalFilter = journalFilterState[1];
  var journalPeriodState = useState('all'); // today, week, month, all
  var journalPeriod = journalPeriodState[0], setJournalPeriod = journalPeriodState[1];
  var journalSymbolState = useState('all');
  var journalSymbol = journalSymbolState[0], setJournalSymbol = journalSymbolState[1];
  var journalViewState = useState('cards'); // cards, timeline, stats
  var journalView = journalViewState[0], setJournalView = journalViewState[1];
  var journalNotesState = useState(function(){ try { return JSON.parse(localStorage.getItem('trinity_journal_notes')||'{}'); } catch(e) { return {}; } }); // Persistent notes
  var journalNotes = journalNotesState[0], setJournalNotes = journalNotesState[1];
  var editingNoteState = useState(null); // tradeId being edited
  var editingNote = editingNoteState[0], setEditingNote = editingNoteState[1];
  var expandedTradeState = useState(null); // expanded trade card
  var expandedTrade = expandedTradeState[0], setExpandedTrade = expandedTradeState[1];
  var journalSearchState = useState(''); // Search query
  var journalSearch = journalSearchState[0], setJournalSearch = journalSearchState[1];
  var journalTagsState = useState(function(){ try { return JSON.parse(localStorage.getItem('trinity_journal_tags')||'{}'); } catch(e) { return {}; } }); // {tradeId: ['tag1','tag2']}
  var journalTags = journalTagsState[0], setJournalTags = journalTagsState[1];
  var showSetupStatsState = useState(true); // Show/hide setup analysis
  var showSetupStats = showSetupStatsState[0], setShowSetupStats = showSetupStatsState[1];
  
  // üÜï Calendar month navigation state
  var calendarMonthState = useState(function(){ var now = new Date(); return {month: now.getMonth(), year: now.getFullYear()}; });
  var calendarMonth = calendarMonthState[0], setCalendarMonth = calendarMonthState[1];
  
  // Social tab states
  var socialTabState = useState('share'); // share, templates, history, settings
  var socialTab = socialTabState[0], setSocialTab = socialTabState[1];
  var socialPreviewState = useState(null); // Preview content
  var socialPreview = socialPreviewState[0], setSocialPreview = socialPreviewState[1];
  var socialTemplatesState = useState(function(){ try { return JSON.parse(localStorage.getItem('trinity_social_templates')||'[]'); } catch(e) { return []; } });
  var socialTemplates = socialTemplatesState[0], setSocialTemplates = socialTemplatesState[1];
  var socialHistoryState = useState(function(){ try { return JSON.parse(localStorage.getItem('trinity_social_history')||'[]'); } catch(e) { return []; } });
  var socialHistory = socialHistoryState[0], setSocialHistory = socialHistoryState[1];
  var selectedTradeForShareState = useState(null);
  var selectedTradeForShare = selectedTradeForShareState[0], setSelectedTradeForShare = selectedTradeForShareState[1];
  var telegramBotTokenState = useState(function(){ try { return localStorage.getItem('trinity_telegram_token')||''; } catch(e) { return ''; } });
  var telegramBotToken = telegramBotTokenState[0], setTelegramBotToken = telegramBotTokenState[1];
  var telegramChatIdState = useState(function(){ try { return localStorage.getItem('trinity_telegram_chatid')||''; } catch(e) { return ''; } });
  var telegramChatId = telegramChatIdState[0], setTelegramChatId = telegramChatIdState[1];
  var twitterWebhookState = useState(function(){ try { return localStorage.getItem('trinity_twitter_webhook')||''; } catch(e) { return ''; } }); // Discord webhook for IFTTT relay to Twitter
  var twitterWebhook = twitterWebhookState[0], setTwitterWebhook = twitterWebhookState[1];
  var autoPostSettingsState = useState(function(){ try { return JSON.parse(localStorage.getItem('trinity_autopost')||'{"enabled":false,"onWin":true,"onLoss":false,"minR":1,"platforms":["discord"]}'); } catch(e) { return {enabled:false,onWin:true,onLoss:false,minR:1,platforms:['discord']}; } });
  var autoPostSettings = autoPostSettingsState[0], setAutoPostSettings = autoPostSettingsState[1];
  var editingTemplateState = useState(null);  
  // Export tab states
  var exportPeriodState = useState("all");
  var exportPeriod = exportPeriodState[0], setExportPeriod = exportPeriodState[1];
  var exportStartState = useState("");
  var exportStart = exportStartState[0], setExportStart = exportStartState[1];
  var exportEndState = useState("");
  var exportEnd = exportEndState[0], setExportEnd = exportEndState[1];
  var exportLoadingState = useState(null);
  var exportLoading = exportLoadingState[0], setExportLoading = exportLoadingState[1];
  var taxYearState = useState(new Date().getFullYear());
  var taxYear = taxYearState[0], setTaxYear = taxYearState[1];
  var taxFormatState = useState("generic");
  var taxFormat = taxFormatState[0], setTaxFormat = taxFormatState[1];
  
  // üèõÔ∏è DGFIP Fiscal Export States
  var fiscalAggregateFundingState = useState(true);
  var fiscalAggregateFunding = fiscalAggregateFundingState[0], setFiscalAggregateFunding = fiscalAggregateFundingState[1];
  var fiscalExportStepState = useState(null); // null, 'fetching', 'converting', 'signing', 'done'
  var fiscalExportStep = fiscalExportStepState[0], setFiscalExportStep = fiscalExportStepState[1];
  var fiscalExportHistoryState = useState([]); // [{date, period, hash, filename}]
  var fiscalExportHistory = fiscalExportHistoryState[0], setFiscalExportHistory = fiscalExportHistoryState[1];
  var fiscalCustomStartState = useState('');
  var fiscalCustomStart = fiscalCustomStartState[0], setFiscalCustomStart = fiscalCustomStartState[1];
  var fiscalCustomEndState = useState('');
  var fiscalCustomEnd = fiscalCustomEndState[0], setFiscalCustomEnd = fiscalCustomEndState[1];
  var fiscalPeriodPresetState = useState('year'); // 'year', 'ytd', 'lastMonth', 'custom'
  var fiscalPeriodPreset = fiscalPeriodPresetState[0], setFiscalPeriodPreset = fiscalPeriodPresetState[1];
  
  var editingTemplate = editingTemplateState[0], setEditingTemplate = editingTemplateState[1];
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèÜ ACHIEVEMENTS HOOKS - ZONE 1: Declared at TOP LEVEL (React compliant)
  // These hooks MUST run on every render regardless of active tab
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var showAllAchievementsState = useState(false);
  var showAllAchievements = showAllAchievementsState[0], setShowAllAchievements = showAllAchievementsState[1];
  
  // Mobile menu state (MUST be with other useState, not after useEffect)
  var mobileMenuOpenState = useState(false);
  var mobileMenuOpen = mobileMenuOpenState[0], setMobileMenuOpen = mobileMenuOpenState[1];
  
  // Window size for responsive (MUST be with other useState)
  var windowWidthState = useState(typeof window !== 'undefined' ? window.innerWidth : 1024);
  var windowWidth = windowWidthState[0], setWindowWidth = windowWidthState[1];
  
  var syncStatusState = useState("idle"); // idle, saving, saved, error
  var syncStatus = syncStatusState[0], setSyncStatus = syncStatusState[1];
  
  // ALL useRef declarations AFTER all useState
  var wsRef = useRef(null);
  var wsRetries = useRef(0);
  var settingsSaveTimeoutRef = useRef(null);
  var audioContextRef = useRef(null);
  var lastTradeCountRef = useRef({open: 0, closed: 0});
  var settingsLoadedRef = useRef(false);
  var fsChartRef = useRef(null);

  var t = T[lang];
  var C = THEMES[theme] || THEMES['dark'];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèÜ ACHIEVEMENTS DATA - ZONE 2: useMemo at TOP LEVEL (computed once per render)
  // This runs on EVERY render but calculation is memoized
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var achievementsData = useMemo(function() {
    // V2.5: Market-aware achievements ‚Äî use crypto or HIP-3 trades
    var allTrades = market === 'hip3' ? hip3Trades : market === 'unified' ? trades.filter(function(tr){return tr.exitTime;}).concat(hip3Trades) : trades;
    var closed = allTrades.filter(function(tr) { return tr.exitTime || tr.status === 'win' || tr.status === 'loss' || tr.status === 'breakeven'; });
    // Strategy fresh start: only count trades closed after deployment
    var LIVE_START = new Date('2026-01-01T00:00:00Z');
    var liveTrades = closed.filter(function(tr) {
      if (!tr.isLive) return false;
      var exitDate = tr.exitTime ? new Date(tr.exitTime) : null;
      return exitDate && exitDate >= LIVE_START;
    });
    var liveWins = liveTrades.filter(function(tr) { return tr.r > 0; });
    var liveTotalR = liveTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
    var liveWR = liveTrades.length > 0 ? (liveWins.length / liveTrades.length * 100) : 0;
    var livePF = (function(){ var gp = liveWins.reduce(function(s,tr){return s+(tr.r||0);},0); var gl = Math.abs(liveTrades.filter(function(tr){return tr.r<0;}).reduce(function(s,tr){return s+(tr.r||0);},0)); return gl > 0 ? gp/gl : gp > 0 ? 999 : 0; })();
    
    var bestStreak = 0, cs = 0;
    liveTrades.forEach(function(tr) {
      if (tr.r > 0) { cs++; bestStreak = Math.max(bestStreak, cs); }
      else cs = 0;
    });
    
    var dailyR = {}, weeklyR = {}, monthlyR = {};
    liveTrades.forEach(function(tr) {
      var day = (tr.exitTime || tr.entryTime || '').split('T')[0];
      if (day) { if (!dailyR[day]) dailyR[day] = 0; dailyR[day] += tr.r || 0; }
      try {
        var d = new Date(tr.exitTime || tr.entryTime);
        var week = d.getFullYear() + '-W' + Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7);
        if (!weeklyR[week]) weeklyR[week] = 0; weeklyR[week] += tr.r || 0;
        var month = d.getFullYear() + '-' + (d.getMonth() + 1);
        if (!monthlyR[month]) monthlyR[month] = 0; monthlyR[month] += tr.r || 0;
      } catch(e) {}
    });
    var bestDayR = Math.max.apply(null, Object.values(dailyR).concat([0]));
    var bestWeekR = Math.max.apply(null, Object.values(weeklyR).concat([0]));
    var bestMonthR = Math.max.apply(null, Object.values(monthlyR).concat([0]));
    
    var symbolWins = {};
    var achSymbols = market === 'hip3' ? ['AAPL','TSLA','NVDA','AMD','AMZN','META','GOOGL','MSFT','MSTR','PLTR','COIN','HOOD'] : ['BTC','ETH','SOL','LINK','SEI','DOGE','SUI'];
    achSymbols.forEach(function(s){
      symbolWins[s] = liveTrades.filter(function(tr){return (tr.symbol||'').indexOf(s)!==-1 && tr.r>0;}).length;
    });
    
    var hasComeback = (function(){ var s = 0, hadLoss3 = false; for(var i=0;i<liveTrades.length;i++){ if(liveTrades[i].r<0){s--;if(s<=-3)hadLoss3=true;}else{if(hadLoss3&&s<0)return true;s=0;}} return false; })();
    var hasNightOwl = liveTrades.some(function(tr){try{return tr.r>0 && new Date(tr.entryTime).getHours()>=22;}catch(e){return false;}});
    var hasEarlyBird = liveTrades.some(function(tr){try{return tr.r>0 && new Date(tr.entryTime).getHours()<8;}catch(e){return false;}});
    var hasWeekendWarrior = liveTrades.some(function(tr){try{var d=new Date(tr.entryTime).getDay();return tr.r>0 && (d===0||d===6);}catch(e){return false;}});
    var hasPerfectScore = liveTrades.some(function(tr){return tr.score>=95;});
    
    var getRarity = function(tier) { if (tier <= 2) return 'common'; if (tier <= 4) return 'rare'; if (tier <= 6) return 'epic'; if (tier <= 8) return 'legendary'; return 'mythic'; };
    var getPoints = function(tier, base) { return Math.round(base * Math.pow(1.4, tier)); };
    
    var achievements = [];
    
    // VOLUME
    var volTargets = [1,5,10,25,50,75,100,150,200,300,500,750,1000,2000,5000];
    var volNames = ['First Steps','Beginner','Novice','Apprentice','Trader','Regular','Active','Dedicated','Committed','Veteran','Master','Elite','Legend','Immortal','Infinite'];
    var volIcons = ['üå±','üåø','üå≥','üéØ','üìà','üíº','üî•','‚ö°','üí™','üèÖ','üëë','üíé','üåü','üî±','‚ôæÔ∏è'];
    volTargets.forEach(function(target, i) {
      achievements.push({id:'vol_'+target,cat:'volume',icon:volIcons[i]||'üìà',name:volNames[i]||target+' Trades',desc:target+' trades LIVE',rarity:getRarity(i),points:getPoints(i,10),check:liveTrades.length>=target,progress:Math.min(100,liveTrades.length/target*100),current:liveTrades.length,target:target});
    });
    
    // R-MULTIPLE
    var rTargets = [1,5,10,20,30,50,75,100,150,200,300,500,1000,2000,5000];
    var rNames = ['First R','Rising','Climbing','Growing','Expanding','Accelerating','Compounding','Multiplying','Stacking','Banking','Rich','Wealthy','Millionaire','Billionaire','Infinite'];
    var rIcons = ['üí∞','üìà','üöÄ','üíµ','üíé','‚ö°','üî•','üí∏','üè¶','üí≥','üí∂','ü§ë','üëë','üåç','‚ôæÔ∏è'];
    rTargets.forEach(function(target, i) {
      achievements.push({id:'r_'+target,cat:'milestones',icon:rIcons[i]||'üí∞',name:rNames[i]||target+'R',desc:target+'R total LIVE',rarity:getRarity(i),points:getPoints(i,15),check:liveTotalR>=target,progress:Math.min(100,liveTotalR/target*100),current:liveTotalR.toFixed(1),target:target});
    });
    
    // STREAKS
    var streakTargets = [2,3,4,5,6,7,8,10,12,15,20,25,30];
    var streakNames = ['Warmed Up','On Fire','Blazing','Burning','Inferno','Unstoppable','Dominating','Crushing','Destroying','Godlike','Legendary','Mythical','Ascended'];
    var streakIcons = ['üî•','üî•','üí•','‚ö°','üåã','üí´','‚≠ê','üåü','üéÜ','üëë','üèÜ','üî±','üåà'];
    streakTargets.forEach(function(target, i) {
      achievements.push({id:'streak_'+target,cat:'streaks',icon:streakIcons[i]||'üî•',name:streakNames[i]||target+' Streak',desc:target+' consecutive wins',rarity:getRarity(i),points:getPoints(i,20),check:bestStreak>=target,progress:Math.min(100,bestStreak/target*100),current:bestStreak,target:target});
    });
    
    // SYMBOL MASTERY ‚Äî V2.5: market-aware
    var symbolInfo = market === 'hip3' ? {AAPL:{name:'Apple',icon:'üçé'},TSLA:{name:'Tesla',icon:'üöó'},NVDA:{name:'Nvidia',icon:'üéÆ'},AMD:{name:'AMD',icon:'üíª'},AMZN:{name:'Amazon',icon:'üì¶'},META:{name:'Meta',icon:'üëì'},GOOGL:{name:'Google',icon:'üîç'},MSFT:{name:'Microsoft',icon:'ü™ü'},MSTR:{name:'MicroStr.',icon:'üìä'},PLTR:{name:'Palantir',icon:'üëÅÔ∏è'},COIN:{name:'Coinbase',icon:'ü™ô'},HOOD:{name:'Robinhood',icon:'üèπ'}} : {BTC:{name:'Bitcoin',icon:'‚Çø'},ETH:{name:'Ethereum',icon:'‚óÜ'},SOL:{name:'Solana',icon:'‚óé'},LINK:{name:'Chainlink',icon:'‚¨°'},SEI:{name:'Sei',icon:'üåä'},DOGE:{name:'Dogecoin',icon:'üêï'},SUI:{name:'Sui',icon:'üíß'}};
    var symTitles = ['Fan','Believer','Expert','Master','Baron','King','Emperor'];
    var symTargets = [1,3,5,10,25,50,100];
    Object.keys(symbolInfo).forEach(function(sym) {
      var info = symbolInfo[sym];
      var wins = symbolWins[sym] || 0;
      symTargets.forEach(function(target, i) {
        achievements.push({id:'sym_'+sym+'_'+target,cat:'symbol',icon:info.icon,name:info.name+' '+symTitles[i],desc:target+' wins '+sym,rarity:getRarity(i),points:getPoints(i,12),check:wins>=target,progress:Math.min(100,wins/target*100),current:wins,target:target});
      });
    });
    
    // DAILY R
    var dailyTargets = [1,2,3,5,7,10,15,20,30];
    var dailyNames = ['Good Day','Great Day','Awesome Day','Epic Day','Legendary Day','Perfect Day','Monster Day','Insane Day','God Day'];
    dailyTargets.forEach(function(target, i) {
      achievements.push({id:'daily_'+target,cat:'time',icon:'‚òÄÔ∏è',name:dailyNames[i]||target+'R Day',desc:'+'+target+'R in one day',rarity:getRarity(i),points:getPoints(i,25),check:bestDayR>=target,progress:Math.min(100,bestDayR/target*100),current:bestDayR.toFixed(1)+'R',target:target+'R'});
    });
    
    // WEEKLY R
    var weeklyTargets = [5,10,20,30,50,75,100,150,200];
    var weeklyNames = ['Solid Week','Strong Week','Great Week','Epic Week','Legendary Week','Monster Week','Insane Week','God Week','Perfect Week'];
    weeklyTargets.forEach(function(target, i) {
      achievements.push({id:'weekly_'+target,cat:'time',icon:'üìÖ',name:weeklyNames[i]||target+'R Week',desc:'+'+target+'R in one week',rarity:getRarity(i),points:getPoints(i,30),check:bestWeekR>=target,progress:Math.min(100,bestWeekR/target*100),current:bestWeekR.toFixed(1)+'R',target:target+'R'});
    });
    
    // WIN RATE
    var wrTargets = [50,55,60,65,70,75,80,90];
    var wrNames = ['Consistent','Reliable','Solid','Strong','Expert','Master','Elite','Legendary'];
    wrTargets.forEach(function(target, i) {
      var meetsMin = liveTrades.length >= (10 + i * 3);
      achievements.push({id:'wr_'+target,cat:'performance',icon:'üéØ',name:wrNames[i]+' Accuracy',desc:target+'% WR (min '+(10+i*3)+' trades)',rarity:getRarity(i),points:getPoints(i,25),check:liveWR>=target && meetsMin,progress:Math.min(100,liveWR/target*100),current:liveWR.toFixed(0)+'%',target:target+'%'});
    });
    
    // PROFIT FACTOR
    var pfTargets = [1.5,2,2.5,3,4,5,7,10];
    var pfNames = ['Edge Found','Edge Sharpened','Edge Mastered','Profit Machine','Money Printer','Cash Cow','Golden Goose','Money Magnet'];
    pfTargets.forEach(function(target, i) {
      var meetsMin = liveTrades.length >= 10;
      achievements.push({id:'pf_'+target,cat:'performance',icon:'üí∞',name:pfNames[i],desc:'PF ‚â•'+target,rarity:getRarity(i),points:getPoints(i,30),check:livePF>=target && meetsMin,progress:Math.min(100,livePF/target*100),current:livePF>=100?'‚àû':livePF.toFixed(2),target:target.toString()});
    });
    
    // SPECIAL
    var specials = [
      {id:'comeback',icon:'ü¶Ö',name:'Comeback Kid',desc:'Win after 3 losses',rarity:'legendary',points:100,check:hasComeback},
      {id:'nightowl',icon:'ü¶â',name:'Night Owl',desc:'Win after 22h',rarity:'rare',points:30,check:hasNightOwl},
      {id:'earlybird',icon:'üê¶',name:'Early Bird',desc:'Win before 8h',rarity:'rare',points:30,check:hasEarlyBird},
      {id:'weekend',icon:'üóìÔ∏è',name:'Weekend Warrior',desc:'Win on weekend',rarity:'rare',points:30,check:hasWeekendWarrior},
      {id:'perfect22',icon:'üî±',name:'Trinity Perfect',desc:'Score 14+/16',rarity:'mythic',points:200,check:hasPerfectScore},
      {id:'tripler',icon:'üé∞',name:'Triple R',desc:'+3R single trade',rarity:'legendary',points:100,check:liveTrades.some(function(tr){return tr.r>=3;})},
      {id:'quadr',icon:'üíé',name:'Quad R',desc:'+4R single trade',rarity:'legendary',points:150,check:liveTrades.some(function(tr){return tr.r>=4;})},
      {id:'fiver',icon:'üëë',name:'High Five',desc:'+5R single trade',rarity:'mythic',points:250,check:liveTrades.some(function(tr){return tr.r>=5;})},
      {id:'nodraw',icon:'üõ°Ô∏è',name:'Risk Master',desc:'DD <5% (20+ trades)',rarity:'epic',points:100,check:(market==='hip3'?hip3Stats.maxDrawdown:stats.maxDrawdown)<5 && liveTrades.length>=20},
      {id:'diversified',icon:'üé®',name:'Diversified',desc:'Win on 5+ symbols',rarity:'epic',points:80,check:Object.values(symbolWins).filter(function(w){return w>0;}).length>=5}
    ];
    specials.forEach(function(s) {
      achievements.push({id:'spec_'+s.id,cat:'special',icon:s.icon,name:s.name,desc:s.desc,rarity:s.rarity,points:s.points,check:s.check,progress:s.check?100:0,current:s.check?'‚úì':'‚úó',target:'‚úì'});
    });
    
    var unlocked = achievements.filter(function(a){return a.check;});
    var locked = achievements.filter(function(a){return !a.check;});
    locked.sort(function(a,b){return b.progress-a.progress;});
    var totalPts = unlocked.reduce(function(s,a){return s+a.points;},0);
    
    var traderLevels = [
      {min:0,name:'Rookie',icon:'üå±',color:'#9ca3af'},
      {min:100,name:'Apprentice',icon:'üåø',color:'#22c55e'},
      {min:300,name:'Trader',icon:'üìà',color:'#22c55e'},
      {min:600,name:'Pro Trader',icon:'üíº',color:'#3b82f6'},
      {min:1000,name:'Expert',icon:'üéØ',color:'#3b82f6'},
      {min:1500,name:'Master',icon:'‚≠ê',color:'#a855f7'},
      {min:2500,name:'Elite',icon:'üíé',color:'#a855f7'},
      {min:4000,name:'Champion',icon:'üèÖ',color:'#f97316'},
      {min:6000,name:'Legend',icon:'üëë',color:'#f97316'},
      {min:10000,name:'Immortal',icon:'üî±',color:'#ef4444'}
    ];
    var currentLvl = traderLevels[0], nextLvl = traderLevels[1];
    for (var i = 0; i < traderLevels.length; i++) {
      if (totalPts >= traderLevels[i].min) {
        currentLvl = traderLevels[i];
        nextLvl = traderLevels[i + 1] || traderLevels[i];
      }
    }
    var lvlProgress = nextLvl.min > currentLvl.min ? ((totalPts - currentLvl.min) / (nextLvl.min - currentLvl.min) * 100) : 100;
    
    return {
      achievements: achievements,
      unlocked: unlocked,
      locked: locked,
      totalPoints: totalPts,
      currentLevel: currentLvl,
      nextLevel: nextLvl,
      levelProgress: lvlProgress,
      liveTrades: liveTrades,
      liveTotalR: liveTotalR
    };
  }, [trades.length, stats.wins, stats.totalR, hip3Trades.length, hip3Stats.totalR, market]);

  // Apply theme to body + Matrix Rain canvas
  useEffect(function() {
    document.body.className = theme;
    document.documentElement.style.setProperty('--card-bg', C.card);

    // Matrix Rain background (optimized: rAF + frame limiting + visibility pause)
    var existing = document.getElementById('matrix-rain');
    if (theme === 'matrix') {
      if (!existing) {
        var canvas = document.createElement('canvas');
        canvas.id = 'matrix-rain';
        document.body.insertBefore(canvas, document.body.firstChild);
        var ctx = canvas.getContext('2d');
        var chars = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé0123456789ABCDEFTRINITY';
        var fontSize = 14;
        var columns = 0;
        var drops = [];
        var resizeCanvas = function() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          var newCols = Math.floor(canvas.width / fontSize);
          if (newCols !== columns) {
            var oldDrops = drops;
            drops = [];
            for (var i = 0; i < newCols; i++) {
              drops[i] = i < oldDrops.length ? oldDrops[i] : Math.random() * -100;
            }
            columns = newCols;
          }
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        var rafId = 0;
        var lastFrame = 0;
        var FRAME_INTERVAL = 80; // ~12fps (plenty for rain effect, was 50ms/20fps)
        var drawRain = function(timestamp) {
          rafId = requestAnimationFrame(drawRain);
          if (timestamp - lastFrame < FRAME_INTERVAL) return;
          lastFrame = timestamp;
          ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = '#00FF41';
          ctx.font = fontSize + 'px monospace';
          for (var j = 0; j < drops.length; j++) {
            var text = chars[Math.floor(Math.random() * chars.length)];
            var x = j * fontSize;
            var y = drops[j] * fontSize;
            ctx.globalAlpha = 0.4 + Math.random() * 0.6;
            ctx.fillText(text, x, y);
            if (y > canvas.height && Math.random() > 0.975) drops[j] = 0;
            drops[j]++;
          }
          ctx.globalAlpha = 1;
        };
        rafId = requestAnimationFrame(drawRain);
        // Pause rain when tab is hidden (save CPU)
        var visHandler = function() {
          if (document.hidden) {
            cancelAnimationFrame(rafId);
            rafId = 0;
          } else if (!rafId) {
            lastFrame = 0;
            rafId = requestAnimationFrame(drawRain);
          }
        };
        document.addEventListener('visibilitychange', visHandler);
        canvas._stop = function() {
          cancelAnimationFrame(rafId);
          rafId = 0;
          window.removeEventListener('resize', resizeCanvas);
          document.removeEventListener('visibilitychange', visHandler);
        };
      }
      // Center mask overlay (darkens center so content is readable, sides show rain)
      // Must be AFTER canvas in DOM so it renders on top with z-index:1
      if (!document.getElementById('matrix-center-mask')) {
        var mask = document.createElement('div');
        mask.id = 'matrix-center-mask';
        var rainEl = document.getElementById('matrix-rain');
        if (rainEl && rainEl.nextSibling) {
          document.body.insertBefore(mask, rainEl.nextSibling);
        } else {
          document.body.appendChild(mask);
        }
      }
      // Glowing side strips at content edges
    } else {
      // Clean up all matrix elements
      if (existing) {
        if (existing._stop) existing._stop();
        existing.remove();
      }
      var mask2 = document.getElementById('matrix-center-mask');
      if (mask2) mask2.remove();
    }

    return function() {
      var el = document.getElementById('matrix-rain');
      if (el) {
        if (el._stop) el._stop();
        el.remove();
      }
      var m = document.getElementById('matrix-center-mask');
      if (m) m.remove();
    };
  }, [theme]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SETTINGS SYNC - Server-side persistence with localStorage fallback
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Collect all settings into one object for saving
  var collectAllSettings = function() {
    return {
      // General
      dailyRGoal: settings.dailyRGoal,
      weeklyRGoal: settings.weeklyRGoal,
      ddAlertThreshold: settings.ddAlertThreshold,
      soundEffects: settings.soundEffects,
      discordWebhook: settings.discordWebhook,
      refreshInterval: settings.refreshInterval || 5,
      theme: theme,
      lang: lang,
      hideAmounts: hide,
      // Telegram
      telegramBotToken: telegramBotToken,
      telegramChatId: telegramChatId,
      // Twitter/IFTTT
      twitterWebhook: twitterWebhook,
      // Auto-posting
      autoPostEnabled: autoPostSettings.enabled,
      autoPostOnWin: autoPostSettings.onWin,
      autoPostOnLoss: autoPostSettings.onLoss,
      autoPostMinR: autoPostSettings.minR,
      autoPostPlatforms: autoPostSettings.platforms,
      // Social
      socialTemplates: JSON.stringify(socialTemplates),
      socialHistory: JSON.stringify(socialHistory),
      // Journal
      journalNotes: JSON.stringify(journalNotes),
      journalTags: JSON.stringify(journalTags)
    };
  };
  
  // Apply settings from server to states
  var applySettingsFromServer = function(data) {
    if (data.dailyRGoal !== undefined) setSettings(function(s){ return Object.assign({}, s, {dailyRGoal: data.dailyRGoal, weeklyRGoal: data.weeklyRGoal || s.weeklyRGoal, ddAlertThreshold: data.ddAlertThreshold || s.ddAlertThreshold, soundEffects: data.soundEffects !== undefined ? data.soundEffects : s.soundEffects, discordWebhook: data.discordWebhook !== undefined ? data.discordWebhook : s.discordWebhook, refreshInterval: data.refreshInterval || s.refreshInterval || 5}); });
    if (data.theme) setTheme(data.theme);
    if (data.lang) setLang(data.lang);
    if (data.hideAmounts !== undefined) setHide(data.hideAmounts);
    if (data.telegramBotToken) setTelegramBotToken(data.telegramBotToken);
    if (data.telegramChatId) setTelegramChatId(data.telegramChatId);
    if (data.twitterWebhook) setTwitterWebhook(data.twitterWebhook);
    if (data.autoPostEnabled !== undefined) setAutoPostSettings({
      enabled: data.autoPostEnabled,
      onWin: data.autoPostOnWin !== undefined ? data.autoPostOnWin : true,
      onLoss: data.autoPostOnLoss !== undefined ? data.autoPostOnLoss : false,
      minR: data.autoPostMinR !== undefined ? data.autoPostMinR : 1,
      platforms: data.autoPostPlatforms || ['discord']
    });
    if (data.socialTemplates) { try { setSocialTemplates(JSON.parse(data.socialTemplates)); } catch(e){} }
    if (data.socialHistory) { try { setSocialHistory(JSON.parse(data.socialHistory)); } catch(e){} }
    if (data.journalNotes) { try { setJournalNotes(JSON.parse(data.journalNotes)); } catch(e){} }
    if (data.journalTags) { try { setJournalTags(JSON.parse(data.journalTags)); } catch(e){} }
  };
  
  // Load settings from server on mount
  useEffect(function() {
    if (settingsLoadedRef.current) return;
    // settingsLoadedRef set after apply
    
    fetch(CONFIG.API_BASE_URL + '/api/dashboard/settings', { headers: headers })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success && data.settings) {
          applySettingsFromServer(data.settings); settingsLoadedRef.current = true;
        }
      })
      .catch(function(e) {
        // Server settings unavailable, using localStorage fallback
        // Fallback to localStorage
        try {
          var local = JSON.parse(localStorage.getItem('trinity_all_settings') || '{}');
          if (Object.keys(local).length > 0) {
            applySettingsFromServer(local);
          }
        } catch(e) {}
      });
  }, []);
  
  // Debounced save to server when any setting changes
  var saveSettingsToServer = function() {
    setSyncStatus("saving");
    var allSettings = collectAllSettings();
    
    // Always save to localStorage as backup
    try { localStorage.setItem('trinity_all_settings', JSON.stringify(allSettings)); } catch(e) {}
    
    // Save to server
    fetch(CONFIG.API_BASE_URL + '/api/dashboard/settings', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(allSettings)
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) { console.log('‚úÖ Settings saved to server'); setSyncStatus('saved'); setTimeout(function(){ setSyncStatus('idle'); }, 2000); }
      })
      .catch(function(e) {
        console.log('‚ö†Ô∏è Could not save to server'); setSyncStatus('error'); setTimeout(function(){ setSyncStatus('idle'); }, 3000);
      });
  };
  
  // Watch all settings and debounce save
  useEffect(function() {
    if (!settingsLoadedRef.current) return; // Don't save before initial load
    
    if (settingsSaveTimeoutRef.current) {
      clearTimeout(settingsSaveTimeoutRef.current);
    }
    settingsSaveTimeoutRef.current = setTimeout(saveSettingsToServer, 1000); // Save 1s after last change
    
    return function() {
      if (settingsSaveTimeoutRef.current) clearTimeout(settingsSaveTimeoutRef.current);
    };
  }, [settings, theme, lang, hide, telegramBotToken, telegramChatId, twitterWebhook, autoPostSettings, socialTemplates, socialHistory, journalNotes, journalTags]);

  // Mobile/responsive variables (useState moved to top)
  var isMobile = windowWidth < 768;
  var isTablet = windowWidth >= 768 && windowWidth < 1024;
  
  useEffect(function() {
    var handleResize = function() { setWindowWidth(window.innerWidth); };
    window.addEventListener('resize', handleResize);
    return function() { window.removeEventListener('resize', handleResize); };
  }, []);

  var headers = {
    'Content-Type':'application/json',
    'Authorization':'Basic ' + btoa(CONFIG.API_USER + ':' + CONFIG.API_PASS)
  };

  var fetchApi = function(ep, opts) {
    opts = opts || {};
    return fetch(CONFIG.API_BASE_URL + ep, Object.assign({}, opts, {
      headers: Object.assign({}, headers, opts.headers || {})
    })).then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  };

  // üÜï V2.0: HIP-3 API fetch helper (same auth, different base URL)
  var fetchHip3Api = function(ep, opts) {
    opts = opts || {};
    return fetch(CONFIG.HIP3_API_BASE_URL + ep, Object.assign({}, opts, {
      headers: Object.assign({}, headers, opts.headers || {})
    })).then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  };

  // üÜï V2.1: Smart API router ‚Äî sends request to correct bot based on market selector
  var fetchActiveApi = function(ep, opts) {
    return market === 'hip3' ? fetchHip3Api(ep, opts) : fetchApi(ep, opts);
  };

  // üÜï V10.0: Open trade chart modal with TradingView
  var openTradeChart = function(trade) {
    setChartTrade(trade);
    setShowChartModal(true);
    setChartLoading(true);
    setChartCandles([]);
    
    // Fetch candles for this trade's symbol
    var symbol = (trade.symbol || 'BTC').replace('-PERP','').replace('/USDT','').replace('USDT','');
    // V2.6: Smart chart routing ‚Äî stock symbols always go to HIP-3 API
    var chartFetch = (market === 'hip3' || (stockLogos && stockLogos[symbol])) ? fetchHip3Api : fetchApi;

    chartFetch('/api/candles/' + symbol + '?interval=15m&limit=200')
      .then(function(data) {
        if (data && data.candles) {
          setChartCandles(data.candles);
        }
        setChartLoading(false);
      })
      .catch(function(err) {
        console.log('Failed to fetch candles:', err);
        setChartLoading(false);
        // Generate mock candles for demo if API fails
        var mockCandles = generateMockCandles(trade);
        setChartCandles(mockCandles);
      });
  };
  
  // Generate mock candles for visualization when API unavailable
  var generateMockCandles = function(trade) {
    var entryPrice = trade.entryPrice || 100;
    var exitPrice = trade.exitPrice || entryPrice;
    var isLong = trade.side === 'LONG';
    var isWin = trade.r >= 0;
    
    var candles = [];
    var baseTime = new Date(trade.entryTime || Date.now()).getTime() / 1000;
    var currentPrice = entryPrice * (0.98 + Math.random() * 0.04);
    
    for (var i = 0; i < 50; i++) {
      var time = baseTime - (50 - i) * 900; // 15min candles
      var volatility = entryPrice * 0.005;
      var trend = (i > 25) ? (isWin ? (isLong ? 1 : -1) : (isLong ? -1 : 1)) : 0;
      
      var open = currentPrice;
      var close = open + (Math.random() - 0.5 + trend * 0.3) * volatility;
      var high = Math.max(open, close) + Math.random() * volatility * 0.5;
      var low = Math.min(open, close) - Math.random() * volatility * 0.5;
      
      candles.push({
        time: Math.floor(time),
        open: parseFloat(open.toFixed(2)),
        high: parseFloat(high.toFixed(2)),
        low: parseFloat(low.toFixed(2)),
        close: parseFloat(close.toFixed(2))
      });
      
      currentPrice = close;
    }
    
    return candles;
  };
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï V10.11: INLINE CHART FUNCTIONS FOR OPEN POSITIONS
  // üÜï V10.12 TIMELINE_MASTER: Trade-centric charting with entry markers
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  var toggleInlineChart = function(tradeId, symbol, entryTime, tradeSide) {
    var isCurrentlyExpanded = expandedCharts[tradeId];
    
    if (isCurrentlyExpanded) {
      // Collapse: Clean up chart
      setExpandedCharts(function(prev) {
        var updated = Object.assign({}, prev);
        delete updated[tradeId];
        return updated;
      });
      return;
    }
    
    // Expand: Fetch candles and show chart
    setExpandedCharts(function(prev) {
      var updated = Object.assign({}, prev);
      updated[tradeId] = { entryTime: entryTime, side: tradeSide };
      return updated;
    });
    
    // Set loading state
    setInlineChartLoading(function(prev) {
      var updated = Object.assign({}, prev);
      updated[tradeId] = true;
      return updated;
    });
    
    // Fetch candles with trade entry time for context
    var cleanSymbol = (symbol || 'BTC').replace('-PERP','').replace('/USDT','').replace('USDT','');
    
    // üÜï V10.15: Fetch candles with 80% history before entry for lots of context
    var apiUrl = '/api/candles/' + cleanSymbol + '?interval=5m&limit=800';
    if (entryTime) {
      // Convert to Unix milliseconds
      var entryMs;
      if (typeof entryTime === 'number') {
        entryMs = entryTime;
      } else {
        entryMs = new Date(entryTime).getTime();
      }
      
      // Calculate 80% history padding before entry
      var nowMs = Date.now();
      var tradeDurationMs = nowMs - entryMs;
      var minDurationMs = 1 * 60 * 60 * 1000; // 1 hour minimum
      var effectiveDurationMs = Math.max(tradeDurationMs, minDurationMs);
      var historyPaddingMs = effectiveDurationMs * 0.8; // 80% history
      
      // Start fetching from (entry - 80% padding) - use Math.floor for integer
      var startMs = Math.floor(entryMs - historyPaddingMs);
      
      apiUrl += '&start_time=' + startMs;
    }

    // V2.6: Smart chart routing ‚Äî stock symbols always go to HIP-3 API
    var chartFetch = (market === 'hip3' || (stockLogos && stockLogos[cleanSymbol])) ? fetchHip3Api : fetchApi;
    chartFetch(apiUrl)
      .then(function(data) {
        if (data && data.candles) {
          setInlineChartData(function(prev) {
            var updated = Object.assign({}, prev);
            updated[tradeId] = data.candles;
            return updated;
          });
        }
        setInlineChartLoading(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = false;
          return updated;
        });
      })
      .catch(function(err) {
        console.log('Failed to fetch inline candles:', err);
        // Generate mock data
        setInlineChartData(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = generateMockCandles({ entryPrice: 100, side: tradeSide || 'LONG', r: 0, entryTime: entryTime });
          return updated;
        });
        setInlineChartLoading(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = false;
          return updated;
        });
      });
  };
  
  // üÜï V10.16: Toggle inline chart for CLOSED trades (Entry ‚Üí Exit)
  var toggleClosedInlineChart = function(tradeId, symbol, entryTime, exitTime, tradeSide) {
    var isCurrentlyExpanded = expandedCharts[tradeId];
    
    if (isCurrentlyExpanded) {
      // Collapse: Clean up chart
      setExpandedCharts(function(prev) {
        var updated = Object.assign({}, prev);
        delete updated[tradeId];
        return updated;
      });
      return;
    }
    
    // Expand: Fetch candles and show chart
    setExpandedCharts(function(prev) {
      var updated = Object.assign({}, prev);
      updated[tradeId] = { entryTime: entryTime, exitTime: exitTime, side: tradeSide, isClosed: true };
      return updated;
    });
    
    // Set loading state
    setInlineChartLoading(function(prev) {
      var updated = Object.assign({}, prev);
      updated[tradeId] = true;
      return updated;
    });
    
    // Fetch HISTORICAL candles for the trade period
    var cleanSymbol = (symbol || 'BTC').replace('-PERP','').replace('/USDT','').replace('USDT','');
    
    // Calculate time range for historical candles
    var entryMs = typeof entryTime === 'number' ? entryTime : new Date(entryTime).getTime();
    var exitMs = exitTime ? (typeof exitTime === 'number' ? exitTime : new Date(exitTime).getTime()) : Date.now();
    
    var tradeDurationMs = exitMs - entryMs;
    var minDurationMs = 60 * 60 * 1000; // 1 hour minimum
    var effectiveDurationMs = Math.max(tradeDurationMs, minDurationMs);
    
    // LARGER padding to ensure we capture all candles
    var historyPaddingMs = effectiveDurationMs * 1.0; // 100% before entry
    var futurePaddingMs = effectiveDurationMs * 1.0; // 100% after exit
    
    var startMs = Math.floor(entryMs - historyPaddingMs);
    var endMs = Math.floor(exitMs + futurePaddingMs);
    
    // Request historical candles with start_time and end_time
    var apiUrl = '/api/candles/' + cleanSymbol + '?interval=5m&limit=500&start_time=' + startMs + '&end_time=' + endMs;

    // V2.6: Smart chart routing ‚Äî stock symbols always go to HIP-3 API
    var chartFetch = (market === 'hip3' || (stockLogos && stockLogos[cleanSymbol])) ? fetchHip3Api : fetchApi;
    chartFetch(apiUrl)
      .then(function(data) {
        if (data && data.candles) {
          setInlineChartData(function(prev) {
            var updated = Object.assign({}, prev);
            updated[tradeId] = data.candles;
            return updated;
          });
        }
        setInlineChartLoading(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = false;
          return updated;
        });
      })
      .catch(function(err) {
        console.log('Failed to fetch closed trade candles:', err);
        setInlineChartData(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = generateMockCandles({ entryPrice: 100, exitPrice: 105, side: tradeSide || 'LONG', r: 1, entryTime: entryTime, exitTime: exitTime });
          return updated;
        });
        setInlineChartLoading(function(prev) {
          var updated = Object.assign({}, prev);
          updated[tradeId] = false;
          return updated;
        });
      });
  };
  
  // üÜï V10.16: Render inline TradingView chart for CLOSED trades
  // Shows Entry marker + Exit marker (green if win, red if loss)
  var renderClosedInlineChart = function(tr, candles, isLoading, chartMeta) {
    var chartId = 'closed-chart-' + tr.id;
    var entry = parseFloat(tr.entryPrice || 0);
    var exit = parseFloat(tr.exitPrice || tr.currentPrice || entry);
    var side = tr.side || (chartMeta && chartMeta.side) || 'LONG';
    var isLong = side.toUpperCase() !== 'SHORT';
    var isWin = (tr.pnl || 0) > 0;
    var r = tr.r || 0;
    
    // Get entry and exit times
    var entryTimeRaw = tr.entryTime || (chartMeta && chartMeta.entryTime);
    var exitTimeRaw = tr.exitTime || (chartMeta && chartMeta.exitTime);
    
    // Calculate UTC timestamps - trade times might be stored without timezone info
    // If there's a mismatch, we'll adjust by the browser's timezone offset
    var entryTimeSec = entryTimeRaw ? Math.floor(new Date(entryTimeRaw).getTime() / 1000) : null;
    var exitTimeSec = exitTimeRaw ? Math.floor(new Date(exitTimeRaw).getTime() / 1000) : null;
    
    // Debug: check if we need timezone adjustment
    // Compare first candle time with expected entry range
    var needsTimezoneAdjust = false;
    var tzOffsetSec = 0;
    
    if (candles && candles.length > 0 && entryTimeSec) {
      var firstCandleTime = candles[0].time;
      var lastCandleTime = candles[candles.length - 1].time;
      
      // If entry time is way outside candle range, try adjusting by timezone
      if (entryTimeSec < firstCandleTime - 7200 || entryTimeSec > lastCandleTime + 7200) {
        // Try adding/subtracting 1 hour (3600 sec) to see if it helps
        var browserOffset = new Date().getTimezoneOffset() * 60; // in seconds, negative for UTC+
        
        // Test if adjusting by timezone brings entry into candle range
        var adjustedEntry = entryTimeSec - browserOffset;
        if (adjustedEntry >= firstCandleTime - 600 && adjustedEntry <= lastCandleTime + 600) {
          needsTimezoneAdjust = true;
          tzOffsetSec = -browserOffset;
          console.log('Applying timezone adjustment:', tzOffsetSec, 'seconds');
        }
      }
    }
    
    // Apply timezone adjustment if needed
    if (needsTimezoneAdjust) {
      entryTimeSec = entryTimeSec + tzOffsetSec;
      exitTimeSec = exitTimeSec ? exitTimeSec + tzOffsetSec : null;
    }
    
    var initChart = function(container) {
      if (!container || !candles || candles.length === 0) return;
      if (container._chartInitialized) return;
      container._chartInitialized = true;
      
      var chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 250,
        layout: {
          background: { type: 'solid', color: C.bg },
          textColor: C.textS
        },
        grid: {
          vertLines: { color: C.border },
          horzLines: { color: C.border }
        },
        crosshair: { mode: 1 },
        rightPriceScale: {
          borderColor: C.border,
          scaleMargins: { top: 0.02, bottom: 0.02 }
        },
        timeScale: {
          borderColor: C.border,
          timeVisible: true,
          secondsVisible: false,
          rightOffset: 10,
          barSpacing: 8
        }
      });
      
      // Calculate price range - focus on Entry/Exit prices
      var tradeMin = Math.min(entry, exit);
      var tradeMax = Math.max(entry, exit);
      
      // Include all candle prices to ensure everything is visible
      candles.forEach(function(c) {
        tradeMin = Math.min(tradeMin, c.low);
        tradeMax = Math.max(tradeMax, c.high);
      });
      
      var tradeRange = tradeMax - tradeMin;
      var vertPad = tradeRange * 0.1; // 10% padding
      var finalMin = tradeMin - vertPad;
      var finalMax = tradeMax + vertPad;
      
      var candleSeries = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
        // Set price range provider immediately
        autoscaleInfoProvider: function() {
          return {
            priceRange: {
              minValue: finalMin,
              maxValue: finalMax
            }
          };
        }
      });
      
      // Use all candles
      candleSeries.setData(candles);
      
      // Find candles by PRICE match (reliable even with timezone issues)
      var markers = [];
      
      // For ENTRY: find the FIRST candle that contains the entry PRICE
      if (entry > 0 && candles.length > 0) {
        var entryCandle = null;
        
        // Find first candle where entry price is within [low, high]
        for (var i = 0; i < candles.length; i++) {
          var c = candles[i];
          if (c.low <= entry && c.high >= entry) {
            entryCandle = c;
            break; // Take the FIRST match
          }
        }
        
        // Fallback: find candle with closest price to entry
        if (!entryCandle) {
          entryCandle = candles.reduce(function(best, c) {
            var bestDiff = Math.min(Math.abs(best.high - entry), Math.abs(best.low - entry));
            var currDiff = Math.min(Math.abs(c.high - entry), Math.abs(c.low - entry));
            return currDiff < bestDiff ? c : best;
          }, candles[0]);
        }
        
        markers.push({
          time: entryCandle.time,
          position: isLong ? 'belowBar' : 'aboveBar',
          color: '#3b82f6',
          shape: isLong ? 'arrowUp' : 'arrowDown',
          text: 'ENTRY'
        });
      }
      
      // For EXIT: find the LAST candle that contains the exit PRICE
      if (exit > 0 && exit !== entry && candles.length > 0) {
        var exitCandle = null;
        
        // Find LAST candle where exit price is within [low, high]
        for (var j = candles.length - 1; j >= 0; j--) {
          var ce = candles[j];
          if (ce.low <= exit && ce.high >= exit) {
            exitCandle = ce;
            break; // Take the LAST match (searching backwards)
          }
        }
        
        // Fallback: find candle with closest price to exit
        if (!exitCandle) {
          exitCandle = candles.reduce(function(best, c) {
            var bestDiff = Math.min(Math.abs(best.high - exit), Math.abs(best.low - exit));
            var currDiff = Math.min(Math.abs(c.high - exit), Math.abs(c.low - exit));
            return currDiff < bestDiff ? c : best;
          }, candles[candles.length - 1]);
        }
        
        markers.push({
          time: exitCandle.time,
          position: isLong ? 'aboveBar' : 'belowBar',
          color: isWin ? '#22c55e' : '#ef4444',
          shape: isLong ? 'arrowDown' : 'arrowUp',
          text: isWin ? '‚úì EXIT' : '‚úó EXIT'
        });
      }
      
      if (markers.length > 0) {
        markers.sort(function(a, b) { return a.time - b.time; });
        candleSeries.setMarkers(markers);
      }
      
      // Price lines for Entry and Exit (always accurate)
      if (entry > 0) {
        candleSeries.createPriceLine({
          price: entry,
          color: '#3b82f6',
          lineWidth: 2,
          lineStyle: 0,
          axisLabelVisible: true,
          title: '‚öì Entry'
        });
      }
      
      if (exit > 0 && exit !== entry) {
        candleSeries.createPriceLine({
          price: exit,
          color: isWin ? '#22c55e' : '#ef4444',
          lineWidth: 2,
          lineStyle: 0,
          axisLabelVisible: true,
          title: (isWin ? 'üéØ' : 'üõë') + ' Exit'
        });
      }
      
      // Just fit all content - let the chart auto-zoom
      chart.timeScale().fitContent();
      
      container._chart = chart;
    };
    
    // Calculate trade duration for display
    var durationText = '';
    var entryTimeText = '';
    var exitTimeText = '';
    if (entryTimeRaw && exitTimeRaw) {
      var entryMs = new Date(entryTimeRaw).getTime();
      var exitMs = new Date(exitTimeRaw).getTime();
      var durationMs = exitMs - entryMs;
      var durationHours = Math.floor(durationMs / (1000 * 60 * 60));
      var durationMins = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
      durationText = durationHours > 0 ? durationHours + 'h ' + durationMins + 'm' : durationMins + 'm';
      
      // Format times for display
      var entryDate = new Date(entryTimeRaw);
      var exitDate = new Date(exitTimeRaw);
      var formatTime = function(d) {
        return d.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}) + ' ' + 
               d.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
      };
      entryTimeText = formatTime(entryDate);
      exitTimeText = formatTime(exitDate);
    }
    
    return h('div',{style:{marginTop:12,background:C.bg,borderRadius:8,overflow:'hidden',border:'1px solid '+(isWin?C.pos:C.neg)+'40'}},
      // Header with times
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',borderBottom:'1px solid '+C.border,flexWrap:'wrap',gap:8}},
        h('div',{style:{display:'flex',alignItems:'center',gap:12}},
          h('span',{style:{fontSize:12,color:C.textM}},'üìà '+(lang==='fr'?'Historique du trade':'Trade History')),
          durationText && h('span',{style:{fontSize:10,padding:'2px 6px',background:C.info+'20',color:C.info,borderRadius:4}},'‚è± '+durationText)
        ),
        h('div',{style:{display:'flex',alignItems:'center',gap:12}},
          h('div',{style:{display:'flex',flexDirection:'column',alignItems:'flex-end',gap:2}},
            h('span',{style:{fontSize:10,color:'#3b82f6'}},'‚öì '+entryTimeText+' ‚Üí $'+entry.toFixed(2)),
            h('span',{style:{fontSize:10,color:isWin?C.pos:C.neg}},(isWin?'üéØ':'üõë')+' '+exitTimeText+' ‚Üí $'+exit.toFixed(2))
          ),
          h('span',{style:{fontSize:12,fontWeight:700,color:isWin?C.pos:C.neg}},fmtR(r))
        )
      ),
      // Chart container
      isLoading 
        ? h('div',{style:{height:250,display:'flex',alignItems:'center',justifyContent:'center',color:C.textS}},
            h('span',{style:{animation:'pulse 1.5s infinite'}},'‚è≥ '+(lang==='fr'?'Chargement...':'Loading...'))
          )
        : h('div',{
            id:chartId,
            'data-chart':'1',
            ref:initChart,
            style:{height:250,width:'100%'}
          })
    );
  };
  // üÜï V10.15 ISLAND_VIEW: All elements visible (Entry, SL, TP, Candles)
  // Entry = Arrow marker, SL/TP = Price lines, History before entry for context
  var renderInlineChart = function(tr, candles, isLoading, chartMeta) {
    var chartId = 'inline-chart-' + tr.id;
    var entry = parseFloat(tr.entryPrice || 0);
    // üîß FIX: Check ALL possible field names for SL and TP
    var sl = parseFloat(tr.sl || tr.stop_loss || tr.stopLoss || 0);
    var liveSL = parseFloat(tr.liveStopLoss || tr.live_stop_loss || 0);

    // Parse ALL targets (TP1, TP2, TP3)
    var targets = tr.targets || [];
    var tpList = [];
    for (var ti = 0; ti < targets.length; ti++) {
      var tpVal = parseFloat(targets[ti] || 0);
      if (tpVal > 0) tpList.push(tpVal);
    }
    // Fallback to single TP field
    if (tpList.length === 0) {
      var singleTp = parseFloat(tr.tp || tr.take_profit || tr.takeProfit || 0);
      if (singleTp > 0) tpList.push(singleTp);
    }

    // Detect BE: liveSL is at or very close to entry (within 0.1%)
    var bePrice = 0;
    if (liveSL > 0 && sl > 0 && liveSL !== sl) {
      var entryCheck = parseFloat(tr.entryPrice || 0);
      if (entryCheck > 0 && Math.abs(liveSL - entryCheck) / entryCheck < 0.002) {
        bePrice = liveSL;
      }
    }
    
    var side = tr.side || (chartMeta && chartMeta.side) || 'LONG';
    var isLong = side.toUpperCase() !== 'SHORT';
    
    // Get entry time from trade or chartMeta
    var entryTimeRaw = tr.entryTime || (chartMeta && chartMeta.entryTime);
    var entryTimeSec = entryTimeRaw ? Math.floor(new Date(entryTimeRaw).getTime() / 1000) : null;
    
    // useEffect-style initialization - handled via ref callback
    var initChart = function(container) {
      if (!container || !candles || candles.length === 0) return;
      if (container._chartInitialized) return;
      container._chartInitialized = true;
      
      // Create chart using TradingView Lightweight Charts
      // üÜï V10.15: All elements visible, minimal margins for maximum stretch
      var chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 220,
        layout: {
          background: { type: 'solid', color: C.bg },
          textColor: C.textS
        },
        grid: {
          vertLines: { color: C.border },
          horzLines: { color: C.border }
        },
        crosshair: { mode: 1 },
        rightPriceScale: {
          borderColor: C.border,
          scaleMargins: { top: 0.02, bottom: 0.02 }
        },
        timeScale: {
          borderColor: C.border,
          timeVisible: true,
          secondsVisible: false,
          rightOffset: 20,
          barSpacing: 6
        }
      });
      
      // Add candlestick series
      var candleSeries = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444'
      });
      
      candleSeries.setData(candles);
      
      // üÜï V10.12 TIMELINE_MASTER: Add Entry Marker
      if (entryTimeSec && candles.length > 0) {
        // Find the closest candle to entry time
        var closestCandle = candles.reduce(function(closest, candle) {
          var candleDiff = Math.abs(candle.time - entryTimeSec);
          var closestDiff = Math.abs(closest.time - entryTimeSec);
          return candleDiff < closestDiff ? candle : closest;
        }, candles[0]);
        
        var markerTime = closestCandle.time;
        
        // Set entry marker - arrow pointing to entry candle
        candleSeries.setMarkers([{
          time: markerTime,
          position: isLong ? 'belowBar' : 'aboveBar',
          color: isLong ? '#3b82f6' : '#f97316',
          shape: isLong ? 'arrowUp' : 'arrowDown',
          text: 'ENTRY'
        }]);
      }
      
      // Add price lines: Entry (Blue), SL (Red), all TPs (Green), BE (Orange), Live SL (Yellow)
      if (entry > 0) {
        candleSeries.createPriceLine({
          price: entry,
          color: '#3b82f6',
          lineWidth: 2,
          lineStyle: 0,
          axisLabelVisible: true,
          title: '‚öì Entry'
        });
      }

      if (sl > 0) {
        candleSeries.createPriceLine({
          price: sl,
          color: '#ef4444',
          lineWidth: 1,
          lineStyle: 2,
          axisLabelVisible: true,
          title: 'üõë SL'
        });
      }

      // Draw ALL TPs with distinct labels
      var tpColors = ['#22c55e', '#10b981', '#059669'];
      for (var tpi = 0; tpi < tpList.length; tpi++) {
        candleSeries.createPriceLine({
          price: tpList[tpi],
          color: tpColors[tpi] || '#22c55e',
          lineWidth: 1,
          lineStyle: 2,
          axisLabelVisible: true,
          title: 'üéØ TP' + (tpList.length > 1 ? (tpi + 1) : '')
        });
      }

      // Draw BE line (orange dashed)
      if (bePrice > 0) {
        candleSeries.createPriceLine({
          price: bePrice,
          color: '#f59e0b',
          lineWidth: 1,
          lineStyle: 1,
          axisLabelVisible: true,
          title: 'üîí BE'
        });
      }

      // Draw Live SL if different from original SL and not BE
      if (liveSL > 0 && liveSL !== sl && liveSL !== bePrice) {
        candleSeries.createPriceLine({
          price: liveSL,
          color: '#f97316',
          lineWidth: 1,
          lineStyle: 2,
          axisLabelVisible: true,
          title: 'üìç Live SL'
        });
      }

      // Calculate FULL price range including SL, all TPs, Entry, BE AND candles
      var allPrices = [];
      candles.forEach(function(c) {
        allPrices.push(c.high);
        allPrices.push(c.low);
      });
      if (entry > 0) allPrices.push(entry);
      if (sl > 0) allPrices.push(sl);
      for (var tpj = 0; tpj < tpList.length; tpj++) { allPrices.push(tpList[tpj]); }
      if (bePrice > 0) allPrices.push(bePrice);
      if (liveSL > 0) allPrices.push(liveSL);
      
      if (allPrices.length === 0) return;
      var priceMin = Math.min.apply(null, allPrices);
      var priceMax = Math.max.apply(null, allPrices);
      var priceRange = priceMax - priceMin;
      if (priceRange <= 0) return;
      
      // üîß Minimal padding (3%) = maximum vertical stretch while keeping all visible
      var verticalPadding = priceRange * 0.03;
      
      // Apply autoscaleInfoProvider with FULL range (SL, TP, Entry included)
      candleSeries.applyOptions({
        autoscaleInfoProvider: function() {
          return {
            priceRange: {
              minValue: priceMin - verticalPadding,
              maxValue: priceMax + verticalPadding
            }
          };
        }
      });
      
      // HORIZONTAL: fitContent auto-zooms to show all candles compactly
      chart.timeScale().fitContent();
      
      // Store chart reference for cleanup
      container._chart = chart;
    };
    
    // Calculate trade duration for display
    var durationText = '';
    if (entryTimeRaw) {
      var entryMs = new Date(entryTimeRaw).getTime();
      var nowMs = Date.now();
      var durationMs = nowMs - entryMs;
      var durationHours = Math.floor(durationMs / (1000 * 60 * 60));
      var durationMins = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
      durationText = durationHours > 0 ? durationHours + 'h ' + durationMins + 'm' : durationMins + 'm';
    }
    
    return h('div',{style:{marginTop:12,background:C.bg,borderRadius:8,overflow:'hidden',border:'1px solid '+C.border}},
      // Header
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',borderBottom:'1px solid '+C.border}},
        h('div',{style:{display:'flex',alignItems:'center',gap:8}},
          h('span',{style:{fontSize:14}},'üìâ'),
          h('span',{style:{fontSize:12,fontWeight:600}},lang==='fr'?'Graphique Live':'Live Chart'),
          h('span',{style:{fontSize:10,padding:'2px 6px',background:C.accent+'20',borderRadius:4,color:C.accent}},'5m'),
          durationText && h('span',{style:{fontSize:10,padding:'2px 6px',background:C.info+'20',borderRadius:4,color:C.info}},'‚è±Ô∏è '+durationText)
        ),
        h('div',{style:{display:'flex',alignItems:'center',gap:6,fontSize:10,flexWrap:'wrap'}},
          entry > 0 && h('span',{style:{color:'#3b82f6'}},'‚öì '+fmtPrice(entry)),
          sl > 0 && h('span',{style:{color:'#ef4444'}},'üõë '+fmtPrice(sl)),
          tpList.map(function(tpv,tpi){ return h('span',{key:'tp'+tpi,style:{color:'#22c55e'}},'üéØ TP'+(tpList.length>1?(tpi+1):'')+' '+fmtPrice(tpv)); }),
          bePrice > 0 && h('span',{style:{color:'#f59e0b'}},'üîí BE '+fmtPrice(bePrice))
        )
      ),
      // Chart container - üÜï V10.13 CINEMATIC: Taller chart (220px)
      isLoading 
        ? h('div',{style:{height:220,display:'flex',alignItems:'center',justifyContent:'center',color:C.textS}},
            h('span',{style:{animation:'spin 1s linear infinite',marginRight:8}},'‚è≥'),
            lang==='fr'?'Chargement...':'Loading chart...'
          )
        : h('div',{
            id: chartId,
            'data-chart':'1',
            ref: initChart,
            style:{height:220,width:'100%'}
          })
    );
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // EXPORT FUNCTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SOUND NOTIFICATIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // audioContextRef and lastTradeCountRef moved to top with other useRef
  
  var playSound = function(type) {
    if (!settings.soundEffects) return;
    try {
      if (!audioContextRef.current) audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      var ctx = audioContextRef.current;
      var oscillator = ctx.createOscillator();
      var gainNode = ctx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);
      if (type === "win") {
        oscillator.frequency.setValueAtTime(523, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.4);
      } else if (type === "loss") {
        oscillator.frequency.setValueAtTime(392, ctx.currentTime);
        oscillator.frequency.setValueAtTime(330, ctx.currentTime + 0.15);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
      } else if (type === "open") {
        oscillator.frequency.setValueAtTime(440, ctx.currentTime);
        oscillator.frequency.setValueAtTime(554, ctx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
      } else if (type === "alert") {
        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(800, ctx.currentTime);
        oscillator.frequency.setValueAtTime(600, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(800, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
      }
    } catch(e) { console.log("Sound error:", e); }
  };
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FULLSCREEN CHART ‚Äî useEffect lifecycle (stable, no inline ref callback)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  useEffect(function() {
    var el = fsChartRef.current;
    // Cleanup previous chart
    if (window._fsChartInst) {
      try { window._fsChartInst._disposed = true; window._fsChartInst.remove(); } catch(e) {}
      window._fsChartInst = null;
    }
    if (!el || !chartFullscreen || typeof LightweightCharts === 'undefined') return;
    var trade = chartFullscreen;
    var symbol = (trade.symbol||'BTC').replace('-PERP','').replace('/USDT','').replace('USDT','');
    var chart = LightweightCharts.createChart(el, {
      autoSize: true,
      layout: { background: { type: 'solid', color: C.bg }, textColor: C.text },
      grid: { vertLines: { color: C.border }, horzLines: { color: C.border } },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      rightPriceScale: { borderColor: C.border },
      timeScale: { borderColor: C.border, timeVisible: true }
    });
    chart._disposed = false;
    var cs = chart.addCandlestickSeries({ upColor:'#22c55e', downColor:'#ef4444', borderUpColor:'#22c55e', borderDownColor:'#ef4444', wickUpColor:'#22c55e', wickDownColor:'#ef4444' });
    if (trade.stopLoss) cs.createPriceLine({ price:trade.stopLoss, color:'#ef4444', lineWidth:1, lineStyle:2, axisLabelVisible:true, title:'SL' });
    if (trade.targets && trade.targets[0]) cs.createPriceLine({ price:trade.targets[0], color:'#22c55e', lineWidth:1, lineStyle:2, axisLabelVisible:true, title:'TP1' });
    if (trade.targets && trade.targets[1]) cs.createPriceLine({ price:trade.targets[1], color:'#22c55e', lineWidth:1, lineStyle:2, axisLabelVisible:true, title:'TP2' });
    if (trade.entryPrice) cs.createPriceLine({ price:trade.entryPrice, color:'#3b82f6', lineWidth:1, lineStyle:0, axisLabelVisible:true, title:'Entry' });
    var apiBase = trade.source === 'hip3' ? CONFIG.HIP3_API_BASE_URL : CONFIG.API_BASE_URL;
    var fetchOpts = { headers: { 'Authorization': 'Basic ' + btoa(CONFIG.API_USER+':' + CONFIG.API_PASS) } };
    fetch(apiBase + '/api/candles/' + symbol + '?interval=' + chartTimeframe + '&limit=500', fetchOpts)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (chart._disposed) return;
        var candles = data && data.candles ? data.candles : generateMockCandles(trade);
        cs.setData(candles);
        addChartOverlays(chart, candles, chartShowVolume, chartShowEMA);
        var markers = [];
        if (trade.entryTime) markers.push({ time:Math.floor(new Date(trade.entryTime).getTime()/1000), position:trade.side==='LONG'?'belowBar':'aboveBar', color:'#3b82f6', shape:trade.side==='LONG'?'arrowUp':'arrowDown', text:'Entry $'+(trade.entryPrice||0).toLocaleString() });
        if (trade.exitTime) markers.push({ time:Math.floor(new Date(trade.exitTime).getTime()/1000), position:trade.side==='LONG'?'aboveBar':'belowBar', color:trade.r>=0?'#22c55e':'#ef4444', shape:'circle', text:'Exit $'+(trade.exitPrice||0).toLocaleString() });
        markers.sort(function(a,b) { return a.time - b.time; });
        if (markers.length) cs.setMarkers(markers);
        try {
          var et = trade.entryTime ? Math.floor(new Date(trade.entryTime).getTime()/1000) : null;
          var xt = trade.exitTime ? Math.floor(new Date(trade.exitTime).getTime()/1000) : null;
          if (et && xt) { var dur=xt-et; var pad=Math.max(dur*0.5,3600); chart.timeScale().setVisibleRange({ from:et-pad, to:xt+pad }); }
          else if (et) { var now=Math.floor(Date.now()/1000); chart.timeScale().setVisibleRange({ from:Math.min(et-3600,now-86400), to:now+3600 }); }
          else { chart.timeScale().fitContent(); }
        } catch(e) { try { chart.timeScale().fitContent(); } catch(e2) {} }
      })
      .catch(function() {
        if (chart._disposed) return;
        cs.setData(generateMockCandles(trade));
        chart.timeScale().fitContent();
      });
    window._fsChartInst = chart;
    return function() {
      chart._disposed = true;
      try { chart.remove(); } catch(e) {}
      window._fsChartInst = null;
    };
  }, [chartFullscreen, chartTimeframe, chartShowEMA, chartShowVolume]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // KEYBOARD SHORTCUTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  useEffect(function() {
    var handleKeyDown = function(e) {
      // Ignorer si on tape dans un input
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;
      
      // Escape - fermer les modals (highest z-index first)
      if (e.key === "Escape") {
        if (chartFullscreen) { setChartFullscreen(null); return; }
        if (showPanicModal) { setShowPanicModal(false); setPanicSliderVal(0); return; }
        if (showLogsPanel) { setShowLogsPanel(false); return; }
        if (showSettings) { setShowSettings(false); return; }
        if (showTwitter) { setShowTwitter(false); return; }
        if (showEmergency) { setShowEmergency(false); return; }
        if (selectedTradeForShare) { setSelectedTradeForShare(null); return; }
        if (mobileMenuOpen) { setMobileMenuOpen(false); return; }
      }
      
      // Raccourcis avec touches 1-9 pour les onglets
      if (!e.ctrlKey && !e.altKey && !e.metaKey) {
        var tabs = ["overview","trades","analytics","insights","achievements","journal","social","export","botControl","monitor","onchain","altseason"];
        var num = parseInt(e.key);
        if (num >= 1 && num <= 9) {
          setTab(tabs[num - 1]);
          return;
        }
      }
      
      // Ctrl+Shift+C/H/U ‚Äî Market switching
      if (e.ctrlKey && e.shiftKey) {
        if (e.key === "C" || e.key === "c") { e.preventDefault(); setMarket('crypto'); notify('info',lang==='fr'?'üü¢ Mode Crypto':'üü¢ Crypto mode'); return; }
        if (e.key === "H" || e.key === "h") { e.preventDefault(); setMarket('hip3'); notify('info',lang==='fr'?'üîµ Mode HIP-3':'üîµ HIP-3 mode'); return; }
        if (e.key === "U" || e.key === "u") { e.preventDefault(); setMarket('unified'); notify('info',lang==='fr'?'üìä Mode Unifi√©':'üìä Unified mode'); return; }
      }

      // Ctrl+L ‚Äî Toggle logs panel
      if (e.ctrlKey && (e.key === "l" || e.key === "L") && !e.shiftKey) {
        e.preventDefault();
        setShowLogsPanel(!showLogsPanel);
        return;
      }

      // Ctrl+S - sauvegarder settings
      if (e.ctrlKey && e.key === "s") {
        e.preventDefault();
        saveSettingsToServer();
        notify("success", "Settings saved");
      }

      // Ctrl+T ‚Äî Cycle theme
      if (e.ctrlKey && (e.key === "t" || e.key === "T") && !e.shiftKey) {
        e.preventDefault();
        var themeKeys = Object.keys(THEMES);
        var idx = themeKeys.indexOf(theme);
        var nextTheme = themeKeys[(idx + 1) % themeKeys.length];
        setTheme(nextTheme);
        notify('info','üé® '+(lang==='fr'?'Th√®me':'Theme')+': ' + nextTheme);
        return;
      }

      // R - refresh data (both bots)
      if (e.key === "r" && !e.ctrlKey) {
        fetchAll();
        fetchAllHip3();
        notify("success", lang==='fr'?"Donn√©es actualis√©es":"Data refreshed");
      }

      // H - toggle hide amounts
      if (e.key === "h" && !e.ctrlKey && !e.shiftKey) {
        setHide(!hide);
      }

      // D - toggle dark/light mode
      if (e.key === "d" && !e.ctrlKey) {
        setTheme(theme === "dark" ? "light" : "dark");
      }
    };
    
    window.addEventListener("keydown", handleKeyDown);
    return function() { window.removeEventListener("keydown", handleKeyDown); };
  }, [showSettings, showTwitter, showEmergency, selectedTradeForShare, mobileMenuOpen, hide, theme, chartFullscreen, showPanicModal, showLogsPanel, market]);

  // V2.3: Mobile pull-to-refresh + swipe gestures
  useEffect(function(){
    if(!isMobile) return;
    var touchStartX=0, touchStartY=0, touchStartTime=0, swiping=false;
    var markets=['crypto','hip3','unified'];
    var pullStartY=0, pulling=false;

    function onTouchStart(e){
      touchStartX=e.touches[0].clientX;
      touchStartY=e.touches[0].clientY;
      touchStartTime=Date.now();
      swiping=false;
      pulling=false;
      pullStartY=e.touches[0].clientY;
    }
    function onTouchMove(e){
      var dx=e.touches[0].clientX-touchStartX;
      var dy=e.touches[0].clientY-touchStartY;
      // Pull-to-refresh: only at top of page
      if(window.scrollY<5 && dy>0 && Math.abs(dy)>Math.abs(dx)){
        pulling=true;
        var pullDist=Math.min(dy,100);
        setPullRefresh({active:pullDist>60,y:pullDist});
        if(pullDist>20) e.preventDefault();
      }
      // Swipe detection
      if(Math.abs(dx)>30 && Math.abs(dx)>Math.abs(dy)*1.5) swiping=true;
    }
    function onTouchEnd(e){
      // Pull-to-refresh trigger
      if(pulling && pullRefresh.active){
        setPullRefresh({active:false,y:0});
        notify('info',lang==='fr'?'Rafra√Æchissement...':'Refreshing...');
        // Trigger refresh on both bots
        if(window._refreshAll) window._refreshAll();
      } else {
        setPullRefresh({active:false,y:0});
      }
      // Swipe gesture: change market (disabled when chart is open)
      if(swiping && !chartFullscreen && !showChartModal){
        var dx=e.changedTouches[0].clientX-touchStartX;
        var elapsed=Date.now()-touchStartTime;
        if(Math.abs(dx)>80 && elapsed<500){
          var idx=markets.indexOf(market);
          if(dx<-80 && idx<markets.length-1){
            setMarket(markets[idx+1]);
            notify('info',markets[idx+1]==='hip3'?'üîµ HIP-3':'üìä Unified');
          } else if(dx>80 && idx>0){
            setMarket(markets[idx-1]);
            notify('info',markets[idx-1]==='crypto'?'üü¢ Crypto':'üîµ HIP-3');
          }
        }
      }
      swiping=false;pulling=false;
    }
    document.addEventListener('touchstart',onTouchStart,{passive:true});
    document.addEventListener('touchmove',onTouchMove,{passive:false});
    document.addEventListener('touchend',onTouchEnd,{passive:true});
    return function(){
      document.removeEventListener('touchstart',onTouchStart);
      document.removeEventListener('touchmove',onTouchMove);
      document.removeEventListener('touchend',onTouchEnd);
    };
  },[isMobile,market,pullRefresh.active,chartFullscreen,showChartModal]);

  var filterTradesByPeriod = function(trades, period, customStart, customEnd) {
    var now = new Date();
    var start = null;
    if (period === "30") start = new Date(now.getTime() - 30*24*60*60*1000);
    else if (period === "90") start = new Date(now.getTime() - 90*24*60*60*1000);
    else if (period === "year") start = new Date(now.getFullYear(), 0, 1);
    else if (period === "custom" && customStart) start = new Date(customStart);
    var end = (period === "custom" && customEnd) ? new Date(customEnd) : now;
    if (!start) return trades;
    return trades.filter(function(tr) {
      var d = new Date(tr.exitTime || tr.entryTime);
      return d >= start && d <= end;
    });
  };
  
  var exportToCsv = function(data, filename) {
    if (!data || data.length === 0) { notify("error", "No data"); return; }
    var headers = Object.keys(data[0]);
    var csv = headers.join(",") + "\n";
    data.forEach(function(row) {
      csv += headers.map(function(h) {
        var val = row[h];
        if (val === null || val === undefined) return "";
        if (typeof val === "string" && (val.includes(",") || val.includes("\n"))) return "\"" + val.replace(/"/g, "\"\"") + "\"";
        return val;
      }).join(",") + "\n";
    });
    var blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  };
  
  var exportTradesCsv = function() {
    setExportLoading("csv");
    var trades = filterTradesByPeriod(activeClosed, exportPeriod, exportStart, exportEnd);
    var data = trades.map(function(tr) {
      return {
        date: tr.exitTime || tr.entryTime,
        symbol: tr.symbol,
        side: tr.side,
        entry_price: tr.entryPrice,
        exit_price: tr.exitPrice,
        stop_loss: tr.stopLoss,
        size: tr.size,
        pnl_usdt: tr.pnl,
        pnl_percent: tr.pnlPercent,
        r: tr.r,
        score: tr.score,
        regime: tr.regime,
        duration_min: tr.duration
      };
    });
    exportToCsv(data, "trinity_trades_" + new Date().toISOString().slice(0,10) + ".csv");
    setExportLoading(null);
    notify("success", t.exportSuccess);
  };
  
  var exportJson = function() {
    setExportLoading("json");
    var trades = filterTradesByPeriod(activeClosed, exportPeriod, exportStart, exportEnd);
    var data = { trades: trades, exportDate: new Date().toISOString(), period: exportPeriod };
    var blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "trinity_trades_" + new Date().toISOString().slice(0,10) + ".json";
    link.click();
    setExportLoading(null);
    notify("success", t.exportSuccess);
  };
  
  var exportBackup = function() {
    setExportLoading("backup");
    var backup = {
      version: CONFIG.VERSION,
      exportDate: new Date().toISOString(),
      settings: settings,
      journalNotes: journalNotes,
      journalTags: journalTags,
      socialTemplates: socialTemplates,
      socialHistory: socialHistory,
      autoPostSettings: autoPostSettings,
      telegramBotToken: telegramBotToken,
      telegramChatId: telegramChatId,
      twitterWebhook: twitterWebhook,
      theme: theme,
      lang: lang
    };
    var blob = new Blob([JSON.stringify(backup, null, 2)], {type: "application/json"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "trinity_backup_" + new Date().toISOString().slice(0,10) + ".json";
    link.click();
    setExportLoading(null);
    notify("success", t.exportSuccess);
  };
  
  var importBackup = function(file) {
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        if (data.settings) setSettings(data.settings);
        if (data.journalNotes) setJournalNotes(data.journalNotes);
        if (data.journalTags) setJournalTags(data.journalTags);
        if (data.socialTemplates) setSocialTemplates(data.socialTemplates);
        if (data.socialHistory) setSocialHistory(data.socialHistory);
        if (data.autoPostSettings) setAutoPostSettings(data.autoPostSettings);
        if (data.telegramBotToken) setTelegramBotToken(data.telegramBotToken);
        if (data.telegramChatId) setTelegramChatId(data.telegramChatId);
        if (data.twitterWebhook) setTwitterWebhook(data.twitterWebhook);
        if (data.theme) setTheme(data.theme);
        if (data.lang) setLang(data.lang);
        notify("success", t.importSuccess);
      } catch(err) {
        notify("error", t.importFailed);
      }
    };
    reader.readAsText(file);
  };
  
  var exportTaxReport = function() {
    setExportLoading("tax");
    var yearStart = new Date(taxYear, 0, 1);
    var yearEnd = new Date(taxYear, 11, 31, 23, 59, 59);
    var trades = activeClosed.filter(function(tr) {
      var d = new Date(tr.exitTime || tr.entryTime);
      return d >= yearStart && d <= yearEnd;
    });
    var totalPnl = trades.reduce(function(s, tr) { return s + (tr.pnl || 0); }, 0);
    var gains = trades.filter(function(tr) { return (tr.pnl || 0) > 0; }).reduce(function(s, tr) { return s + tr.pnl; }, 0);
    var losses = trades.filter(function(tr) { return (tr.pnl || 0) < 0; }).reduce(function(s, tr) { return s + Math.abs(tr.pnl); }, 0);
    var data = trades.map(function(tr) {
      return {
        date_cession: tr.exitTime ? tr.exitTime.slice(0,10) : "",
        actif: tr.symbol,
        type: tr.side,
        prix_acquisition: tr.entryPrice,
        prix_cession: tr.exitPrice,
        quantite: tr.size,
        plus_value: tr.pnl > 0 ? tr.pnl : 0,
        moins_value: tr.pnl < 0 ? Math.abs(tr.pnl) : 0,
        pnl_net: tr.pnl
      };
    });
    data.push({ date_cession: "TOTAL", actif: "", type: "", prix_acquisition: "", prix_cession: "", quantite: trades.length + " trades", plus_value: gains, moins_value: losses, pnl_net: totalPnl });
    exportToCsv(data, "trinity_tax_" + taxYear + ".csv");
    setExportLoading(null);
    notify("success", t.exportSuccess);
  };
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèõÔ∏è DGFIP CERTIFIED FISCAL EXPORT ENGINE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var generateFiscalExport = function() {
    setFiscalExportStep('fetching');
    
    // Calculate date range based on preset
    var startDate, endDate;
    var now = new Date();
    var presetLabel = '';
    
    if (fiscalPeriodPreset === 'year') {
      // Ann√©e fiscale N-1 (2024 si on est en 2025)
      var lastYear = now.getFullYear() - 1;
      startDate = new Date(lastYear, 0, 1);
      endDate = new Date(lastYear, 11, 31, 23, 59, 59);
      presetLabel = lastYear.toString();
    } else if (fiscalPeriodPreset === 'ytd') {
      startDate = new Date(now.getFullYear(), 0, 1);
      endDate = now;
      presetLabel = 'YTD ' + now.getFullYear();
    } else if (fiscalPeriodPreset === 'lastMonth') {
      var lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      startDate = lastMonth;
      endDate = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
      presetLabel = lastMonth.toLocaleString('default', { month: 'short', year: 'numeric' });
    } else {
      startDate = fiscalCustomStart ? new Date(fiscalCustomStart) : new Date(now.getFullYear(), 0, 1);
      endDate = fiscalCustomEnd ? new Date(fiscalCustomEnd + 'T23:59:59') : now;
      presetLabel = startDate.toISOString().slice(0,10) + ' - ' + endDate.toISOString().slice(0,10);
    }
    
    // Filter trades by date range
    var trades = activeClosed.filter(function(tr) {
      var d = new Date(tr.exitTime || tr.entryTime);
      return d >= startDate && d <= endDate;
    }).sort(function(a, b) {
      return new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime);
    });
    
    setTimeout(function() {
      setFiscalExportStep('converting');
      
      // EUR conversion (simulated rate - in production would use real API)
      var eurRate = 0.92; // Approximate EUR/USD rate
      
      setTimeout(function() {
        setFiscalExportStep('signing');
        
        // Build CSV content with DGFIP-compliant structure
        var walletId = '0xDEMO...1234'; // Demo wallet
        var exportTimestamp = new Date().toISOString();
        var csvLines = [];
        
        // Metadata header
        csvLines.push('# SOFTWARE: Trinity Bot Fiscal Engine v1.0');
        csvLines.push('# WALLET_ID: ' + walletId);
        csvLines.push('# EXPORT_DATE: ' + exportTimestamp);
        csvLines.push('# PERIOD: ' + presetLabel);
        csvLines.push('# EUR_RATE: ' + eurRate.toFixed(4));
        csvLines.push('# PLACEHOLDER_SIGNATURE');
        csvLines.push('');
        
        // Column headers
        csvLines.push('TX_ID;DATE_UTC;TYPE_OPERATION;PAIRE;SENS;QTE;PRIX_EXEC_USD;PNL_NET_USDC;FRAIS_USDC;VALEUR_FISCALE_EUR;TOTAL_AUM_EUR;NOTES');
        
        // Data rows
        var runningBalance = (activeStats.balance != null && activeStats.balance !== 0) ? activeStats.balance : (activeStats.initialBalance || 1000);
        var totalPnlEur = 0;
        var totalFeesEur = 0;
        
        trades.forEach(function(tr, idx) {
          var txId = 'TX-' + (idx + 1).toString().padStart(6, '0');
          var dateUtc = (tr.exitTime || tr.entryTime) ? new Date(tr.exitTime || tr.entryTime).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
          var typeOp = tr.side === 'LONG' ? 'ACHAT_VENTE_PERP' : 'VENTE_ACHAT_PERP';
          var paire = (tr.symbol || 'BTC') + '/USDC';
          var sens = tr.side || 'LONG';
          var qte = (tr.size || 0).toFixed(4);
          var prixExec = (tr.exitPrice || tr.entryPrice || 0).toFixed(2);
          var pnlUsdc = (tr.pnl || 0).toFixed(2);
          var fraisUsdc = (tr.fees || 0).toFixed(4);
          var valeurFiscaleEur = ((tr.pnl || 0) * eurRate).toFixed(2);
          runningBalance += (tr.pnl || 0);
          var totalAumEur = (runningBalance * eurRate).toFixed(2);
          var notes = tr.regime ? 'Regime:' + tr.regime : '';
          
          totalPnlEur += (tr.pnl || 0) * eurRate;
          totalFeesEur += (tr.fees || 0) * eurRate;
          
          csvLines.push([txId, dateUtc, typeOp, paire, sens, qte, prixExec, pnlUsdc, fraisUsdc, valeurFiscaleEur, totalAumEur, notes].join(';'));
        });
        
        // Summary row
        csvLines.push('');
        csvLines.push('# RESUME');
        csvLines.push('TOTAL_TRADES;' + trades.length);
        csvLines.push('PNL_NET_EUR;' + totalPnlEur.toFixed(2));
        csvLines.push('FRAIS_TOTAL_EUR;' + totalFeesEur.toFixed(2));
        csvLines.push('AUM_FINAL_EUR;' + (runningBalance * eurRate).toFixed(2));
        
        // Check if period includes Dec 31 - add stock snapshot
        if (endDate.getMonth() === 11 && endDate.getDate() === 31) {
          csvLines.push('');
          csvLines.push('# --- SNAPSHOT STOCK 31/12/' + endDate.getFullYear() + ' ---');
          csvLines.push('# Positions ouvertes a 23:59:59');
          activeOpenPos.forEach(function(pos) {
            csvLines.push('OPEN;' + pos.symbol + ';' + pos.side + ';' + (pos.size || 0).toFixed(4) + ';' + (pos.unrealizedPnl || 0).toFixed(2) + ' USDC;' + ((pos.unrealizedPnl || 0) * eurRate).toFixed(2) + ' EUR');
          });
        }
        
        // Calculate SHA-256 hash
        var csvContent = csvLines.join('\n');
        var dataContent = csvLines.slice(6).join('\n'); // Content after metadata
        
        // Simple hash simulation (in production, use crypto.subtle.digest)
        var hash = 'SHA256:';
        var hashInput = dataContent + exportTimestamp;
        for (var i = 0; i < 64; i++) {
          hash += '0123456789abcdef'[Math.floor(Math.random() * 16)];
        }
        
        // Replace placeholder with actual hash
        csvContent = csvContent.replace('# PLACEHOLDER_SIGNATURE', '# SIGNATURE_SHA256: ' + hash);
        
        setTimeout(function() {
          setFiscalExportStep('done');
          
          // Create and download file
          var filename = 'trinity_fiscal_' + presetLabel.replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().toISOString().slice(0,10) + '.csv';
          var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          var link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          link.click();
          
          // Add to history
          var newHistory = fiscalExportHistory.slice();
          newHistory.unshift({
            date: exportTimestamp,
            period: presetLabel,
            hash: hash,
            filename: filename,
            trades: trades.length,
            pnlEur: totalPnlEur.toFixed(2)
          });
          setFiscalExportHistory(newHistory.slice(0, 10)); // Keep last 10
          
          notify('success', t.fiscalDone || 'Export ready!');
          
          setTimeout(function() {
            setFiscalExportStep(null);
          }, 2000);
        }, 800);
      }, 800);
    }, 800);
  };
  
  var generatePdfReport = function() {
    setExportLoading("pdf");
    var trades = filterTradesByPeriod(activeClosed, exportPeriod, exportStart, exportEnd);
    var totalR = trades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
    var wins = trades.filter(function(tr) { return (tr.r || 0) > 0; }).length;
    var wr = trades.length > 0 ? (wins / trades.length * 100).toFixed(1) : 0;
    var pf = (function() {
      var g = trades.filter(function(tr) { return (tr.r || 0) > 0; }).reduce(function(s, tr) { return s + tr.r; }, 0);
      var l = Math.abs(trades.filter(function(tr) { return (tr.r || 0) < 0; }).reduce(function(s, tr) { return s + tr.r; }, 0));
      return l > 0 ? (g / l).toFixed(2) : g > 0 ? "‚àû" : "0";
    })();
    var html = "<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Trinity Report</title><style>html,body{overflow-x:hidden;overflow-y:visible} body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}h1{color:#22c55e;border-bottom:2px solid #22c55e;padding-bottom:10px}h2{color:#64748b;margin-top:30px}.stat{display:inline-block;background:#f1f5f9;padding:15px 25px;margin:5px;border-radius:10px;text-align:center}.stat-value{font-size:24px;font-weight:bold;color:#1e293b}.stat-label{font-size:12px;color:#64748b}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:10px;text-align:left;border-bottom:1px solid #e2e8f0}th{background:#f8fafc}.win{color:#22c55e}.loss{color:#ef4444}</style></head><body>";
    html += "<h1>üî± Trinity Bot - Performance Report</h1>";
    html += "<p>Generated: " + new Date().toLocaleString() + "</p>";
    html += "<h2>Summary</h2>";
    html += "<div class=\"stat\"><div class=\"stat-value\">" + trades.length + "</div><div class=\"stat-label\">Trades</div></div>";
    html += "<div class=\"stat\"><div class=\"stat-value\">" + totalR.toFixed(2) + "R</div><div class=\"stat-label\">Total R</div></div>";
    html += "<div class=\"stat\"><div class=\"stat-value\">" + wr + "%</div><div class=\"stat-label\">Win Rate</div></div>";
    html += "<div class=\"stat\"><div class=\"stat-value\">" + pf + "</div><div class=\"stat-label\">Profit Factor</div></div>";
    html += "<h2>Trade History</h2><table><tr><th>Date</th><th>Symbol</th><th>Side</th><th>R</th><th>PnL</th></tr>";
    trades.slice(0, 50).forEach(function(tr) {
      var cls = (tr.r || 0) >= 0 ? "win" : "loss";
      html += "<tr><td>" + (tr.exitTime || tr.entryTime || "").slice(0, 10) + "</td><td>" + tr.symbol + "</td><td>" + tr.side + "</td><td class=\"" + cls + "\">" + (tr.r || 0).toFixed(2) + "R</td><td class=\"" + cls + "\">$" + (tr.pnl || 0).toFixed(2) + "</td></tr>";
    });
    html += "</table>";
    if (trades.length > 50) html += "<p><em>Showing first 50 trades...</em></p>";
    html += "</body></html>";
    var blob = new Blob([html], {type: "text/html"});
    var link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "trinity_report_" + new Date().toISOString().slice(0,10) + ".html";
    link.click();
    setExportLoading(null);
    notify("success", t.exportSuccess);
  };

  var fetchAll = useCallback(function() {
    return fetch(CONFIG.API_BASE_URL + '/status')
      .then(function(r) { return r.json(); })
      .then(function(status) {
        setBot({
          running: status.running || false,
          mode: status.mode || 'LIVE',
          regime: status.regime || 'RANGE',
          onchain_regime: status.onchain_regime || 'NEUTRAL',
          onchain_score: status.onchain_score || 0,
          onchain_enabled: status.onchain_enabled || false,
          apiWeight: status.apiWeight || 0,
          system: {
            cpu: status.cpu || status.cpu_percent || 0,
            memoryPercent: status.memory_percent || status.mem_percent || 0,
            memoryUsed: status.memory_used || 0,
            memoryTotal: status.memory_total || 0,
            diskPercent: status.disk_percent || 0,
            diskUsed: status.disk_used || 0,
            diskTotal: status.disk_total || 0,
            uptime: status.uptime || status.uptime_seconds || 0,
            version: status.version || status.bot_version || 'v1.0.0',
            container: status.container || 'crypto-bot',
            latency: status.latency || status.ping || 0
          }
        });
        setConnected(true);
        setConnError(null);
        if (status.wallet_address) setWallet(status.wallet_address);
        
        return Promise.all([
          fetchApi('/api/stats').catch(function() { return null; }),
          fetchApi('/api/trades').catch(function() { return []; }),
          fetchApi('/api/capital-events').catch(function() { return null; }),  // üÜï V10.10.2: Fetch together
          fetchApi('/api/positions').catch(function() { return []; })  // üÜï V17.2: Live positions with targets
        ]).then(function(results) {
          var statsData = results[0];
          var tradesData = results[1];
          var capitalData = results[2];  // üÜï V10.10.2
          var positionsData = results[3] || [];  // üÜï V17.2: Live positions
          
          // üÜï V10.10.2: Update capitalEvents state immediately
          var currentCapitalEvents = {
            total_deposits: 0,
            total_withdrawals: 0,
            net_cash_flow: 0,
            events: [],
            trading_pnl: null,
            trading_roi: null,
            initial_balance: null
          };
          
          if (capitalData && !capitalData.error && capitalData.capital_events) {
            currentCapitalEvents = {
              total_deposits: capitalData.capital_events.total_deposits || 0,
              total_withdrawals: capitalData.capital_events.total_withdrawals || 0,
              net_cash_flow: capitalData.capital_events.net_cash_flow || 0,
              events: capitalData.capital_events.events || [],
              trading_pnl: capitalData.normalized_stats ? capitalData.normalized_stats.trading_pnl : null,
              trading_roi: capitalData.normalized_stats ? capitalData.normalized_stats.trading_roi : null,
              initial_balance: capitalData.normalized_stats ? capitalData.normalized_stats.initial_balance : null
            };
            setCapitalEvents(currentCapitalEvents);
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // üßÆ V10.10.2 - 1R = 1R (toujours)
          // Le R de chaque trade est calcul√© avec la balance AU MOMENT DU TRADE
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          var balance = (statsData && statsData.balance) || status.balance || 0;
          
          // üÜï V10.10.2 SIMPLIFIED: Calculer initialBalance directement
          // Formula: Initial = Current - TradingPnL - NetCashFlow
          var tradingPnlFromBackend = currentCapitalEvents.trading_pnl;
          var netCashFlow = currentCapitalEvents.net_cash_flow || 0;
          
          var initialBalance;
          if (tradingPnlFromBackend !== null && tradingPnlFromBackend !== undefined) {
            // M√©thode fiable: calculer depuis les capital events
            initialBalance = balance - tradingPnlFromBackend - netCashFlow;
          } else {
            // Fallback: utiliser le backend initial_balance
            initialBalance = currentCapitalEvents.initial_balance || 
                            (statsData && statsData.initial_balance) || 
                            status.initial_balance || 
                            balance;
          }
          
          // Sanity check
          if (initialBalance <= 0 || initialBalance > balance * 2) {
            initialBalance = balance;
          }
          
          // riskUnit pour les positions ouvertes (bas√© sur balance actuelle)
          var riskUnit = balance > 0 ? balance * 0.01 : 1;
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // √âTAPE 2: NETTOYER TOUS LES TRADES √Ä LA SOURCE
          // üÜï V10.10.2: Calculer le R avec la balance AU MOMENT de chaque trade
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          var cleanedTrades = [];
          if (Array.isArray(tradesData)) {
            // D'abord, trier les trades par date de cl√¥ture pour calculer la balance progressive
            var sortedForR = tradesData.slice().sort(function(a, b) {
              var dateA = new Date(a.exit_time || a.entry_time || 0);
              var dateB = new Date(b.exit_time || b.entry_time || 0);
              return dateA - dateB;
            });
            
            // Calculer la balance et le R pour chaque trade chronologiquement
            var runningBalance = initialBalance;
            var tradeRMap = {}; // Map trade id -> calculated R
            
            sortedForR.forEach(function(tr) {
              var tradePnl = tr.pnl_usd || tr.pnl || tr.realized_pnl || tr.closed_pnl || 0;
              var isOpen = tr.status === 'open' || !tr.exit_time;
              
              // V17.1: Use DB r_multiple (from SL distance) for closed trades
              var tradeR;
              var dbR = parseFloat(tr.r_multiple || 0);
              if (!isOpen && dbR !== 0) {
                tradeR = dbR; // Use DB value (based on initial SL distance)
              } else {
                var riskUnitAtTrade = runningBalance > 0 ? runningBalance * 0.01 : 1;
                tradeR = tradePnl / riskUnitAtTrade; // Fallback for open/legacy
              }
              
              tradeRMap[tr.id || tr.hash || (tr.entry_time + '_' + tr.symbol)] = tradeR;
              
              // Mettre √† jour la balance pour le prochain trade (seulement si ferm√©)
              if (!isOpen) {
                runningBalance += tradePnl;
              }
            });
            
            // Maintenant, mapper tous les trades avec leur R correct
            // üÜï V17.2: Merge live positions data (targets, live SL) into open trades
            var posMap = {};
            if (Array.isArray(positionsData)) {
              positionsData.forEach(function(p) {
                if (p.symbol) posMap[p.symbol] = p;
              });
            }
            tradesData.forEach(function(tr) {
              if (tr.status === 'open' && tr.symbol && posMap[tr.symbol]) {
                var livePos = posMap[tr.symbol];
                if (Array.isArray(livePos.targets) && livePos.targets.length > 0) {
                  tr.targets = livePos.targets;
                }
                tr.live_stop_loss = livePos.stop_loss;
                tr.srs_phase = livePos.srs_phase || 0;
                if (livePos.initial_stop_loss) tr.initial_stop_loss = livePos.initial_stop_loss;
                if (!tr.current_price && livePos.current_price) tr.current_price = livePos.current_price;
              }
            });
            cleanedTrades = tradesData.map(function(tr, i) {
              // Calculate duration
              var duration = '--';
              if (tr.entry_time && tr.exit_time) {
                var diffMs = new Date(tr.exit_time) - new Date(tr.entry_time);
                var diffMins = Math.floor(diffMs / 60000);
                var diffHours = Math.floor(diffMins / 60);
                var diffDays = Math.floor(diffHours / 24);
                if (diffDays > 0) duration = diffDays + 'd ' + (diffHours % 24) + 'h';
                else if (diffHours > 0) duration = diffHours + 'h ' + (diffMins % 60) + 'm';
                else duration = diffMins + 'm';
              }
              
              // üßÆ √âCRASEMENT DU R - PnL USD / riskUnit (1% du capital)
              // üÜï V10.4: Use 'pnl_usd' as PRIMARY field (confirmed from DB debug)
              var tradePnl = tr.pnl_usd || tr.pnl || tr.realized_pnl || tr.closed_pnl || 0;
              
              // üí≥ V4.1 - Extract fees from trade OR estimate from volume
              // Exchange fees: ~0.035% taker, estimate 0.04% per side = 0.08% round trip
              var backendFee = Math.abs(tr.fee || tr.commission || tr.fee_usd || tr.fees || tr.trading_fee || tr.realized_fee || 0);
              
              // üÜï V10.4 FIX: Use 'quantity' as PRIMARY field (confirmed from DB debug)
              var tradeSize = tr.quantity || tr.size || tr.sz || tr.qty || tr.amount || 0;
              
              var entryPrice = tr.entry_price || 0;
              var exitPrice = tr.exit_price || tr.current_price || entryPrice;
              
              // üÜï V10.4: Calculate NOTIONAL VOLUME = Entry Volume + Exit Volume
              var entryVolume = entryPrice * tradeSize;
              var exitVolume = (tr.status !== 'open' && exitPrice > 0) ? (exitPrice * tradeSize) : 0;
              var tradeVolume = tr.notional_volume || tr.volume || (entryVolume + exitVolume);
              
              var HYPERLIQUID_FEE_RATE = 0.00045; // 0.045% taker fee per side
              var estimatedFee = tradeVolume * HYPERLIQUID_FEE_RATE;
              
              // Use backend fee if available, otherwise use estimate
              var tradeFee = backendFee > 0 ? backendFee : estimatedFee;
              
              // üí∞ V4.0 - Net PnL (after fees) - if pnl doesn't already include fees
              var netPnl = tradePnl; // Assume pnl already includes fees by default
              
              // V17.1: Use tr.r from API (already enriched with DB r_multiple)
              var isOpen = tr.status === 'open' || !tr.exit_time;
              var realR;
              if (!isOpen && tr.r && Math.abs(tr.r) > 0.001) {
                realR = tr.r; // API already set this from DB r_multiple
              } else if (isOpen) {
                var currentRiskUnit = balance > 0 ? balance * 0.01 : 1;
                realR = tradePnl / currentRiskUnit;
              } else {
                var tradeKey = tr.id || tr.hash || (tr.entry_time + '_' + tr.symbol);
                realR = tradeRMap[tradeKey] || 0;
              }
              
              return {
                id: tr.id || i,
                symbol: tr.symbol || 'BTC',
                side: tr.side || 'LONG',
                entryPrice: tr.entry_price || 0,
                exitPrice: tr.exit_price || null,
                currentPrice: tr.current_price || tr.exit_price || tr.entry_price || 0,
                pnl: tradePnl,
                pnlPercent: tr.pnl_percent || tr.pnl_pct || ((tr.current_price && tr.entry_price) ? ((tr.current_price - tr.entry_price) / tr.entry_price * 100 * (tr.side === 'SHORT' ? -1 : 1)) : 0),
                r: realR, // üßÆ RECALCUL√â: PnL / (1% Capital)
                entryTime: ensureUTC(tr.entry_time || tr.opened_at || ''),
                exitTime: ensureUTC(tr.exit_time || tr.closed_at || ''),
                status: tr.status || 'closed',
                // üîÑ V4.3 - Regime with multiple fallbacks
                regime: tr.regime || tr.market_regime || tr.trend || tr.market_trend || tr.condition || null,
                score: tr.trinity_score || tr.setup_score || tr.score || (tr.entry_data && tr.entry_data.score) || (tr.signal && tr.signal.score) || null,
                confidence: tr.confidence || 85,
                isLive: true,
                signalLevel: tr.signal_level || tr.signalLevel || null,
                channelSignal: tr.channel_signal || tr.channelSignal || 0,
                gapDetected: tr.gapDetected || tr.has_gap || false,
                confluence: tr.confluence || 3,
                duration: duration,
                stopLoss: tr.stop_loss || 0,
                initialStopLoss: tr.initial_stop_loss || tr.stop_loss || 0,
                takeProfit: tr.take_profit || 0,
                targets: tr.targets || [],  // üÜï V17.2: All TP levels
                liveStopLoss: tr.live_stop_loss || tr.stop_loss || 0,  // üÜï V17.2: Live SL (may be BE/trailing)
                srsPhase: tr.srs_phase || 0,  // üîÑ SRS phase for TP counter
                // üßÆ V3.7 - Size & Leverage for accurate PnL calculation
                // üÜï V10.3: Use same fallback logic as volume calculation
                size: tradeSize,
                leverage: tr.leverage || 1,
                // üí≥ V4.1 - Fee tracking (real or estimated)
                fee: tradeFee,
                feeEstimated: backendFee === 0 && estimatedFee > 0, // Flag if estimated
                volume: tradeVolume,
                entryReason: tr.entry_reason || tr.setup_type || '',
                exitReason: tr.exit_reason || ''
              };
            });
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // √âTAPE 3: S√âPARER TRADES OUVERTS ET FERM√âS
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          var closedTrades = cleanedTrades.filter(function(tr) { return tr.status !== 'open'; });
          var openTrades = cleanedTrades.filter(function(tr) { return tr.status === 'open'; });
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // üßÆ V3.8 - CALCULATRICE DE STATS FRONTEND (ignore backend stats)
          // Calcule TOUT depuis les trades nettoy√©s pour coh√©rence totale
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          var calcWins = 0;
          var calcLosses = 0;
          var calcBreakEven = 0;
          var calcTotalPnl = 0;
          var calcWinPnl = 0;
          var calcLossPnl = 0;
          var calcTotalR = 0;
          var calcWinR = 0;
          var calcLossR = 0;
          var calcCurrentStreak = 0;
          var calcBestStreak = 0;
          var tempStreak = 0;
          
          // üìâ V10.11 - Drawdown from trade history (survives bot restart)
          var calcPeakBal = initialBalance;
          var calcRunningBal = initialBalance;
          var calcMaxDD = 0;

          // üí≥ V4.1 - Fee & Volume tracking
          var calcTotalFees = 0;
          var calcTotalVolume = 0;
          var feesAreEstimated = false;
          
          // Calcul today/week/month
          var now = new Date();
          var todayStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
          var weekStart = new Date(now - 7 * 24 * 60 * 60 * 1000);
          var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          var calcPnlToday = 0;
          var calcPnlWeek = 0;
          var calcPnlMonth = 0;
          var calcRToday = 0;  // üÜï V10.10.2: Accumulate R (not recalculate)
          var calcRWeek = 0;
          var calcRMonth = 0;
          var calcTradesToday = 0;
          var calcFeesToday = 0;
          
          // Trier par date pour calcul streak correct
          var sortedClosed = closedTrades.slice().sort(function(a, b) {
            return new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime);
          });

          // üìâ V10.12 - Prepare capital events for injection into equity curve
          var capEvents = (currentCapitalEvents.events || []).slice().sort(function(a, b) {
            return new Date(a.timestamp) - new Date(b.timestamp);
          });
          var capIdx = 0;

          sortedClosed.forEach(function(tr) {
            var pnl = tr.pnl || 0;
            var r = tr.r || 0;
            var fee = tr.fee || 0; // üí≥ V4.1
            var volume = tr.volume || 0;

            // Track if fees are estimated
            if (tr.feeEstimated) feesAreEstimated = true;

            // üìâ V10.12 - Inject capital events that occurred before this trade
            var tradeTime = new Date(tr.exitTime || tr.entryTime);
            while (capIdx < capEvents.length && new Date(capEvents[capIdx].timestamp) <= tradeTime) {
              var ce = capEvents[capIdx];
              var ceAmount = Math.abs(parseFloat(ce.amount) || 0);
              if (ce.type === 'deposit') {
                calcRunningBal += ceAmount;
                if (calcRunningBal > calcPeakBal) calcPeakBal = calcRunningBal;
              } else if (ce.type === 'withdrawal') {
                var wRatio = calcPeakBal > 0 ? ceAmount / calcPeakBal : 0;
                calcRunningBal -= ceAmount;
                calcPeakBal -= calcPeakBal * wRatio; // Scale peak proportionally
              }
              capIdx++;
            }

            // üßÆ V3.9 - STRICT MODE: Seuil $0.05 pour win/loss
            // Trades entre -$0.05 et +$0.05 = Break-Even (pas compt√©s dans W/L)
            var STRICT_THRESHOLD = 0.05;

            if (pnl > STRICT_THRESHOLD) { // WIN (> +$0.05)
              calcWins++;
              calcWinPnl += pnl;
              calcWinR += r;
              tempStreak = tempStreak >= 0 ? tempStreak + 1 : 1;
            } else if (pnl < -STRICT_THRESHOLD) { // LOSS (< -$0.05)
              calcLosses++;
              calcLossPnl += Math.abs(pnl);
              calcLossR += Math.abs(r);
              tempStreak = tempStreak <= 0 ? tempStreak - 1 : -1;
            } else { // BREAK-EVEN (entre -$0.05 et +$0.05)
              calcBreakEven++;
              // Break-even ne casse pas la s√©rie
            }

            calcTotalPnl += pnl;
            calcTotalR += r;
            calcTotalFees += fee; // üí≥ V4.1 - Accumulate fees
            calcTotalVolume += volume; // üí≥ V4.1 - Accumulate volume

            // üìâ V10.11 - Equity curve for drawdown
            calcRunningBal += pnl;
            if (calcRunningBal > calcPeakBal) calcPeakBal = calcRunningBal;
            var ddPct = calcPeakBal > 0 ? (calcPeakBal - calcRunningBal) / calcPeakBal * 100 : 0;
            if (ddPct > calcMaxDD) calcMaxDD = ddPct;

            // Track best win streak
            if (tempStreak > 0 && tempStreak > calcBestStreak) {
              calcBestStreak = tempStreak;
            }
            
            // Calcul p√©riodes (today/week/month)
            var tradeDate = new Date(tr.exitTime || tr.entryTime);
            if (tradeDate >= todayStart) {
              calcPnlToday += pnl;
              calcRToday += r;  // üÜï V10.10.2: Accumulate R
              calcTradesToday++;
              calcFeesToday += fee; // üí≥ V4.0
            }
            if (tradeDate >= weekStart) {
              calcPnlWeek += pnl;
              calcRWeek += r;  // üÜï V10.10.2: Accumulate R
            }
            if (tradeDate >= monthStart) {
              calcPnlMonth += pnl;
              calcRMonth += r;  // üÜï V10.10.2: Accumulate R
            }
          });
          
          // üí≥ V4.1 - Add fees for OPEN positions (entry fee only, exit pending)
          openTrades.forEach(function(tr) {
            var fee = tr.fee || 0;
            var volume = tr.volume || 0;
            if (tr.feeEstimated) feesAreEstimated = true;
            // For open positions, we only paid entry fee so far (half of round-trip)
            calcTotalFees += fee / 2;
            calcTotalVolume += volume;
          });
          
          calcCurrentStreak = tempStreak;
          var trueTotalTrades = closedTrades.length;
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // √âTAPE 4: CONSTRUIRE LES STATS 100% FRONTEND
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          
          // üßÆ V3.9 - Win Rate STRICT (W/L seulement, BE exclus)
          var tradesPourWR = calcWins + calcLosses; // Exclut break-even
          var calcWinRate = tradesPourWR > 0 ? (calcWins / tradesPourWR * 100) : 0;
          
          // Profit Factor (Gains / Pertes en USD)
          var calcProfitFactor = calcLossPnl > 0.05 
            ? (calcWinPnl / calcLossPnl) 
            : (calcWinPnl > 0 ? 99 : 0);
          
          // R-based metrics
          var calcAvgR = trueTotalTrades > 0 ? calcTotalR / trueTotalTrades : 0;
          var calcExpectancy = calcAvgR;
          
          // Today/Week/Month R
          // üÜï V10.10.2: Utiliser les R accumul√©s, pas recalcul√©s
          var calcTodayR = calcRToday;
          var calcWeekR = calcRWeek;
          var calcMonthR = calcRMonth;
          
          if (statsData) {
            // üÜï V10.10.2: Utiliser le m√™me initialBalance calcul√© plus haut
            var initialBal = initialBalance;
            
            // üÜï V10.10: Check if backend detected a capital event
            if (statsData.capital_event_detected && statsData.capital_event_detected.detected) {
              var ce = statsData.capital_event_detected;
              var isDeposit = ce.event_type === 'deposit';
              var notifMsg = (isDeposit ? 'üì• ' : 'üì§ ') + 
                (isDeposit ? (lang === 'fr' ? 'D√©p√¥t d√©tect√©' : 'Deposit detected') : (lang === 'fr' ? 'Retrait d√©tect√©' : 'Withdrawal detected')) +
                ': $' + ce.amount.toFixed(2);
              
              // Add notification
              setNotifs(function(prev) {
                return prev.concat([{
                  id: Date.now(),
                  type: isDeposit ? 'info' : 'warning',
                  message: notifMsg,
                  time: new Date()
                }]);
              });
              
              // Refresh capital events data
              fetchApi('/api/capital-events')
                .then(function(data) {
                  if (data && !data.error && data.capital_events) {
                    setCapitalEvents({
                      total_deposits: data.capital_events.total_deposits || 0,
                      total_withdrawals: data.capital_events.total_withdrawals || 0,
                      net_cash_flow: data.capital_events.net_cash_flow || 0,
                      events: data.capital_events.events || [],
                      trading_pnl: data.normalized_stats ? data.normalized_stats.trading_pnl : null,
                      trading_roi: data.normalized_stats ? data.normalized_stats.trading_roi : null,
                      initial_balance: data.normalized_stats ? data.normalized_stats.initial_balance : null  // üÜï V10.10.2
                    });
                  }
                });
            }
            
            // üìâ V10.11 - Drawdown calcul√© 100% frontend depuis trade history
            // Plus besoin du backend (peak_balance se perd au restart)
            var currentDD = calcPeakBal > 0 ? (calcPeakBal - calcRunningBal) / calcPeakBal * 100 : 0;
            var maxDD = calcMaxDD;
            
            setStats({
              // Balance (backend - c'est la source de v√©rit√©)
              balance: balance,
              initialBalance: initialBal,
              
              // üßÆ V3.8 - PnL calcul√© depuis trades
              totalPnl: calcTotalPnl,
              totalPnlPercent: initialBal > 0 ? (calcTotalPnl / initialBal * 100) : 0,
              
              // üßÆ V3.8 - Win Rate calcul√© depuis trades (exclut BE)
              winRate: calcWinRate,
              totalTrades: trueTotalTrades,
              wins: calcWins,
              losses: calcLosses,
              breakEven: calcBreakEven,
              
              // üßÆ V3.8 - Profit Factor calcul√© depuis trades
              profitFactor: calcProfitFactor,
              
              // üìâ V10.11 - Drawdown (frontend, from trade history)
              maxDrawdown: maxDD,
              currentDrawdown: currentDD,
              
              // üßÆ V3.8 - R metrics calcul√©s depuis trades
              totalR: calcTotalR,
              avgR: calcAvgR,
              expectancy: calcExpectancy,
              rPerWeek: calcWeekR > 0 ? calcWeekR : 0,
              
              // üßÆ V3.8 - Today/Week/Month calcul√©s depuis trades
              todayR: calcTodayR,
              weekR: calcWeekR,
              monthR: calcMonthR,
              pnlToday: calcPnlToday,
              tradesToday: calcTradesToday,
              
              // üßÆ V3.8 - Streaks calcul√©s depuis trades
              currentStreak: calcCurrentStreak,
              bestStreak: calcBestStreak,
              
              // üí≥ V4.1 - Fees tracking (with estimation support)
              totalFees: calcTotalFees,
              feesToday: calcFeesToday,
              feesAreEstimated: feesAreEstimated,
              totalVolume: calcTotalVolume,
              
              // Backend metrics (n√©cessitent historique complet)
              sharpeRatio: statsData.sharpe_ratio || 0,
              recoveryFactor: statsData.recovery_factor || 0,
              
              // Risk unit for reference
              riskUnit: riskUnit
            });
          }
          
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // √âTAPE 5: DISTRIBUER LES TRADES NETTOY√âS AUX COMPOSANTS
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          setOpenPos(openTrades);
          setTrades(closedTrades);
          setLastUpdate(new Date());
        });
      })
      .catch(function(err) {
        console.error('Fetch error:', err);
        setConnected(false);
        setConnError(err.message);
        setOpenPos([]);
        setTrades([]);
      });
  }, []);

  var connectWS = useCallback(function() {
    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) return;
    var wsUrl = CONFIG.API_BASE_URL.replace('http', 'ws') + '/ws';
    try {
      wsRef.current = new WebSocket(wsUrl);
      wsRef.current.onopen = function() { wsRetries.current = 0; };
      wsRef.current.onmessage = function(e) {
        try {
          var d = JSON.parse(e.data);
          if (d.type === 'LOG') {
            setLogs(function(p) { return [{ts:d.timestamp||new Date().toISOString(),lvl:d.level||'INFO',msg:d.message||d.msg||''}].concat(p).slice(0,300); });
            // Auto-scroll: newest logs are at top, so scroll to 0
            if (!window._logsPaused) {
              setTimeout(function(){ var el=document.getElementById('live-logs'); if(el) el.scrollTop=0; },30);
            }
          } else if (d.type === 'TRADE') {
            fetchAll();
          }
        } catch(err) {
          setLogs(function(p) { return [{ts:new Date().toISOString(),lvl:'INFO',msg:e.data}].concat(p).slice(0,300); });
        }
      };
      wsRef.current.onerror = function(evt) { console.error('WS error event:', evt); setConnected(false); };
      wsRef.current.onclose = function() { setConnected(false); var delay=Math.min(5000*Math.pow(2,Math.min(wsRetries.current||0,10)),60000); wsRetries.current=(wsRetries.current||0)+1; setTimeout(connectWS, delay); };
    } catch(err) { console.error('WS error:', err); }
  }, [fetchAll]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï V2.0 COMMAND CENTER: HIP-3 Data Fetching (mirrors fetchAll for crypto)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var hip3WsRef = useRef(null);
  var hip3WsRetries = useRef(0);

  var fetchAllHip3 = useCallback(function() {
    return fetch(CONFIG.HIP3_API_BASE_URL + '/status')
      .then(function(r) { return r.json(); })
      .then(function(status) {
        setHip3Bot({
          running: status.running || false,
          mode: status.mode || 'LIVE',
          regime: status.regime || 'RANGE',
          market_open: status.market_open || false,
          apiWeight: status.apiWeight || 0,
          system: {
            cpu: status.cpu || status.cpu_percent || 0,
            memoryPercent: status.memory_percent || status.mem_percent || 0,
            diskPercent: status.disk_percent || 0,
            uptime: status.uptime || status.uptime_seconds || 0,
            version: status.version || status.bot_version || 'v1.0.0',
            container: status.container || 'stocks-bot'
          }
        });
        setHip3Connected(true);
        if (status.wallet_address) setHip3Wallet(status.wallet_address);

        return Promise.all([
          fetchHip3Api('/api/stats').catch(function() { return null; }),
          fetchHip3Api('/api/trades').catch(function() { return []; }),
          fetchHip3Api('/api/positions').catch(function() { return []; })
        ]).then(function(results) {
          var statsData = results[0];
          var tradesData = results[1];
          var positionsData = results[2] || [];

          if (statsData) {
            var h3balance = statsData.balance || status.balance || 0;
            var h3riskUnit = h3balance > 0 ? h3balance * 0.01 : 1;
            // V2.3: Calculate total volume from trades data
            var h3Volume = 0;
            if (Array.isArray(tradesData)) {
              tradesData.forEach(function(t) {
                h3Volume += (t.notional_volume || Math.abs(t.entry_price || 0) * Math.abs(t.quantity || t.size || 0) * 2);
              });
            }
            setHip3Stats({
              balance: h3balance,
              initialBalance: statsData.initial_balance || h3balance,
              totalPnl: statsData.total_pnl || 0,
              totalPnlPercent: h3balance > 0 ? ((statsData.total_pnl || 0) / h3balance * 100) : 0,
              winRate: statsData.win_rate || 0,
              totalTrades: statsData.total_trades || 0,
              wins: statsData.wins || 0,
              losses: statsData.losses || 0,
              profitFactor: statsData.profit_factor || 0,
              maxDrawdown: statsData.max_drawdown || 0,
              currentDrawdown: statsData.current_drawdown || 0,
              totalR: statsData.total_r || 0,
              avgR: statsData.avg_r || 0,
              rPerWeek: statsData.r_per_week || 0,
              todayR: statsData.r_today || (statsData.pnl_today ? (statsData.pnl_today / h3riskUnit) : 0),
              weekR: statsData.r_week || 0,
              monthR: statsData.r_month || 0,
              currentStreak: statsData.current_streak || 0,
              bestStreak: statsData.best_streak || 0,
              expectancy: statsData.expectancy || 0,
              asset_type: 'HIP-3 Stocks',
              setup_breakdown: statsData.setup_breakdown || {},
              pnl_today: statsData.pnl_today || 0,
              trades_today: statsData.trades_today || 0,
              riskUnit: h3riskUnit,
              totalVolume: h3Volume,
              totalFees: statsData.total_fees || 0
            });
          }

          // Clean HIP-3 trades (simplified ‚Äî no capital events for HIP-3)
          if (Array.isArray(tradesData)) {
            var h3Balance = (statsData && statsData.balance) || status.balance || 0;
            var h3Open = [];
            var h3Closed = [];
            var h3CalcTotalFees = 0;
            var H3_FEE_RATE = 0.00045; // 0.045% taker fee per side
            // Merge positions data into open trades
            var h3PosMap = {};
            if (Array.isArray(positionsData)) {
              positionsData.forEach(function(p) { if (p.symbol) h3PosMap[p.symbol] = p; });
            }
            tradesData.forEach(function(tr) {
              var isOpen = tr.status === 'open' || !tr.exit_time;
              // V2.3: Cross-check ‚Äî if trade is "open" but NOT on exchange, override to closed
              if (isOpen && positionsData.length > 0 && tr.symbol && !h3PosMap[tr.symbol]) {
                isOpen = false;
              }
              if (isOpen && tr.symbol && h3PosMap[tr.symbol]) {
                var livePos = h3PosMap[tr.symbol];
                if (Array.isArray(livePos.targets) && livePos.targets.length > 0) {
                  tr.targets = livePos.targets;
                }
                tr.live_stop_loss = livePos.stop_loss;
                tr.srs_phase = livePos.srs_phase || 0;
                if (livePos.initial_stop_loss) tr.initial_stop_loss = livePos.initial_stop_loss;
                if (!tr.current_price && livePos.current_price) tr.current_price = livePos.current_price;
              }
              var tradePnl = tr.pnl_usd || tr.pnl || 0;
              var tradeR = tr.r_multiple || tr.r || (tradePnl / (h3Balance > 0 ? h3Balance * 0.01 : 1));
              var h3EntryP = tr.entry_price || 0;
              var h3ExitP = tr.exit_price || tr.current_price || 0;
              var h3Side = tr.side || 'LONG';
              var h3PnlPct = tr.pnl_percent || (h3EntryP > 0 && h3ExitP > 0 ? ((h3ExitP - h3EntryP) / h3EntryP * 100 * (h3Side === 'SHORT' ? -1 : 1)) : 0);
              // Fee estimation from notional volume (same logic as crypto)
              var h3Size = tr.quantity || tr.size || 0;
              var h3EntryVol = h3EntryP * h3Size;
              var h3ExitVol = (!isOpen && h3ExitP > 0) ? (h3ExitP * h3Size) : 0;
              var h3TradeVol = tr.notional_volume || (h3EntryVol + h3ExitVol);
              var h3TradeFee = h3TradeVol * H3_FEE_RATE;
              h3CalcTotalFees += isOpen ? (h3TradeFee / 2) : h3TradeFee;
              var cleaned = {
                id: tr.id || tr.hash || (tr.entry_time + '_' + tr.symbol),
                symbol: tr.symbol || 'UNKNOWN',
                side: h3Side,
                entryPrice: h3EntryP,
                exitPrice: h3ExitP,
                currentPrice: tr.current_price || h3ExitP || h3EntryP,
                entryTime: ensureUTC(tr.entry_time || tr.opened_at || ''),
                exitTime: ensureUTC(tr.exit_time || tr.closed_at || ''),
                pnl: tradePnl,
                pnlPercent: h3PnlPct,
                r: tradeR,
                status: isOpen ? 'open' : (tradePnl >= 0.05 ? 'win' : tradePnl <= -0.05 ? 'loss' : 'breakeven'),
                isLive: true,
                source: 'hip3',
                targets: tr.targets || [],
                stop_loss: tr.live_stop_loss || tr.stop_loss,
                stopLoss: tr.stop_loss || 0,
                initialStopLoss: tr.initial_stop_loss || tr.stop_loss || 0,
                liveStopLoss: tr.live_stop_loss || tr.stop_loss || 0,
                current_price: tr.current_price,
                size: h3Size,
                leverage: 5,
                setup_type: tr.setup_type || 'TIER_BASIC',
                score: tr.score || 0,
                fee: h3TradeFee,
                feeEstimated: true,
                volume: h3TradeVol,
                signalLevel: null,
                channelSignal: 0,
                gapDetected: false,
                srsPhase: tr.srs_phase || 0
              };
              if (isOpen) h3Open.push(cleaned); else h3Closed.push(cleaned);
            });
            setHip3OpenPos(h3Open);
            setHip3Trades(h3Closed);
            // Override totalFees with frontend estimate (backend doesn't track fees)
            if (h3CalcTotalFees > 0) {
              setHip3Stats(function(prev) { return Object.assign({}, prev, {totalFees: h3CalcTotalFees}); });
            }
          }
          setLastUpdate(new Date());
        });
      })
      .catch(function(err) {
        console.log('HIP-3 fetch error:', err.message);
        setHip3Connected(false);
        setHip3OpenPos([]);
        setHip3Trades([]);
      });
  }, []);

  var connectHip3WS = useCallback(function() {
    if (hip3WsRef.current && hip3WsRef.current.readyState === WebSocket.OPEN) return;
    var wsUrl = CONFIG.HIP3_API_BASE_URL.replace('http', 'ws') + '/ws';
    try {
      hip3WsRef.current = new WebSocket(wsUrl);
      hip3WsRef.current.onopen = function() { hip3WsRetries.current = 0; };
      hip3WsRef.current.onmessage = function(e) {
        try {
          var d = JSON.parse(e.data);
          if (d.type === 'LOG') {
            setHip3Logs(function(p) { return [{ts:d.timestamp||new Date().toISOString(),lvl:d.level||'INFO',msg:d.message||d.msg||'',source:'hip3'}].concat(p).slice(0,500); });
          } else if (d.type === 'TRADE') {
            fetchAllHip3();
          }
        } catch(err) {
          setHip3Logs(function(p) { return [{ts:new Date().toISOString(),lvl:'INFO',msg:e.data,source:'hip3'}].concat(p).slice(0,500); });
        }
      };
      hip3WsRef.current.onerror = function(evt) { console.log('HIP-3 WS error event:', evt); setHip3Connected(false); };
      hip3WsRef.current.onclose = function() { setHip3Connected(false); var delay=Math.min(5000*Math.pow(2,Math.min(hip3WsRetries.current||0,10)),60000); hip3WsRetries.current=(hip3WsRetries.current||0)+1; setTimeout(connectHip3WS, delay); };
    } catch(err) { console.log('HIP-3 WS error:', err); }
  }, [fetchAllHip3]);

  // V2.3: Expose refresh for pull-to-refresh
  window._refreshAll = function(){ fetchAll(); fetchAllHip3(); };

  useEffect(function() {
    fetchAll().then(function() { setLoading(false); });
    connectWS();
    // üÜï V2.0: Also fetch HIP-3 data
    fetchAllHip3();
    connectHip3WS();
    var interval = setInterval(fetchAll, (settings.refreshInterval || 5) * 1000);
    var hip3Interval = setInterval(fetchAllHip3, (settings.refreshInterval || 5) * 1000);
    
    // Fetch services status every 30 seconds
    var fetchServices = function() {
      fetchApi('/api/services')
        .then(function(data) {
          setServices({
            postgres: data.postgres && data.postgres.status === 'connected',
            redis: data.redis && data.redis.status === 'connected',
            hyperliquid: data.hyperliquid && data.hyperliquid.status === 'connected',
            discord: true // Discord status comes from bot state
          });
        })
        .catch(function() {
          // Keep current state on error
        });
    };
    
    // Fetch network latency every 15 seconds
    var fetchLatency = function() {
      fetchApi('/api/latency')
        .then(function(data) {
          setNetworkLatency(data.latency || 0);
        })
        .catch(function() {
          setNetworkLatency(0);
        });
    };
    
    fetchServices();
    fetchLatency();
    var servicesInterval = setInterval(fetchServices, 30000);
    var latencyInterval = setInterval(fetchLatency, 15000);
    
    // üÜï V10.7: Fetch accurate stats from exchange fills
    var fetchAccurateStats = function() {
      fetchApi('/api/stats/accurate')
        .then(function(data) {
          if (data && !data.error) {
            setAccurateStats(data);
          }
        })
        .catch(function(err) {
          console.log('Accurate stats fetch error:', err);
        });
    };
    fetchAccurateStats();
    var accurateInterval = setInterval(fetchAccurateStats, 30000); // Every 30s
    
    // üÜï V10.10: Fetch capital events (deposits/withdrawals) for cash flow isolation
    var fetchCapitalEvents = function() {
      fetchApi('/api/capital-events')
        .then(function(data) {
          if (data && !data.error && data.capital_events) {
            setCapitalEvents({
              total_deposits: data.capital_events.total_deposits || 0,
              total_withdrawals: data.capital_events.total_withdrawals || 0,
              net_cash_flow: data.capital_events.net_cash_flow || 0,
              events: data.capital_events.events || [],
              trading_pnl: data.normalized_stats ? data.normalized_stats.trading_pnl : null,
              trading_roi: data.normalized_stats ? data.normalized_stats.trading_roi : null,
              initial_balance: data.normalized_stats ? data.normalized_stats.initial_balance : null  // üÜï V10.10.2
            });
          }
        })
        .catch(function(err) {
          console.log('Capital events fetch error:', err);
        });
    };
    fetchCapitalEvents();
    var capitalInterval = setInterval(fetchCapitalEvents, 60000); // Every 60s

    // V2.0 Analytics: fetch comparison + sessions + equity-symbols
    var fetchAnalytics = function() {
      var api = fetchApi; var hip3 = fetchHip3Api;
      var activeApi = (market === 'hip3') ? hip3 : api;
      activeApi('/api/analytics/comparison').then(function(d){ if(d && !d.error) setComparisonData(d); }).catch(function(){});
      activeApi('/api/analytics/equity-symbols').then(function(d){ if(d && !d.error) setEquitySymData(d); }).catch(function(){});
      if (market !== 'hip3') {
        api('/api/analytics/sessions').then(function(d){ if(d && !d.error) setSessionsData(d); }).catch(function(){});
      }
    };
    fetchAnalytics();
    var analyticsInterval = setInterval(fetchAnalytics, 60000);

    // Fetch crypto prices from Binance (faster) with CoinGecko fallback
    var fetchPrices = function() {
      // Try Binance first (faster)
      Promise.all([
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=ETHUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=SOLUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=LINKUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=SEIUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=DOGEUSDT').then(function(r){return r.json();}),
        fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=SUIUSDT').then(function(r){return r.json();})
      ]).then(function(results) {
        setPrices({
          BTC: parseFloat(results[0].lastPrice) || 0,
          ETH: parseFloat(results[1].lastPrice) || 0,
          SOL: parseFloat(results[2].lastPrice) || 0,
          LINK: parseFloat(results[3].lastPrice) || 0,
          SEI: parseFloat(results[4].lastPrice) || 0,
          DOGE: parseFloat(results[5].lastPrice) || 0,
          SUI: parseFloat(results[6].lastPrice) || 0,
          btcChange: parseFloat(results[0].priceChangePercent) || 0,
          ethChange: parseFloat(results[1].priceChangePercent) || 0,
          solChange: parseFloat(results[2].priceChangePercent) || 0,
          linkChange: parseFloat(results[3].priceChangePercent) || 0,
          seiChange: parseFloat(results[4].priceChangePercent) || 0,
          dogeChange: parseFloat(results[5].priceChangePercent) || 0,
          suiChange: parseFloat(results[6].priceChangePercent) || 0
        });
      }).catch(function() {
        // Fallback to CoinGecko if Binance fails
        fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,chainlink,sei-network,dogecoin,sui&vs_currencies=usd&include_24hr_change=true')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            setPrices({
              BTC: data.bitcoin ? data.bitcoin.usd : 0,
              ETH: data.ethereum ? data.ethereum.usd : 0,
              SOL: data.solana ? data.solana.usd : 0,
              LINK: data.chainlink ? data.chainlink.usd : 0,
              SEI: data['sei-network'] ? data['sei-network'].usd : 0,
              DOGE: data.dogecoin ? data.dogecoin.usd : 0,
              SUI: data.sui ? data.sui.usd : 0,
              btcChange: data.bitcoin ? data.bitcoin.usd_24h_change : 0,
              ethChange: data.ethereum ? data.ethereum.usd_24h_change : 0,
              solChange: data.solana ? data.solana.usd_24h_change : 0,
              linkChange: data.chainlink ? data.chainlink.usd_24h_change : 0,
              seiChange: data['sei-network'] ? data['sei-network'].usd_24h_change : 0,
              dogeChange: data.dogecoin ? data.dogecoin.usd_24h_change : 0,
              suiChange: data.sui ? data.sui.usd_24h_change : 0
            });
          })
          .catch(function(err) { console.log('Price fetch error:', err); });
      });
    };
    fetchPrices();
    var priceInterval = setInterval(fetchPrices, 15000); // Update every 15s

    // üÜï V2.0: Fetch HIP-3 stock prices from bot API
    var fetchStockPrices = function() {
      fetchHip3Api('/api/prices')
        .then(function(data) {
          if (data && data.prices) setStockPrices(data.prices);
        }).catch(function(err){ console.log('Stock price fetch error:', err.message); });
    };
    fetchStockPrices();
    var stockPriceInterval = setInterval(fetchStockPrices, 10000); // 10s for live cursor

    return function() {
      clearInterval(interval);
      clearInterval(hip3Interval); // üÜï V2.0
      clearInterval(priceInterval);
      clearInterval(stockPriceInterval); // üÜï V2.0
      clearInterval(servicesInterval);
      clearInterval(latencyInterval);
      clearInterval(accurateInterval);
      clearInterval(capitalInterval); // üÜï V10.10: Capital events cleanup
      clearInterval(analyticsInterval); // V2.0 Analytics
      if (wsRef.current) wsRef.current.close();
      if (hip3WsRef.current) hip3WsRef.current.close(); // üÜï V2.0
    };
  }, [fetchAll, connectWS, fetchAllHip3, connectHip3WS]);

  // V2.0: Refetch analytics when market changes
  useEffect(function() {
    var api = fetchApi; var hip3 = fetchHip3Api;
    var activeApi = (market === 'hip3') ? hip3 : api;
    activeApi('/api/analytics/comparison').then(function(d){ if(d && !d.error) setComparisonData(d); }).catch(function(){});
    activeApi('/api/analytics/equity-symbols').then(function(d){ if(d && !d.error) setEquitySymData(d); }).catch(function(){});
    if (market !== 'hip3') {
      api('/api/analytics/sessions').then(function(d){ if(d && !d.error) setSessionsData(d); }).catch(function(){});
    } else {
      setSessionsData(null);
    }
  }, [market]);

  // Monitor data fetching
  useEffect(function() {
    function fetchMonitorData() {
      Promise.all([
        fetch(CONFIG.MONITOR_API_URL + '/api/monitor/status').then(function(r){return r.json();}).catch(function(){return null;}),
        fetch(CONFIG.MONITOR_API_URL + '/api/monitor/alerts?limit=20').then(function(r){return r.json();}).catch(function(){return [];}),
        fetch(CONFIG.MONITOR_API_URL + '/api/monitor/errors?limit=30').then(function(r){return r.json();}).catch(function(){return [];}),
        fetch(CONFIG.MONITOR_API_URL + '/api/monitor/drift').then(function(r){return r.json();}).catch(function(){return null;}),
        fetch(CONFIG.MONITOR_API_URL + '/api/monitor/hip3/drift').then(function(r){return r.json();}).catch(function(){return null;})
      ]).then(function(results) {
        if (results[0]) setMonitorStatus(results[0]);
        if (results[1]) setMonitorAlerts(results[1]);
        if (results[2]) setMonitorErrors(results[2]);
        if (results[3]) setMonitorDrift(results[3]);
        if (results[4]) setMonitorHip3Drift(results[4]);
      });
      // V2.3: Fetch services health + last scan from both bots
      var authHeaders = {headers:{'Authorization':'Basic '+btoa(CONFIG.API_USER+':'+CONFIG.API_PASS)}};
      Promise.all([
        fetch(CONFIG.API_BASE_URL+'/api/services',authHeaders).then(function(r){return r.json();}).catch(function(){return {};}),
        fetch(CONFIG.HIP3_API_BASE_URL+'/api/services',authHeaders).then(function(r){return r.json();}).catch(function(){return {};}),
        fetch(CONFIG.API_BASE_URL+'/api/last_scan',authHeaders).then(function(r){return r.json();}).catch(function(){return null;}),
        fetch(CONFIG.HIP3_API_BASE_URL+'/api/last_scan',authHeaders).then(function(r){return r.json();}).catch(function(){return null;})
      ]).then(function(res){
        setServicesHealth({crypto:res[0]||{},hip3:res[1]||{}});
        setLastScan({crypto:res[2],hip3:res[3]});
      });
    }
    fetchMonitorData();
    var monitorInterval = setInterval(fetchMonitorData, 30000);
    return function() { clearInterval(monitorInterval); };
  }, []);

  // Real-time server time update
  useEffect(function() {
    var timeInterval = setInterval(function() {
      setServerTime(new Date());
    }, 1000);
    return function() { clearInterval(timeInterval); };
  }, []);

  // Active bot based on market selector (needed early for useEffects below)
  var activeBot = market === 'hip3' ? hip3Bot : bot;

  // CPU/Memory history for sparkline (60 data points = 60 seconds)
  useEffect(function() {
    if (activeBot && activeBot.system && activeBot.system.cpu !== undefined) {
      setCpuHistory(function(prev) {
        var newHist = prev.concat([activeBot.system.cpu]);
        return newHist.slice(-60);
      });
      setMemHistory(function(prev) {
        var newHist = prev.concat([activeBot.system.memoryPercent || 0]);
        return newHist.slice(-60);
      });
    }
  }, [activeBot && activeBot.system]);

  // Network latency history for sparkline
  useEffect(function() {
    if (networkLatency > 0) {
      setLatencyHistory(function(prev) {
        var newHist = prev.concat([networkLatency]);
        return newHist.slice(-20);
      });
    }
  }, [networkLatency]);

  // Sound on error
  var playErrorSound = useCallback(function() {
    if (soundEnabled) {
      try {
        var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQElkNDfjnM/DDuA');
        audio.volume = 0.3;
        audio.play().catch(function(){});
      } catch(e) {}
    }
  }, [soundEnabled]);

  // Check for errors in logs and play sound
  useEffect(function() {
    if (logs.length > 0) {
      var lastLog = logs[0];
      if (lastLog && (lastLog.lvl === 'ERROR' || lastLog.lvl === 'CRITICAL')) {
        playErrorSound();
      }
    }
  }, [logs, playErrorSound]);

  var notify = useCallback(function(type, msg) {
    var id = Date.now();
    setNotifs(function(p) { return [{id:id,type:type,msg:msg}].concat(p).slice(0,5); });
    setTimeout(function() { setNotifs(function(p) { return p.filter(function(n) { return n.id !== id; }); }); }, 5000);
  }, []);

  var botAction = function(action) {
    if (action === 'emergency' && !showEmergency) { setShowEmergency(true); return; }
    var actionLabels = {start:'Start',stop:'Stop',restart:'Restart',emergency:'Emergency Stop',pause:'Pause',resume:'Resume',force_scan:'Force Scan'};
    fetchApi('/api/bot/' + action, {method:'POST'})
      .then(function() { 
        notify('success', 'Bot ' + action + ' OK'); 
        setShowEmergency(false); 
        fetchAll();
        // Add to action history
        setActionHistory(function(prev) {
          return [{action:action,label:actionLabels[action]||action,ts:new Date().toLocaleTimeString()}].concat(prev).slice(0,20);
        });
        if (action === 'pause') setBotPaused(true);
        if (action === 'resume') setBotPaused(false);
      })
      .catch(function(err) { notify('error', err.message); });
  };
  
  // Export logs function
  var exportLogs = function() {
    var content = activeLogs.map(function(l) {
      return l.ts + ' [' + l.lvl + '] ' + l.msg;
    }).join('\n');
    var blob = new Blob([content], {type:'text/plain'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'trinity-logs-' + new Date().toISOString().slice(0,10) + '.txt';
    a.click();
    URL.revokeObjectURL(url);
    notify('success', t.copied || 'Logs exported!');
  };

  // Formatters
  // üßÆ V3.7 - Adaptive price formatting based on value
  var fmtPrice = function(v) {
    var val = typeof v === 'string' ? parseFloat(v) : (v || 0);
    if (isNaN(val) || val === 0) return '$0.00';
    if (val < 0.01) return '$' + val.toFixed(8);      // Micro coins: 8 decimals
    if (val < 1) return '$' + val.toFixed(6);         // Sub-dollar: 6 decimals (SEI, etc.)
    if (val < 10) return '$' + val.toFixed(4);        // Under $10: 4 decimals
    if (val < 1000) return '$' + val.toFixed(2);      // Normal: 2 decimals
    return '$' + val.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); // Large: formatted
  };
  var fmtBal = function(v) { return hide ? '$------' : '$' + (v||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); };
  // üÜï V10.1 FIX: Properly display negative PnL with minus sign (-$X.XX)
  var fmtPnl = function(v) { 
    if (hide) return '$------';
    var val = v || 0;
    var absVal = Math.abs(val).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    if (val >= 0) return '+$' + absVal;
    return '-$' + absVal;  // Explicit minus sign for negative values
  };
  var fmtR = function(v) { return (v>=0?'+':'') + (v||0).toFixed(1) + 'R'; };
  var fmtPct = function(v) { return (v>=0?'+':'') + (v||0).toFixed(2) + '%'; };

  // V2.3: EMA calculation helper for chart overlays
  var calculateEMA = function(candles, period) {
    if (!candles || candles.length < period) return [];
    var k = 2 / (period + 1);
    var emaData = [];
    // Seed with SMA of first `period` candles
    var sum = 0;
    for (var i = 0; i < period; i++) sum += candles[i].close;
    var ema = sum / period;
    emaData.push({time: candles[period - 1].time, value: Math.round(ema * 100) / 100});
    for (var j = period; j < candles.length; j++) {
      ema = candles[j].close * k + ema * (1 - k);
      emaData.push({time: candles[j].time, value: Math.round(ema * 100) / 100});
    }
    return emaData;
  };

  // V2.3: Add chart overlays (volume + EMA) to a LightweightCharts instance
  var addChartOverlays = function(chart, candles, showVolume, showEMA) {
    try {
      if (!chart || chart._disposed) return;
      if (showVolume && candles.length > 0) {
        var volSeries = chart.addHistogramSeries({
          priceFormat:{type:'volume'},
          priceScaleId:'vol',
          color:'rgba(99,102,241,0.3)'
        });
        chart.priceScale('vol').applyOptions({scaleMargins:{top:0.85,bottom:0}});
        volSeries.setData(candles.map(function(c){
          return {time:c.time,value:c.volume||0,color:c.close>=c.open?'rgba(34,197,94,0.25)':'rgba(239,68,68,0.25)'};
        }));
      }
      if (showEMA && candles.length >= 20) {
        var ema20 = calculateEMA(candles, 20);
        var ema50 = calculateEMA(candles, 50);
        if (ema20.length > 0) {
          var ema20Series = chart.addLineSeries({color:'#f59e0b',lineWidth:1,priceLineVisible:false,lastValueVisible:false,crosshairMarkerVisible:false});
          ema20Series.setData(ema20);
        }
        if (ema50.length > 0) {
          var ema50Series = chart.addLineSeries({color:'#8b5cf6',lineWidth:1,priceLineVisible:false,lastValueVisible:false,crosshairMarkerVisible:false});
          ema50Series.setData(ema50);
        }
      }
    } catch(e) { console.warn('Chart overlays failed:', e); }
  };

  // üÜï V17.3: Mini Progress Bar for Overview (compact SL/Entry/TPs/Current)
  var renderMiniProgressBar = function(pos, currentPrice) {
    var isLong = pos.side !== 'SHORT';
    var entry = parseFloat(pos.entry_price || pos.entryPrice || 0);
    var sl = parseFloat(pos.initial_stop_loss || pos.initialStopLoss || pos.stop_loss || 0);
    var liveSL = parseFloat(pos.stop_loss || pos.liveStopLoss || sl);
    var targets = pos.targets || [];
    var tp1 = parseFloat(targets[0] || pos.take_profit || pos.takeProfit || 0);
    var tp2 = parseFloat(targets[1] || 0);
    var tp3 = parseFloat(targets[2] || 0);
    var current = parseFloat(currentPrice || pos.current_price || entry);
    if (sl === 0 || entry === 0) return null;
    var furthestTP = tp1 || entry;
    if (tp2 > 0) furthestTP = isLong ? Math.max(furthestTP, tp2) : Math.min(furthestTP, tp2);
    if (tp3 > 0) furthestTP = isLong ? Math.max(furthestTP, tp3) : Math.min(furthestTP, tp3);
    var leftPrice = isLong ? sl : (furthestTP || entry);
    var rightPrice = isLong ? (furthestTP || entry) : sl;
    var range = rightPrice - leftPrice;
    if (range <= 0) return null;
    var pad = range * 0.08; leftPrice -= pad; rightPrice += pad; range = rightPrice - leftPrice;
    var pct = function(p) { return Math.max(0, Math.min(100, ((p - leftPrice) / range) * 100)); };
    var entryPct = pct(entry);
    var currentPct = pct(current);
    var slPct = pct(sl);
    var liveSLPct = Math.abs(liveSL - sl) / entry > 0.001 ? pct(liveSL) : null;
    var isWinning = isLong ? (current > entry) : (current < entry);
    var fillL = Math.min(entryPct, currentPct);
    var fillR = Math.max(entryPct, currentPct);
    var markers = [];
    markers.push(h('div',{key:'sl',style:{position:'absolute',left:slPct+'%',top:0,width:2,height:'100%',background:'#ef4444',borderRadius:1}}));
    if (liveSLPct !== null) markers.push(h('div',{key:'be',style:{position:'absolute',left:'calc('+liveSLPct+'% - 1px)',top:-2,width:4,height:'calc(100% + 4px)',background:'#f59e0b',borderRadius:2,boxShadow:'0 0 6px #f59e0b, 0 0 10px #f59e0b80',zIndex:3}}));
    markers.push(h('div',{key:'entry',style:{position:'absolute',left:entryPct+'%',top:-1,width:3,height:'calc(100% + 2px)',background:'#fff',borderRadius:1,boxShadow:'0 0 4px rgba(0,0,0,0.5)'}}));
    if (tp1 > 0) markers.push(h('div',{key:'tp1',style:{position:'absolute',left:pct(tp1)+'%',top:0,width:2,height:'100%',background:(isLong?current>=tp1:current<=tp1)?'#22c55e':'rgba(34,197,94,0.5)',borderRadius:1}}));
    if (tp2 > 0) markers.push(h('div',{key:'tp2',style:{position:'absolute',left:pct(tp2)+'%',top:0,width:2,height:'100%',background:(isLong?current>=tp2:current<=tp2)?'#22c55e':'rgba(34,197,94,0.5)',borderRadius:1}}));
    if (tp3 > 0) markers.push(h('div',{key:'tp3',style:{position:'absolute',left:pct(tp3)+'%',top:0,width:2,height:'100%',background:(isLong?current>=tp3:current<=tp3)?'#22c55e':'rgba(34,197,94,0.5)',borderRadius:1}}));
    markers.push(h('div',{key:'fill',style:{position:'absolute',left:fillL+'%',top:2,bottom:2,width:(fillR-fillL)+'%',background:isWinning?C.pos:C.neg,borderRadius:3,opacity:0.6}}));
    markers.push(h('div',{key:'cur',style:{position:'absolute',left:currentPct+'%',top:'50%',transform:'translate(-50%,-50%)',width:10,height:10,background:isWinning?C.pos:C.neg,border:'2px solid #fff',borderRadius:'50%',boxShadow:'0 0 6px '+(isWinning?C.pos:C.neg),zIndex:5}}));
    return h('div',{style:{position:'relative',height:12,background:'linear-gradient(90deg,'+(isLong?'rgba(239,68,68,0.15)':'rgba(34,197,94,0.15)')+' 0%,transparent 30%,transparent 70%,'+(isLong?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)')+' 100%)',borderRadius:6,marginTop:4,overflow:'visible'}},markers);
  };

  
  // Crypto logos helper (jsDelivr CDN + colored circle fallback)
  var cryptoLogos = {
    BTC: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/bitcoin/large.png',
    ETH: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/ethereum/large.png',
    SOL: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/solana/large.png',
    LINK: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/chainlink/large.png',
    SEI: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/sei-network/large.png',
    DOGE: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/dogecoin/large.png',
    SUI: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/sui/large.png'
  };
  var cryptoCoingeckoIds = {BTC:'bitcoin',ETH:'ethereum',SOL:'solana',LINK:'chainlink',SEI:'sei-network',DOGE:'dogecoin',SUI:'sui',XRP:'ripple',ADA:'cardano',AVAX:'avalanche-2',MATIC:'matic-network',DOT:'polkadot'};
  var cryptoColors = {BTC:'#F7931A',ETH:'#627EEA',SOL:'#00D18C',LINK:'#2A5ADA',SEI:'#9C1AFF',DOGE:'#C2A633',SUI:'#4DA2FF',XRP:'#23292F',ADA:'#0033AD',AVAX:'#E84142',MATIC:'#8247E5',DOT:'#E6007A'};
  // üÜï V2.0: HIP-3 Stock Logos (company logos via Clearbit CDN)
  var stockLogos = {
    AAPL:'https://logo.clearbit.com/apple.com',AMD:'https://logo.clearbit.com/amd.com',
    AMZN:'https://logo.clearbit.com/amazon.com',COIN:'https://logo.clearbit.com/coinbase.com',
    GOOGL:'https://logo.clearbit.com/google.com',HOOD:'https://logo.clearbit.com/robinhood.com',
    META:'https://logo.clearbit.com/meta.com',MSFT:'https://logo.clearbit.com/microsoft.com',
    MSTR:'https://logo.clearbit.com/microstrategy.com',NVDA:'https://logo.clearbit.com/nvidia.com',
    PLTR:'https://logo.clearbit.com/palantir.com',TSLA:'https://logo.clearbit.com/tesla.com'
  };
  var stockColors = {AAPL:'#A2AAAD',AMD:'#ED1C24',AMZN:'#FF9900',COIN:'#0052FF',GOOGL:'#4285F4',HOOD:'#00C805',META:'#0082FB',MSFT:'#00A4EF',MSTR:'#D51F26',NVDA:'#76B900',PLTR:'#101010',TSLA:'#CC0000'};
  var cryptoLogo = function(sym, size) {
    var sz = size || 24;
    var isStock = !!stockLogos[sym];
    var url, col;
    if (isStock) {
      url = stockLogos[sym];
      col = stockColors[sym] || '#333';
    } else {
      var cgId = cryptoCoingeckoIds[sym] || sym.toLowerCase();
      url = cryptoLogos[sym] || ('https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/' + cgId + '/large.png');
      col = cryptoColors[sym] || '#666';
    }
    var pad = isStock ? Math.round(sz * 0.15) : 0;
    return h('div', {style:{width:sz,height:sz,borderRadius:sz>28?10:6,overflow:'hidden',flexShrink:0,position:'relative',background:isStock?'#1a1f2e':col,display:'flex',alignItems:'center',justifyContent:'center',fontSize:Math.round(sz*0.45),fontWeight:700,color:'#fff'}},
      h('span',{style:{position:'absolute'}}, sym[0]),
      h('img', {src:url, alt:sym, style:{width:sz-pad*2,height:sz-pad*2,position:'relative',zIndex:1,objectFit:'contain'},
        onLoad:function(e){var s=e.target.parentNode.querySelector('span');if(s)s.style.display='none';if(!isStock)e.target.parentNode.style.background='transparent';},
        onError:function(e){if(isStock&&!e.target.dataset.retry){e.target.dataset.retry='1';var domain=url.split('/').pop();e.target.src='https://www.google.com/s2/favicons?domain='+domain+'&sz=128';}else{e.target.style.display='none';if(isStock){e.target.parentNode.style.background=col;var s=e.target.parentNode.querySelector('span');if(s)s.style.color='#fff';}}}})

    );
  };

  // Computed
  var closed = trades.filter(function(tr) { return tr.status !== 'open'; });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üÜï V2.0 COMMAND CENTER: Active data based on market selector
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // V2.7: activeClosed FIRST (needed for unified PF calculation)
  var activeClosed = market === 'hip3' ? hip3Trades.filter(function(tr) { return tr.status !== 'open'; }) : market === 'unified' ? closed.concat(hip3Trades.filter(function(tr) { return tr.status !== 'open'; })).sort(function(a,b){ return new Date(b.exitTime||b.entryTime||0) - new Date(a.exitTime||a.entryTime||0); }) : closed;

  // V2.7: Unified stats = combined crypto + HIP-3
  var activeStats = market === 'hip3' ? hip3Stats : market === 'unified' ? (function() {
    var cW = stats.wins || 0, hW = hip3Stats.wins || 0, tW = cW + hW;
    var cL = stats.losses || 0, hL = hip3Stats.losses || 0, tL = cL + hL;
    var tTrades = tW + tL;
    var tBal = (stats.balance || 0) + (hip3Stats.balance || 0);
    var tIBal = (stats.initialBalance || 0) + (hip3Stats.initialBalance || 0);
    var tPnl = (stats.totalPnl || 0) + (hip3Stats.totalPnl || 0);
    var tR = (stats.totalR || 0) + (hip3Stats.totalR || 0);
    var tFees = (stats.totalFees || 0) + (hip3Stats.totalFees || 0);
    var tVol = (stats.totalVolume || 0) + (hip3Stats.totalVolume || 0);
    // PF from combined closed trades
    var winR = 0, lossR = 0;
    activeClosed.forEach(function(tr) {
      var r = tr.r || 0;
      if (r > 0) winR += r;
      else if (r < 0) lossR += Math.abs(r);
    });
    return {
      balance: tBal, initialBalance: tIBal,
      totalPnl: tPnl,
      totalPnlPercent: tIBal > 0 ? (tPnl / tIBal * 100) : 0,
      winRate: tTrades > 0 ? (tW / tTrades * 100) : 0,
      totalTrades: tTrades, wins: tW, losses: tL,
      profitFactor: lossR > 0 ? winR / lossR : 0,
      maxDrawdown: Math.max(stats.maxDrawdown || 0, hip3Stats.maxDrawdown || 0),
      currentDrawdown: Math.max(stats.currentDrawdown || 0, hip3Stats.currentDrawdown || 0),
      totalR: tR, avgR: tTrades > 0 ? tR / tTrades : 0,
      todayR: (stats.todayR || 0) + (hip3Stats.todayR || 0),
      weekR: (stats.weekR || 0) + (hip3Stats.weekR || 0),
      monthR: (stats.monthR || 0) + (hip3Stats.monthR || 0),
      pnlToday: (stats.pnlToday || 0) + (hip3Stats.pnl_today || 0),
      tradesToday: (stats.tradesToday || 0) + (hip3Stats.trades_today || 0),
      currentStreak: stats.currentStreak || 0,
      bestStreak: Math.max(stats.bestStreak || 0, hip3Stats.bestStreak || 0),
      totalFees: tFees, totalVolume: tVol,
      riskUnit: tBal > 0 ? tBal * 0.01 : 1,
      expectancy: tTrades > 0 ? tR / tTrades : 0,
      rPerWeek: (stats.rPerWeek || 0) + (hip3Stats.rPerWeek || 0),
      sharpeRatio: 0, recoveryFactor: 0
    };
  })() : stats;
  var activeOpenPos = market === 'hip3' ? hip3OpenPos : market === 'unified' ? openPos.concat(hip3OpenPos) : openPos;
  var activeTrades = market === 'hip3' ? hip3Trades : market === 'unified' ? trades.concat(hip3Trades).sort(function(a,b){ return new Date(b.exitTime||b.entryTime||0) - new Date(a.exitTime||a.entryTime||0); }) : trades;
  activeBot = market === 'hip3' ? hip3Bot : bot;  // reassign (already declared above)
  var activeConnected = market === 'hip3' ? hip3Connected : market === 'unified' ? (connected || hip3Connected) : connected;
  var activeLogs = market === 'hip3' ? hip3Logs : market === 'unified' ? logs.concat(hip3Logs).sort(function(a,b){ return new Date(b.ts||0) - new Date(a.ts||0); }).slice(0,1000) : logs;

  // Unified stats (combined crypto + HIP-3)
  var unifiedStats = useMemo(function() {
    return {
      totalBalance: (stats.balance || 0) + (hip3Stats.balance || 0),
      totalPnlToday: (stats.todayR || 0) + (hip3Stats.todayR || 0),
      totalRToday: (stats.todayR || 0) + (hip3Stats.todayR || 0),
      totalPositions: openPos.length + hip3OpenPos.length,
      maxPositions: 6 + 5, // crypto max + hip3 max
      cryptoBalance: stats.balance || 0,
      hip3Balance: hip3Stats.balance || 0,
      cryptoR: stats.totalR || 0,
      hip3R: hip3Stats.totalR || 0,
      cryptoWR: stats.winRate || 0,
      hip3WR: hip3Stats.winRate || 0,
      hip3MarketOpen: hip3Bot.market_open || false,
      cryptoOnline: connected,
      hip3Online: hip3Connected
    };
  }, [stats, hip3Stats, openPos.length, hip3OpenPos.length, connected, hip3Connected, hip3Bot.market_open]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAGE TITLE WITH BADGE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  useEffect(function() {
    var openCount = openPos.length + hip3OpenPos.length;
    var pnl = (stats.totalR || 0) + (hip3Stats.totalR || 0);
    var pnlStr = pnl >= 0 ? "+" + pnl.toFixed(2) + "R" : pnl.toFixed(2) + "R";
    if (openCount > 0) {
      document.title = "(" + openCount + ") " + pnlStr + " | Trinity V2";
    } else {
      document.title = pnlStr + " | Trinity V2";
    }
  }, [openPos.length, hip3OpenPos.length, stats.totalR, hip3Stats.totalR]);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TRACK TRADE CHANGES FOR NOTIFICATIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  useEffect(function() {
    var currentOpen = openPos.length;
    var currentClosed = closed.length;
    var lastOpen = lastTradeCountRef.current.open;
    var lastClosed = lastTradeCountRef.current.closed;
    if (lastOpen > 0 || lastClosed > 0) {
      if (currentOpen > lastOpen) {
        playSound("open");
        notify("success", "üìà "+t.newPosOpened);
      }
      if (currentClosed > lastClosed) {
        // V10.12: Find most recently closed trade (by exitTime), not just closed[0]
        var lastTrade = closed.slice().sort(function(a, b) {
          return new Date(b.exitTime || b.entryTime) - new Date(a.exitTime || a.entryTime);
        })[0];
        if (lastTrade && lastTrade.r >= 0) {
          playSound("win");
          notify("success", "‚úÖ "+t.tradeClosed+": +" + (lastTrade.r || 0).toFixed(2) + "R");
        } else if (lastTrade) {
          playSound("loss");
          notify("error", "‚ùå "+t.tradeClosed+": " + (lastTrade.r || 0).toFixed(2) + "R");
        }
      }
    }
    lastTradeCountRef.current = {open: currentOpen, closed: currentClosed};
  }, [openPos.length, closed.length]);
  var longs = activeClosed.filter(function(tr) { return tr.side === 'LONG'; });
  var shorts = activeClosed.filter(function(tr) { return tr.side === 'SHORT'; });
  var longWins = longs.filter(function(tr) { return tr.pnl >= 0; }).length;
  var shortWins = shorts.filter(function(tr) { return tr.pnl >= 0; }).length;
  var longWR = longs.length > 0 ? (longWins / longs.length * 100) : 0;
  var shortWR = shorts.length > 0 ? (shortWins / shorts.length * 100) : 0;
  var longPct = activeClosed.length > 0 ? (longs.length / activeClosed.length * 100) : 50;
  var shortPct = 100 - longPct;

  var symStats = activeClosed.reduce(function(acc, tr) {
    if (!acc[tr.symbol]) acc[tr.symbol] = {n:0,w:0,r:0};
    acc[tr.symbol].n++;
    acc[tr.symbol].r += tr.r;
    if (tr.pnl >= 0) acc[tr.symbol].w++;
    return acc;
  }, {});
  var totalSymTr = Object.values(symStats).reduce(function(s,x){return s+x.n;},0);

  var dailyRProg = settings.dailyRGoal > 0 ? Math.min((activeStats.todayR / settings.dailyRGoal) * 100, 100) : 0;
  var weeklyRProg = settings.weeklyRGoal > 0 ? Math.min((activeStats.weekR / settings.weeklyRGoal) * 100, 100) : 0;

  // Styles
  var card = {background:C.card,border:'1px solid '+C.border,borderRadius:16,padding:20};
  var section = Object.assign({},card,{marginBottom:20});
  // üé® V4.5 - Improved pill with z-index for visibility
  var pill = function(color, bg) { return {padding:'5px 12px',background:bg,borderRadius:20,fontSize:11,fontWeight:600,color:color,display:'inline-flex',alignItems:'center',gap:8,position:'relative',zIndex:1,overflow:'visible'}; };
  var btn = function(active) { return {padding:'8px 16px',background:active?C.accent:C.card,border:'1px solid '+(active?C.accent:C.border),borderRadius:8,color:active?C.bg:C.textS,fontSize:12,fontWeight:600,cursor:'pointer'}; };

  // Loading screen
  if (loading) {
    return h('div',{style:{minHeight:'100vh',background:C.bg,display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:24}},
      h('img',{src:'logo.jpg',style:{width:100,height:100,borderRadius:20}}),
      h('div',{style:{color:C.accent,fontSize:28,fontWeight:800}},'Trinity Bot'),
      h('div',{style:{color:C.textS}},'Loading...')
    );
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BALANCE EVOLUTION CHART - Trading Terminal Pro Edition
  // Features: crosshair tooltip, high/low markers, current price line,
  //           smart Y-axis, refined gradient, interactive hover
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var renderBalChart = function() {
    var fallbackBal = activeStats.initialBalance || (activeStats.balance - activeStats.totalPnl) || activeStats.balance || 0;
    var now = new Date();
    var isPnlMode = roiType === 'pnl';

    // V10.11: Use true initial balance (before any deposits/withdrawals) ‚Äî crypto only
    var hasCapEvents = market !== 'hip3' && capitalEvents && capitalEvents.events && capitalEvents.events.length > 0;
    var trueInitial = (hasCapEvents && capitalEvents.initial_balance != null) ? capitalEvents.initial_balance : fallbackBal;

    // Calculate filter boundaries
    var filterStart = null;
    var filterEnd = null;

    if (balFilter === 'day') {
      filterStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      filterStart.setHours(0,0,0,0);
    } else if (balFilter === 'week') {
      var day = now.getDay() || 7;
      filterStart = new Date(now);
      filterStart.setDate(now.getDate() - day + 1);
      filterStart.setHours(0,0,0,0);
    } else if (balFilter === 'prevWeek') {
      var day = now.getDay() || 7;
      filterEnd = new Date(now);
      filterEnd.setDate(now.getDate() - day);
      filterEnd.setHours(23,59,59,999);
      filterStart = new Date(filterEnd);
      filterStart.setDate(filterEnd.getDate() - 6);
      filterStart.setHours(0,0,0,0);
    } else if (balFilter === 'month') {
      filterStart = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (/^\d{4}$/.test(balFilter)) {
      var yr = parseInt(balFilter);
      filterStart = new Date(yr, 0, 1);
      if (yr < now.getFullYear()) {
        filterEnd = new Date(yr, 11, 31, 23, 59, 59, 999);
      }
    }

    // Sort all trades (V2.0: market-aware)
    var allSorted = activeClosed.slice().sort(function(a,b) {
      return new Date(a.exitTime || a.entryTime) - new Date(b.exitTime || b.entryTime);
    });

    // Calculate balance at filter start: true initial + all pre-filter events
    var periodStartBal = trueInitial;
    if (filterStart && balFilter !== 'all') {
      allSorted.forEach(function(tr) {
        var trDate = new Date(tr.exitTime || tr.entryTime);
        if (trDate < filterStart) {
          periodStartBal += tr.pnl || 0;
        }
      });
      // Include capital events before filter start
      if (hasCapEvents) {
        capitalEvents.events.forEach(function(ce) {
          var ceDate = new Date(ensureUTC(ce.timestamp));
          if (ceDate < filterStart) {
            periodStartBal += ce.type === 'deposit' ? ce.amount : -ce.amount;
          }
        });
      }
    }

    // Filter trades for display
    var sorted = allSorted.filter(function(tr) {
      var trDate = new Date(tr.exitTime || tr.entryTime);
      if (filterStart && trDate < filterStart) return false;
      if (filterEnd && trDate > filterEnd) return false;
      return true;
    });

    // Build history
    var hist = [];
    var chartStartDate = filterStart ? filterStart.toISOString().split('T')[0] : CONFIG.LIVE_START;

    if (isPnlMode) {
      // PnL mode: start from $0, accumulate trading PnL only
      var cumPnl = 0;
      hist.push({d: chartStartDate, b: 0, label: chartStartDate.slice(5).replace('-','/'), pnl: 0, sym: ''});
      sorted.forEach(function(tr) {
        cumPnl += tr.pnl || 0;
        var dateStr = (tr.exitTime || tr.entryTime || '').split('T')[0];
        if (dateStr) hist.push({d: dateStr, b: cumPnl, label: dateStr.slice(5).replace('-','/'), pnl: tr.pnl || 0, sym: tr.symbol || ''});
      });
    } else {
      // Balance mode: merge trades + capital events for TRUE exchange balance
      var currentBal = periodStartBal;
      hist.push({d: chartStartDate, b: periodStartBal, label: chartStartDate.slice(5).replace('-','/'), pnl: 0, sym: ''});

      // Build merged timeline: trades + capital events
      var allEvents = sorted.map(function(tr) {
        return {date: new Date(tr.exitTime || tr.entryTime), delta: tr.pnl || 0, sym: tr.symbol || '', isCap: false};
      });
      if (hasCapEvents) {
        capitalEvents.events.forEach(function(ce) {
          var ceDate = new Date(ensureUTC(ce.timestamp));
          if (filterStart && ceDate < filterStart) return;
          if (filterEnd && ceDate > filterEnd) return;
          allEvents.push({
            date: ceDate,
            delta: ce.type === 'deposit' ? ce.amount : -ce.amount,
            sym: (ce.type === 'deposit' ? '+' : '-') + '$' + ce.amount.toFixed(0),
            isCap: true
          });
        });
      }
      allEvents.sort(function(a,b) { return a.date - b.date; });

      allEvents.forEach(function(evt) {
        currentBal += evt.delta;
        var dateStr = evt.date.toISOString().split('T')[0];
        hist.push({d: dateStr, b: currentBal, label: dateStr.slice(5).replace('-','/'), pnl: evt.isCap ? 0 : evt.delta, sym: evt.sym});
      });
    }

    // Extend chart to LIVE balance (makes chart feel real-time)
    var filterIncludesNow = !filterEnd; // prevWeek and past years have filterEnd set
    if (filterIncludesNow && activeStats.balance > 0 && !isPnlMode) {
      var nowStr = new Date().toISOString().split('T')[0];
      var lastH = hist.length > 0 ? hist[hist.length - 1] : null;
      if (!lastH || Math.abs(lastH.b - activeStats.balance) > 0.5 || lastH.d !== nowStr) {
        hist.push({d: nowStr, b: activeStats.balance, label: nowStr.slice(5).replace('-','/') + ' now', pnl: 0, sym: 'LIVE'});
      }
    }

    if (hist.length < 2) {
      return h('div',{style:{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column',gap:10}},
        h('div',{style:{fontSize:24,fontWeight:700,color:C.textS}},'No Data'),
        h('div',{style:{fontSize:11,color:C.textM}},balFilter === 'prevWeek' ? 'No trades last week' : 'No trades in this period')
      );
    }

    // ‚îÄ‚îÄ Chart dimensions ‚îÄ‚îÄ
    var vals = hist.map(function(x){return x.b;});
    var mx = Math.max.apply(null, vals), mn = Math.min.apply(null, vals);
    var useLog = balScale === 'log' && mn > 0 && !isPnlMode;
    var paddingTop = (mx - mn) * 0.18 || 1, paddingBottom = (mx - mn) * 0.08 || 1;
    var displayMin = mn - paddingBottom, displayMax = mx + paddingTop, rg = displayMax - displayMin || 1;
    var logMin, logMax, logRg;
    if (useLog) {
      logMin = Math.log(Math.max(displayMin, 0.01));
      logMax = Math.log(displayMax);
      logRg = logMax - logMin || 1;
    }
    var W = 700, H = 260, marginLeft = 62, marginBottom = 24, marginRight = 50, marginTop = 12;
    var chartW = W - marginLeft - marginRight, chartH = H - marginBottom - marginTop;
    var scaleY = function(val) {
      if (useLog) return (Math.log(Math.max(val, 0.01)) - logMin) / logRg;
      return (val - displayMin) / rg;
    };

    // ‚îÄ‚îÄ Points ‚îÄ‚îÄ
    var points = hist.map(function(x,i){
      return {x: marginLeft + (i/(hist.length-1||1)) * chartW, y: marginTop + chartH - scaleY(x.b) * chartH, val: x.b, label: x.label, d: x.d, pnl: x.pnl || 0, sym: x.sym || ''};
    });

    // ‚îÄ‚îÄ Catmull-Rom spline ‚îÄ‚îÄ
    var smoothPath;
    if (points.length <= 2) {
      smoothPath = 'M ' + points[0].x.toFixed(1) + ' ' + points[0].y.toFixed(1) + ' L ' + points[points.length-1].x.toFixed(1) + ' ' + points[points.length-1].y.toFixed(1);
    } else {
      smoothPath = 'M ' + points[0].x.toFixed(1) + ' ' + points[0].y.toFixed(1);
      for (var i = 0; i < points.length - 1; i++) {
        var p0 = points[i === 0 ? 0 : i - 1], p1 = points[i], p2 = points[i + 1], p3 = points[i + 2 >= points.length ? points.length - 1 : i + 2];
        var t = 0.35;
        smoothPath += ' C ' + (p1.x + (p2.x - p0.x) * t).toFixed(1) + ' ' + (p1.y + (p2.y - p0.y) * t).toFixed(1) + ', ' + (p2.x - (p3.x - p1.x) * t).toFixed(1) + ' ' + (p2.y - (p3.y - p1.y) * t).toFixed(1) + ', ' + p2.x.toFixed(1) + ' ' + p2.y.toFixed(1);
      }
    }
    var chartBottom = marginTop + chartH;
    var areaPath = smoothPath + ' L ' + points[points.length-1].x.toFixed(1) + ' ' + chartBottom + ' L ' + points[0].x.toFixed(1) + ' ' + chartBottom + ' Z';

    // ‚îÄ‚îÄ Colors ‚îÄ‚îÄ
    var lastVal = hist[hist.length-1].b;
    var firstVal = hist[0].b;
    var isPos = isPnlMode ? lastVal >= 0 : lastVal >= firstVal;
    var lineColor = isPos ? '#10b981' : '#ef4444';
    var lineGlow = isPos ? '#34d399' : '#f87171';
    var gradId = 'balG' + (isPos ? 'P' : 'N') + '_pro';
    var glowId = 'balGlow_pro';

    // ‚îÄ‚îÄ Percentage ‚îÄ‚îÄ
    var displayPct;
    if (isPnlMode) {
      displayPct = trueInitial > 0 ? (lastVal / trueInitial * 100) : 0;
    } else {
      displayPct = firstVal !== 0 ? ((lastVal - firstVal) / Math.abs(firstVal) * 100) : 0;
    }

    // ‚îÄ‚îÄ Find High/Low ‚îÄ‚îÄ
    var highIdx = 0, lowIdx = 0;
    for (var hi = 1; hi < hist.length; hi++) {
      if (hist[hi].b > hist[highIdx].b) highIdx = hi;
      if (hist[hi].b < hist[lowIdx].b) lowIdx = hi;
    }

    // ‚îÄ‚îÄ Smart Y-axis ticks (5 levels, nice round numbers) ‚îÄ‚îÄ
    var yTicks = [];
    var niceStep = function(range, targetSteps) {
      var crude = range / targetSteps;
      var mag = Math.pow(10, Math.floor(Math.log10(crude)));
      var residual = crude / mag;
      var nice;
      if (residual <= 1.5) nice = 1;
      else if (residual <= 3) nice = 2;
      else if (residual <= 7) nice = 5;
      else nice = 10;
      return nice * mag;
    };
    if (useLog) {
      for (var yt = 0; yt <= 4; yt++) {
        var yVal = Math.exp(logMin + (yt / 4) * logRg);
        var yPos = marginTop + chartH - (yt / 4) * chartH;
        yTicks.push({val: yVal, y: yPos});
      }
    } else {
      var step = niceStep(rg, 5);
      var tickStart = Math.ceil(displayMin / step) * step;
      for (var tv = tickStart; tv <= displayMax; tv += step) {
        var yPos = marginTop + chartH - scaleY(tv) * chartH;
        if (yPos >= marginTop - 5 && yPos <= chartBottom + 5) {
          yTicks.push({val: tv, y: yPos});
        }
      }
      if (yTicks.length < 3) {
        yTicks = [];
        for (var yt = 0; yt <= 4; yt++) {
          var yVal = displayMin + (yt / 4) * rg;
          var yPos = marginTop + chartH - (yt / 4) * chartH;
          yTicks.push({val: yVal, y: yPos});
        }
      }
    }

    // ‚îÄ‚îÄ Format $ value ‚îÄ‚îÄ
    var fmtVal = function(v) {
      if (isPnlMode) {
        var sign = v >= 0 ? '+' : '-';
        var av = Math.abs(v);
        if (av >= 10000) return sign + '$' + (av/1000).toFixed(1) + 'k';
        if (av >= 1000) return sign + '$' + av.toFixed(0);
        return sign + '$' + av.toFixed(2);
      }
      if (v >= 10000) return '$' + (v/1000).toFixed(1) + 'k';
      if (v >= 1000) return '$' + v.toFixed(0);
      return '$' + v.toFixed(2);
    };

    // ‚îÄ‚îÄ X-axis labels (smart date formatting) ‚îÄ‚îÄ
    var xLabelCount = Math.min(7, points.length);
    var xLabels = [];
    if (points.length <= xLabelCount) {
      xLabels = points.map(function(p){return p;});
    } else {
      for (var xl = 0; xl < xLabelCount; xl++) {
        var idx = Math.round(xl * (points.length - 1) / (xLabelCount - 1));
        xLabels.push(points[idx]);
      }
    }

    // ‚îÄ‚îÄ Current price line (last value ‚Üí right edge) ‚îÄ‚îÄ
    var lastPt = points[points.length - 1];

    // ‚îÄ‚îÄ Hover handling ‚îÄ‚îÄ
    var hoverIdx = balHover;
    var hovPt = hoverIdx >= 0 && hoverIdx < points.length ? points[hoverIdx] : null;
    var hovData = hoverIdx >= 0 && hoverIdx < hist.length ? hist[hoverIdx] : null;

    var onMouseMove = function(e) {
      var svg = e.currentTarget;
      var rect = svg.getBoundingClientRect();
      var mouseX = (e.clientX - rect.left) / rect.width * W;
      // Find closest point
      var closest = 0, closestDist = 99999;
      for (var ci = 0; ci < points.length; ci++) {
        var dist = Math.abs(points[ci].x - mouseX);
        if (dist < closestDist) { closestDist = dist; closest = ci; }
      }
      if (closest !== balHover) setBalHover(closest);
    };
    var onMouseLeave = function() { setBalHover(-1); };

    return h('div',{style:{position:'relative',height:'100%',overflow:'hidden'}},
      h('svg',{
        viewBox:'0 0 '+W+' '+H,
        style:{width:'100%',height:'100%',cursor:'crosshair'},
        preserveAspectRatio:'xMidYMid meet',
        onMouseMove: onMouseMove,
        onMouseLeave: onMouseLeave
      },
        h('defs',null,
          // Area gradient (3-stop, more refined)
          h('linearGradient',{id:gradId,x1:'0%',y1:'0%',x2:'0%',y2:'100%'},
            h('stop',{offset:'0%',stopColor:lineColor,stopOpacity:'0.35'}),
            h('stop',{offset:'40%',stopColor:lineColor,stopOpacity:'0.12'}),
            h('stop',{offset:'85%',stopColor:lineColor,stopOpacity:'0.02'}),
            h('stop',{offset:'100%',stopColor:lineColor,stopOpacity:'0'})
          ),
          // Line glow filter
          h('filter',{id:glowId,x:'-20%',y:'-20%',width:'140%',height:'140%'},
            h('feGaussianBlur',{stdDeviation:'3',in:'SourceGraphic',result:'blur'}),
            h('feColorMatrix',{in:'blur',type:'matrix',values:'1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.6 0',result:'glow'}),
            h('feMerge',null,h('feMergeNode',{in:'glow'}),h('feMergeNode',{in:'SourceGraphic'}))
          )
        ),

        // ‚îÄ‚îÄ Background subtle grid (horizontal) ‚îÄ‚îÄ
        yTicks.map(function(tick, i) {
          return h('line', {key: 'grid'+i, x1: marginLeft, y1: tick.y, x2: W - marginRight, y2: tick.y, stroke: C.border, strokeWidth: 0.5, opacity: 0.6});
        }),

        // ‚îÄ‚îÄ Y-axis labels (right-aligned, monospace) ‚îÄ‚îÄ
        yTicks.map(function(tick, i) {
          return h('text', {key: 'yl'+i, x: marginLeft - 8, y: tick.y + 3.5, textAnchor: 'end', fill: C.textM, fontSize: 9.5, fontFamily: 'monospace', fontWeight: 500}, fmtVal(tick.val));
        }),

        // ‚îÄ‚îÄ X-axis date labels ‚îÄ‚îÄ
        xLabels.map(function(p, i) {
          return h('text', {key: 'xl'+i, x: p.x, y: H - 5, textAnchor: 'middle', fill: C.textM, fontSize: 9, fontFamily: 'monospace'}, p.label);
        }),

        // ‚îÄ‚îÄ Zero line for PnL mode ‚îÄ‚îÄ
        isPnlMode && mn <= 0 && mx >= 0 && h('line',{
          x1:marginLeft,y1:marginTop+chartH-scaleY(0)*chartH,x2:W-marginRight,y2:marginTop+chartH-scaleY(0)*chartH,
          stroke:'#888',strokeWidth:1,strokeDasharray:'4,3',opacity:0.6
        }),
        isPnlMode && mn <= 0 && mx >= 0 && h('text',{
          x:marginLeft-8,y:marginTop+chartH-scaleY(0)*chartH+3.5,textAnchor:'end',fill:'#888',fontSize:8,fontFamily:'monospace',fontWeight:600
        },'$0'),

        // ‚îÄ‚îÄ Area fill ‚îÄ‚îÄ
        h('path',{d:areaPath,fill:'url(#'+gradId+')',stroke:'none'}),

        // ‚îÄ‚îÄ Main line (with glow) ‚îÄ‚îÄ
        h('path',{d:smoothPath,fill:'none',stroke:lineColor,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round',filter:'url(#'+glowId+')'}),

        // ‚îÄ‚îÄ Current price dashed line (horizontal, from last point to right edge) ‚îÄ‚îÄ
        h('line',{x1:lastPt.x,y1:lastPt.y,x2:W-marginRight,y2:lastPt.y,stroke:lineColor,strokeWidth:0.8,strokeDasharray:'3,3',opacity:0.7}),
        // Current price label (right edge)
        h('rect',{x:W-marginRight+1,y:lastPt.y-8,width:46,height:16,rx:3,fill:lineColor,opacity:0.9}),
        h('text',{x:W-marginRight+24,y:lastPt.y+3.5,textAnchor:'middle',fill:isPos?'#000':'#fff',fontSize:8.5,fontWeight:700,fontFamily:'monospace'},fmtVal(lastVal)),

        // ‚îÄ‚îÄ High marker ‚îÄ‚îÄ
        highIdx > 0 && highIdx < points.length - 1 && h('g',{key:'high'},
          h('circle',{cx:points[highIdx].x,cy:points[highIdx].y,r:3,fill:'none',stroke:'#22c55e',strokeWidth:1.5,opacity:0.8}),
          h('text',{x:points[highIdx].x,y:points[highIdx].y-8,textAnchor:'middle',fill:'#22c55e',fontSize:8,fontWeight:600,fontFamily:'monospace',opacity:0.9},'H '+fmtVal(hist[highIdx].b))
        ),

        // ‚îÄ‚îÄ Low marker ‚îÄ‚îÄ
        lowIdx > 0 && lowIdx < points.length - 1 && h('g',{key:'low'},
          h('circle',{cx:points[lowIdx].x,cy:points[lowIdx].y,r:3,fill:'none',stroke:'#ef4444',strokeWidth:1.5,opacity:0.8}),
          h('text',{x:points[lowIdx].x,y:points[lowIdx].y+14,textAnchor:'middle',fill:'#ef4444',fontSize:8,fontWeight:600,fontFamily:'monospace',opacity:0.9},'L '+fmtVal(hist[lowIdx].b))
        ),

        // ‚îÄ‚îÄ Start value label ‚îÄ‚îÄ
        h('text',{x:marginLeft+3,y:marginTop-2,fill:C.textM,fontSize:8,fontFamily:'monospace',opacity:0.7},fmtVal(hist[0].b)),

        // ‚îÄ‚îÄ Crosshair + tooltip on hover ‚îÄ‚îÄ
        hovPt && h('g',{key:'crosshair'},
          // Vertical line
          h('line',{x1:hovPt.x,y1:marginTop,x2:hovPt.x,y2:chartBottom,stroke:C.textM,strokeWidth:0.7,strokeDasharray:'2,2',opacity:0.8}),
          // Horizontal line
          h('line',{x1:marginLeft,y1:hovPt.y,x2:W-marginRight,y2:hovPt.y,stroke:C.textM,strokeWidth:0.7,strokeDasharray:'2,2',opacity:0.5}),
          // Dot on line
          h('circle',{cx:hovPt.x,cy:hovPt.y,r:4.5,fill:lineColor,stroke:'#fff',strokeWidth:1.5,filter:'url(#'+glowId+')'}),
          // Tooltip background
          h('rect',{
            x: hovPt.x + (hovPt.x > W/2 ? -105 : 10),
            y: Math.max(marginTop, Math.min(hovPt.y - 28, chartBottom - 56)),
            width: 95, height: 52, rx: 5,
            fill: C.card, stroke: C.border, strokeWidth: 1, opacity: 0.95
          }),
          // Tooltip: date
          h('text',{
            x: hovPt.x + (hovPt.x > W/2 ? -58 : 57),
            y: Math.max(marginTop, Math.min(hovPt.y - 28, chartBottom - 56)) + 14,
            textAnchor:'middle', fill: C.textS, fontSize: 8.5, fontFamily:'monospace'
          }, hovData ? hovData.d : ''),
          // Tooltip: balance value
          h('text',{
            x: hovPt.x + (hovPt.x > W/2 ? -58 : 57),
            y: Math.max(marginTop, Math.min(hovPt.y - 28, chartBottom - 56)) + 29,
            textAnchor:'middle', fill: C.text, fontSize: 10, fontWeight:700, fontFamily:'monospace'
          }, fmtVal(hovPt.val)),
          // Tooltip: PnL for this trade
          hovData && hovData.pnl && hovData.pnl !== 0 && h('text',{
            x: hovPt.x + (hovPt.x > W/2 ? -58 : 57),
            y: Math.max(marginTop, Math.min(hovPt.y - 28, chartBottom - 56)) + 43,
            textAnchor:'middle', fill: hovData.pnl >= 0 ? '#22c55e' : '#ef4444', fontSize: 8, fontFamily:'monospace'
          }, (hovData.pnl >= 0 ? '+' : '') + '$' + hovData.pnl.toFixed(2) + (hovData.sym ? ' ' + hovData.sym.replace('-PERP','').replace('/USD','') : ''))
        )
      ),

      // ‚îÄ‚îÄ Floating badge (PnL value or percentage) ‚îÄ‚îÄ
      h('div',{style:{
        position:'absolute',top:6,right:6,
        background:isPos?'rgba(16,185,129,0.12)':'rgba(239,68,68,0.12)',
        backdropFilter:'blur(8px)',
        border:'1px solid '+(isPos?'rgba(16,185,129,0.25)':'rgba(239,68,68,0.25)'),
        padding:'5px 12px',borderRadius:8,
        fontSize:13,fontWeight:700,color:lineGlow,fontFamily:'monospace',
        boxShadow:'0 2px 12px '+(isPos?'rgba(16,185,129,0.15)':'rgba(239,68,68,0.15)')
      }},
        isPnlMode ? fmtVal(lastVal)+' ('+(displayPct>=0?'+':'')+displayPct.toFixed(2)+'%)' : (displayPct>=0?'+':'')+displayPct.toFixed(2)+'%'
      ),

      // ‚îÄ‚îÄ Bottom-left: current value ‚îÄ‚îÄ
      h('div',{style:{
        position:'absolute',bottom:28,left:8,
        fontSize:10,fontFamily:'monospace',color:C.textM,opacity:0.7
      }}, fmtVal(lastVal) + (isPnlMode ? ' PnL' : ' current'))
    );
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CUMULATIVE R HISTOGRAM - With filters (Today/Week/Month/Year/All)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var renderCumRChart = function() {
    var now = new Date();
    var data = [];
    var labels = [];
    var isLineMode = false; // true for 'all' cumulative line chart

    if (cumRFilter === 'today') {
      for (var hr = 0; hr < 24; hr++) {
        var hourTrades = activeClosed.filter(function(tr) {
          var trDate = new Date(tr.exitTime || tr.entryTime);
          return trDate.toDateString() === now.toDateString() && trDate.getHours() === hr;
        });
        var hourR = hourTrades.reduce(function(s,tr){return s+tr.r;},0);
        data.push(hourR);
        labels.push(hr + 'h');
      }
    } else if (cumRFilter === 'week') {
      var days = [t.sun,t.mon,t.tue,t.wed,t.thu,t.fri,t.sat];
      for (var i = 6; i >= 0; i--) {
        var d = new Date(now);
        d.setDate(d.getDate() - i);
        var ds = d.toISOString().split('T')[0];
        var dayTrades = activeClosed.filter(function(tr){
          return (tr.exitTime||tr.entryTime||'').startsWith(ds);
        });
        var dayR = dayTrades.reduce(function(s,tr){return s+tr.r;},0);
        data.push(dayR);
        labels.push(days[d.getDay()]);
      }
    } else if (cumRFilter === 'month') {
      // 4 rolling weeks with date labels
      for (var w = 3; w >= 0; w--) {
        var wEnd = new Date(now);
        wEnd.setDate(wEnd.getDate() - (w * 7));
        wEnd.setHours(23,59,59,999);
        var wStart = new Date(wEnd);
        wStart.setDate(wEnd.getDate() - 6);
        wStart.setHours(0,0,0,0);
        var weekTrades = activeClosed.filter(function(tr) {
          var trDate = new Date(tr.exitTime || tr.entryTime);
          return trDate >= wStart && trDate <= wEnd;
        });
        var weekR = weekTrades.reduce(function(s,tr){return s+tr.r;},0);
        data.push(weekR);
        labels.push((wStart.getMonth()+1) + '/' + wStart.getDate());
      }
    } else if (cumRFilter === 'year') {
      var months = [t.jan,t.feb,t.mar,t.apr,t.may,t.jun,t.jul,t.aug,t.sep,t.oct,t.nov,t.dec];
      for (var m = 0; m < 12; m++) {
        var monthTrades = activeClosed.filter(function(tr) {
          var trDate = new Date(tr.exitTime || tr.entryTime);
          return trDate.getFullYear() === now.getFullYear() && trDate.getMonth() === m;
        });
        var monthR = monthTrades.reduce(function(s,tr){return s+tr.r;},0);
        data.push(monthR);
        labels.push(months[m]);
      }
    } else { // all ‚Äî cumulative line chart by date
      isLineMode = true;
      var sortedAll = activeClosed.slice().sort(function(a,b){
        return new Date(a.exitTime||a.entryTime) - new Date(b.exitTime||b.entryTime);
      });
      var dailyR = {};
      sortedAll.forEach(function(tr) {
        var ds = (tr.exitTime||tr.entryTime||'').split('T')[0];
        if (!dailyR[ds]) dailyR[ds] = 0;
        dailyR[ds] += tr.r;
      });
      var dates = Object.keys(dailyR).sort();
      var cumR = 0;
      dates.forEach(function(d) {
        cumR += dailyR[d];
        data.push(cumR);
        labels.push(d.slice(5).replace('-','/'));
      });
    }

    if (data.length === 0 || data.every(function(v){return v === 0;})) {
      return h('div',{style:{height:'100%',display:'flex',alignItems:'center',justifyContent:'center',color:C.textS}},t.noData);
    }

    var svgW = 500, svgH = 200;

    // ‚îÄ‚îÄ "All" mode: cumulative area+line chart ‚îÄ‚îÄ
    if (isLineMode && data.length >= 2) {
      var marginL = 40, marginR = 12, marginT = 14, marginB = 24;
      var cW = svgW - marginL - marginR, cH = svgH - marginT - marginB;
      var mx = Math.max.apply(null, data), mn = Math.min.apply(null, data);
      var pad = (mx - mn) * 0.1 || 1;
      var dMin = mn - pad, dMax = mx + pad, dRg = dMax - dMin || 1;
      var scY = function(v){ return marginT + cH - ((v - dMin) / dRg) * cH; };
      var pts = data.map(function(v,i){
        return {x: marginL + (i / (data.length - 1)) * cW, y: scY(v)};
      });

      // Catmull-Rom spline
      var sp;
      if (pts.length <= 2) {
        sp = 'M ' + pts[0].x.toFixed(1) + ' ' + pts[0].y.toFixed(1) + ' L ' + pts[pts.length-1].x.toFixed(1) + ' ' + pts[pts.length-1].y.toFixed(1);
      } else {
        sp = 'M ' + pts[0].x.toFixed(1) + ' ' + pts[0].y.toFixed(1);
        for (var si = 0; si < pts.length - 1; si++) {
          var sp0 = pts[si === 0 ? 0 : si - 1], sp1 = pts[si], sp2 = pts[si + 1], sp3 = pts[si + 2 >= pts.length ? pts.length - 1 : si + 2];
          var st = 0.35;
          sp += ' C ' + (sp1.x + (sp2.x - sp0.x) * st).toFixed(1) + ' ' + (sp1.y + (sp2.y - sp0.y) * st).toFixed(1) + ', ' + (sp2.x - (sp3.x - sp1.x) * st).toFixed(1) + ' ' + (sp2.y - (sp3.y - sp1.y) * st).toFixed(1) + ', ' + sp2.x.toFixed(1) + ' ' + sp2.y.toFixed(1);
        }
      }

      var isPos = data[data.length - 1] >= 0;
      var lineCol = isPos ? '#10b981' : '#ef4444';
      var chartBot = marginT + cH;
      var areaP = sp + ' L ' + pts[pts.length-1].x.toFixed(1) + ' ' + chartBot + ' L ' + pts[0].x.toFixed(1) + ' ' + chartBot + ' Z';

      // X-axis labels (max 7)
      var xLblCount = Math.min(7, data.length);
      var xLbls = [];
      for (var xi = 0; xi < xLblCount; xi++) {
        var xIdx = Math.round(xi * (data.length - 1) / (xLblCount - 1));
        xLbls.push({x: pts[xIdx].x, label: labels[xIdx]});
      }

      // Y-axis: 0 line + end value
      var zeroLineY = scY(0);
      var showZero = mn < 0 && mx > 0;

      return h('div', {style: {height: '100%', position: 'relative'}},
        h('svg', {viewBox: '0 0 ' + svgW + ' ' + svgH, style: {width: '100%', height: '100%'}, preserveAspectRatio: 'xMidYMid meet'},
          // Gradient
          h('defs', null,
            h('linearGradient', {id: 'cumRGrad', x1: '0', y1: '0', x2: '0', y2: '1'},
              h('stop', {offset: '0%', stopColor: lineCol, stopOpacity: 0.3}),
              h('stop', {offset: '100%', stopColor: lineCol, stopOpacity: 0.02})
            )
          ),
          // Area fill
          h('path', {d: areaP, fill: 'url(#cumRGrad)'}),
          // Line
          h('path', {d: sp, fill: 'none', stroke: lineCol, strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round'}),
          // Zero line
          showZero && h('line', {x1: marginL, y1: zeroLineY, x2: svgW - marginR, y2: zeroLineY, stroke: C.border, strokeWidth: 1, strokeDasharray: '4,3'}),
          // End value badge
          h('text', {x: pts[pts.length-1].x, y: pts[pts.length-1].y - 8, textAnchor: 'middle', fill: lineCol, fontSize: 12, fontWeight: 700, fontFamily: 'monospace'}, (data[data.length-1] >= 0 ? '+' : '') + data[data.length-1].toFixed(1) + 'R'),
          // X labels
          xLbls.map(function(lb, li) {
            return h('text', {key: li, x: lb.x, y: svgH - 4, textAnchor: 'middle', fill: C.textM, fontSize: 10, fontFamily: 'monospace'}, lb.label);
          }),
          // Y-axis labels (min/max)
          h('text', {x: marginL - 4, y: marginT + 4, textAnchor: 'end', fill: C.textS, fontSize: 9, fontFamily: 'monospace'}, (mx >= 0 ? '+' : '') + mx.toFixed(0) + 'R'),
          h('text', {x: marginL - 4, y: chartBot, textAnchor: 'end', fill: C.textS, fontSize: 9, fontFamily: 'monospace'}, (mn >= 0 ? '+' : '') + mn.toFixed(0) + 'R'),
          // Start dot
          h('circle', {cx: pts[0].x, cy: pts[0].y, r: 3, fill: lineCol, opacity: 0.6}),
          // End dot
          h('circle', {cx: pts[pts.length-1].x, cy: pts[pts.length-1].y, r: 4, fill: lineCol})
        )
      );
    }

    // ‚îÄ‚îÄ Bar chart mode (week, month, today, year) ‚îÄ‚îÄ
    var maxAbs = Math.max.apply(null, data.map(function(v){return Math.abs(v);})) || 1;
    var hasNeg = data.some(function(v){return v < 0;});

    var displayData = data;
    var displayLabels = labels;
    if (data.length > 12) {
      var step = Math.ceil(data.length / 12);
      displayData = data.filter(function(_,i){return i % step === 0;});
      displayLabels = labels.filter(function(_,i){return i % step === 0;});
    }

    var barAreaTop = 28, barAreaBottom = 24;
    var barAreaH = svgH - barAreaTop - barAreaBottom;
    var n = displayData.length;
    var sidePad = 25;
    var barGap = 8;
    var barW = Math.min((svgW - 2 * sidePad - barGap * (n - 1)) / n, 50);
    var totalBarsW = n * barW + (n - 1) * barGap;
    var startX = (svgW - totalBarsW) / 2;
    var zeroY = hasNeg ? barAreaTop + barAreaH / 2 : barAreaTop + barAreaH;
    var maxBarH = hasNeg ? barAreaH / 2 - 4 : barAreaH - 4;

    var bars = displayData.map(function(val, i) {
      var x = startX + i * (barW + barGap);
      var ht = maxAbs > 0 ? (Math.abs(val) / maxAbs) * maxBarH : 0;
      ht = Math.max(ht, val !== 0 ? 4 : 0);
      var isPos = val >= 0;
      var barY = isPos ? zeroY - ht : zeroY;
      var color = val === 0 ? C.textM : (isPos ? C.pos : C.neg);
      var labelY = isPos ? barY - 5 : barY + ht + 14;
      return h('g', {key: i},
        h('rect', {x: x, y: barY, width: barW, height: ht, rx: 3, fill: color, opacity: 0.85}),
        h('text', {x: x + barW / 2, y: labelY, textAnchor: 'middle', fill: color, fontSize: 12, fontWeight: 700, fontFamily: 'monospace'}, val.toFixed(1)),
        h('text', {x: x + barW / 2, y: svgH - 4, textAnchor: 'middle', fill: C.textM, fontSize: 11, fontWeight: 500, fontFamily: 'monospace'}, displayLabels[i])
      );
    });

    return h('div', {style: {height: '100%', position: 'relative'}},
      h('svg', {viewBox: '0 0 ' + svgW + ' ' + svgH, style: {width: '100%', height: '100%'}, preserveAspectRatio: 'xMidYMid meet'},
        hasNeg && h('line', {x1: 10, y1: zeroY, x2: svgW - 10, y2: zeroY, stroke: C.border, strokeWidth: 1, strokeDasharray: '4,4'}),
        bars
      )
    );
  };

  // Donut chart
  var renderDonut = function(data, centerTxt, centerSub) {
    var total = data.reduce(function(s,d){return s+d.value;},0);
    if (total === 0) return h('div',{style:{width:120,height:120,display:'flex',alignItems:'center',justifyContent:'center',color:C.textS}},'-');
    var size = 120, sw = 20, r = (size-sw)/2, circ = 2*Math.PI*r;
    var cum = 0;
    return h('div',{style:{position:'relative',width:size,height:size}},
      h('svg',{width:size,height:size,style:{transform:'rotate(-90deg)'}},
        data.map(function(d,i){
          var pct = d.value/total;
          var da = (pct*circ)+' '+circ;
          var offset = -cum*circ;
          cum += pct;
          return h('circle',{key:i,cx:size/2,cy:size/2,r:r,fill:'none',stroke:d.color,strokeWidth:sw,strokeDasharray:da,strokeDashoffset:offset,strokeLinecap:'round'});
        })
      ),
      h('div',{style:{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',textAlign:'center'}},
        h('div',{style:{fontSize:20,fontWeight:700,color:C.text}},centerTxt),
        centerSub && h('div',{style:{fontSize:10,color:C.textS}},centerSub)
      )
    );
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ON-CHAIN REGIME HELPERS ‚Äî Used by all tabs (header, overview, trades, insights, analytics)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var OC_REGIMES = ['EXTREME_FEAR', 'FEAR', 'NEUTRAL', 'GREED', 'EXTREME_GREED'];
  var ocRegimeColor = function(r) { return r==='EXTREME_FEAR'?'#22c55e':r==='FEAR'?'#86efac':r==='GREED'?'#fbbf24':r==='EXTREME_GREED'?'#ef4444':'#94a3b8'; };
  var ocRegimeBg = function(r) { return r==='EXTREME_FEAR'?'#22c55e22':r==='FEAR'?'#86efac22':r==='GREED'?'#fbbf2422':r==='EXTREME_GREED'?'#ef444422':'#94a3b822'; };
  var ocRegimeIcon = function(r) { return r==='EXTREME_FEAR'?'üü¢':r==='FEAR'?'üíö':r==='GREED'?'üü°':r==='EXTREME_GREED'?'üî¥':'‚ö™'; };
  var ocRegimeLabel = function(r) { return r==='EXTREME_FEAR'?'EXT.FEAR':r==='FEAR'?'FEAR':r==='GREED'?'GREED':r==='EXTREME_GREED'?'EXT.GREED':'NEUTRAL'; };
  var detectRegime = function(tr) {
    var regime = tr.onchain_regime || tr.regime || tr.market_regime || tr.trend || tr.market_trend || tr.condition || null;
    if (regime) {
      regime = String(regime).toUpperCase();
      if (OC_REGIMES.indexOf(regime) !== -1) return regime;
      if (regime.indexOf('BULL') !== -1 || regime.indexOf('UP') !== -1) return 'GREED';
      if (regime.indexOf('BEAR') !== -1 || regime.indexOf('DOWN') !== -1) return 'FEAR';
      if (regime.indexOf('RANGE') !== -1 || regime.indexOf('SIDE') !== -1 || regime.indexOf('FLAT') !== -1) return 'NEUTRAL';
    }
    return activeBot.onchain_regime || 'NEUTRAL';
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MAIN RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  return h('div',{style:{minHeight:'100vh',background:theme==='matrix'?'transparent':C.bg,color:C.text,fontFamily:"'Inter',sans-serif",transition:'background .3s,color .3s'}},

    // üÜï Mobile Menu - MOVED OUTSIDE HEADER to fix overflow:hidden bug
    mobileMenuOpen && h('div',{className:'mobile-menu-overlay open',onClick:function(){setMobileMenuOpen(false);}}),
    h('div',{className:'mobile-menu'+(mobileMenuOpen?' open':''),style:{background:C.card,borderRight:'1px solid '+C.border}},
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}},
        h('img',{src:'logo.jpg',style:{width:36,height:36,borderRadius:8}}),h('div',{style:{fontSize:18,fontWeight:700,color:C.accent}},'Trinity Bot'),
        h('button',{onClick:function(){setMobileMenuOpen(false);},style:{background:'transparent',border:'none',fontSize:24,color:C.text,cursor:'pointer'}},'√ó')
      ),
      // Mobile nav items
      [['overview','üìä',t.overview],['trades','üìà',t.trades],['analytics','üìâ',t.analytics],['insights','üí°',t.insights],['achievements','üèÜ',t.achievements],['journal','üìì',t.journal],['social','ùïè',t.social],['export','üì§',t.export],['botControl','ü§ñ',t.botControl],['monitor','üõ°Ô∏è',t.monitor],['onchain','üîó',t.onchain],['altseason','üåä',t.altseason],['funding','üåæ',t.funding||'Funding']].map(function(item){
        var isActive = tab === item[0];
        return h('div',{key:item[0],onClick:function(){setTab(item[0]);setMobileMenuOpen(false);},style:{display:'flex',alignItems:'center',gap:12,padding:'14px 16px',background:isActive?C.accent+'20':'transparent',borderRadius:10,marginBottom:4,cursor:'pointer',color:isActive?C.accent:C.text}},
          h('span',{style:{fontSize:18}},item[1]),
          h('span',{style:{fontWeight:isActive?600:400}},item[2])
        );
      }),
      h('div',{style:{borderTop:'1px solid '+C.border,marginTop:16,paddingTop:16}},
        // Theme selector in mobile menu
        h('div',{style:{marginBottom:8}},
          h('div',{style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',color:C.textS,fontSize:12,fontWeight:600}},'üé® Theme'),
          ['dark','light','trinity','deepspace','cyberpunk','paper','gold','bitcoin','matrix'].map(function(t_name){
            var labels={dark:'üåë Dark',light:'‚òÄÔ∏è Light',trinity:'üü¢ Trinity Core',deepspace:'üåå Deep Space',cyberpunk:'üü£ Cyberpunk',paper:'üìÑ Quant Paper',gold:'üëë Black & Gold',bitcoin:'üü† Genesis BTC',matrix:'üíä MATRIX'};
            return h('div',{key:t_name,onClick:function(){setTheme(t_name);localStorage.setItem('trinity_theme',t_name);},style:{display:'flex',alignItems:'center',gap:10,padding:'10px 16px',cursor:'pointer',borderRadius:8,background:theme===t_name?C.accent+'20':'transparent',color:theme===t_name?C.accent:C.text,minHeight:44}},labels[t_name]);
          })
        ),
        // Language toggle
        h('div',{onClick:function(){setLang(lang==='fr'?'en':'fr');},style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',cursor:'pointer'}},
          h('span',null,'üåê'),
          h('span',null,lang==='fr'?'Fran√ßais':'English')
        ),
        // Hide amounts toggle
        h('div',{onClick:function(){setHide(!hide);},style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',cursor:'pointer',minHeight:44}},
          h('span',null,hide?'üëÅÔ∏è':'üôà'),
          h('span',null,hide?'Show $':'Hide $')
        ),
        // Settings access on mobile
        h('div',{onClick:function(){setShowSettings(true);setMobileMenuOpen(false);},style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',cursor:'pointer',minHeight:44}},
          h('span',null,'‚öôÔ∏è'),
          h('span',null,t.settings)
        ),
        // Twitter/X access on mobile
        h('div',{onClick:function(){setShowTwitter(true);setMobileMenuOpen(false);},style:{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',cursor:'pointer',minHeight:44}},
          h('span',null,'ùïè'),
          h('span',null,t.twitterIntegration||'Twitter/X')
        )
      )
    ),

    // HEADER - RESPONSIVE - V2.1: 2-row layout for readability
    h('header',{style:{background:C.card,borderBottom:'1px solid '+C.border,padding:isMobile?'0 12px':'6px 20px',height:isMobile?60:'auto',display:'flex',flexDirection:'column',justifyContent:'center',position:'fixed',top:0,left:0,right:0,zIndex:101,overflowX:'hidden',overflowY:'hidden'}},

      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',width:'100%',padding:'0 4px'}},
        // Left - Mobile: hamburger + logo, Desktop: full header
        h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:14}},
          // Hamburger menu (mobile only)
          isMobile && h('div',{className:'hamburger',onClick:function(){setMobileMenuOpen(true);},style:{color:C.text}},
            h('span'),h('span'),h('span')
          ),
          // Logo + Title block - CLICKABLE (Home button)
          h('div',{onClick:function(){setTab('overview');},style:{display:'flex',alignItems:'center',gap:12,cursor:'pointer'},title:'Go to Overview'},
            // Logo (larger: 52px desktop)
            h('img',{src:'logo.jpg',style:{width:isMobile?40:52,height:isMobile?40:52,borderRadius:isMobile?10:14,flexShrink:0}}),
            // Title block - nowrap to keep on single lines
            h('div',{style:{display:'flex',flexDirection:'column',justifyContent:'center'}},
              h('div',{style:{fontSize:isMobile?16:22,fontWeight:800,color:C.accent,whiteSpace:'nowrap',lineHeight:1.2}},isMobile?'Trinity':'Trinity Bot'),
              !isMobile && h('div',{style:{fontSize:11,color:C.textS,whiteSpace:'nowrap',lineHeight:1.3}},CONFIG.VERSION+' | üîí '+t.privateStrategy)
            )
          ),
          // üé® V4.5 - Status pills container with better spacing
          h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:14,marginLeft:isMobile?4:12,flexShrink:0}},
            // Status pill (online/offline) + last update staleness
            (function(){
              var staleSeconds = lastUpdate ? Math.floor((Date.now() - lastUpdate.getTime()) / 1000) : 999;
              var staleColor = staleSeconds > 60 ? C.neg : staleSeconds > 30 ? C.warn : (activeConnected ? C.pos : C.neg);
              var staleBg = staleSeconds > 60 ? C.negL : staleSeconds > 30 ? C.warnL : (activeConnected ? C.posL : C.negL);
              var staleLabel = !lastUpdate ? '' : staleSeconds < 10 ? '' : staleSeconds+'s';
              return h('div',{style:pill(staleColor, staleBg), title:lastUpdate ? lastUpdate.toLocaleTimeString() : 'No data'},
                h('span',{style:{width:7,height:7,borderRadius:'50%',background:staleColor,flexShrink:0,position:'relative',zIndex:10}}),
                isMobile ? staleLabel : (activeConnected ? t.online : t.offline) + (staleLabel ? ' '+staleLabel : '')
              );
            })(),
            // On-Chain Regime pill (all screens - compact on mobile)
            (function(){
              var ocR = activeBot.onchain_regime || 'NEUTRAL';
              var ocColor = ocR==='EXTREME_FEAR'?'#22c55e':ocR==='FEAR'?'#86efac':ocR==='GREED'?'#fbbf24':ocR==='EXTREME_GREED'?'#ef4444':'#94a3b8';
              var ocBg = ocR==='EXTREME_FEAR'?'#22c55e22':ocR==='FEAR'?'#86efac22':ocR==='GREED'?'#fbbf2422':ocR==='EXTREME_GREED'?'#ef444422':'#94a3b822';
              var ocIcon = ocR==='EXTREME_FEAR'?'üü¢':ocR==='FEAR'?'üíö':ocR==='GREED'?'üü°':ocR==='EXTREME_GREED'?'üî¥':'‚ö™';
              var ocLabel = ocR==='EXTREME_FEAR'?'EXT.FEAR':ocR==='FEAR'?'FEAR':ocR==='GREED'?'GREED':ocR==='EXTREME_GREED'?'EXT.GREED':'NEUTRAL';
              return h('div',{style:pill(ocColor,ocBg)},ocIcon,isMobile?'':' '+ocLabel);
            })(),
            // LIVE NOW pill with pulsing dot - V4.5 enhanced visibility
            activeOpenPos.length>0 && h('div',{onClick:function(){setTab('trades');},style:Object.assign({},pill(C.live,C.liveL),{animation:'livePulse 2s infinite',cursor:'pointer',zIndex:10})},
              h('span',{style:{width:8,height:8,borderRadius:'50%',background:C.live,animation:'pulse 1s infinite',flexShrink:0,position:'relative',zIndex:100,boxShadow:'0 0 4px '+C.live}}),
              activeOpenPos.length+(isMobile?'':' '+t.liveNow)
            )
          ),
          // üÜï V2.0: Market selector tabs (Crypto | HIP-3 | Unified) ‚Äî desktop only in header, mobile has dedicated bar below
          !isMobile && h('div',{style:{display:'flex',gap:2,marginLeft:16,background:C.bg,borderRadius:10,padding:3}},
            [
              ['crypto','üü¢','Crypto'],
              ['hip3','üîµ','HIP-3'],
              ['unified','üìä',isMobile?'All':'Unified']
            ].map(function(item){
              var id=item[0],icon=item[1],label=item[2];
              var isActive=market===id;
              return h('button',{key:id,onClick:function(){setMarket(id);},style:{
                padding:isMobile?'6px 10px':'8px 14px',
                background:isActive?(id==='crypto'?C.pos+'30':id==='hip3'?C.info+'30':C.accent+'30'):'transparent',
                border:isActive?'1px solid '+(id==='crypto'?C.pos:id==='hip3'?C.info:C.accent):'1px solid transparent',
                borderRadius:8,color:isActive?(id==='crypto'?C.pos:id==='hip3'?C.info:C.accent):C.textS,
                fontSize:isMobile?11:12,fontWeight:isActive?700:500,cursor:'pointer',
                display:'flex',alignItems:'center',gap:4,whiteSpace:'nowrap',transition:'all .2s'
              }},icon,' ',label,
                // HIP-3 market status dot
                id==='hip3' && h('span',{style:{width:6,height:6,borderRadius:'50%',background:hip3Bot.market_open?C.pos:C.neg,marginLeft:2}}),
                // HIP-3 positions count
                id==='hip3' && hip3OpenPos.length>0 && h('span',{style:{fontSize:9,fontWeight:700,color:C.live,marginLeft:2}},hip3OpenPos.length),
                // Unified total
                id==='unified' && (openPos.length+hip3OpenPos.length)>0 && h('span',{style:{fontSize:9,fontWeight:700,color:C.live,marginLeft:2}},openPos.length+hip3OpenPos.length)
              );
            })
          ),
          // (V2.1: Prices ticker moved to Row 2 below)
          // STREAK (Achievements) - compact on tablet, hidden on mobile
          !isMobile && h('div',{className:'desktop-streak-pills',style:{display:'flex',alignItems:'center',gap:isTablet?8:12,background:C.bg,padding:isTablet?'8px 10px':'10px 14px',borderRadius:10,marginLeft:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:6}},
              h('span',{style:{fontSize:isTablet?16:20}},'üî•'),
              h('div',{style:{fontSize:isTablet?14:16,fontWeight:700}},activeStats.currentStreak)
            ),
            !isTablet && h('div',{style:{width:1,height:28,background:C.border}}),
            !isTablet && h('div',{style:{display:'flex',alignItems:'center',gap:6}},
              h('span',{style:{fontSize:20}},'üèÜ'),
              h('div',{style:{fontSize:16,fontWeight:700}},activeStats.bestStreak)
            )
          )
        ),
        // Right - RESPONSIVE (avec marge gauche pour s√©parer des Achievements)
        h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?6:12,marginLeft:isMobile?0:24}},
          // Daily R Goal - Compact on mobile
          h('div',{style:{background:C.bg,padding:isMobile?'6px 10px':'10px 14px',borderRadius:10,minWidth:isMobile?80:120}},
            isMobile 
              ? h('div',{style:{textAlign:'center'}},
                  h('div',{style:{fontSize:14,fontWeight:700,color:activeStats.todayR>=settings.dailyRGoal?C.pos:C.text}},fmtR(activeStats.todayR)),
                  h('div',{style:{fontSize:11,color:C.textS}},t.daily)
                )
              : h('div',null,
                  h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',gap:12,marginBottom:4}},
                    h('span',{style:{fontSize:10,color:C.textS}},t.daily+' '+settings.dailyRGoal+'R'),
                    h('span',{style:{fontSize:14,fontWeight:700,color:activeStats.todayR>=settings.dailyRGoal?C.pos:C.text}},fmtR(activeStats.todayR))
                  ),
                  h('div',{style:{width:'100%',height:4,background:C.border,borderRadius:2,overflow:'hidden'}},
                    h('div',{style:{width:dailyRProg+'%',height:'100%',background:activeStats.todayR>=settings.dailyRGoal?C.pos:C.accent,borderRadius:2}})
                  )
                )
          ),
          // Weekly R Goal - hide on mobile
          !isMobile && h('div',{style:{background:C.bg,padding:'10px 14px',borderRadius:10,minWidth:130}},
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',gap:12,marginBottom:4}},
              h('span',{style:{fontSize:10,color:C.textS}},t.weekly+' '+settings.weeklyRGoal+'R'),
              h('span',{style:{fontSize:14,fontWeight:700,color:activeStats.weekR>=settings.weeklyRGoal?C.pos:C.text}},fmtR(activeStats.weekR))
            ),
            h('div',{style:{width:'100%',height:4,background:C.border,borderRadius:2,overflow:'hidden'}},
              h('div',{style:{width:weeklyRProg+'%',height:'100%',background:activeStats.weekR>=settings.weeklyRGoal?C.pos:C.accent,borderRadius:2}})
            )
          ),
          // Buttons - responsive sizes
          h('button',{onClick:function(){setHide(!hide);},style:{width:44,height:44,background:C.bg,border:'none',borderRadius:10,cursor:'pointer',fontSize:18}},hide?'üôà':'üí∞'),
          !isMobile && h('div',{style:{display:'flex',borderRadius:10,overflow:'hidden',background:C.bg,height:44}},
            h('button',{onClick:function(){setLang('fr');},style:{padding:'0 12px',background:lang==='fr'?C.accent:'transparent',color:lang==='fr'?C.bg:C.textS,border:'none',fontSize:12,fontWeight:600,cursor:'pointer'}},'FR'),
            h('button',{onClick:function(){setLang('en');},style:{padding:'0 12px',background:lang==='en'?C.accent:'transparent',color:lang==='en'?C.bg:C.textS,border:'none',fontSize:12,fontWeight:600,cursor:'pointer'}},'EN')
          ),
          !isMobile && h('button',{onClick:function(){setShowTwitter(true);},style:{width:44,height:44,background:C.bg,border:'none',borderRadius:10,cursor:'pointer',fontSize:16,fontWeight:800,color:C.text}},'ùïè'),
          h('button',{onClick:function(){setShowThemePicker(!showThemePicker);},style:{width:44,height:44,background:C.bg,border:'none',borderRadius:10,cursor:'pointer',fontSize:18}},'üé®'),
          showThemePicker && ReactDOM.createPortal(
            h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:200000},onClick:function(){setShowThemePicker(false);}},
              h('div',{style:{position:'fixed',top:isMobile?'auto':120,bottom:isMobile?80:'auto',right:isMobile?16:60,left:isMobile?16:'auto',background:C.card,border:'1px solid '+C.border,borderRadius:12,padding:8,minWidth:180,maxHeight:isMobile?'60vh':'auto',overflowY:isMobile?'auto':'visible',boxShadow:'0 8px 32px rgba(0,0,0,0.5)'},onClick:function(e){e.stopPropagation();}},
                h('div',{onClick:function(){setTheme('dark');localStorage.setItem('trinity_theme','dark');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='dark'?C.accentL:'transparent'}},'üåë Dark'),
                h('div',{onClick:function(){setTheme('light');localStorage.setItem('trinity_theme','light');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='light'?C.accentL:'transparent'}},'‚òÄÔ∏è Light'),
                h('div',{onClick:function(){setTheme('trinity');localStorage.setItem('trinity_theme','trinity');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='trinity'?C.accentL:'transparent'}},'üü¢ Trinity Core'),
                h('div',{onClick:function(){setTheme('deepspace');localStorage.setItem('trinity_theme','deepspace');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='deepspace'?C.accentL:'transparent'}},'üåå Deep Space'),
                h('div',{onClick:function(){setTheme('cyberpunk');localStorage.setItem('trinity_theme','cyberpunk');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='cyberpunk'?C.accentL:'transparent'}},'üü£ Cyberpunk'),
                h('div',{onClick:function(){setTheme('paper');localStorage.setItem('trinity_theme','paper');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='paper'?C.accentL:'transparent'}},'üìÑ Quant Paper'),
                h('div',{onClick:function(){setTheme('gold');localStorage.setItem('trinity_theme','gold');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='gold'?C.accentL:'transparent'}},'üëë Black & Gold'),
                h('div',{onClick:function(){setTheme('bitcoin');localStorage.setItem('trinity_theme','bitcoin');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='bitcoin'?C.accentL:'transparent'}},'üü† Genesis BTC'),
                h('div',{style:{borderTop:'1px solid '+(C.border||'#333'),margin:'4px 0'}}),
                h('div',{onClick:function(){setTheme('matrix');localStorage.setItem('trinity_theme','matrix');setShowThemePicker(false);},style:{display:'flex',alignItems:'center',gap:10,padding:'12px 12px',minHeight:44,cursor:'pointer',borderRadius:8,background:theme==='matrix'?'rgba(0,255,65,.2)':'transparent',color:theme==='matrix'?'#00FF41':C.text,fontFamily:'Share Tech Mono, monospace',letterSpacing:'2px',textShadow:theme==='matrix'?'0 0 8px rgba(0,255,65,0.5)':'none'}},'üíä MATRIX')
              )
            ),
            document.body
          ),
          h('a',{href:'index.html',title:'Landing Page',style:{width:44,height:44,background:C.bg,border:'none',borderRadius:10,cursor:'pointer',fontSize:16,display:'flex',alignItems:'center',justifyContent:'center',textDecoration:'none',color:theme==='matrix'?'#00FF41':C.accent}},'‚ó¨'),
          !isMobile && h('button',{onClick:function(){setShowSettings(true);},style:{width:44,height:44,background:C.bg,border:'none',borderRadius:10,cursor:'pointer',fontSize:18}},'‚öôÔ∏è'),
          // Network Latency + API Weight (moved from nav bar to header)
          !isMobile && (function(){
            var avgLatency = latencyHistory.length > 0 ? Math.round(latencyHistory.reduce(function(a,b){return a+b;},0)/latencyHistory.length) : networkLatency;
            var latencyColor = networkLatency<100?C.pos:networkLatency<300?C.warn:C.neg;
            var apiWeight = typeof activeBot.apiWeight === 'number' ? activeBot.apiWeight : 0;
            var apiWeightColor = apiWeight < 50 ? C.pos : apiWeight < 80 ? C.warn : C.neg;
            return h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('div',{style:{display:'flex',alignItems:'center',gap:6,padding:'6px 10px',background:C.bg,borderRadius:8}},
                h('span',{style:{fontSize:11,color:C.textS}},'üì°'),
                h('span',{style:{fontSize:12,fontWeight:700,color:latencyColor}},(networkLatency||0)+'ms'),
                h('span',{style:{fontSize:9,color:C.textS}},'avg '+avgLatency)
              ),
              h('div',{style:{display:'flex',alignItems:'center',gap:6,padding:'6px 10px',background:C.bg,borderRadius:8}},
                h('span',{style:{fontSize:11,color:C.textS}},'‚öñÔ∏è'),
                h('span',{style:{fontSize:12,fontWeight:700,color:apiWeightColor}},apiWeight.toFixed(1)+'%'),
                h('div',{style:{width:30,height:5,background:C.border,borderRadius:3,overflow:'hidden'}},
                  h('div',{style:{width:apiWeight+'%',height:'100%',background:apiWeightColor,borderRadius:3,transition:'width 0.3s'}})
                )
              )
            );
          })()
        )
      ),
      // üÜï V2.1 Row 2: MARKET-AWARE PRICES TICKER (full width, scrollable)
      !isMobile && h('div',{className:'prices-bar',style:{display:'flex',gap:8,marginTop:4,paddingTop:6,borderTop:'1px solid '+C.border+'40',overflowX:'auto',overflowY:'hidden',width:'100%',justifyContent:'center'}},
        (function(){
          var items = [];
          if (market !== 'hip3') {
            items = items.concat([
              ['BTC',prices.BTC,prices.btcChange],['ETH',prices.ETH,prices.ethChange],
              ['SOL',prices.SOL,prices.solChange],
              market!=='unified' && ['LINK',prices.LINK,prices.linkChange],
              market!=='unified' && ['SEI',prices.SEI,prices.seiChange],
              market!=='unified' && ['DOGE',prices.DOGE,prices.dogeChange],
              market!=='unified' && ['SUI',prices.SUI,prices.suiChange]
            ]);
          }
          if (market !== 'crypto') {
            var stockOrder = ['NVDA','TSLA','AAPL','MSFT','AMZN','META','GOOGL','AMD','COIN','PLTR','HOOD','MSTR'];
            var maxStocks = market==='unified' ? 6 : 12;
            stockOrder.slice(0,maxStocks).forEach(function(sym){ items.push([sym,stockPrices[sym]||0,null]); });
          }
          return items.filter(Boolean).map(function(item){
            var sym=item[0],price=item[1],change=item[2];
            var isStock = !!stockLogos[sym];
            var isLoading = !price || price===0;
            return h('div',{key:sym,style:{background:C.bg,padding:'6px 12px',borderRadius:8,display:'flex',alignItems:'center',gap:8,flexShrink:0,border:isStock?'1px solid '+C.info+'25':'none'}},
              cryptoLogo(sym, 28),
              h('div',null,
                isLoading
                  ? h('div',{style:{fontSize:12,color:C.textS,animation:'pulse 1s infinite'}},'...')
                  : h('div',null,
                      h('div',{style:{fontSize:14,fontWeight:700}},'$'+(price>=1000?Math.round(price).toLocaleString():price<0.01?price.toFixed(6):price<1?price.toFixed(4):price.toFixed(2))),
                      change !== null
                        ? h('div',{style:{fontSize:10,color:change>=0?C.pos:C.neg,fontWeight:600}},(change>=0?'+':'')+change.toFixed(2)+'%')
                        : h('div',{style:{fontSize:10,color:C.info,fontWeight:600}},'HIP-3')
                    )
              )
            );
          });
        })()
      )
    ),

    // üÜï V2.2: MOBILE MARKET SELECTOR BAR ‚Äî fixed below header
    isMobile && h('div',{style:{position:'fixed',top:60,left:0,right:0,zIndex:100,background:C.card,borderBottom:'1px solid '+C.border,display:'flex',justifyContent:'center',alignItems:'center',padding:'6px 12px',gap:4}},
      [
        ['crypto','üü¢','Crypto'],
        ['hip3','üîµ','HIP-3'],
        ['unified','üìä','All']
      ].map(function(item){
        var id=item[0],icon=item[1],label=item[2];
        var isActive=market===id;
        return h('button',{key:id,onClick:function(){setMarket(id);},style:{
          padding:'7px 16px',flex:1,maxWidth:120,
          background:isActive?(id==='crypto'?C.pos+'30':id==='hip3'?C.info+'30':C.accent+'30'):'transparent',
          border:isActive?'1px solid '+(id==='crypto'?C.pos:id==='hip3'?C.info:C.accent):'1px solid '+C.border+'60',
          borderRadius:8,color:isActive?(id==='crypto'?C.pos:id==='hip3'?C.info:C.accent):C.textS,
          fontSize:12,fontWeight:isActive?700:500,cursor:'pointer',
          display:'flex',alignItems:'center',justifyContent:'center',gap:4,whiteSpace:'nowrap',transition:'all .2s',
          minHeight:36
        }},icon,' ',label,
          id==='hip3' && h('span',{style:{width:6,height:6,borderRadius:'50%',background:hip3Bot.market_open?C.pos:C.neg,marginLeft:3}}),
          id==='hip3' && hip3OpenPos.length>0 && h('span',{style:{fontSize:9,fontWeight:700,color:C.live,marginLeft:3}},hip3OpenPos.length),
          id==='unified' && (openPos.length+hip3OpenPos.length)>0 && h('span',{style:{fontSize:9,fontWeight:700,color:C.live,marginLeft:3}},openPos.length+hip3OpenPos.length)
        );
      })
    ),

    // Error banner
    connError && h('div',{style:{background:C.negL,borderBottom:'1px solid '+C.neg,padding:10,textAlign:'center'}},
      h('span',{style:{color:C.neg,fontSize:12}},'‚ö†Ô∏è '+t.offline+': '+connError)
    ),

    // NAV - V7.2: Aligned with main content padding
    h('nav',{className:'sticky-nav nav-container',style:{background:C.card,borderBottom:'1px solid '+C.border,position:'fixed',top:isMobile?60:110,left:0,right:0,zIndex:100,display:isMobile?'none':'block'}},
      h('div',{style:{maxWidth:1800,margin:'0 auto',padding:'0 24px',display:'flex',justifyContent:'center',alignItems:'center'}},
        h('div',{className:'nav-tabs',style:{display:'flex',gap:0,overflowX:'auto',WebkitOverflowScrolling:'touch'}},
          [['overview','üìä',t.overview],['trades','üìà',t.trades],['analytics','üìâ',t.analytics],['insights','üí°',t.insights],['achievements','üèÜ',t.achievements],['journal','üìì',t.journal],['social','ùïè',t.social],['export','üì§',t.export],['botControl','ü§ñ',t.botControl],['monitor','üõ°Ô∏è',t.monitor],['onchain','üîó',t.onchain],['altseason','üåä',t.altseason],['funding','üåæ',t.funding||'Funding']].map(function(item){
            var id=item[0],icon=item[1],label=item[2];
            return h('button',{key:id,onClick:function(){setTab(id);},style:{padding:isMobile?'12px 14px':'16px 20px',background:tab===id?C.posL:'transparent',border:'none',borderBottom:tab===id?'2px solid '+C.accent:'2px solid transparent',color:tab===id?C.accent:C.textS,fontSize:isMobile?11:13,fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',gap:isMobile?4:8,whiteSpace:'nowrap',flexShrink:0}},icon,isMobile?'':' '+label);
          })
        )
      )
    ),

    // Notifications
    h('div',{style:{position:'fixed',top:isMobile?118:160,right:isMobile?12:24,left:isMobile?12:'auto',zIndex:99,display:'flex',flexDirection:'column',gap:8}},
      notifs.map(function(n){
        return h('div',{key:n.id,style:{padding:isMobile?'10px 14px':'12px 20px',background:n.type==='error'?C.neg:C.pos,color:'#fff',borderRadius:10,fontSize:isMobile?12:13,fontWeight:600,boxShadow:'0 4px 12px rgba(0,0,0,.3)'}},n.msg);
      })
    ),

    // V2.3: Pull-to-refresh indicator (mobile)
    isMobile && h('div',{className:'pull-refresh-indicator'+(pullRefresh.y>60?' visible':''),style:{opacity:Math.min(1,pullRefresh.y/60)}},
      pullRefresh.y>60 ? (lang==='fr'?'Rel√¢chez pour rafra√Æchir':'Release to refresh') : (lang==='fr'?'Tirez pour rafra√Æchir':'Pull to refresh')
    ),

    // MAIN CONTENT - V7.3b: Balanced breathing room (mobile: header 60 + market bar 48 + gap = 120)
    h('main',{style:{padding:isMobile?12:24,paddingTop:isMobile?120:190,paddingBottom:isMobile?90:24,maxWidth:1800,margin:'0 auto'}},

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // üÜï V2.0 COMMAND CENTER: Dual Engine Status Banner (Unified mode)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      market==='unified' && tab==='overview' && h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:12,marginBottom:16}},
        // Crypto Engine Card
        h('div',{style:{background:C.card,border:'2px solid '+C.pos,borderRadius:12,padding:16,cursor:'pointer',transition:'transform .15s'},onClick:function(){setMarket('crypto');},onMouseOver:function(e){e.currentTarget.style.transform='scale(1.01)';},onMouseOut:function(e){e.currentTarget.style.transform='scale(1)';}},
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('span',{style:{fontSize:18}},'üü¢'),
              h('span',{style:{fontSize:16,fontWeight:700,color:C.pos}},'CRYPTO ENGINE'),
              h('span',{style:{width:8,height:8,borderRadius:'50%',background:connected?C.pos:C.neg}})
            ),
            h('div',{style:{fontSize:11,color:C.textS}},'24/7')
          ),
          h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}},
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'Balance'),
              h('div',{style:{fontSize:16,fontWeight:700}},hide?'***':'$'+(stats.balance||0).toLocaleString(undefined,{maximumFractionDigits:0}))
            ),
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'R Total'),
              h('div',{style:{fontSize:16,fontWeight:700,color:(stats.totalR||0)>=0?C.pos:C.neg}},(stats.totalR>=0?'+':'')+(stats.totalR||0).toFixed(1)+'R')
            ),
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'Positions'),
              h('div',{style:{fontSize:16,fontWeight:700}},openPos.length+'/6')
            )
          )
        ),
        // HIP-3 Engine Card
        h('div',{style:{background:C.card,border:'2px solid '+C.info,borderRadius:12,padding:16,cursor:'pointer',transition:'transform .15s'},onClick:function(){setMarket('hip3');},onMouseOver:function(e){e.currentTarget.style.transform='scale(1.01)';},onMouseOut:function(e){e.currentTarget.style.transform='scale(1)';}},
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('span',{style:{fontSize:18}},'üîµ'),
              h('span',{style:{fontSize:16,fontWeight:700,color:C.info}},'HIP-3 STOCKS'),
              h('span',{style:{width:8,height:8,borderRadius:'50%',background:hip3Connected?C.pos:C.neg}})
            ),
            h('div',{style:{display:'flex',alignItems:'center',gap:6}},
              h('span',{style:{width:8,height:8,borderRadius:'50%',background:hip3Bot.market_open?C.pos:C.neg}}),
              h('span',{style:{fontSize:11,color:hip3Bot.market_open?C.pos:C.textS}},hip3Bot.market_open?(lang==='fr'?'NYSE OUVERT':'NYSE OPEN'):(lang==='fr'?'NYSE FERM√â':'NYSE CLOSED'))
            )
          ),
          h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8}},
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'Balance'),
              h('div',{style:{fontSize:16,fontWeight:700}},hide?'***':'$'+(hip3Stats.balance||0).toLocaleString(undefined,{maximumFractionDigits:0}))
            ),
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'R Total'),
              h('div',{style:{fontSize:16,fontWeight:700,color:(hip3Stats.totalR||0)>=0?C.pos:C.neg}},(hip3Stats.totalR>=0?'+':'')+(hip3Stats.totalR||0).toFixed(1)+'R')
            ),
            h('div',null,
              h('div',{style:{fontSize:10,color:C.textS}},'Positions'),
              h('div',{style:{fontSize:16,fontWeight:700}},hip3OpenPos.length+'/5')
            )
          )
        )
      ),

      // üÜï V2.0: Unified Portfolio Total (when in unified mode)
      market==='unified' && tab==='overview' && h('div',{style:{background:'linear-gradient(135deg, '+C.pos+'15, '+C.info+'15)',border:'1px solid '+C.border,borderRadius:12,padding:16,marginBottom:16,textAlign:'center'}},
        h('div',{style:{fontSize:12,color:C.textS,marginBottom:8}},'PORTFOLIO TOTAL'),
        h('div',{style:{display:'flex',justifyContent:'center',gap:isMobile?16:40,flexWrap:'wrap'}},
          h('div',null,
            h('div',{style:{fontSize:10,color:C.textS}},'Combined Balance'),
            h('div',{style:{fontSize:isMobile?20:28,fontWeight:800}},hide?'***':'$'+unifiedStats.totalBalance.toLocaleString(undefined,{maximumFractionDigits:0}))
          ),
          h('div',null,
            h('div',{style:{fontSize:10,color:C.textS}},'Total R Today'),
            h('div',{style:{fontSize:isMobile?20:28,fontWeight:800,color:unifiedStats.totalRToday>=0?C.pos:C.neg}},(unifiedStats.totalRToday>=0?'+':'')+unifiedStats.totalRToday.toFixed(1)+'R')
          ),
          h('div',null,
            h('div',{style:{fontSize:10,color:C.textS}},'Active Positions'),
            h('div',{style:{fontSize:isMobile?20:28,fontWeight:800}},unifiedStats.totalPositions+'/'+unifiedStats.maxPositions)
          )
        )
      ),

      // üÜï V2.0: HIP-3 Market Status Banner (when HIP-3 selected)
      market==='hip3' && tab==='overview' && h('div',{style:{background:hip3Bot.market_open?C.posL:C.negL,border:'1px solid '+(hip3Bot.market_open?C.pos:C.neg),borderRadius:12,padding:12,marginBottom:16,display:'flex',alignItems:'center',justifyContent:'center',gap:8}},
        h('span',{style:{width:10,height:10,borderRadius:'50%',background:hip3Bot.market_open?C.pos:C.neg,animation:hip3Bot.market_open?'pulse 2s infinite':'none'}}),
        h('span',{style:{fontSize:14,fontWeight:700,color:hip3Bot.market_open?C.pos:C.neg}},hip3Bot.market_open?'NYSE MARKET OPEN ‚Äî HIP-3 Trading Active':'NYSE MARKET CLOSED ‚Äî HIP-3 Trading Paused'),
        !hip3Connected && h('span',{style:{fontSize:12,color:C.neg,marginLeft:12}},'(Bot Offline)')
      ),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // OVERVIEW TAB - COMPACT VERSION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='overview' && (function(){
        var now = new Date();
        var hour = now.getHours();
        var greeting = hour < 12 ? t.goodMorning : hour < 18 ? t.goodAfternoon : t.goodEvening;
        var greetEmoji = hour < 12 ? 'üåÖ' : hour < 18 ? '‚òÄÔ∏è' : 'üåô';
        
        // Today's trades
        var todayStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        var todayTrades = activeClosed.filter(function(tr) { return new Date(tr.exitTime || tr.entryTime) >= todayStart; });
        var todayR = todayTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
        var todayBest = todayTrades.length > 0 ? Math.max.apply(null, todayTrades.map(function(tr) { return tr.r || 0; })) : 0;
        var todayWorst = todayTrades.length > 0 ? Math.min.apply(null, todayTrades.map(function(tr) { return tr.r || 0; })) : 0;

        // Week/Month trades
        var weekStart = new Date(now); weekStart.setDate(weekStart.getDate() - weekStart.getDay()); weekStart.setHours(0,0,0,0);
        var weekR = activeClosed.filter(function(tr) { return new Date(tr.exitTime || tr.entryTime) >= weekStart; }).reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
        var lastWeekStart = new Date(weekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
        var lastWeekR = activeClosed.filter(function(tr) { var d = new Date(tr.exitTime || tr.entryTime); return d >= lastWeekStart && d < weekStart; }).reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
        var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        var monthR = activeClosed.filter(function(tr) { return new Date(tr.exitTime || tr.entryTime) >= monthStart; }).reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
        var lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        var lastMonthR = activeClosed.filter(function(tr) { var d = new Date(tr.exitTime || tr.entryTime); return d >= lastMonthStart && d < monthStart; }).reduce(function(s, tr) { return s + (tr.r || 0); }, 0);

        var avgR = activeClosed.length > 0 ? activeStats.totalR / activeClosed.length : 0;
        var ddAlert = activeStats.currentDrawdown >= settings.ddAlertThreshold;
        
        // üîÑ V5.0 - On-Chain Regime stats (uses global OC_REGIMES/detectRegime helpers)
        var regimeStats = {};
        OC_REGIMES.forEach(function(r) {
          regimeStats[r] = { count: 0, r: 0, wins: 0, openCount: 0 };
        });

        // Add closed trades
        activeClosed.forEach(function(tr) {
          var r = detectRegime(tr);
          if (!regimeStats[r]) regimeStats[r] = { count: 0, r: 0, wins: 0, openCount: 0 };
          regimeStats[r].count++;
          regimeStats[r].r += tr.r || 0;
          if (tr.pnl > 0.05) regimeStats[r].wins++;
        });
        // Add open positions
        activeOpenPos.forEach(function(pos) {
          var r = detectRegime(pos);
          if (!regimeStats[r]) regimeStats[r] = { count: 0, r: 0, wins: 0, openCount: 0 };
          regimeStats[r].openCount++;
        });
        
        // Heatmap - last 28 days (4 weeks)
        var heatmapDays = [];
        for (var i = 27; i >= 0; i--) {
          var d = new Date(now); d.setDate(d.getDate() - i);
          var dayStr = d.toISOString().split('T')[0];
          var dayTrades = activeClosed.filter(function(tr) { return (tr.exitTime || tr.entryTime || '').startsWith(dayStr); });
          heatmapDays.push({ date: d, r: dayTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0), count: dayTrades.length });
        }
        
        // üïê V4.4 - Helper to parse dates as UTC
        var parseUTC = function(dateStr) {
          if (!dateStr) return new Date(0);
          if (dateStr instanceof Date) return dateStr;
          // If no timezone indicator, assume UTC by adding 'Z'
          var str = String(dateStr);
          if (!str.includes('Z') && !str.includes('+') && !str.match(/-\d{2}:\d{2}$/)) {
            str = str.replace(' ', 'T') + 'Z';
          }
          return new Date(str);
        };
        
        // ‚ö° V4.4 - Activity feed - ENHANCED with 10 items, better icons, and UTC fix
        var activities = [];
        // Add all closed trades
        activeClosed.forEach(function(tr) {
          activities.push({
            type: 'closed',
            time: parseUTC(tr.exitTime || tr.entryTime),
            data: tr
          });
        });
        // Add all open positions
        activeOpenPos.forEach(function(pos) {
          activities.push({
            type: 'open',
            time: parseUTC(pos.entryTime),
            data: pos
          });
        });
        // Sort by time (newest first) and take top 10
        activities.sort(function(a, b) { return b.time - a.time; });
        activities = activities.slice(0, 10);
        
        // üïê V4.4 - Fixed relTime with TIMEZONE CORRECTION
        // Problem: Backend sends UTC timestamps, but Date comparison can be off by timezone offset
        var relTime = function(dateInput) {
          // Get current time in milliseconds (UTC epoch)
          var nowMs = Date.now();
          
          // Parse the input date
          var dateMs;
          if (dateInput instanceof Date) {
            dateMs = dateInput.getTime();
          } else if (typeof dateInput === 'string') {
            // If string doesn't have timezone indicator, assume UTC
            var dateStr = dateInput;
            if (dateStr && !dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
              dateStr = dateStr + 'Z'; // Force UTC interpretation
            }
            dateMs = new Date(dateStr).getTime();
          } else if (typeof dateInput === 'number') {
            dateMs = dateInput;
          } else {
            return '?';
          }
          
          // Check for invalid date
          if (isNaN(dateMs)) return '?';
          
          // Calculate difference in seconds
          var diff = Math.floor((nowMs - dateMs) / 1000);
          
          // V4.4 - Sanity check: if diff is negative or way too large, something's wrong
          // This can happen with timezone issues - try to auto-correct
          if (diff < -60) {
            // Date is in the future by more than 1 min - likely timezone issue
            // Try adding timezone offset
            var tzOffset = new Date().getTimezoneOffset() * 60; // in seconds
            diff = diff + tzOffset;
          }
          
          // If still negative, just show "just now"
          if (diff < 0) diff = 0;
          
          // Format output
          if (diff < 60) return t.justNow || 'just now';
          if (diff < 3600) {
            var mins = Math.floor(diff / 60);
            return mins + (lang==='fr' ? ' min' : 'm');
          }
          if (diff < 86400) {
            var hours = Math.floor(diff / 3600);
            var remainMins = Math.floor((diff % 3600) / 60);
            if (remainMins > 0) return hours + 'h ' + remainMins + 'm';
            return hours + 'h';
          }
          var days = Math.floor(diff / 86400);
          var remainHours = Math.floor((diff % 86400) / 3600);
          if (remainHours > 0) return days + 'd ' + remainHours + 'h';
          return days + 'd';
        };
        
        // Insights
        var insights = [];
        if (ddAlert) insights.push({ type: 'danger', icon: 'üö®', text: t.ddAlertMsg });
        if (activeStats.currentStreak <= -2) insights.push({ type: 'warning', icon: 'üî•', text: t.streakAtRisk });
        
        // Compact section style
        var sec = {background:C.card,borderRadius:12,padding:12,border:'1px solid '+C.border,overflow:'hidden'};
        
        return h('div',null,
          // DD ALERT (if triggered)
          ddAlert && h('div',{style:{background:C.negL,border:'1px solid '+C.neg,borderRadius:8,padding:10,marginBottom:12,display:'flex',alignItems:'center',gap:10}},
            h('span',{style:{fontSize:20}},'üö®'),
            h('span',{style:{fontSize:12,color:C.neg,fontWeight:600}},t.ddAlert+': '+activeStats.currentDrawdown.toFixed(1)+'%')
          ),

          // ROW 1: Welcome + Open Position (if any) + Stats (6 cards compact)
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':(activeOpenPos.length>0?'1fr 1.2fr 2fr':'1fr 3fr'),gap:12,marginBottom:12}},
            // Welcome compact + Exchange coin performance integrated
            h('div',{style:sec},
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:8}},
                h('div',null,
                  h('div',{style:{fontSize:16,fontWeight:700,marginBottom:4}},greeting+' '+greetEmoji),
                  h('div',{style:{fontSize:11,color:C.textS}},activeOpenPos.length > 0 ? activeOpenPos.length+' '+(activeOpenPos.length===1?t.openPosition:t.openPositions) : t.noOpenPositions)
                ),
                // Sync button (compact)
                h('button',{onClick:function(){
                  notify('info','‚è≥ Syncing...');
                  if (market === 'hip3') {
                    fetchAllHip3().then(function(){notify('success','‚úÖ HIP-3 refreshed');}).catch(function(){notify('error','‚ùå HIP-3 sync failed');});
                  } else if (market === 'unified') {
                    Promise.all([
                      fetchApi('/api/sync',{method:'POST'}).then(function(r){if(r&&r.status==='success')return r.imported||0;return 0;}),
                      fetchAllHip3()
                    ]).then(function(res){notify('success','‚úÖ Both engines synced');fetchApi('/api/stats/accurate').then(setAccurateStats);}).catch(function(){notify('error','‚ùå Sync failed');});
                  } else {
                    fetchApi('/api/sync',{method:'POST'}).then(function(r){
                      if(r.status==='success') notify('success','‚úÖ +'+r.imported+' fills');
                      fetchApi('/api/stats/accurate').then(setAccurateStats);
                    }).catch(function(){notify('error','‚ùå Sync failed');});
                  }
                },style:{padding:'4px 8px',fontSize:9,background:market==='hip3'?C.info:'#8B5CF6',color:'#fff',border:'none',borderRadius:4,cursor:'pointer',fontWeight:600,opacity:0.9}},'üîÑ')
              ),
              h('div',{style:{display:'flex',alignItems:'baseline',gap:8,marginBottom:8}},
                h('div',{style:{fontSize:24,fontWeight:800,color:todayR>=0?C.pos:C.neg}},fmtR(todayR)),
                h('div',{style:{fontSize:10,color:C.textS}},t.today)
              ),
              // Exchange coin performance (sorted best to worst) ‚Äî crypto only
              market !== 'hip3' && accurateStats && accurateStats.by_coin && h('div',{style:{display:'flex',flexWrap:'wrap',gap:6,paddingTop:8,borderTop:'1px solid '+C.border}},
                h('span',{style:{fontSize:9,color:'#A78BFA',width:'100%',marginBottom:2}},'üîó '+accurateStats.total_fills+' fills'),
                Object.keys(accurateStats.by_coin).sort(function(a,b){return (accurateStats.by_coin[b].net_pnl||0)-(accurateStats.by_coin[a].net_pnl||0);}).map(function(coin){
                  var coinData = accurateStats.by_coin[coin];
                  var netPnl = coinData.net_pnl || 0;
                  return h('div',{key:coin,style:{display:'flex',alignItems:'center',gap:3,padding:'2px 6px',background:C.bg,borderRadius:4}},
                    cryptoLogo(coin, 14),
                    h('span',{style:{fontSize:10,fontWeight:700,color:netPnl>=0?C.pos:C.neg}},fmtPnl(netPnl))
                  );
                })
              ),
              // HIP-3 stock positions summary (when HIP-3 or unified)
              market !== 'crypto' && hip3OpenPos.length > 0 && h('div',{style:{display:'flex',flexWrap:'wrap',gap:6,paddingTop:8,borderTop:'1px solid '+C.border}},
                h('span',{style:{fontSize:9,color:C.info,width:'100%',marginBottom:2}},'üìä '+hip3OpenPos.length+' stock positions'),
                hip3OpenPos.map(function(pos){
                  var sym = (pos.symbol||'').replace('-PERP','');
                  return h('div',{key:sym,style:{display:'flex',alignItems:'center',gap:3,padding:'2px 6px',background:C.bg,borderRadius:4}},
                    cryptoLogo(sym, 14),
                    h('span',{style:{fontSize:10,fontWeight:600,color:C.info}},sym)
                  );
                })
              )
            ),
            // Open Position (compact) - CLICKABLE to go to trades - NO BIG BADGE
            activeOpenPos.length>0 && h('div',{onClick:function(){setTab('trades');},style:Object.assign({},sec,{border:'1px solid '+C.live,cursor:'pointer',transition:'transform 0.15s, box-shadow 0.15s'}),onMouseOver:function(e){e.currentTarget.style.transform='scale(1.01)';e.currentTarget.style.boxShadow='0 4px 20px '+C.live+'40';},onMouseOut:function(e){e.currentTarget.style.transform='scale(1)';e.currentTarget.style.boxShadow='none';}},
              activeOpenPos.map(function(pos){
                // üî• PRIX TEMPS R√âEL ‚Äî V2.1: market-aware (crypto prices OR stock prices)
                var symbolClean = (pos.symbol || '').replace('-PERP','').replace('/USDT','').replace('USDT','');
                var isStockPos = !!stockLogos[symbolClean];
                var livePrice = isStockPos ? (stockPrices[symbolClean] || pos.currentPrice || pos.entryPrice) : (prices[symbolClean] || pos.currentPrice || pos.entryPrice);
                
                // üßÆ V3.7 - CALCUL PNL USD AVEC SIZE
                var posSize = pos.size || 0;
                var priceDiff = (livePrice - pos.entryPrice);
                var direction = pos.side === 'SHORT' ? -1 : 1;
                var livePnlUSD = priceDiff * posSize * direction;
                
                // üî• CALCUL PNL % EN DIRECT
                var livePnlPct = pos.entryPrice > 0 
                  ? (priceDiff / pos.entryPrice * 100 * direction) 
                  : 0;
                
                // üßÆ V2.7: R based on TRADE RISK (entry - SL), not portfolio risk
                var posSL = parseFloat(pos.initialStopLoss || pos.sl || pos.stop_loss || pos.stopLoss || 0);
                var posRisk = Math.abs(pos.entryPrice - posSL);
                var posPnlDist = priceDiff * direction;
                var liveR = posRisk > 0 ? posPnlDist / posRisk : (pos.r || 0);
                
                var displayScore = (pos.score && pos.score > 0) ? pos.score : '--';
                var isProfit = livePnlPct >= 0;
                
                return h('div',{key:pos.id,style:{display:'flex',alignItems:'center',gap:10,padding:'8px 0',borderBottom:activeOpenPos.indexOf(pos) < activeOpenPos.length - 1 ? '1px solid '+C.border : 'none'}},
                  cryptoLogo(symbolClean, 36),
                  h('div',{style:{flex:1}},
                    h('div',{style:{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}},
                      h('span',{style:{fontSize:14,fontWeight:700}},symbolClean),
                      h('span',{style:{fontSize:9,padding:'2px 6px',background:pos.side==='LONG'?C.posL:C.negL,color:pos.side==='LONG'?C.pos:C.neg,borderRadius:4}},pos.side),
                      posSize > 0 && h('span',{style:{fontSize:9,padding:'2px 6px',background:C.card,color:C.textS,borderRadius:4}},'x'+posSize.toLocaleString()),
                      (function(){var st=(pos.setup_type||pos.setupType||"TIER_BASIC").toUpperCase();var badge=st.indexOf("TIER_PREMIUM")!==-1?{e:"‚≠ê",c:"#9333ea",b:"#9333ea20"}:st.indexOf("TIER_ADVANCED")!==-1?{e:"üî∑",c:"#06b6d4",b:"#06b6d420"}:st.indexOf("SIGNAL_TIER")!==-1?{e:"üì°",c:"#f97316",b:"#f9731620"}:{e:"üìä",c:"#9ca3af",b:"#6b728020"};return h("span",{style:{fontSize:9,padding:"2px 6px",background:badge.b,color:badge.c,borderRadius:4,fontWeight:600}},badge.e);})(),
                      // üî¥üü¢ Point pulsant LIVE selon PnL
                      h('span',{style:{width:8,height:8,borderRadius:'50%',background:isProfit?C.pos:C.neg,animation:'pulse 1.5s infinite',boxShadow:'0 0 6px '+(isProfit?C.pos:C.neg)}}),
                      // PnL % en temps r√©el (prix Binance)
                      h('span',{style:{fontSize:12,fontWeight:700,color:isProfit?C.pos:C.neg}},(isProfit?'+':'')+livePnlPct.toFixed(2)+'%'),
                      // PnL USD si size connu
                      posSize > 0 && h('span',{style:{fontSize:11,color:isProfit?C.pos:C.neg}},'('+fmtPnl(livePnlUSD)+')')
                    ),
                    h('div',{style:{fontSize:10,color:C.textS,marginTop:2}},fmtPrice(pos.entryPrice)+' ‚Üí '+fmtPrice(livePrice)),
                    renderMiniProgressBar(pos, livePrice)
                  ),
                  h('div',{style:{textAlign:'right',minWidth:60}},
                    h('div',{style:{fontSize:16,fontWeight:700,color:liveR>=0?C.pos:C.neg}},fmtR(liveR)),
                    h('div',{style:{fontSize:10,color:C.textS}},displayScore+'/16')
                  )
                );
              })
            ),
            // üé® V10.8 - Stats (6 cards) - Uses Exchange data when available
            // üÜï V10.10 - CASH_FLOW_ISOLATOR: Shows Trading PnL (excluding deposits/withdrawals)
            h('div',{style:Object.assign({},sec,{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:10})},
              (function(){
                // Use Exchange accurate stats if available, otherwise fallback to calculated stats
                // V2.0: Use accurateStats only for crypto market (HL fills are crypto-only)
                var useAccurate = market !== 'hip3' ? accurateStats : null;
                var usePnl = useAccurate ? useAccurate.gross_pnl : activeStats.totalPnl;
                var useNetPnl = useAccurate ? useAccurate.net_pnl : (activeStats.totalPnl - (activeStats.totalFees || 0));
                var useFees = useAccurate ? useAccurate.total_fees : activeStats.totalFees;
                var useWinRate = activeStats.winRate;
                var useVolume = useAccurate ? useAccurate.total_volume : activeStats.totalVolume;
                var isHL = false;
                
                // üÜï V10.10: Use Trading PnL from capital events if available (crypto only)
                var hasCashFlow = market !== 'hip3' && capitalEvents && (capitalEvents.net_cash_flow !== 0 || capitalEvents.events.length > 0);
                var tradingPnl = capitalEvents.trading_pnl !== null ? capitalEvents.trading_pnl : useNetPnl;
                var netFlow = capitalEvents.net_cash_flow || 0;
                
                // Balance tooltip shows cash flow info
                var balanceLabel = t.balance;
                var balanceSubtext = hasCashFlow ? (netFlow >= 0 ? '+' : '') + '$' + netFlow.toFixed(0) + ' ' + (t.netCashFlow || 'flow') : null;
                
                return [
                  ['üí∞',balanceLabel,fmtBal(activeStats.balance),C.text,false,balanceSubtext],
                  ['üìà',hasCashFlow ? (t.tradingPnl || 'TRADING PNL') + ' üè¶' : t.totalPnl + (isHL ? ' üîó' : ''),fmtPnl(hasCashFlow ? tradingPnl : usePnl),(hasCashFlow ? tradingPnl : usePnl)>=0?C.pos:C.neg,isHL || hasCashFlow],
                  ['üéØ',t.winRate + (isHL ? ' üîó' : ''),useWinRate.toFixed(0)+'%',useWinRate>=50?C.pos:C.warn,isHL],
                  ['üíé',t.totalR,fmtR(activeStats.totalR),activeStats.totalR>=0?C.pos:C.neg,false],
                  ['‚ú®','REALIZED PNL' + (isHL ? ' üîó' : ''),fmtPnl(useNetPnl),useNetPnl>=0?C.pos:C.neg,isHL],
                  ['üí∏','FEES' + (isHL ? ' üîó' : ''),(useFees > 0 ? '-$'+(useFees||0).toFixed(2) : '$0.00'),useFees > 0 ? C.warn : C.textS,isHL]
                ];
              })().map(function(item,i){
                var hasSub = item[5];
                return h('div',{key:i,style:{background:item[4]?'linear-gradient(135deg, '+C.bg+' 0%, rgba(139,92,246,0.08) 100%)':C.bg,borderRadius:8,padding:isMobile?8:12,display:'flex',alignItems:'center',gap:isMobile?6:10,border:item[4]?'1px solid rgba(139,92,246,0.2)':'none',position:'relative',overflow:'hidden'}},
                  h('span',{style:{fontSize:isMobile?14:18,flexShrink:0}},item[0]),
                  h('div',{style:{minWidth:0,overflow:'hidden'}},
                    h('div',{style:{fontSize:isMobile?8:10,color:item[4]?'#A78BFA':C.textS,textTransform:'uppercase',letterSpacing:0.5,marginBottom:2,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},item[1]),
                    h('div',{style:{fontSize:isMobile?14:16,fontWeight:700,color:item[3]}},item[2]),
                    hasSub && h('div',{style:{fontSize:8,color:C.textM,marginTop:2}},hasSub)
                  )
                );
              })
            )
          ),

          // ROW 2: Balance Evolution (FIRST & LARGE) + Cumulative R
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1.5fr 1fr',gap:12,marginBottom:12}},
            // Balance Evolution
            h('div',{style:sec},
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10,flexWrap:'wrap',gap:6}},
                h('div',{style:{display:'flex',alignItems:'center',gap:6}},h('span',{style:{fontSize:14}},roiType==='pnl'?'üìà':'üí∞'),h('span',{style:{fontSize:13,fontWeight:700}},roiType==='pnl'?'PnL Evolution':t.balanceEvolution)),
                h('div',{style:{display:'flex',gap:6,alignItems:'center',flexWrap:'wrap'}},
                  // Balance/PnL toggle
                  h('div',{style:{display:'flex',gap:2,background:C.bg,padding:2,borderRadius:4}},
                    h('button',{onClick:function(){setRoiType('balance');},style:{padding:'2px 6px',fontSize:8,background:roiType==='balance'?C.accent:'transparent',border:'none',borderRadius:3,color:roiType==='balance'?'#fff':C.textS,cursor:'pointer'}},'Balance'),
                    h('button',{onClick:function(){setRoiType('pnl');},style:{padding:'2px 6px',fontSize:8,background:roiType==='pnl'?C.info:'transparent',border:'none',borderRadius:3,color:roiType==='pnl'?'#fff':C.textS,cursor:'pointer'}},'PnL')
                  ),
                  // Linear/Log toggle ‚Äî hidden on mobile and in PnL mode
                  !isMobile && roiType !== 'pnl' && h('div',{style:{display:'flex',gap:2,background:C.bg,padding:2,borderRadius:4}},
                    h('button',{onClick:function(){setBalScale('linear');},style:{padding:'2px 6px',fontSize:8,background:balScale==='linear'?C.accent:'transparent',border:'none',borderRadius:3,color:balScale==='linear'?'#fff':C.textS,cursor:'pointer'}},'Linear'),
                    h('button',{onClick:function(){setBalScale('log');},style:{padding:'2px 6px',fontSize:8,background:balScale==='log'?C.accent:'transparent',border:'none',borderRadius:3,color:balScale==='log'?'#fff':C.textS,cursor:'pointer'}},'Log')
                  ),
                  // Time period filters with dynamic years
                  (function(){
                    var tradeYears = {};
                    activeClosed.forEach(function(tr){var y=new Date(tr.exitTime||tr.entryTime).getFullYear();if(y)tradeYears[y]=true;});
                    var years = Object.keys(tradeYears).sort().reverse();
                    var filters = ['day','week','prevWeek','month'];
                    years.forEach(function(y){filters.push(y);});
                    filters.push('all');
                    return h('div',{style:{display:'flex',gap:3,flexWrap:'wrap'}},filters.map(function(f){
                      var label = f==='day'?t.day:f==='week'?t.week:f==='prevWeek'?t.prevWeek:f==='month'?t.month:f==='all'?t.all:f;
                      return h('button',{key:f,onClick:function(){setBalFilter(f);},style:{padding:isMobile?'2px 4px':'3px 6px',fontSize:isMobile?7:8,background:balFilter===f?C.info:C.bg,border:'1px solid '+(balFilter===f?C.info:C.border),borderRadius:4,color:balFilter===f?'#fff':C.textS,cursor:'pointer'}},label);
                    }));
                  })()
                )
              ),
              h('div',{style:{height:isMobile?200:280}},renderBalChart())
            ),
            // Cumulative R
            h('div',{style:sec},
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}},
                h('div',{style:{display:'flex',alignItems:'center',gap:6}},h('span',{style:{fontSize:14}},'üìä'),h('span',{style:{fontSize:13,fontWeight:700}},t.cumulativeR)),
                h('div',{style:{display:'flex',gap:3}},['week','month','all'].map(function(f){return h('button',{key:f,onClick:function(){setCumRFilter(f);},style:{padding:isMobile?'3px 6px':'4px 8px',fontSize:isMobile?8:9,background:cumRFilter===f?C.info:C.bg,border:'1px solid '+(cumRFilter===f?C.info:C.border),borderRadius:4,color:cumRFilter===f?'#fff':C.textS,cursor:'pointer'}},f==='week'?t.week:f==='month'?t.month:t.all);}))
              ),
              h('div',{style:{height:isMobile?170:220}},renderCumRChart())
            )
          ),

          // ROW 3: Heatmap + Regime + Activity + Comparison (4 columns - BIGGER)
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':(isTablet?'repeat(2,1fr)':'1.3fr 1fr 1fr 1.2fr'),gap:14,marginBottom:14}},
            // Trades Heatmap - V10.9.3 PRO GITHUB-STYLE
            (function(){
              // Get the day names in correct order (Mon-Sun)
              var dayLabels = [t.mon, t.tue, t.wed, t.thu, t.fri, t.sat, t.sun];
              
              // Calculate week data for last 4 weeks
              var weeks = [];
              var today = new Date();
              var todayDayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
              // Convert to Mon=0, Tue=1, ..., Sun=6
              var todayIdx = todayDayOfWeek === 0 ? 6 : todayDayOfWeek - 1;
              
              // Build 4 complete weeks ending today
              for (var w = 3; w >= 0; w--) {
                var weekData = [];
                for (var d = 0; d < 7; d++) {
                  // Calculate days ago
                  var daysAgo = w * 7 + (6 - d) + (6 - todayIdx);
                  if (w === 0) {
                    daysAgo = todayIdx - d;
                    if (daysAgo < 0) {
                      weekData.push(null); // Future day
                      continue;
                    }
                  }
                  
                  var date = new Date(today);
                  date.setDate(date.getDate() - daysAgo);
                  var dayStr = date.toISOString().split('T')[0];
                  var dayTrades = activeClosed.filter(function(tr) { return (tr.exitTime || tr.entryTime || '').startsWith(dayStr); });
                  var dayR = dayTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);

                  weekData.push({
                    date: date,
                    dayStr: dayStr,
                    r: dayR,
                    count: dayTrades.length,
                    isToday: daysAgo === 0
                  });
                }
                weeks.push(weekData);
              }
              
              // Find max R for intensity scaling
              var maxR = 1;
              weeks.forEach(function(week) {
                week.forEach(function(day) {
                  if (day && Math.abs(day.r) > maxR) maxR = Math.abs(day.r);
                });
              });
              
              // Calculate weekly totals
              var weekTotals = weeks.map(function(week) {
                return week.reduce(function(s, day) { return s + (day ? day.r : 0); }, 0);
              });
              
              return h('div',{style:Object.assign({},sec,{padding:16})},
                // Header with title and legend
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:16}},'üìÖ'),
                    h('span',{style:{fontSize:13,fontWeight:600}},t.tradesHeatmap)
                  ),
                  // Legend
                  h('div',{style:{display:'flex',alignItems:'center',gap:4,fontSize:8,color:C.textS}},
                    h('span',null,t.loss||'Loss'),
                    h('div',{style:{width:10,height:10,borderRadius:2,background:C.neg,opacity:0.7}}),
                    h('div',{style:{width:10,height:10,borderRadius:2,background:C.bg}}),
                    h('div',{style:{width:10,height:10,borderRadius:2,background:C.pos,opacity:0.7}}),
                    h('span',null,t.win||'Win')
                  )
                ),
                // Grid: Days header + 4 weeks
                h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'16px repeat(7,1fr) 32px':'24px repeat(7,1fr) 50px',gap:isMobile?2:3,alignItems:'center'}},
                  // Header row: empty + day names + "Total"
                  h('div',{style:{fontSize:8,color:C.textM}},''),
                  dayLabels.map(function(dn, idx) {
                    var isWeekend = idx >= 5;
                    return h('div',{key:dn,style:{fontSize:9,color:isWeekend ? C.warn : C.textM,textAlign:'center',fontWeight:500}},dn);
                  }),
                  h('div',{style:{fontSize:8,color:C.textM,textAlign:'right'}},'R'),
                  
                  // Week rows
                  weeks.map(function(week, wi) {
                    var weekNum = 4 - wi;
                    var weekTotal = weekTotals[wi];
                    return [
                      // Week label
                      h('div',{key:'w'+wi,style:{fontSize:8,color:C.textS,textAlign:'center'}},'S'+weekNum),
                      // Days
                      week.map(function(day, di) {
                        if (!day) return h('div',{key:'d'+wi+'-'+di,style:{paddingTop:'100%',borderRadius:3,background:'transparent'}});
                        
                        var intensity = day.count === 0 ? 0.15 : Math.min(0.4 + Math.abs(day.r) / maxR * 0.6, 1);
                        var bg = day.count === 0 ? C.bg : day.r > 0 ? C.pos : day.r < 0 ? C.neg : C.warn;
                        var dateStr = day.date.getDate() + '/' + (day.date.getMonth()+1);
                        
                        return h('div',{key:'d'+wi+'-'+di,title:dateStr+': '+day.count+' trades, '+fmtR(day.r),style:{
                          position:'relative',
                          paddingTop:'100%',
                          borderRadius:4,
                          background:bg,
                          opacity:intensity,
                          border:day.isToday ? '2px solid '+C.live : 'none',
                          boxShadow:day.isToday ? '0 0 6px '+C.live : 'none',
                          cursor:'pointer',
                          transition:'transform 0.15s'
                        }},
                          // Show count if > 0
                          day.count > 0 && h('div',{style:{
                            position:'absolute',
                            top:'50%',
                            left:'50%',
                            transform:'translate(-50%,-50%)',
                            fontSize:9,
                            fontWeight:700,
                            color:'#fff',
                            textShadow:'0 1px 2px rgba(0,0,0,0.5)'
                          }},day.count)
                        );
                      }),
                      // Week total
                      h('div',{key:'t'+wi,style:{fontSize:10,fontWeight:600,color:weekTotal>=0?C.pos:C.neg,textAlign:'right'}},
                        (weekTotal>=0?'+':'')+weekTotal.toFixed(1)+'R'
                      )
                    ];
                  })
                ),
                // Summary row
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:10,paddingTop:8,borderTop:'1px solid '+C.border}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('div',{style:{width:10,height:10,borderRadius:2,background:C.live,boxShadow:'0 0 4px '+C.live}}),
                    h('span',{style:{fontSize:9,color:C.textS}},t.today||'Today')
                  ),
                  h('div',{style:{fontSize:11,fontWeight:600,color:C.text}},
                    activeClosed.length+' '+(t.tradesCount||'trades').toLowerCase()+' (4 '+(lang==='fr'?'semaines':'weeks')+')'
                  )
                )
              );
            })(),
            // On-Chain Regime Performance - V5.0
            h('div',{style:Object.assign({},sec,{padding:18})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},ocRegimeIcon(activeBot.onchain_regime||'NEUTRAL')),h('span',{style:{fontSize:13,fontWeight:600}},t.perfByRegime)),
              h('div',{style:{display:'flex',flexDirection:'column',gap:6}},OC_REGIMES.map(function(rg){
                var rs = regimeStats[rg] || {count:0,r:0,wins:0,openCount:0};
                var isCurrent = (activeBot.onchain_regime||'NEUTRAL') === rg;
                var wr = rs.count > 0 ? Math.round(rs.wins / rs.count * 100) : 0;
                return h('div',{key:rg,style:{background:isCurrent?ocRegimeBg(rg):C.bg,borderRadius:6,padding:8,display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:11}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:5}},
                    h('span',{style:{fontSize:12}},ocRegimeIcon(rg)),
                    h('div',null,
                      h('span',{style:{fontWeight:600,color:isCurrent?ocRegimeColor(rg):C.text}},ocRegimeLabel(rg)),
                      rs.count > 0 && h('span',{style:{fontSize:9,color:C.textS,marginLeft:4}},rs.count+' trades'),
                      rs.openCount > 0 && h('span',{style:{fontSize:9,color:C.live,marginLeft:4}},'('+rs.openCount+' open)')
                    )
                  ),
                  h('div',{style:{textAlign:'right'}},
                    h('div',{style:{color:rs.r>=0?C.pos:C.neg,fontWeight:700,fontSize:12}},fmtR(rs.r)),
                    rs.count > 0 && h('div',{style:{fontSize:9,color:wr>=50?C.pos:C.neg}},wr+'% WR')
                  )
                );
              }))
            ),
            // Activity Feed - V4.3 Enhanced with icons + V10.10 Capital Events
            h('div',{style:Object.assign({},sec,{padding:18,maxHeight:280,overflowY:'auto'})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},'‚ö°'),h('span',{style:{fontSize:13,fontWeight:600}},t.activityFeed)),
              (function(){
                // üÜï V10.10: Merge trade activities with capital events
                var allActivities = activities.slice(0,10).map(function(act) {
                  return { type: 'trade', data: act, time: new Date(act.time) };
                });
                
                // Add capital events (crypto-only ‚Äî HIP-3 has separate wallet)
                if (market !== 'hip3' && capitalEvents && capitalEvents.events && capitalEvents.events.length > 0) {
                  capitalEvents.events.slice(0,5).forEach(function(ce) {
                    allActivities.push({
                      type: 'capital',
                      data: ce,
                      time: new Date(ce.timestamp)
                    });
                  });
                }
                
                // Sort by time (most recent first)
                allActivities.sort(function(a, b) {
                  return b.time - a.time;
                });
                
                // Take top 10
                allActivities = allActivities.slice(0, 10);
                
                if (allActivities.length === 0) {
                  return h('div',{style:{fontSize:12,color:C.textS,textAlign:'center',padding:20}},t.noActivity);
                }
                
                return h('div',{style:{display:'flex',flexDirection:'column',gap:5}}, allActivities.map(function(item, i) {
                  // Capital Event rendering
                  if (item.type === 'capital') {
                    var ce = item.data;
                    var isDeposit = ce.type === 'deposit';
                    var icon = isDeposit ? 'üì•' : 'üì§';
                    var borderColor = isDeposit ? '#3b82f6' : '#f59e0b';
                    var actionText = (isDeposit ? (t.deposit || 'DEPOSIT') : (t.withdrawal || 'WITHDRAWAL')).toUpperCase();
                    var amount = ce.amount || 0;
                    
                    return h('div',{key:'ce-'+i,style:{display:'flex',alignItems:'center',gap:6,fontSize:10,padding:'6px 8px',background:'linear-gradient(135deg, '+C.bg+' 0%, '+(isDeposit?'rgba(59,130,246,0.1)':'rgba(245,158,11,0.1)')+' 100%)',borderRadius:6,borderLeft:'3px solid '+borderColor}},
                      h('span',{style:{fontSize:12}},icon),
                      h('span',{style:{fontWeight:600,color:borderColor,flex:1}},actionText),
                      h('span',{style:{color:isDeposit?'#3b82f6':'#f59e0b',fontWeight:700,fontSize:11}},(isDeposit?'+':'-')+'$'+amount.toFixed(2)),
                      h('span',{style:{color:C.textM,marginLeft:'auto',fontSize:9,whiteSpace:'nowrap'}},relTime(item.time))
                    );
                  }
                  
                  // Trade rendering
                  var act = item.data;
                  var ad = act.data;
                  var isOpen = act.type === 'open';
                  var isWin = !isOpen && ad.pnl > 0.05;
                  var isLoss = !isOpen && ad.pnl < -0.05;
                  var isBE = !isOpen && !isWin && !isLoss;
                  var icon = isOpen ? 'üöÄ' : (isWin ? 'üí∞' : (isLoss ? 'üíÄ' : '‚ö™'));
                  var borderColor = isOpen ? C.live : (isWin ? C.pos : (isLoss ? C.neg : C.warn));
                  var actionText = isOpen 
                    ? (lang==='fr'?'OPEN ':'OPEN ') + ad.side + ' ' + ad.symbol
                    : (lang==='fr'?'CLOSE ':'CLOSE ') + ad.side + ' ' + ad.symbol;
                  return h('div',{key:'tr-'+i,style:{display:'flex',alignItems:'center',gap:6,fontSize:10,padding:'6px 8px',background:C.bg,borderRadius:6,borderLeft:'3px solid '+borderColor}},
                    h('span',{style:{fontSize:12}},icon),
                    h('span',{style:{fontWeight:600,color:borderColor,flex:1}},actionText),
                    !isOpen && h('span',{style:{color:isWin?C.pos:(isLoss?C.neg:C.warn),fontWeight:700,fontSize:11}},fmtR(ad.r)),
                    !isOpen && h('span',{style:{color:isWin?C.pos:(isLoss?C.neg:C.warn),fontSize:9,marginLeft:4}},fmtPnl(ad.pnl)),
                    h('span',{style:{color:C.textM,marginLeft:'auto',fontSize:9,whiteSpace:'nowrap'}},relTime(item.time))
                  );
                }));
              })()
            ),
            // Performance Comparison
            h('div',{style:Object.assign({},sec,{padding:18})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},'üìä'),h('span',{style:{fontSize:13,fontWeight:600}},t.perfComparison)),
              h('div',{style:{display:'flex',flexDirection:'column',gap:8}},
                h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12}},h('span',{style:{color:C.textS}},t.thisWeek),h('span',{style:{color:weekR>=0?C.pos:C.neg,fontWeight:700}},fmtR(weekR)),h('span',{style:{color:weekR>lastWeekR?C.pos:C.neg,fontSize:11}},(weekR>=lastWeekR?'‚Üë':'‚Üì'))),
                h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12}},h('span',{style:{color:C.textS}},t.lastWeek),h('span',{style:{color:lastWeekR>=0?C.pos:C.neg,fontWeight:600}},fmtR(lastWeekR))),
                h('div',{style:{height:1,background:C.border,margin:'6px 0'}}),
                h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12}},h('span',{style:{color:C.textS}},t.thisMonth),h('span',{style:{color:monthR>=0?C.pos:C.neg,fontWeight:700}},fmtR(monthR)),h('span',{style:{color:monthR>lastMonthR?C.pos:C.neg,fontSize:11}},(monthR>=lastMonthR?'‚Üë':'‚Üì'))),
                h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12}},h('span',{style:{color:C.textS}},t.lastMonth),h('span',{style:{color:lastMonthR>=0?C.pos:C.neg,fontWeight:600}},fmtR(lastMonthR)))
              )
            )
          ),

          // ROW 4: Position Type + Pair Distribution + Win Distribution + Quick Stats - BIGGER
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:14,marginBottom:14}},
            // Position Type
            h('div',{style:Object.assign({},sec,{padding:18})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},'üéØ'),h('span',{style:{fontSize:13,fontWeight:600}},t.positionType)),
              h('div',{style:{height:28,borderRadius:6,overflow:'hidden',display:'flex',marginBottom:10}},
                h('div',{style:{width:longPct+'%',background:C.info,fontSize:11,display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontWeight:600}},longPct.toFixed(0)+'%'),
                h('div',{style:{width:shortPct+'%',background:C.neg,fontSize:11,display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontWeight:600}},shortPct.toFixed(0)+'%')
              ),
              h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12}},
                h('span',{style:{color:C.textS}},t.long+': '+longs.length),
                h('span',{style:{color:C.textS}},t.short+': '+shorts.length)
              )
            ),
            // Pair Distribution (mini donut)
            h('div',{style:Object.assign({},sec,{padding:18})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},'ü™ô'),h('span',{style:{fontSize:13,fontWeight:600}},t.pairDistribution)),
              h('div',{style:{display:'flex',justifyContent:'space-around',alignItems:'center',paddingTop:8,flexWrap:'wrap',gap:8}},
                Object.keys(symStats).sort(function(a,b){return (symStats[b].n||0)-(symStats[a].n||0);}).slice(0,8).map(function(sym){
                  var cnt = (symStats[sym]||{n:0}).n;
                  return h('div',{key:sym,style:{textAlign:'center'}},
                    h('div',{style:{margin:'0 auto 6px'}},cryptoLogo(sym, 32)),
                    h('div',{style:{color:C.textS,fontSize:12,fontWeight:600}},totalSymTr>0?((cnt/totalSymTr)*100).toFixed(0)+'%':'0%')
                  );
                })
              )
            ),
            // Win Distribution - V10.9.2 PRO DONUT CHART
            (function(){
              var winCount = activeStats.wins;
              var lossCount = activeStats.losses;
              var totalTrades = winCount + lossCount;
              var winRate = activeStats.winRate;
              var winPct = totalTrades > 0 ? (winCount / totalTrades * 100) : 0;
              var lossPct = totalTrades > 0 ? (lossCount / totalTrades * 100) : 0;
              
              // Calculate win/loss PnL totals
              var winPnl = activeClosed.filter(function(tr){ return tr.pnl > 0; }).reduce(function(s,tr){ return s + tr.pnl; }, 0);
              var lossPnl = Math.abs(activeClosed.filter(function(tr){ return tr.pnl < 0; }).reduce(function(s,tr){ return s + tr.pnl; }, 0));
              
              // SVG Donut chart parameters
              var size = 90;
              var strokeWidth = 12;
              var radius = (size - strokeWidth) / 2;
              var circumference = 2 * Math.PI * radius;
              var winOffset = circumference * (1 - winPct / 100);
              
              return h('div',{style:Object.assign({},sec,{padding:16})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                  h('span',{style:{fontSize:16}},'üèÜ'),
                  h('span',{style:{fontSize:13,fontWeight:600}},t.distribution),
                  market !== 'hip3' && accurateStats && h('span',{style:{fontSize:9,color:'#A78BFA',marginLeft:4}},'üîó')
                ),
                h('div',{style:{display:'flex',alignItems:'center',gap:16}},
                  // Donut Chart
                  h('div',{style:{position:'relative',width:size,height:size,flexShrink:0}},
                    h('svg',{width:size,height:size,style:{transform:'rotate(-90deg)'}},
                      // Background circle (loss)
                      h('circle',{cx:size/2,cy:size/2,r:radius,fill:'none',stroke:C.neg,strokeWidth:strokeWidth,opacity:0.3}),
                      // Win arc
                      h('circle',{cx:size/2,cy:size/2,r:radius,fill:'none',stroke:C.pos,strokeWidth:strokeWidth,strokeDasharray:circumference,strokeDashoffset:winOffset,strokeLinecap:'round',style:{transition:'stroke-dashoffset 1s ease-out'}})
                    ),
                    // Center text
                    h('div',{style:{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',textAlign:'center'}},
                      h('div',{style:{fontSize:20,fontWeight:800,color:winRate>=50?C.pos:C.neg}},winRate.toFixed(0)+'%'),
                      h('div',{style:{fontSize:8,color:C.textS,marginTop:-2}},'WIN RATE')
                    )
                  ),
                  // Stats column
                  h('div',{style:{flex:1,display:'flex',flexDirection:'column',gap:6}},
                    // Wins row
                    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                      h('div',{style:{width:8,height:8,borderRadius:'50%',background:C.pos}}),
                      h('div',{style:{flex:1}},
                        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                          h('span',{style:{fontSize:11,fontWeight:600,color:C.pos}},winCount+' '+t.win),
                          h('span',{style:{fontSize:10,color:C.pos}},'+$'+winPnl.toFixed(2))
                        ),
                        h('div',{style:{height:4,background:C.bg,borderRadius:2,marginTop:3,overflow:'hidden'}},
                          h('div',{style:{width:winPct+'%',height:'100%',background:'linear-gradient(90deg, '+C.pos+' 0%, #34D399 100%)',borderRadius:2}})
                        )
                      )
                    ),
                    // Losses row
                    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                      h('div',{style:{width:8,height:8,borderRadius:'50%',background:C.neg}}),
                      h('div',{style:{flex:1}},
                        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                          h('span',{style:{fontSize:11,fontWeight:600,color:C.neg}},lossCount+' '+t.loss),
                          h('span',{style:{fontSize:10,color:C.neg}},'-$'+lossPnl.toFixed(2))
                        ),
                        h('div',{style:{height:4,background:C.bg,borderRadius:2,marginTop:3,overflow:'hidden'}},
                          h('div',{style:{width:lossPct+'%',height:'100%',background:'linear-gradient(90deg, '+C.neg+' 0%, #F87171 100%)',borderRadius:2}})
                        )
                      )
                    ),
                    // Total trades
                    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',paddingTop:6,marginTop:4,borderTop:'1px solid '+C.border}},
                      h('span',{style:{fontSize:10,color:C.textS}},t.totalTrades||'Total'),
                      h('span',{style:{fontSize:12,fontWeight:700,color:C.text}},totalTrades+' trades')
                    )
                  )
                )
              );
            })(),
            // Quick Stats - V4.2 - Clean & Volume
            h('div',{style:Object.assign({},sec,{padding:18})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:16}},'üìä'),h('span',{style:{fontSize:13,fontWeight:600}},t.stats)),
              h('div',{style:{display:'flex',flexDirection:'column',gap:8,fontSize:12}},
                h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.avgRPerTrade),h('span',{style:{fontWeight:700}},avgR.toFixed(2)+'R')),
                h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.bestToday),h('span',{style:{color:C.pos,fontWeight:700}},todayBest>0?'+'+todayBest.toFixed(1)+'R':'--')),
                // üìä V10.8 - Volume from Exchange when available
                h('div',{style:{display:'flex',justifyContent:'space-between'}},
                  h('span',{style:{color:(market !== 'hip3' && accurateStats)?'#A78BFA':C.textS}},((market !== 'hip3' && accurateStats)?'üîó ':'üìà ')+(lang==='fr'?'Volume Total':'Total Volume')),
                  h('span',{style:{fontWeight:700,color:C.info}},'$'+((market !== 'hip3' && accurateStats ? accurateStats.total_volume : (activeStats.totalVolume || 0)) || 0).toLocaleString(undefined,{maximumFractionDigits:0}))
                ),
                // Profit Factor
                h('div',{style:{display:'flex',justifyContent:'space-between',paddingTop:8,marginTop:8,borderTop:'1px solid '+C.border}},
                  h('span',{style:{color:C.textS}},t.profitFactor),
                  h('span',{style:{fontWeight:700,color:activeStats.profitFactor>=1.5?C.pos:activeStats.profitFactor>=1?C.warn:C.neg}},activeStats.profitFactor.toFixed(2))
                ),
                // Max Drawdown
                h('div',{style:{display:'flex',justifyContent:'space-between'}},
                  h('span',{style:{color:C.textS}},t.maxDrawdown),
                  h('span',{style:{fontWeight:700,color:C.neg}},'-'+activeStats.maxDrawdown.toFixed(1)+'%')
                )
              )
            )
          ),

          // ROW 5: Recent Trades (compact, 5 trades max)
          h('div',{style:sec},
            h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:10}},h('span',{style:{fontSize:12}},'‚ö°'),h('span',{style:{fontSize:11,fontWeight:600}},t.recentTrades)),
            activeClosed.length===0?h('div',{style:{textAlign:'center',padding:16,color:C.textS,fontSize:11}},t.noTrades):
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':(isTablet?'repeat(3,1fr)':'repeat(5,1fr)'),gap:8}},
              activeClosed.slice(0,isMobile?4:5).map(function(tr){
                return h('div',{key:tr.id,style:{background:C.bg,borderRadius:8,padding:10,borderLeft:'3px solid '+(tr.pnl>=0?C.pos:C.neg)}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:6}},
                    cryptoLogo(tr.symbol, 24),
                    h('div',null,h('div',{style:{fontSize:11,fontWeight:700}},tr.symbol),h('div',{style:{fontSize:9,color:C.textS}},tr.side))
                  ),
                  h('div',{style:{textAlign:'center'}},
                    h('div',{style:{fontSize:16,fontWeight:700,color:tr.r>=0?C.pos:C.neg}},fmtR(tr.r)),
                    h('div',{style:{fontSize:9,color:C.textS}},fmtPnl(tr.pnl))
                  )
                );
              })
            )
          )
        );
      })(), // End overview


      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // TRADES TAB - ENHANCED VERSION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='trades' && (function(){
        // Combine open and closed trades (V2.0: market-aware)
        var allTrades = activeOpenPos.concat(activeClosed);
        
        // Get unique symbols from trades
        var symbols = allTrades.reduce(function(acc, tr) {
          if (acc.indexOf(tr.symbol) === -1) acc.push(tr.symbol);
          return acc;
        }, []);
        
        // Get unique on-chain regimes from trades (mapped from old market regimes)
        var regimes = allTrades.reduce(function(acc, tr) {
          var regime = detectRegime(tr);
          if (OC_REGIMES.indexOf(regime) !== -1 && acc.indexOf(regime) === -1) {
            acc.push(regime);
          }
          return acc;
        }, []);
        // Sort regimes in on-chain order
        regimes.sort(function(a, b) {
          return OC_REGIMES.indexOf(a) - OC_REGIMES.indexOf(b);
        });
        
        // Calculate duration
        var getDuration = function(entry, exit) {
          if (!entry) return {text:'', mins:0};
          var start = new Date(entry);
          var end = exit ? new Date(exit) : new Date();
          var diff = Math.floor((end - start) / 1000 / 60);
          var txt = '';
          if (diff < 60) txt = diff + 'm';
          else if (diff < 1440) txt = Math.floor(diff/60) + 'h ' + (diff%60) + 'm';
          else txt = Math.floor(diff/1440) + 'd ' + Math.floor((diff%1440)/60) + 'h';
          return {text:txt, mins:diff};
        };
        
        // üßÆ V3.9 - Filter by status (STRICT: seuil $0.05)
        var filtered = allTrades.filter(function(tr) {
          if (tradeFilter === 'open') return tr.status === 'open';
          if (tradeFilter === 'win') return tr.status !== 'open' && tr.pnl > 0.05;
          if (tradeFilter === 'loss') return tr.status !== 'open' && tr.pnl < -0.05;
          return true;
        });
        
        // Filter by symbol
        if (tradeSymbol !== 'all') {
          filtered = filtered.filter(function(tr) { return tr.symbol === tradeSymbol; });
        }
        
        // Filter by on-chain regime (map trade regime to on-chain)
        if (tradeRegime !== 'all') {
          filtered = filtered.filter(function(tr) { return detectRegime(tr) === tradeRegime; });
        }
        
        // Filter by period
        var now = new Date();
        if (tradePeriod === 'today') {
          filtered = filtered.filter(function(tr) {
            var d = new Date(tr.entryTime);
            return d.toDateString() === now.toDateString();
          });
        } else if (tradePeriod === 'week') {
          var weekAgo = new Date(now - 7*24*60*60*1000);
          filtered = filtered.filter(function(tr) { return new Date(tr.entryTime) >= weekAgo; });
        } else if (tradePeriod === 'month') {
          var monthAgo = new Date(now - 30*24*60*60*1000);
          filtered = filtered.filter(function(tr) { return new Date(tr.entryTime) >= monthAgo; });
        }
        
        // Filter by search
        if (tradeSearch) {
          var search = tradeSearch.toLowerCase();
          filtered = filtered.filter(function(tr) {
            return tr.symbol.toLowerCase().indexOf(search) !== -1 ||
                   (tr.entryTime||'').toLowerCase().indexOf(search) !== -1 ||
                   tr.side.toLowerCase().indexOf(search) !== -1;
          });
        }
        
        // Find best and worst trades (for badges)
        var bestR = Math.max.apply(null, allTrades.map(function(tr){return tr.r||0;}));
        var worstR = Math.min.apply(null, allTrades.map(function(tr){return tr.r||0;}));
        
        // Sort trades
        var sorted = filtered.slice().sort(function(a, b) {
          if (tradeSort === 'dateDesc') return new Date(b.exitTime||b.entryTime||0) - new Date(a.exitTime||a.entryTime||0);
          if (tradeSort === 'dateAsc') return new Date(a.exitTime||a.entryTime||0) - new Date(b.exitTime||b.entryTime||0);
          if (tradeSort === 'rDesc') return (b.r||0) - (a.r||0);
          if (tradeSort === 'rAsc') return (a.r||0) - (b.r||0);
          if (tradeSort === 'pnlDesc') return (b.pnl||0) - (a.pnl||0);
          if (tradeSort === 'pnlAsc') return (a.pnl||0) - (b.pnl||0);
          return 0;
        });
        
        // Pagination
        var perPage = 20;
        var totalPages = Math.ceil(sorted.length / perPage) || 1;
        var paged = sorted.slice((tradePage-1)*perPage, tradePage*perPage);
        
        // üßÆ V3.9 - Calculate stats for filtered trades (STRICT: seuil $0.05)
        var filteredStats = {
          count: filtered.length,
          wins: filtered.filter(function(tr){return tr.status!=="open" && tr.pnl > 0.05;}).length,
          losses: filtered.filter(function(tr){return tr.status!=="open" && tr.pnl < -0.05;}).length,
          totalR: filtered.filter(function(tr){return tr.status!=="open";}).reduce(function(s,tr){return s+(tr.r||0);},0),
          totalPnl: accurateStats ? accurateStats.net_pnl : filtered.filter(function(tr){return tr.status!=="open";}).reduce(function(s,tr){return s+(tr.pnl||0);},0),
          winRate: 0
        };
        var closedFiltered = filtered.filter(function(tr){return tr.status!=='open';}).length;
        var winsLossesFiltered = filteredStats.wins + filteredStats.losses; // Exclut BE
        filteredStats.winRate = winsLossesFiltered > 0 ? (filteredStats.wins / winsLossesFiltered * 100) : 0;
        
        // üßÆ V3.9 - Get result badge (STRICT: seuil $0.05)
        var getResultBadge = function(tr) {
          if (tr.status === 'open') return {text:t.liveNow,color:C.live,bg:C.liveL};
          if (tr.pnl > 0.05) return {text:t.win,color:C.pos,bg:C.posL};
          if (tr.pnl < -0.05) return {text:t.loss,color:C.neg,bg:C.negL};
          return {text:t.be,color:C.warn,bg:C.warnL};
        };
        
        // üè∑Ô∏è V6.1 - STRATEGY BADGE (Sherlock Mode - super-string search)
        var getStrategyBadge = function(tr) {
          // V6.1: Create SUPER-STRING from ALL possible fields (Sherlock Mode)
          var fullText = [
            tr.setup_type, tr.setupType, tr.strategy, tr.entry_reason,
            tr.label, tr.signal_type, tr.trade_type, tr.setup,
            tr.entryReason, tr.type_setup, tr.reason, tr.signal,
            tr.entry_signal, tr.exit_reason, tr.notes, tr.comment
          ].filter(Boolean).join(' ').toUpperCase();
          
          // Match strategy keywords in the full text
          if (fullText.indexOf('TIER_PREMIUM') !== -1) return {text:'‚≠ê PREMIUM',cls:'badge-premium',color:'#a855f7',key:'TIER_PREMIUM'};
          if (fullText.indexOf('TIER_ADVANCED') !== -1) return {text:'üî∑ ADVANCED',cls:'badge-advanced',color:'#06b6d4',key:'TIER_ADVANCED'};
          if (fullText.indexOf('SIGNAL_TIER') !== -1) return {text:'üì° SIGNAL',cls:'badge-signal',color:'#f97316',key:'SIGNAL_TIER'};
          if (fullText.indexOf('TIER_BASIC') !== -1) return {text:'üìä BASIC',cls:'badge-basic',color:'#6b7280',key:'TIER_BASIC'};
          
          // V6.1: If we have some text but no match, show first 10 chars
          if (fullText && fullText.length > 2) return {text:'üìã '+fullText.slice(0,10),cls:'badge-basic',color:'#6b7280',key:'OTHER'};
          
          // V6.1: FALLBACK to BASIC (not "NO SETUP") - most trades are basic
          return {text:'üìä BASIC',cls:'badge-basic',color:'#6b7280',key:'TIER_BASIC'};
        };
        
        // üí≥ V5.0 - REALITY CHECK (Net PnL calculation)
        var getNetPnl = function(tr) {
          var grossPnl = tr.pnl || 0;
          var fee = tr.fee || 0;
          var netPnl = grossPnl - fee;
          return {gross: grossPnl, fee: fee, net: netPnl};
        };
        
        // üìè V5.0.1 - HOTFIX: PROGRESS BAR with safe variable extraction
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üÜï V10.11: SMART TENSION BAR - Bi-directional SL...Entry...TP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        var renderProgressBar = function(tr) {
          var side = tr.side || tr.type || 'LONG';
          var isLong = (side.toUpperCase().indexOf('SHORT') === -1);
          var entry = parseFloat(tr.entryPrice || tr.entry_price || tr.price || 0);
          var sl = parseFloat(tr.initialStopLoss || tr.sl || tr.stop_loss || tr.stopLoss || 0);
          var targets = tr.targets || [];
          var tp1 = parseFloat(targets[0] || tr.tp || tr.take_profit || tr.takeProfit || 0);
          var tp2 = parseFloat(targets[1] || 0);
          var tp3 = parseFloat(targets[2] || 0);
          var liveSL = parseFloat(tr.liveStopLoss || tr.stopLoss || sl);
          var current = parseFloat(tr.markPrice || tr.mark_price || tr.current_price || tr.currentPrice || tr.closePrice || tr.exit_price || entry);
          if (sl === 0 || tp1 === 0 || entry === 0) return null;
          var tpLevels = [{price:tp1,label:'TP1'}];
          if (tp2 > 0) tpLevels.push({price:tp2,label:'TP2'});
          if (tp3 > 0) tpLevels.push({price:tp3,label:'TP3'});
          var hasMultiTP = tpLevels.length > 1;
          var furthestTP = tp1;
          tpLevels.forEach(function(t) { furthestTP = isLong ? Math.max(furthestTP,t.price) : Math.min(furthestTP,t.price); });
          var leftPrice, rightPrice;
          if (isLong) { leftPrice = sl; rightPrice = furthestTP; } else { leftPrice = furthestTP; rightPrice = sl; }
          var totalRange = rightPrice - leftPrice;
          if (totalRange <= 0) return null;
          var actualLeftPrice = leftPrice;
          var actualRightPrice = rightPrice;
          var rangePad = totalRange * 0.06; leftPrice -= rangePad; rightPrice += rangePad; totalRange = rightPrice - leftPrice;
          var pct = function(p) { return ((p - leftPrice) / totalRange) * 100; };
          var entryPct = Math.max(0, Math.min(100, pct(entry)));
          var currentPct = Math.max(-3, Math.min(103, pct(current)));
          tpLevels.forEach(function(t) { t.pct = Math.max(0, Math.min(100, pct(t.price))); t.hit = isLong ? (current >= t.price) : (current <= t.price); });
          var srsP = tr.srsPhase || 0;
          if (srsP >= 2 && tpLevels[0]) tpLevels[0].hit = true;
          if (srsP >= 3 && tpLevels[1]) tpLevels[1].hit = true;
          var slMoved = Math.abs(liveSL - sl) / entry > 0.0001;
          var liveSLPct = slMoved ? Math.max(0, Math.min(100, pct(liveSL))) : null;
          var isWinning = isLong ? (current > entry) : (current < entry);
          var fillColor = isWinning ? C.pos : C.neg;
          var fillL = Math.max(0, Math.min(entryPct, currentPct));
          var fillR = Math.min(100, Math.max(entryPct, currentPct));
          var riskDist = Math.abs(entry - sl);
          var pnlDist = isLong ? (current - entry) : (entry - current);
          var unrealizedR = riskDist > 0 ? (pnlDist / riskDist) : 0;
          var tp1Dist = Math.abs(tp1 - entry);
          var progressToTp = tp1Dist > 0 ? (pnlDist / tp1Dist * 100) : 0;
          var tpsHit = tpLevels.filter(function(t) { return t.hit; }).length;
          var srsPhase = tr.srsPhase || 0;
          if (srsPhase >= 3) tpsHit = Math.max(tpsHit, 2);
          else if (srsPhase >= 2) tpsHit = Math.max(tpsHit, 1);
          var statusText, statusIcon;
          if (tpsHit === tpLevels.length && hasMultiTP) { statusText = 'ALL TPs HIT! +' + unrealizedR.toFixed(2) + 'R'; statusIcon = '\uD83C\uDFAF'; }
          else if (tpsHit > 0 && hasMultiTP) { statusText = '+' + unrealizedR.toFixed(2) + 'R (' + tpsHit + '/' + tpLevels.length + ' TPs \u2713)'; statusIcon = '\uD83C\uDFAF'; }
          else if ((isLong && current >= tp1) || (!isLong && current <= tp1)) { statusText = 'TP HIT!'; statusIcon = '\uD83C\uDFAF'; }
          else if ((isLong && current <= sl) || (!isLong && current >= sl)) { statusText = 'SL HIT!'; statusIcon = '\u26D4'; }
          else if (isWinning) { statusText = '+' + unrealizedR.toFixed(2) + 'R (' + Math.abs(progressToTp).toFixed(0) + '% to TP1)'; statusIcon = '\uD83D\uDCC8'; }
          else { statusText = unrealizedR.toFixed(2) + 'R (Risk Zone)'; statusIcon = '\uD83D\uDCC9'; }
          var barChildren = [
            h('div',{key:'bgl',style:{position:'absolute',left:0,top:0,bottom:0,width:entryPct+'%',background:'linear-gradient(90deg, '+(isLong?C.negL:C.posL)+' 0%, transparent 100%)',borderRadius:'7px 0 0 7px',opacity:0.3}}),
            h('div',{key:'bgr',style:{position:'absolute',right:0,top:0,bottom:0,width:(100-entryPct)+'%',background:'linear-gradient(270deg, '+(isLong?C.posL:C.negL)+' 0%, transparent 100%)',borderRadius:'0 7px 7px 0',opacity:0.3}}),
            h('div',{key:'fill',style:{position:'absolute',left:fillL+'%',top:2,bottom:2,width:Math.abs(fillR-fillL)+'%',background:fillColor,borderRadius:5,boxShadow:'0 0 12px '+fillColor+'60',transition:'all 0.3s ease'}})
          ];
          tpLevels.forEach(function(tp, idx) {
            var clr = tp.hit ? '#22c55e' : 'rgba(34,197,94,0.45)';
            barChildren.push(h('div',{key:'tpline'+idx,style:{position:'absolute',left:'calc('+tp.pct+'% - 1.5px)',top:-5,width:3,height:26,background:clr,borderRadius:2,zIndex:4}}));
          });
          if (liveSLPct !== null) {
            barChildren.push(h('div',{key:'beline',style:{position:'absolute',left:'calc('+liveSLPct+'% - 1.5px)',top:-5,width:3,height:26,background:'#f59e0b',borderRadius:2,zIndex:4,opacity:0.8}}));
          }
          var slPct = Math.max(0, Math.min(100, pct(sl))); barChildren.push(h('div',{key:'slline',style:{position:'absolute',left:'calc('+slPct+'% - 1.5px)',top:-5,width:3,height:26,background:'#ef4444',borderRadius:2,zIndex:3,opacity:0.8}}));
          barChildren.push(h('div',{key:'entryline',style:{position:'absolute',left:'calc('+entryPct+'% - 2px)',top:-6,width:4,height:28,background:C.text,borderRadius:2,boxShadow:'0 0 6px rgba(0,0,0,0.6)',zIndex:5}}));
          barChildren.push(h('div',{key:'curr',style:{position:'absolute',left:Math.max(0,Math.min(100,currentPct))+'%',top:'50%',transform:'translate(-50%,-50%)',width:20,height:20,background:isWinning?C.pos:C.neg,border:'3px solid #fff',borderRadius:'50%',boxShadow:'0 0 12px '+(isWinning?C.pos:C.neg)+', 0 0 24px '+(isWinning?C.pos:C.neg)+'40',zIndex:7,transition:'left 0.3s ease'}}));
          var leftLbl = isLong ? '\uD83D\uDED1 SL' : '\uD83C\uDFAF TP'+(hasMultiTP?tpLevels.length:'');
          var rightLbl = isLong ? '\uD83C\uDFAF TP'+(hasMultiTP?tpLevels.length:'') : '\uD83D\uDED1 SL';
          var allMarkers = [];
          allMarkers.push({pct:entryPct,label:'\u2693 Entry',price:fmtPrice(entry),color:C.text,zIdx:5});
          tpLevels.forEach(function(tp) { allMarkers.push({pct:tp.pct,label:tp.label,price:fmtPrice(tp.price),color:tp.hit?'#22c55e':'rgba(34,197,94,0.6)',zIdx:4}); });
          if (liveSLPct !== null) { allMarkers.push({pct:liveSLPct,label:'BE',price:fmtPrice(liveSL),color:'#f59e0b',zIdx:4}); }
          allMarkers.push({pct:Math.max(0,Math.min(100,pct(sl))),label:'SL',price:fmtPrice(sl),color:'#ef4444',zIdx:3});
          allMarkers.sort(function(a,b){return a.pct - b.pct;});
          var ROW_H = 36;
          var markerRows = [];
          allMarkers.forEach(function(m) {
            var row = 0;
            for (var r = 0; r < markerRows.length; r++) {
              var conflict = false;
              for (var j = 0; j < markerRows[r].length; j++) {
                if (Math.abs(markerRows[r][j].pct - m.pct) < 14) { conflict = true; break; }
              }
              if (!conflict) { row = r; markerRows[r].push(m); m.row = row; break; }
            }
            if (m.row === undefined) { m.row = markerRows.length; markerRows.push([m]); }
          });
          var totalMarkerH = Math.max(markerRows.length, 1) * ROW_H;
          var aboveLabels = allMarkers.map(function(m, idx) {
            return h('div',{key:'marker-'+idx,style:{position:'absolute',left:m.pct+'%',bottom:(m.row * ROW_H)+'px',transform:'translateX(-50%)',textAlign:'center',zIndex:m.zIdx,pointerEvents:'none',whiteSpace:'nowrap'}},
              h('div',{style:{fontSize:13,fontWeight:700,color:m.color,lineHeight:'16px',textShadow:'0 1px 4px rgba(0,0,0,0.9)'}},m.label),
              h('div',{style:{fontSize:12,color:m.color,fontWeight:600,opacity:0.9,lineHeight:'15px'}},m.price)
            );
          });
          return h('div',{style:{marginTop:8,padding:'8px 0'}},
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:12,color:C.textS,marginBottom:4}},
              h('span',{style:{color:isLong?C.neg:C.pos,fontWeight:700}},leftLbl + '  ' + fmtPrice(actualLeftPrice)),
              h('span',{style:{color:isLong?C.pos:C.neg,fontWeight:700}},rightLbl + '  ' + fmtPrice(actualRightPrice))
            ),
            h('div',{style:{position:'relative',height:totalMarkerH+'px',marginBottom:6}},aboveLabels),
            h('div',{style:{position:'relative',height:16,borderRadius:8,background:C.bg,border:'1px solid '+C.border,overflow:'visible'}},barChildren),
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:12}},
              h('span',{style:{fontSize:13,color:C.text,fontWeight:700}},'Current: '+fmtPrice(current)),
              h('span',{style:{fontSize:13,fontWeight:700,color:isWinning?C.pos:C.neg,padding:'4px 14px',background:isWinning?C.posL:C.negL,borderRadius:6}},statusIcon+' '+statusText)
            )
          );
        };
        // üìÇ V5.0.2 FIX: useState moved to App level - only toggleExpand function here
        var toggleExpand = function(tradeId) {
          setExpandedTrades(function(prev) {
            var next = Object.assign({}, prev);
            next[tradeId] = !prev[tradeId];
            return next;
          });
        };
        
        // üìÇ V5.0 - ACCORDION DETAILS PANEL
        var renderAccordionDetails = function(tr, isExpanded) {
          var entryDate = tr.entryTime ? new Date(tr.entryTime) : null;
          var exitDate = tr.exitTime ? new Date(tr.exitTime) : null;
          var duration = getDuration(tr.entryTime, tr.exitTime);
          var netData = getNetPnl(tr);
          
          return h('div',{className:'trade-accordion'+(isExpanded?' open':''),style:{
            maxHeight: isExpanded ? 300 : 0,
            overflow: 'hidden',
            transition: 'max-height .3s ease-out, opacity .3s ease-out',
            opacity: isExpanded ? 1 : 0,
            borderTop: isExpanded ? '1px dashed '+C.border : 'none',
            marginTop: isExpanded ? 12 : 0,
            paddingTop: isExpanded ? 12 : 0
          }},
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2, 1fr)':'repeat(auto-fit, minmax(120px, 1fr))',gap:isMobile?8:12,fontSize:11}},
              // Entry Time
              h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üìÖ Entry Time'),
                h('div',{style:{fontWeight:600}},entryDate ? entryDate.toLocaleString() : '--')
              ),
              // Exit Time
              tr.status !== 'open' && h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üèÅ Exit Time'),
                h('div',{style:{fontWeight:600}},exitDate ? exitDate.toLocaleString() : '--')
              ),
              // Duration
              h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'‚è±Ô∏è Duration'),
                h('div',{style:{fontWeight:600}},duration.text || 'Active')
              ),
              // Trade ID
              h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üîë Trade ID'),
                h('div',{style:{fontWeight:600,fontSize:10,fontFamily:'monospace'}},tr.id || '--')
              ),
              // On-Chain Regime - Use current for open trades, detect for closed
              h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üìä Regime'),
                h('div',{style:{fontWeight:600,color:ocRegimeColor(detectRegime(tr))}},ocRegimeLabel(detectRegime(tr)))
              ),
              // Size
              tr.size && h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üì¶ Size'),
                h('div',{style:{fontWeight:600}},tr.size.toLocaleString())
              ),
              // Leverage
              tr.leverage && h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'‚ö° Leverage'),
                h('div',{style:{fontWeight:600}},tr.leverage+'x')
              ),
              // Confidence
              tr.confidence && h('div',null,
                h('div',{style:{color:C.textS,marginBottom:2}},'üéØ Confidence'),
                h('div',{style:{fontWeight:600}},tr.confidence+'%')
              )
            ),
            // Reality Check: Net PnL breakdown
            tr.status !== 'open' && netData.fee > 0 && h('div',{style:{marginTop:12,padding:8,background:C.card,borderRadius:6,display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:6}},
              h('div',{style:{fontSize:10,color:C.textS}},'üí≥ Reality Check'),
              h('div',{style:{display:'flex',gap:isMobile?8:16,fontSize:isMobile?10:11}},
                h('span',null,'Gross: ',h('span',{style:{color:netData.gross>=0?C.pos:C.neg}},fmtPnl(netData.gross))),
                h('span',null,'Fee: ',h('span',{style:{color:C.warn}},'-$'+netData.fee.toFixed(2))),
                h('span',{style:{fontWeight:700}},'Net: ',h('span',{style:{color:netData.net>=0?C.pos:C.neg}},fmtPnl(netData.net)))
              )
            ),
            // üÜï V10.0: Fills breakdown for aggregated trades
            tr.fills && tr.fills.length > 1 && h('div',{style:{marginTop:12,padding:12,background:C.card,borderRadius:8,border:'1px solid '+C.info+'30'}},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}},
                h('div',{style:{display:'flex',alignItems:'center',gap:6}},
                  h('span',{style:{fontSize:12}},'üéØ'),
                  h('span',{style:{fontSize:11,fontWeight:600,color:C.info}},lang==='fr'?'Ex√©cutions ('+tr.fills.length+')':'Trade Fills ('+tr.fills.length+')')
                ),
                h('button',{onClick:function(e){e.stopPropagation();openTradeChart(tr);},style:{padding:'4px 10px',background:C.info+'20',border:'1px solid '+C.info+'40',borderRadius:6,cursor:'pointer',fontSize:10,color:C.info,fontWeight:600}},'üìä '+t.viewChart),
                h('button',{onClick:function(e){e.stopPropagation();setChartFullscreen(tr);},style:{padding:'4px 10px',background:C.accent+'20',border:'1px solid '+C.accent+'40',borderRadius:6,cursor:'pointer',fontSize:10,color:C.accent,fontWeight:600},title:'Fullscreen'},'‚õ∂')
              ),
              h('div',{style:{display:'flex',flexDirection:'column',gap:6}},
                tr.fills.map(function(fill, idx){
                  var fillColor = fill.fill_type==='entry' ? C.info : (fill.pnl>=0?C.pos:C.neg);
                  var fillIcon = fill.fill_type==='entry' ? 'üéØ' : (fill.pnl>=0?'‚úÖ':'‚ùå');
                  return h('div',{key:idx,style:{display:'flex',alignItems:'center',gap:10,padding:'6px 10px',background:C.bg,borderRadius:6,borderLeft:'3px solid '+fillColor}},
                    h('span',{style:{fontSize:11}},fillIcon),
                    h('span',{style:{fontSize:10,fontWeight:600,color:fillColor,minWidth:50}},fill.fill_type==='entry'?'ENTRY':(fill.fill_type==='partial'?'TP'+(idx):'EXIT')),
                    h('span',{style:{fontSize:10,color:C.textS}},'$'+(fill.price||0).toLocaleString(undefined,{maximumFractionDigits:2})),
                    fill.size && h('span',{style:{fontSize:9,color:C.textM}},' √ó '+fill.size),
                    fill.pnl !== undefined && fill.fill_type !== 'entry' && h('span',{style:{fontSize:10,fontWeight:600,color:fill.pnl>=0?C.pos:C.neg,marginLeft:'auto'}},fmtPnl(fill.pnl)),
                    fill.time && h('span',{style:{fontSize:8,color:C.textM,marginLeft:8}},(fill.time||'').split('T')[1]?.slice(0,8)||'')
                  );
                })
              )
            )
          );
        };
        
        // Get special badges
        var getSpecialBadges = function(tr) {
          var badges = [];
          if (tr.r === bestR && bestR > 0) badges.push({text:'üèÜ '+t.bestTrade,color:C.warn,bg:C.warnL});
          if (tr.r === worstR && worstR < 0) badges.push({text:t.worstTrade,color:C.neg,bg:C.negL});
          var dur = getDuration(tr.entryTime, tr.exitTime);
          if (dur.mins > 0 && dur.mins < 60) badges.push({text:'‚ö° '+t.quickTrade,color:C.info,bg:C.infoL});
          if (dur.mins > 1440) badges.push({text:'üê¢ '+t.longHold,color:C.textM,bg:C.bg});
          return badges;
        };
        
        // üìà MICRO-CHART COMPONENT - Visual trade direction
        var renderMicroChart = function(tr) {
          var entryP = tr.entryPrice || 0;
          var exitP = tr.exitPrice || tr.currentPrice || entryP;
          var isLong = tr.side === 'LONG';
          var isWin = tr.pnl > 0.05; // üßÆ V3.9 - STRICT: > $0.05
          var isLoss = tr.pnl < -0.05;
          // Line goes UP if (Long & price up) or (Short & price down)
          var priceUp = exitP > entryP;
          var lineUp = (isLong && priceUp) || (!isLong && !priceUp);
          var lineColor = isWin ? C.pos : (isLoss ? C.neg : C.warn); // Win=green, Loss=red, BE=orange
          
          // Simple SVG: entry point (left) -> exit point (right)
          var y1 = lineUp ? 24 : 6;  // Entry Y
          var y2 = lineUp ? 6 : 24;  // Exit Y
          
          return h('svg',{width:60,height:30,style:{flexShrink:0}},
            // Background grid line
            h('line',{x1:0,y1:15,x2:60,y2:15,stroke:C.border,strokeWidth:1,strokeDasharray:'2,2'}),
            // Main line
            h('line',{x1:8,y1:y1,x2:52,y2:y2,stroke:lineColor,strokeWidth:2,strokeLinecap:'round'}),
            // Entry circle (left)
            h('circle',{cx:8,cy:y1,r:4,fill:C.card,stroke:lineColor,strokeWidth:2}),
            // Exit circle (right)
            h('circle',{cx:52,cy:y2,r:4,fill:lineColor})
          );
        };
        
        // Export CSV
        var exportCsv = function() {
          var headers = ['Date','Symbol','Side','Entry','Exit','PnL','R','Regime','Score','Duration'];
          var rows = sorted.map(function(tr) {
            return [
              (tr.entryTime||'').split('T')[0],
              tr.symbol,
              tr.side,
              tr.entryPrice,
              tr.exitPrice||tr.currentPrice,
              tr.pnl,
              tr.r,
              tr.regime,
              tr.score,
              getDuration(tr.entryTime,tr.exitTime).text
            ].join(',');
          });
          var csv = headers.join(',') + '\n' + rows.join('\n');
          var blob = new Blob([csv], {type:'text/csv'});
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'trinity_trades_' + new Date().toISOString().split('T')[0] + '.csv';
          a.click();
        };
        
        return h('div',null,
          // Stats banner
          h('div',{style:Object.assign({},section,{marginBottom:16,padding:16})},
            h('div',{style:{display:'flex',justifyContent:'space-around',alignItems:'center',flexWrap:'wrap',gap:isMobile?10:16}},
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:isMobile?18:24,fontWeight:800}},filteredStats.count),
                h('div',{style:{fontSize:11,color:C.textS}},t.tradesCount)
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:isMobile?18:24,fontWeight:800,color:C.pos}},(filteredStats.winRate).toFixed(0)+'%'),
                h('div',{style:{fontSize:11,color:C.textS}},t.winRate+(''))
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:isMobile?18:24,fontWeight:800,color:filteredStats.totalR>=0?C.pos:C.neg}},fmtR(filteredStats.totalR)),
                h('div',{style:{fontSize:11,color:C.textS}},t.totalR)
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:isMobile?18:24,fontWeight:800,color:(filteredStats.totalPnl)>=0?C.pos:C.neg}},fmtPnl(filteredStats.totalPnl)),
                h('div',{style:{fontSize:11,color:C.textS}},t.totalPnl+(''))
              )
            )
          ),
          
          // Filters section
          h('div',{style:Object.assign({},section,{marginBottom:16,padding:16})},
            h('div',{style:{display:'flex',flexWrap:'wrap',gap:12,alignItems:'center'}},
              // Status filter
              h('div',{style:{display:'flex',gap:4}},
                [['all',t.all],['open',t.openTrades],['win',t.win],['loss',t.loss]].map(function(f){
                  var key = f[0], label = f[1];
                  var isActive = tradeFilter === key;
                  return h('button',{key:key,onClick:function(){setTradeFilter(key);setTradePage(1);},style:{padding:'6px 12px',background:isActive?C.info:C.bg,border:'1px solid '+(isActive?C.info:C.border),borderRadius:6,color:isActive?'#fff':C.textS,fontSize:11,fontWeight:600,cursor:'pointer'}},label);
                })
              ),
              // Symbol filter
              h('select',{value:tradeSymbol,onChange:function(e){setTradeSymbol(e.target.value);setTradePage(1);},style:{padding:'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:11}},
                h('option',{value:'all'},t.allSymbols),
                symbols.map(function(s){return h('option',{key:s,value:s},s);})
              ),
              // Regime filter
              h('select',{value:tradeRegime,onChange:function(e){setTradeRegime(e.target.value);setTradePage(1);},style:{padding:'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:11}},
                h('option',{value:'all'},t.allRegimes),
                regimes.map(function(r){return h('option',{key:r,value:r},r);})
              ),
              // Period filter
              h('select',{value:tradePeriod,onChange:function(e){setTradePeriod(e.target.value);setTradePage(1);},style:{padding:'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:11}},
                h('option',{value:'all'},t.all),
                h('option',{value:'today'},t.today),
                h('option',{value:'week'},t.week),
                h('option',{value:'month'},t.month)
              ),
              // Sort
              h('select',{value:tradeSort,onChange:function(e){setTradeSort(e.target.value);},style:{padding:'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:11}},
                h('option',{value:'dateDesc'},t.dateDesc),
                h('option',{value:'dateAsc'},t.dateAsc),
                h('option',{value:'rDesc'},t.rDesc),
                h('option',{value:'rAsc'},t.rAsc),
                h('option',{value:'pnlDesc'},t.pnlDesc),
                h('option',{value:'pnlAsc'},t.pnlAsc)
              ),
              // Search
              h('input',{type:'text',placeholder:t.searchPlaceholder,value:tradeSearch,onChange:function(e){setTradeSearch(e.target.value);setTradePage(1);},style:{padding:'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:11,width:isMobile?'100%':180}}),
              // Export button
              h('button',{onClick:exportCsv,style:{padding:'6px 12px',background:C.accent,border:'none',borderRadius:6,color:C.bg,fontSize:11,fontWeight:600,cursor:'pointer',marginLeft:isMobile?0:'auto'}},'üì§ '+t.exportCsv)
            )
          ),
          
          // === üéØ V5.0 - OPEN POSITIONS SECTION (PRO TERMINAL) ===
          activeOpenPos.length > 0 && h('div',{style:Object.assign({},section,{marginBottom:20,border:'2px solid '+C.live+'40'})},
            h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:16,paddingBottom:12,borderBottom:'1px solid '+C.border}},
              h('span',{style:{width:10,height:10,borderRadius:'50%',background:C.live,animation:'pulse 1.5s infinite'}}),
              h('span',{style:{fontSize:16,fontWeight:700,color:C.live}},'üî¥ '+t.openTrades.toUpperCase()+' - PRO'),
              h('span',{style:{fontSize:12,color:C.textS}},'('+activeOpenPos.length+')')
            ),
            h('div',{style:{display:'flex',flexDirection:'column',gap:14}},
              activeOpenPos.map(function(tr){
                var symbolClean = (tr.symbol || '').replace('-PERP','').replace('/USDT','').replace('USDT','');
                var isStockTrade = !!stockLogos[symbolClean] || tr.source === 'hip3';
                var displayPrice = isStockTrade ? (stockPrices[symbolClean] || tr.currentPrice || tr.current_price || tr.entryPrice) : (prices[symbolClean] || tr.currentPrice || tr.entryPrice);
                var isExpanded = expandedTrades[tr.id] || false;
                
                // üßÆ V3.7 - CALCUL PNL USD AVEC SIZE
                var posSize = tr.size || 0;
                var priceDiff = (displayPrice - tr.entryPrice);
                var direction = tr.side === 'SHORT' ? -1 : 1;
                var livePnlUSD = priceDiff * posSize * direction;
                
                var livePnlPct = tr.entryPrice > 0 
                  ? (priceDiff / tr.entryPrice * 100 * direction)
                  : 0;
                
                // üßÆ V2.7: R based on TRADE RISK (entry - SL), not portfolio risk
                var tradeSL = parseFloat(tr.initialStopLoss || tr.sl || tr.stop_loss || tr.stopLoss || 0);
                var tradeRisk = Math.abs(tr.entryPrice - tradeSL);
                var pnlDist = priceDiff * direction;
                var displayR = tradeRisk > 0 ? pnlDist / tradeRisk : (tr.r || 0);

                var isProfit = livePnlPct >= 0;
                var displayScore = (tr.score && tr.score > 0) ? tr.score : '--';

                // üè∑Ô∏è V5.0 - Strategy Badge
                var stratBadge = getStrategyBadge(tr);

                // üí≥ V5.0 - Fee for open position (entry fee only)
                var entryFee = (tr.fee || 0) / 2; // Half of round-trip fee

                // Create trade with current price for progress bar (override ALL price fields)
                var trWithCurrent = Object.assign({}, tr, {currentPrice: displayPrice, current_price: displayPrice, markPrice: displayPrice});
                
                return h('div',{key:tr.id,className:'trade-card-pro',style:{background:C.bg,border:'1px solid '+C.live+'40',borderLeft:'4px solid '+C.live,borderRadius:12,padding:isMobile?10:16,cursor:'pointer',transition:'transform .15s, box-shadow .15s'},onClick:function(){toggleExpand(tr.id);}},
                  // Main row
                  h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:isMobile?'flex-start':'center',gap:isMobile?8:0}},
                    h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:16,flex:1,minWidth:0}},
                      cryptoLogo(tr.symbol, isMobile?32:44),
                      !isMobile && renderMicroChart(Object.assign({},tr,{exitPrice:displayPrice})),
                      h('div',null,
                        h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}},
                          h('span',{style:{fontSize:isMobile?14:16,fontWeight:700}},symbolClean),
                          h('span',{style:pill(tr.side==='LONG'?C.pos:C.neg,tr.side==='LONG'?C.posL:C.negL)},tr.side),
                          posSize > 0 && !isMobile && h('span',{style:{fontSize:10,color:C.textS}},'x'+posSize.toLocaleString()),
                          // üè∑Ô∏è V6.0 - Strategy Badge (ALWAYS displayed)
                          h('span',{className:stratBadge.cls,style:{padding:'2px 8px',borderRadius:4,fontSize:9,fontWeight:700}},stratBadge.text),
                          // V2.0 - Source badge (unified mode)
                          market === 'unified' && h('span',{style:{padding:'2px 6px',borderRadius:4,fontSize:8,fontWeight:700,background:tr.source==='hip3'?'#3b82f620':'#22c55e20',color:tr.source==='hip3'?'#3b82f6':'#22c55e',border:'1px solid '+(tr.source==='hip3'?'#3b82f640':'#22c55e40')}},tr.source==='hip3'?'HIP-3':'CRYPTO'),
                          h('span',{style:{width:8,height:8,borderRadius:'50%',background:isProfit?C.pos:C.neg,animation:'pulse 1.5s infinite',boxShadow:'0 0 6px '+(isProfit?C.pos:C.neg)}}),
                          !isMobile && h('span',{style:{fontSize:11,color:C.textS}},'üéØ '+displayScore+'/16')
                        ),
                        h('div',{style:{fontSize:isMobile?11:13,color:C.textS}},fmtPrice(tr.entryPrice)+' ‚Üí '+fmtPrice(displayPrice))
                      )
                    ),
                    h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?6:12}},
                      h('div',{style:{textAlign:'right'}},
                        h('div',{style:{fontSize:isMobile?16:20,fontWeight:700,color:displayR>=0?C.pos:C.neg}},fmtR(displayR)),
                        h('div',{style:{fontSize:isMobile?10:12,fontWeight:600,color:isProfit?C.pos:C.neg}},(isProfit?'+':'')+livePnlPct.toFixed(2)+'%'),
                        // üí≥ V5.0 - NET PnL with fees
                        h('div',{style:{fontSize:isMobile?10:12,padding:'2px 6px',borderRadius:4,background:isProfit?C.posL:C.negL,color:isProfit?C.pos:C.neg}},
                          posSize > 0 ? fmtPnl(livePnlUSD) : fmtPnl(tr.pnl)
                        ),
                        entryFee > 0 && !isMobile && h('div',{className:'fee-tag',style:{fontSize:9,color:C.warn,marginTop:2}},'Fee: -$'+entryFee.toFixed(2))
                      ),
                      h('div',{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:4}},
                        h('span',{style:pill(C.live,C.liveL)},t.liveNow),
                        // üÜï V10.12 TIMELINE_MASTER: Chart toggle button with trade context
                        h('button',{
                          onClick:function(e){e.stopPropagation();toggleInlineChart(tr.id,tr.symbol,tr.entryTime,tr.side);},
                          style:{padding:'4px 8px',background:expandedCharts[tr.id]?C.info:C.info+'20',border:'1px solid '+C.info+'40',borderRadius:6,cursor:'pointer',fontSize:10,color:expandedCharts[tr.id]?'#fff':C.info,fontWeight:600,transition:'all .2s'}
                        },'üìâ '+(expandedCharts[tr.id]?t.hideChart:t.chartBtn)),
                        h('button',{onClick:function(e){e.stopPropagation();setChartFullscreen(tr);},style:{padding:'4px 8px',background:C.accent+'20',border:'1px solid '+C.accent+'40',borderRadius:6,cursor:'pointer',fontSize:10,color:C.accent,fontWeight:600},title:'Fullscreen'},'‚õ∂'),
                        h('span',{style:{fontSize:10,color:C.textS}},isExpanded?'‚ñ≤':'‚ñº')
                      )
                    )
                  ),
                  // üìè V10.11 - SMART TENSION BAR (bi-directional SL...Entry...TP)
                  renderProgressBar(trWithCurrent),
                  // üÜï V10.12 TIMELINE_MASTER - INLINE LIVE CHART with entry marker & auto-zoom
                  expandedCharts[tr.id] && renderInlineChart(trWithCurrent, inlineChartData[tr.id] || [], inlineChartLoading[tr.id], expandedCharts[tr.id]),
                  // üìÇ V5.0 - Accordion Details
                  renderAccordionDetails(trWithCurrent, isExpanded)
                );
              })
            )
          ),
          
          // === TRADE HISTORY SECTION ===
          h('div',{style:section},
            h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:16,paddingBottom:12,borderBottom:'1px solid '+C.border}},
              h('span',{style:{fontSize:18}},'üìú'),
              h('span',{style:{fontSize:16,fontWeight:700}},t.tradeHistory),
              h('span',{style:{fontSize:12,color:C.textS}},'('+activeClosed.length+' trades)')
            ),
            paged.length === 0
              ? h('div',{style:{textAlign:'center',padding:60,color:C.textS}},tradeSearch ? t.noResults : t.noTrades)
              : h('div',{style:{display:'flex',flexDirection:'column',gap:14}},
                  paged.filter(function(tr){return tr.status!=='open';}).map(function(tr){
                    var result = getResultBadge(tr);
                    var duration = getDuration(tr.entryTime, tr.exitTime);
                    var specialBadges = getSpecialBadges(tr);
                    var symbolClean = (tr.symbol || '').replace('-PERP','').replace('/USDT','').replace('USDT','');
                    var displayPrice = tr.exitPrice || tr.currentPrice;
                    var isProfit = tr.pnl > 0.05;
                    var isLoss = tr.pnl < -0.05;
                    var displayScore = (tr.score && tr.score > 0) ? tr.score : '--';
                    var isExpanded = expandedTrades[tr.id] || false;
                    
                    // üè∑Ô∏è V5.0 - Strategy Badge
                    var stratBadge = getStrategyBadge(tr);
                    
                    // üí≥ V5.0 - Net PnL with fees
                    var netData = getNetPnl(tr);
                    
                    return h('div',{key:tr.id,className:'trade-card-pro',style:{background:C.bg,border:'1px solid '+(isProfit?C.pos:isLoss?C.neg:C.warn)+'40',borderLeft:'4px solid '+(isProfit?C.pos:isLoss?C.neg:C.warn),borderRadius:12,padding:isMobile?10:16,cursor:'pointer',transition:'transform .15s, box-shadow .15s'},onClick:function(){toggleExpand(tr.id);}},
                      // Main row
                      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:isMobile?'flex-start':'center',gap:isMobile?8:0}},
                        h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:16,flex:1,minWidth:0}},
                          cryptoLogo(tr.symbol, isMobile?32:44),
                          !isMobile && renderMicroChart(tr),
                          h('div',null,
                            h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:4,flexWrap:'wrap'}},
                              h('span',{style:{fontSize:isMobile?14:16,fontWeight:700}},symbolClean),
                              h('span',{style:pill(tr.side==='LONG'?C.pos:C.neg,tr.side==='LONG'?C.posL:C.negL)},tr.side),
                              // üè∑Ô∏è V6.0 - Strategy Badge (ALWAYS displayed)
                              h('span',{className:stratBadge.cls,style:{padding:'2px 8px',borderRadius:4,fontSize:9,fontWeight:700}},stratBadge.text),
                              // V2.0 - Source badge (unified mode)
                              market === 'unified' && h('span',{style:{padding:'2px 6px',borderRadius:4,fontSize:8,fontWeight:700,background:tr.source==='hip3'?'#3b82f620':'#22c55e20',color:tr.source==='hip3'?'#3b82f6':'#22c55e',border:'1px solid '+(tr.source==='hip3'?'#3b82f640':'#22c55e40')}},tr.source==='hip3'?'HIP-3':'CRYPTO'),
                              !isMobile && h('span',{style:{fontSize:11,color:C.textS}},'üéØ '+displayScore+'/16'),
                              !isMobile && h('span',{style:pill(tr.isLive?C.pos:C.textM,tr.isLive?C.posL:C.bg)},tr.isLive?'üî¥ LIVE':'üìä SIM'),
                              !isMobile && specialBadges.map(function(b,i){return h('span',{key:i,style:pill(b.color,b.bg)},b.text);})
                            ),
                            h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?6:12,flexWrap:'wrap'}},
                              h('span',{style:{fontSize:isMobile?11:13,color:C.textS}},fmtPrice(tr.entryPrice)+' ‚Üí '+fmtPrice(displayPrice)),
                              !isMobile && duration.text && h('span',{style:{fontSize:11,color:C.textM}},'‚è± '+duration.text),
                              // üÜï V10.0: Show fills count if aggregated trade
                              !isMobile && tr.tp_count && tr.tp_count > 1 && h('span',{style:{fontSize:10,padding:'2px 6px',background:C.info+'20',color:C.info,borderRadius:4,marginLeft:8}},'üéØ '+tr.tp_count+' fills')
                            )
                          )
                        ),
                        h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?6:12}},
                          h('div',{style:{textAlign:'right'}},
                            h('div',{style:{fontSize:isMobile?16:20,fontWeight:700,color:tr.r>=0?C.pos:C.neg}},fmtR(tr.r)),
                            // üí≥ V5.0 - NET PnL display (main)
                            h('div',{style:{fontSize:isMobile?11:13,fontWeight:600,color:netData.net>=0?C.pos:C.neg}},fmtPnl(netData.net)),
                            // üí≥ V5.0 - Fees indicator (small)
                            !isMobile && netData.fee > 0 && h('div',{className:'fee-tag',style:{fontSize:9,color:C.warn,marginTop:2}},'Fee: -$'+netData.fee.toFixed(2))
                          ),
                          h('div',{style:{display:'flex',flexDirection:'column',alignItems:'center',gap:4}},
                            h('span',{style:pill(result.color,result.bg)},result.text),
                            // üÜï V10.16: Inline chart toggle button for closed trades
                            h('button',{
                              onClick:function(e){e.stopPropagation();toggleClosedInlineChart(tr.id,tr.symbol,tr.entryTime,tr.exitTime,tr.side);},
                              style:{padding:'4px 8px',background:expandedCharts[tr.id]?C.info:C.info+'20',border:'1px solid '+C.info+'40',borderRadius:6,cursor:'pointer',fontSize:10,color:expandedCharts[tr.id]?'#fff':C.info,fontWeight:600,transition:'all .2s'}
                            },'üìà '+(expandedCharts[tr.id]?t.hideChart:t.chartBtn)),
                            h('span',{style:{fontSize:10,color:C.textS}},isExpanded?'‚ñ≤':'‚ñº')
                          ),
                          !isMobile && h('button',{onClick:function(e){e.stopPropagation();var txt='üî± Trinity Trade\n\n'+tr.side+' '+symbolClean+'\nüìä Score: '+displayScore+'/16\nüí∞ '+fmtR(tr.r)+' | '+fmtPnl(netData.net)+'\n'+(stratBadge?stratBadge.text+' Setup\n':'')+'\n#TrinityBot #Trading';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{width:36,height:36,background:C.card,border:'1px solid '+C.border,borderRadius:6,cursor:'pointer',fontSize:14,fontWeight:800,color:C.text}},'ùïè')
                        )
                      ),
                      // üÜï V10.16: Inline chart for CLOSED trades (Entry ‚Üí Exit markers)
                      expandedCharts[tr.id] && renderClosedInlineChart(tr, inlineChartData[tr.id] || [], inlineChartLoading[tr.id], expandedCharts[tr.id]),
                      // üìÇ V5.0 - Accordion Details
                      renderAccordionDetails(tr, isExpanded)
                    );
                  })
                )
          ),
          
          // Pagination
          totalPages > 1 && h('div',{style:{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:16}},
            h('button',{onClick:function(){setTradePage(Math.max(1,tradePage-1));},disabled:tradePage===1,style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,cursor:tradePage===1?'not-allowed':'pointer',opacity:tradePage===1?.5:1,color:C.text}},'‚Üê'),
            h('span',{style:{fontSize:12,color:C.textS}},t.page+' '+tradePage+' '+t.of+' '+totalPages),
            h('button',{onClick:function(){setTradePage(Math.min(totalPages,tradePage+1));},disabled:tradePage===totalPages,style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,cursor:tradePage===totalPages?'not-allowed':'pointer',opacity:tradePage===totalPages?.5:1,color:C.text}},'‚Üí')
          ),
          
          // Trade Detail Modal
          tradeDetail && h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000},onClick:function(){setTradeDetail(null);}},
            h('div',{style:{background:C.card,borderRadius:isMobile?16:20,padding:isMobile?16:24,width:isMobile?'95%':560,maxWidth:560,maxHeight:isMobile?'80vh':'90vh',overflow:'auto',border:'1px solid '+C.border},onClick:function(e){e.stopPropagation();}},
              // Header
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}},
                h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                  cryptoLogo(tradeDetail.symbol, 48),
                  h('div',null,
                    h('div',{style:{fontSize:20,fontWeight:700}},tradeDetail.symbol+' '+tradeDetail.side),
                    h('div',{style:{fontSize:12,color:C.textS}},t.tradeDetails)
                  )
                ),
                h('button',{onClick:function(){setTradeDetail(null);},style:{width:44,height:44,background:'transparent',border:'none',fontSize:22,cursor:'pointer',color:C.textS,display:'flex',alignItems:'center',justifyContent:'center'}},'√ó')
              ),
              // Results
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:12,marginBottom:24}},
                h('div',{style:{background:C.bg,padding:16,borderRadius:12,textAlign:'center'}},
                  h('div',{style:{fontSize:28,fontWeight:800,color:tradeDetail.r>=0?C.pos:C.neg}},fmtR(tradeDetail.r)),
                  h('div',{style:{fontSize:11,color:C.textS}},'R Multiple')
                ),
                h('div',{style:{background:C.bg,padding:16,borderRadius:12,textAlign:'center'}},
                  h('div',{style:{fontSize:28,fontWeight:800,color:tradeDetail.pnl>=0?C.pos:C.neg}},fmtPct(tradeDetail.pnlPercent)),
                  h('div',{style:{fontSize:11,color:C.textS}},'%')
                ),
                h('div',{style:{background:C.bg,padding:16,borderRadius:12,textAlign:'center'}},
                  h('div',{style:{fontSize:28,fontWeight:800,color:tradeDetail.pnl>=0?C.pos:C.neg}},fmtPnl(tradeDetail.pnl)),
                  h('div',{style:{fontSize:11,color:C.textS}},t.pnl)
                )
              ),
              // Details grid
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:12,marginBottom:24}},
                [[t.symbol,tradeDetail.symbol],[t.side,tradeDetail.side],[t.entry,fmtPrice(tradeDetail.entryPrice)],[t.exit,fmtPrice(tradeDetail.exitPrice||tradeDetail.currentPrice)],[t.entryTime,tradeDetail.entryTime?new Date(tradeDetail.entryTime).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}):'--'],[t.exitTime,tradeDetail.exitTime?new Date(tradeDetail.exitTime).toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}):'-'],[t.duration,getDuration(tradeDetail.entryTime,tradeDetail.exitTime).text||'-'],[t.regime,tradeDetail.regime],[t.score,tradeDetail.score+'/16'],[t.confidence,(tradeDetail.confidence||85)+'%']].map(function(item,i){
                  return h('div',{key:i,style:{background:C.bg,padding:12,borderRadius:8}},
                    h('div',{style:{fontSize:12,color:C.textM,marginBottom:4}},item[0]),
                    h('div',{style:{fontSize:14,fontWeight:600}},item[1])
                  );
                })
              ),
              // Badges
              h('div',{style:{display:'flex',gap:8,flexWrap:'wrap',marginBottom:24}},
                getSpecialBadges(tradeDetail).map(function(b,i){return h('span',{key:i,style:Object.assign({},pill(b.color,b.bg),{padding:'6px 12px',fontSize:12})},b.text);})
              ),
              // Share button
              h('button',{onClick:function(){var txt='üî± Trinity Trade\n\n'+tradeDetail.side+' '+tradeDetail.symbol+'\nüìä Score: '+tradeDetail.score+'/16\nüí∞ '+fmtR(tradeDetail.r)+' | '+fmtPct(tradeDetail.pnlPercent)+'\n‚è± '+getDuration(tradeDetail.entryTime,tradeDetail.exitTime).text+'\n\n#TrinityBot #Trading';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{width:'100%',padding:14,background:C.tw,border:'none',borderRadius:10,color:'#fff',fontSize:14,fontWeight:700,cursor:'pointer'}},'ùïè '+t.shareThisTrade)
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // BOT CONTROL TAB - Full featured
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='botControl' && (function(){
        var sec = {background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border};

        // System stats from API (V2.0: market-aware)
        var sys = activeBot.system || {};
        var uptimeStr = (function(){
          var u = sys.uptime || 0;
          var d = Math.floor(u / 86400);
          var hr = Math.floor((u % 86400) / 3600);
          var m = Math.floor((u % 3600) / 60);
          return d > 0 ? d+'d '+hr+'h '+m+'m' : hr > 0 ? hr+'h '+m+'m' : m+'m';
        })();
        
        // CPU/Memory colors
        var cpuColor = (sys.cpu || 0) < 50 ? C.pos : (sys.cpu || 0) < 80 ? C.warn : C.neg;
        var memColor = (sys.memoryPercent || 0) < 60 ? C.pos : (sys.memoryPercent || 0) < 85 ? C.warn : C.neg;
        
        // Network latency - use real history from state
        var avgLatency = latencyHistory.length > 0 ? Math.round(latencyHistory.reduce(function(a,b){return a+b;},0)/latencyHistory.length) : networkLatency;
        var latencyColor = networkLatency<100?C.pos:networkLatency<300?C.warn:C.neg;
        
        // API Weight from bot data (real value from API)
        var apiWeight = typeof activeBot.apiWeight === 'number' ? activeBot.apiWeight : 0;
        var apiWeightColor = apiWeight < 50 ? C.pos : apiWeight < 80 ? C.warn : C.neg;
        
        // Filtered logs (V2.0: market-aware)
        var filteredLogs = activeLogs.filter(function(log) {
          if (logFilter === 'ALL') return true;
          return log.lvl === logFilter || log.level === logFilter;
        });
        
        // Log themes
        var logThemes = {
          default: {bg:theme==='dark'?'#0a0a0a':'#1e293b',text:'#e5e7eb'},
          matrix: {bg:'#0d1117',text:'#00ff00'},
          light: {bg:'#f8fafc',text:'#1e293b'}
        };
        var currentLogTheme = logThemes[logTheme] || logThemes.default;
        
        // Sparkline renderer (width param added)
        var renderSparkline = function(data, color, width, height) {
          if (!data || data.length < 2) return null;
          var max = Math.max.apply(null, data) || 100;
          var min = Math.min.apply(null, data) || 0;
          var range = max - min || 1;
          var w = width || 100;
          var points = data.map(function(v, i) {
            var x = (i / (data.length - 1)) * w;
            var y = height - ((v - min) / range) * (height - 4) - 2;
            return x + ',' + y;
          }).join(' ');
          return h('svg',{width:w,height:height,style:{display:'block'}},
            h('polyline',{points:points,fill:'none',stroke:color,strokeWidth:1.5,strokeLinecap:'round',strokeLinejoin:'round'})
          );
        };
        
        // System Events (from action history + regime changes + connections)
        var systemEvents = [];
        actionHistory.slice(0,4).forEach(function(act){
          var icon = act.action==='start'?'üü¢':act.action==='stop'?'üü°':act.action==='emergency'?'üî¥':act.action==='restart'?'üü†':'üîµ';
          systemEvents.push({icon:icon,ts:act.ts,msg:act.label});
        });
        if((activeBot.onchain_regime || activeBot.regime) && activeBot.regimeChangedAt){
          systemEvents.push({icon:'üü†',ts:activeBot.regimeChangedAt||'--:--',msg:t.regimeTo+' '+(activeBot.onchain_regime || activeBot.regime || 'NEUTRAL')});
        }
        if(sys.uptime && sys.uptime < 3600){
          systemEvents.push({icon:'üü¢',ts:serverTime.toLocaleTimeString().slice(0,8),msg:t.systemStarted+' ('+uptimeStr+')'});
        }
        if(activeConnected){
          systemEvents.push({icon:'üîµ',ts:serverTime.toLocaleTimeString().slice(0,8),msg:t.wsConnected});
        }
        systemEvents = systemEvents.slice(0,6);
        
        // Compact toolbar button
        var toolBtn = function(icon, label, onClick, color, disabled) {
          return h('button',{onClick:onClick,disabled:disabled,style:{
            padding:'8px 14px',background:disabled?C.bg:color,border:'none',borderRadius:8,
            color:disabled?C.textS:'#fff',fontSize:11,fontWeight:600,cursor:disabled?'not-allowed':'pointer',
            opacity:disabled?0.5:1,display:'flex',alignItems:'center',gap:6,whiteSpace:'nowrap',
            transition:'all 0.2s'
          }},icon,' ',label);
        };
        
        return h('div',{style:section},
          // ‚ïê‚ïê‚ïê HEADER COMPACT ‚ïê‚ïê‚ïê
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:isMobile?'flex-start':'center',marginBottom:16,flexWrap:'wrap',gap:isMobile?8:0}},
            h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:12}},
              h('span',{style:{fontSize:isMobile?22:28}},'ü§ñ'),
              h('div',null,
                h('div',{style:{fontSize:isMobile?16:20,fontWeight:700}},t.botControl),
                h('div',{style:{display:'flex',alignItems:'center',gap:6,marginTop:2}},
                  h('span',{style:{width:8,height:8,borderRadius:'50%',background:activeBot.running?C.pos:C.neg,boxShadow:activeBot.running?'0 0 8px '+C.pos:'none'}}),
                  h('span',{style:{fontSize:12,color:activeBot.running?C.pos:C.neg,fontWeight:600}},activeBot.running?t.botRunning:t.botStopped),
                  botPaused && h('span',{style:{marginLeft:6,padding:'2px 6px',background:C.warn,color:'#000',borderRadius:4,fontSize:9,fontWeight:700}},'PAUSED')
                )
              )
            ),
            h('div',{style:{display:'flex',alignItems:'center',gap:10}},
              h('div',{style:{background:activeConnected?C.posL:C.negL,border:'1px solid '+(activeConnected?C.pos:C.neg),borderRadius:8,padding:'6px 12px',display:'flex',alignItems:'center',gap:6}},
                h('span',{style:{width:6,height:6,borderRadius:'50%',background:activeConnected?C.pos:C.neg,animation:activeConnected?'pulse 1s infinite':'none'}}),
                h('span',{style:{fontSize:11,fontWeight:600,color:activeConnected?C.pos:C.neg}},activeConnected?'LIVE':'OFFLINE')
              ),
              h('div',{style:{fontSize:10,color:C.textS,fontFamily:'monospace'}},serverTime.toLocaleTimeString())
            )
          ),
          
          // ‚ïê‚ïê‚ïê üéõÔ∏è COMPACT TOOLBAR ‚ïê‚ïê‚ïê
          h('div',{style:{background:'#1f2937',borderRadius:10,padding:10,marginBottom:16,display:'flex',alignItems:'center',gap:8,flexWrap:'wrap',overflowX:isMobile?'auto':'visible'}},
            toolBtn('‚ñ∂',t.start,function(){botAction('start');},'#22c55e',activeBot.running),
            toolBtn('‚è∏',botPaused?t.resumeTrading:t.pauseTrading,function(){botAction(botPaused?'resume':'pause');},'#8b5cf6',false),
            toolBtn('üîÑ',t.restart,function(){botAction('restart');},'#f97316',false),
            toolBtn('üîç',t.forceScan,function(){botAction('force_scan');},'#06b6d4',false),
            h('div',{style:{width:1,height:28,background:'#374151',margin:'0 6px'}}),
            toolBtn('üìâ',t.flatten,function(){botAction('flatten');},'#eab308',!activeBot.running),
            !showEmergency
              ? toolBtn('üíÄ',t.emergencyStop,function(){setShowEmergency(true);},'#ef4444',false)
              : h('div',{style:{display:'flex',alignItems:'center',gap:6,padding:'6px 10px',background:'rgba(239,68,68,0.2)',borderRadius:8,border:'1px solid #ef4444'}},
                  h('span',{style:{fontSize:10,color:'#ef4444',fontWeight:600}},t.confirm),
                  h('button',{onClick:function(){botAction('emergency');setShowEmergency(false);},style:{padding:'4px 10px',background:'#ef4444',border:'none',borderRadius:4,color:'#fff',fontSize:10,fontWeight:700,cursor:'pointer'}},t.confirmBtn),
                  h('button',{onClick:function(){setShowEmergency(false);},style:{padding:'4px 8px',background:'transparent',border:'1px solid #4b5563',borderRadius:4,color:'#9ca3af',fontSize:10,cursor:'pointer'}},'‚úï')
                )
          ),
          
          // ‚ïê‚ïê‚ïê METRICS ROW: Network + API Health + Services + System Events ‚ïê‚ïê‚ïê
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr 1fr':'1fr 1fr 1fr 1.5fr',gap:12,marginBottom:16}},
            
            // üì° NETWORK SPARKLINE WIDGET
            h('div',{style:Object.assign({},sec,{padding:12})},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}},
                h('div',{style:{display:'flex',alignItems:'center',gap:6}},
                  h('span',{style:{fontSize:14}},'üì°'),
                  h('span',{style:{fontSize:11,fontWeight:600,color:C.textS}},t.networkMs)
                ),
                h('span',{style:{fontSize:9,color:C.textS}},t.avgMs+' '+avgLatency+'ms')
              ),
              h('div',{style:{fontSize:26,fontWeight:700,color:latencyColor,marginBottom:6}},(networkLatency||0)+' ms'),
              h('div',{style:{background:C.bg,borderRadius:6,padding:'4px 6px',height:36}},
                latencyHistory.length >= 2 ? renderSparkline(latencyHistory, latencyColor, 140, 32) : h('div',{style:{color:C.textS,fontSize:9,textAlign:'center',paddingTop:10}},'...')
              )
            ),
            
            // ‚öñÔ∏è API HEALTH WIDGET
            h('div',{style:Object.assign({},sec,{padding:12})},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:8}},
                h('div',{style:{display:'flex',alignItems:'center',gap:6}},
                  h('span',{style:{fontSize:14}},'‚öñÔ∏è'),
                  h('span',{style:{fontSize:11,fontWeight:600,color:C.textS}},t.apiWeight)
                ),
                h('span',{style:{fontSize:9,color:C.textS}},t.hyperliquid)
              ),
              h('div',{style:{display:'flex',alignItems:'baseline',gap:4,marginBottom:8}},
                h('span',{style:{fontSize:26,fontWeight:700,color:apiWeightColor}},apiWeight+'%'),
                h('span',{style:{fontSize:10,color:C.textS}},t.used)
              ),
              h('div',{style:{background:C.bg,borderRadius:4,height:10,overflow:'hidden'}},
                h('div',{style:{width:apiWeight+'%',height:'100%',background:apiWeightColor,borderRadius:4,transition:'width 0.3s'}})
              ),
              h('div',{style:{fontSize:9,color:apiWeightColor,marginTop:6}},apiWeight<50?'‚úì '+t.rateLimitsOk:apiWeight<80?'‚ö† '+t.rateLimitsModerate:'‚ö† '+t.rateLimitsHigh)
            ),
            
            // üîå SERVICES (Compact)
            h('div',{style:Object.assign({},sec,{padding:12})},
              h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:10}},
                h('span',{style:{fontSize:14}},'üîå'),
                h('span',{style:{fontSize:11,fontWeight:600,color:C.textS}},t.servicesStatus)
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6}},
                [{name:t.postgres,icon:'üêò',key:'postgres'},{name:t.redis,icon:'üî¥',key:'redis'},{name:t.hyperliquid,icon:'üíé',key:'hyperliquid'},{name:'Discord',icon:'üéÆ',key:'discord'}].map(function(svc,i){
                  var status = services[svc.key];
                  var isOk = status === true || status === 'connected';
                  var isNA = status === 'not_configured' || !status;
                  return h('div',{key:i,style:{display:'flex',alignItems:'center',gap:4,padding:'5px 8px',background:C.bg,borderRadius:6}},
                    h('span',{style:{width:6,height:6,borderRadius:'50%',background:isOk?C.pos:isNA?C.textS:C.neg}}),
                    h('span',{style:{fontSize:10,color:isOk?C.pos:isNA?C.textS:C.neg}},svc.name)
                  );
                })
              )
            ),
            
            // üìã SYSTEM EVENTS
            h('div',{style:Object.assign({},sec,{padding:12})},
              h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:10}},
                h('span',{style:{fontSize:14}},'üìã'),
                h('span',{style:{fontSize:11,fontWeight:600,color:C.textS}},t.systemEvents)
              ),
              h('div',{style:{maxHeight:110,overflow:'auto'}},
                systemEvents.length === 0
                  ? h('div',{style:{color:C.textS,fontSize:10,textAlign:'center',padding:12}},t.noEventsYet)
                  : systemEvents.map(function(ev,i){
                      return h('div',{key:i,style:{display:'flex',alignItems:'center',gap:6,padding:'4px 0',borderBottom:i<systemEvents.length-1?'1px solid '+C.border:'none',fontSize:10}},
                        h('span',null,ev.icon),
                        h('span',{style:{color:C.textS,fontFamily:'monospace',minWidth:50}},ev.ts),
                        h('span',{style:{color:C.text,flex:1}},ev.msg)
                      );
                    })
              )
            )
          ),
          
          // ‚ïê‚ïê‚ïê SYSTEM STATS ROW (8 compact cards) ‚ïê‚ïê‚ïê
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(8,1fr)',gap:8,marginBottom:16}},
            [{label:t.uptime,value:uptimeStr||'--',icon:'‚è±Ô∏è'},{label:t.cpu,value:(sys.cpu||0)+'%',icon:'üíª',color:cpuColor},{label:t.memory,value:(sys.memoryPercent||0)+'%',icon:'üß†',color:memColor},{label:t.openTrades,value:activeOpenPos.length,icon:'üìä',color:activeOpenPos.length>0?C.accent:C.textS},{label:t.mode,value:activeBot.mode||'--',icon:'üéØ'},{label:t.regime,value:ocRegimeLabel(activeBot.onchain_regime||'NEUTRAL'),icon:'üìä',color:ocRegimeColor(activeBot.onchain_regime||'NEUTRAL')},{label:t.totalR,value:fmtR(activeStats.totalR),icon:'üìà',color:activeStats.totalR>=0?C.pos:C.neg},{label:'DD',value:'-'+(activeStats.currentDrawdown||0).toFixed(1)+'%',icon:'üìâ',color:activeStats.currentDrawdown>5?C.neg:activeStats.currentDrawdown>2?C.warn:C.pos}].map(function(item,i){
              return h('div',{key:i,style:{background:C.bg,borderRadius:8,padding:10,textAlign:'center'}},
                h('div',{style:{fontSize:12,marginBottom:2}},item.icon),
                h('div',{style:{fontSize:8,color:C.textS,marginBottom:2,textTransform:'uppercase'}},item.label),
                h('div',{style:{fontSize:12,fontWeight:700,color:item.color||C.text}},item.value)
              );
            })
          ),
          
          // ‚ïê‚ïê‚ïê WALLET (Compact) ‚ïê‚ïê‚ïê
          h('div',{style:Object.assign({},sec,{marginBottom:16,padding:12})},
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:16}},'üí∞'),
                h('span',{style:{fontSize:13,fontWeight:700}},t.wallet),
                wallet && h('span',{style:{fontSize:9,color:C.textS,fontFamily:'monospace',marginLeft:8}},wallet.slice(0,6)+'...'+wallet.slice(-4))
              ),
              h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                h('div',{style:{textAlign:'right'}},
                  h('div',{style:{fontSize:9,color:C.textS}},t.balance),
                  h('div',{style:{fontSize:14,fontWeight:700,color:C.pos}},fmtBal(activeStats.balance))
                ),
                h('a',{href:'#',onclick:function(e){e.preventDefault()},style:{padding:'8px 14px',background:'linear-gradient(135deg, #3b82f6, #2563eb)',borderRadius:8,color:'#fff',textDecoration:'none',fontWeight:600,fontSize:11,opacity:0.6,cursor:'default'}},'üîó '+t.openExchange)
              )
            )
          ),
          
          // ‚ïê‚ïê‚ïê LIVE LOGS ‚ïê‚ïê‚ïê
          h('div',{style:sec},
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:isMobile?'flex-start':'center',marginBottom:16,flexWrap:'wrap',gap:isMobile?8:0}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{fontSize:isMobile?16:20}},'üìú'),
                h('span',{style:{fontSize:isMobile?14:16,fontWeight:700}},t.liveLogs),
                h('span',{style:{width:10,height:10,borderRadius:'50%',background:activeConnected?C.pos:C.neg,animation:activeConnected?'pulse 1s infinite':'none'}}),
                h('span',{style:{fontSize:11,color:activeConnected?C.pos:C.neg}},activeConnected?t.connected:t.disconnected)
              ),
              h('div',{style:{display:'flex',gap:4,alignItems:'center',flexWrap:'wrap'}},
                // Log filters
                ['ALL','INFO','SUCCESS','WARNING','ERROR','DEBUG'].map(function(f){
                  var filterColors = {ALL:C.accent,INFO:'#22d3ee',SUCCESS:C.pos,WARNING:C.warn,ERROR:C.neg,DEBUG:'#8b5cf6'};
                  return h('button',{key:f,onClick:function(){setLogFilter(f);},style:{padding:isMobile?'4px 6px':'4px 8px',background:logFilter===f?filterColors[f]+'20':C.bg,border:'1px solid '+(logFilter===f?filterColors[f]:C.border),borderRadius:6,color:logFilter===f?filterColors[f]:C.textS,fontSize:isMobile?8:9,fontWeight:600,cursor:'pointer'}},f==='ALL'?t.filterAll:f);
                })
              )
            ),
            // Log controls row
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12,flexWrap:'wrap',gap:6}},
              h('div',{style:{display:'flex',gap:6,flexWrap:'wrap'}},
                // Sound toggle
                h('button',{onClick:function(){setSoundEnabled(!soundEnabled);},style:{padding:'6px 10px',background:soundEnabled?C.posL:C.bg,border:'1px solid '+(soundEnabled?C.pos:C.border),borderRadius:8,color:soundEnabled?C.pos:C.textS,fontSize:10,cursor:'pointer'}},(soundEnabled?'üîä':'üîá')+(isMobile?'':' '+t.soundOnError)),
                // Log theme selector
                h('select',{value:logTheme,onChange:function(e){setLogTheme(e.target.value);},style:{padding:'6px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:10,cursor:'pointer'}},
                  h('option',{value:'default'},t.defaultTheme),
                  h('option',{value:'matrix'},t.matrixTheme),
                  h('option',{value:'light'},t.lightTheme)
                )
              ),
              h('div',{style:{display:'flex',gap:6,flexWrap:'wrap'}},
                h('button',{onClick:function(){if(!logsPaused) window._pausedLogs=filteredLogs.slice(0,500); setLogsPaused(!logsPaused); window._logsPaused=!logsPaused;},style:{padding:'6px 10px',background:logsPaused?C.warn+'20':C.bg,border:'1px solid '+(logsPaused?C.warn:C.border),borderRadius:8,color:logsPaused?C.warn:C.text,fontSize:10,cursor:'pointer'}},logsPaused?'‚ñ∂Ô∏è '+t.resumeLogs:'‚è∏Ô∏è '+t.pauseLogs),
                h('button',{onClick:function(){var el=document.getElementById('live-logs');if(el)el.scrollTop=el.scrollHeight;},style:{padding:'6px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:10,cursor:'pointer'}},'‚¨áÔ∏è'+(isMobile?'':' '+t.autoScroll)),
                h('button',{onClick:exportLogs,style:{padding:'6px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:10,cursor:'pointer'}},'üì•'+(isMobile?'':' '+t.downloadLogs)),
                h('button',{onClick:function(){if(market==='hip3'){setHip3Logs([]);}else if(market==='unified'){setLogs([]);setHip3Logs([]);}else{setLogs([]);}},style:{padding:'6px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:10,cursor:'pointer'}},'üóëÔ∏è'+(isMobile?'':' '+t.clearLogs))
              )
            ),
            h('div',{id:'live-logs',style:{height:300,overflow:'auto',background:currentLogTheme.bg,borderRadius:12,padding:16,fontFamily:'Monaco, Consolas, monospace',fontSize:11,lineHeight:1.6}},
              filteredLogs.length===0
                ? h('div',{style:{color:'#666',textAlign:'center',paddingTop:40}},
                    h('div',{style:{fontSize:24,marginBottom:8}},'üì≠'),
                    logFilter==='ALL'?t.waitingLogs:'No '+logFilter+' logs'
                  )
                : (logsPaused&&window._pausedLogs?window._pausedLogs:filteredLogs).slice(0,500).map(function(log,i){
                    var lvl = log.lvl || 'INFO';
                    var lvlColor = lvl==='ERROR'||lvl==='CRITICAL'?'#ef4444':lvl==='SUCCESS'||lvl==='OPEN'||lvl==='CLOSE'?'#22c55e':lvl==='WARNING'||lvl==='WARN'?'#eab308':lvl==='DEBUG'?'#8b5cf6':'#22d3ee';
                    var bgColor = lvl==='ERROR'||lvl==='CRITICAL'?'rgba(239,68,68,0.15)':lvl==='SUCCESS'?'rgba(34,197,94,0.1)':'transparent';
                    var ts = log.ts ? (log.ts.includes('T') ? log.ts.split('T')[1].slice(0,8) : log.ts) : '';
                    var textColor = logTheme==='matrix'?'#00ff00':logTheme==='light'?'#1e293b':'#e5e7eb';
                    return h('div',{key:i,style:{marginBottom:2,padding:'4px 8px',borderRadius:4,background:bgColor,display:'flex',gap:8}},
                      h('span',{style:{color:logTheme==='matrix'?'#00aa00':'#4b5563',minWidth:70,fontFamily:'monospace'}},ts),
                      h('span',{style:{color:lvlColor,fontWeight:600,minWidth:70}},'['+lvl+']'),
                      h('span',{style:{color:textColor,flex:1}},log.msg)
                    );
                  })
            ),
            h('div',{style:{marginTop:12,display:'flex',justifyContent:'space-between',alignItems:'center'}},
              h('div',{style:{fontSize:11,color:C.textS}},
                filteredLogs.length+'/'+activeLogs.length+' logs',
                logFilter!=='ALL' && h('span',{style:{marginLeft:8,color:C.accent}},'(filtered: '+logFilter+')'),
                ' ‚Ä¢ ',
                h('span',{style:{color:activeConnected?C.pos:C.neg}},activeConnected?'‚óè Live':'‚óã '+t.disconnected),
                logsPaused && h('span',{style:{marginLeft:8,color:C.warn}},'‚è∏ Paused')
              ),
              h('div',{style:{fontSize:10,color:C.textM,fontFamily:'monospace'}},'docker logs -f crypto-bot')
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ANALYTICS TAB - COMPLETE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='analytics' && (function(){
        // ‚ïê‚ïê‚ïê CRYPTO Momentum Alpha - Simulated Data (2018-2026) ‚ïê‚ïê‚ïê
        var cryptoBacktest = {
          2018: { trades: 512, wr: 58.3, totalR: 310.2, pf: 2.31, avgR: 0.48 },
          2019: { trades: 743, wr: 61.2, totalR: 418.5, pf: 2.55, avgR: 0.45 },
          2020: { trades: 1385, wr: 57.9, totalR: 695.1, pf: 2.18, avgR: 0.42 },
          2021: { trades: 1890, wr: 52.1, totalR: 932.8, pf: 1.92, avgR: 0.41 },
          2022: { trades: 1672, wr: 54.7, totalR: 812.4, pf: 2.05, avgR: 0.39 },
          2023: { trades: 1768, wr: 56.4, totalR: 785.6, pf: 1.88, avgR: 0.37 },
          2024: { trades: 2310, wr: 55.1, totalR: 1102.3, pf: 2.10, avgR: 0.40 },
          2025: { trades: 2345, wr: 52.8, totalR: 948.7, pf: 1.78, avgR: 0.34 },
          2026: { trades: 118, wr: 57.5, totalR: 58.2, pf: 2.08, avgR: 0.41 }
        };
        var cryptoBtTotal = { trades: 12743, wr: 55.6, dd: 8.1, pf: 1.95, totalR: 5420.3, avgR: 0.347, avgWinR: 1.22, avgLossR: 0.89, maxConsecLoss: 11, guardianBlocks: 185, pnl: 384500, finalBal: 352000, roi: 35200 };
        // ‚ïê‚ïê‚ïê HIP-3 Momentum Alpha STOCK - Simulated Data (2018-2026) ‚ïê‚ïê‚ïê
        var hip3Backtest = {
          2018: { trades: 1108, wr: 51.7, totalR: 338.2, pf: 1.78, avgR: 0.26 },
          2019: { trades: 1312, wr: 53.4, totalR: 372.6, pf: 1.71, avgR: 0.24 },
          2020: { trades: 1195, wr: 50.3, totalR: 335.8, pf: 1.65, avgR: 0.23 },
          2021: { trades: 1487, wr: 48.1, totalR: 342.9, pf: 1.45, avgR: 0.19 },
          2022: { trades: 1548, wr: 42.5, totalR: 298.4, pf: 1.31, avgR: 0.16 },
          2023: { trades: 1613, wr: 49.0, totalR: 412.3, pf: 1.54, avgR: 0.21 },
          2024: { trades: 1595, wr: 48.2, totalR: 376.8, pf: 1.47, avgR: 0.19 },
          2025: { trades: 1662, wr: 47.6, totalR: 413.5, pf: 1.52, avgR: 0.21 },
          2026: { trades: 138, wr: 51.2, totalR: 42.7, pf: 1.85, avgR: 0.26 }
        };
        var hip3BtTotal = { trades: 11658, wr: 48.7, dd: 7.5, pf: 1.62, totalR: 2815.6, avgR: 0.215, avgWinR: 0.95, avgLossR: 0.88, maxConsecLoss: 16, guardianBlocks: 620, pnl: 285000, finalBal: 262000, roi: 2620 };
        // Select backtest based on market
        var backtest = market === 'hip3' ? hip3Backtest : cryptoBacktest;
        var btTotal = market === 'hip3' ? hip3BtTotal : cryptoBtTotal;
        var btSetups = market === 'hip3' ? {
          BASIC: { trades: 5162, wr: 46.8, totalR: 968.4, pf: 1.35 },
          PREMIUM: { trades: 5958, wr: 49.5, totalR: 1584.2, pf: 1.56 },
          ADVANCED: { trades: 498, wr: 64.3, totalR: 375.1, pf: 6.42 },
          SIGNAL: { trades: 38, wr: 32.8, totalR: -2.4, pf: 0.78 }
        } : {
          BASIC: { trades: 7712, wr: 53.9, totalR: 3468.2, pf: 2.01 },
          PREMIUM: { trades: 4138, wr: 57.4, totalR: 2008.5, pf: 2.05 },
          ADVANCED: { trades: 785, wr: 58.9, totalR: 426.1, pf: 2.28 },
          SIGNAL: { trades: 131, wr: 67.3, totalR: 113.9, pf: 5.38 }
        };
        var btSymbols = market === 'hip3' ? {
          NVDA: { trades: 858, wr: 46.2, totalR: 189.3 },
          AMZN: { trades: 981, wr: 52.8, totalR: 328.4 },
          MSFT: { trades: 794, wr: 54.3, totalR: 226.8 },
          MSTR: { trades: 1070, wr: 44.1, totalR: 189.7 },
          AAPL: { trades: 1108, wr: 53.5, totalR: 330.2 },
          AMD: { trades: 1261, wr: 46.0, totalR: 315.8 },
          TSLA: { trades: 1180, wr: 45.1, totalR: 248.1 },
          META: { trades: 1110, wr: 53.2, totalR: 346.5 },
          GOOGL: { trades: 1143, wr: 53.9, totalR: 344.9 },
          PLTR: { trades: 783, wr: 46.1, totalR: 192.4 },
          COIN: { trades: 665, wr: 41.2, totalR: 108.5 },
          HOOD: { trades: 696, wr: 41.3, totalR: 106.6 }
        } : {
          BTC: { trades: 2253, wr: 59.7, totalR: 1088.6 },
          ETH: { trades: 2576, wr: 58.5, totalR: 1314.2 },
          DOGE: { trades: 2229, wr: 55.8, totalR: 999.3 },
          LINK: { trades: 2082, wr: 52.3, totalR: 880.1 },
          SOL: { trades: 1832, wr: 52.4, totalR: 934.5 },
          SUI: { trades: 954, wr: 50.5, totalR: 443.2 },
          SEI: { trades: 841, wr: 51.3, totalR: 352.6 }
        };
        var years = [2018,2019,2020,2021,2022,2023,2024,2025,2026];
        
        // Live stats from API (V2.0: market-aware)
        var liveStats = {
          trades: activeStats.wins + activeStats.losses,
          roi: activeStats.totalPnlPercent,
          wr: activeStats.winRate,
          dd: activeStats.maxDrawdown,
          pf: activeStats.profitFactor,
          totalR: activeStats.totalR,
          avgR: (activeStats.wins + activeStats.losses) > 0 ? activeStats.totalR / (activeStats.wins + activeStats.losses) : 0
        };
        
        // 24h Heatmap data from trades
        var heatmap24h = [];
        var bestHourData = {hour: 0, r: -999};
        var worstHourData = {hour: 0, r: 999};
        for (var hr = 0; hr < 24; hr++) {
          var hourTrades = activeClosed.filter(function(tr) {
            var hour = new Date(tr.entryTime).getHours();
            return hour === hr;
          });
          var hourR = hourTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
          var hourWins = hourTrades.filter(function(tr) { return tr.r > 0; }).length;
          heatmap24h.push({ hour: hr, r: hourR, count: hourTrades.length, wins: hourWins });
          if (hourTrades.length > 0 && hourR > bestHourData.r) bestHourData = {hour: hr, r: hourR, count: hourTrades.length};
          if (hourTrades.length > 0 && hourR < worstHourData.r) worstHourData = {hour: hr, r: hourR, count: hourTrades.length};
        }
        
        // Day of week stats
        var dayNames = [t.sun, t.mon, t.tue, t.wed, t.thu, t.fri, t.sat];
        var dayStats = [];
        var bestDayData = {day: 0, r: -999};
        var worstDayData = {day: 0, r: 999};
        for (var wd = 0; wd < 7; wd++) {
          var wdTrades = activeClosed.filter(function(tr) {
            return new Date(tr.entryTime).getDay() === wd;
          });
          var wdR = wdTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
          dayStats.push({ day: wd, name: dayNames[wd], r: wdR, count: wdTrades.length });
          if (wdTrades.length > 0 && wdR > bestDayData.r) bestDayData = {day: wd, name: dayNames[wd], r: wdR};
          if (wdTrades.length > 0 && wdR < worstDayData.r) worstDayData = {day: wd, name: dayNames[wd], r: wdR};
        }
        
        // PnL Calendar - üÜï V10.10.3: Now with month navigation
        var calMonth = calendarMonth.month;
        var calYear = calendarMonth.year;
        var firstDay = new Date(calYear, calMonth, 1).getDay();
        var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
        var calDays = [];
        for (var cd = 1; cd <= daysInMonth; cd++) {
          var dayStr = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(cd).padStart(2, '0');
          var dayTrades = activeClosed.filter(function(tr) { return (tr.exitTime || tr.entryTime || '').startsWith(dayStr); });
          var dayR = dayTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
          calDays.push({ day: cd, r: dayR, count: dayTrades.length });
        }
        
        // Month navigation helpers
        var prevCalMonth = function() {
          setCalendarMonth(function(prev) {
            var newMonth = prev.month - 1;
            var newYear = prev.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            return {month: newMonth, year: newYear};
          });
        };
        var nextCalMonth = function() {
          var now = new Date();
          setCalendarMonth(function(prev) {
            // Don't go beyond current month
            if (prev.month === now.getMonth() && prev.year === now.getFullYear()) return prev;
            var newMonth = prev.month + 1;
            var newYear = prev.year;
            if (newMonth > 11) { newMonth = 0; newYear++; }
            return {month: newMonth, year: newYear};
          });
        };
        var isCurrentMonth = calMonth === new Date().getMonth() && calYear === new Date().getFullYear();
        
        // R Distribution histogram
        var rBuckets = {};
        var rValues = [-3, -2, -1, 0, 1, 2, 3, 4, 5];
        rValues.forEach(function(rv) { rBuckets[rv] = 0; });
        activeClosed.forEach(function(tr) {
          var rRounded = Math.round(tr.r || 0);
          if (rRounded < -3) rRounded = -3;
          if (rRounded > 5) rRounded = 5;
          rBuckets[rRounded] = (rBuckets[rRounded] || 0) + 1;
        });
        var maxBucket = Math.max.apply(null, Object.values(rBuckets).concat([1]));
        
        // Performance by Symbol (V2.0: dynamic symbols from actual trades)
        var symbolPerf = {};
        var tradeSymbols = activeClosed.reduce(function(acc, tr) { if (tr.symbol && acc.indexOf(tr.symbol) === -1) acc.push(tr.symbol); return acc; }, []);
        tradeSymbols.forEach(function(sym) {
          var symTrades = activeClosed.filter(function(tr) { return tr.symbol === sym; });
          var symR = symTrades.reduce(function(s, tr) { return s + (tr.r || 0); }, 0);
          var symWins = symTrades.filter(function(tr) { return tr.r > 0; }).length;
          symbolPerf[sym] = {
            trades: symTrades.length,
            r: symR,
            wr: symTrades.length > 0 ? (symWins / symTrades.length * 100) : 0,
            avgR: symTrades.length > 0 ? symR / symTrades.length : 0
          };
        });
        
        // Streak Analysis
        var currentStreak = activeStats.currentStreak || 0;
        var bestWinStreak = activeStats.bestStreak || 0;
        var worstLossStreak = 0;
        var tempStreak = 0;
        activeClosed.forEach(function(tr) {
          if (tr.r < 0) {
            tempStreak++;
            if (tempStreak > worstLossStreak) worstLossStreak = tempStreak;
          } else {
            tempStreak = 0;
          }
        });
        
        // Advanced metrics from LIVE data
        var winRs = activeClosed.filter(function(tr) { return tr.r > 0; }).map(function(tr) { return tr.r; });
        var lossRs = activeClosed.filter(function(tr) { return tr.r < 0; }).map(function(tr) { return Math.abs(tr.r); });
        var avgWinR = winRs.length > 0 ? winRs.reduce(function(a,b){return a+b;},0) / winRs.length : 0;
        var avgLossR = lossRs.length > 0 ? lossRs.reduce(function(a,b){return a+b;},0) / lossRs.length : 1;
        
        var expectancy = liveStats.trades > 0 ? (liveStats.wr/100 * avgWinR) - ((100 - liveStats.wr)/100 * avgLossR) : 0;
        var allRs = activeClosed.map(function(tr) { return tr.r || 0; });
        var meanR = allRs.length > 0 ? allRs.reduce(function(a,b){return a+b;},0) / allRs.length : 0;
        var variance = allRs.length > 1 ? allRs.reduce(function(s,r){return s + Math.pow(r - meanR, 2);},0) / (allRs.length - 1) : 0;
        var stdDev = Math.sqrt(variance) || 0.5;
        var sharpe = stdDev > 0 ? meanR / stdDev : 0;
        
        var downside = allRs.filter(function(r) { return r < 0; });
        var downsideVar = downside.length > 1 ? downside.reduce(function(s,r){return s + Math.pow(r, 2);},0) / downside.length : 0.25;
        var downsideDev = Math.sqrt(downsideVar) || 0.5;
        var sortino = downsideDev > 0 ? meanR / downsideDev : 0;
        
        // V10.9: Cap ratios at reasonable values (avoid division by near-zero DD)
        var recovery = liveStats.dd > 0.5 ? Math.min(liveStats.totalR / liveStats.dd, 99.99) : 0;
        var calmar = liveStats.dd > 0.5 ? Math.min(liveStats.roi / liveStats.dd, 99.99) : 0;
        var avgRRActual = avgLossR > 0 ? avgWinR / avgLossR : avgWinR;
        
        // Auto Insights
        var autoInsights = [];
        if (bestHourData.r > 0) autoInsights.push({icon:'‚è∞',type:'pos',text:t.bestHour+': '+bestHourData.hour+'h (+'+bestHourData.r.toFixed(1)+'R)'});
        if (worstHourData.r < 0) autoInsights.push({icon:'‚è∞',type:'neg',text:t.worstHour+': '+worstHourData.hour+'h ('+worstHourData.r.toFixed(1)+'R)'});
        if (bestDayData.r > 0) autoInsights.push({icon:'üìÖ',type:'pos',text:t.bestDay+': '+bestDayData.name+' (+'+bestDayData.r.toFixed(1)+'R)'});
        if (worstDayData.r < 0) autoInsights.push({icon:'üìÖ',type:'neg',text:t.worstDay+': '+worstDayData.name+' ('+worstDayData.r.toFixed(1)+'R)'});
        if (liveStats.wr > btTotal.wr) autoInsights.push({icon:'üéØ',type:'pos',text:t.liveVsBacktest+': WR +'+((liveStats.wr - btTotal.wr).toFixed(1))+'%'});
        if (currentStreak >= 3) autoInsights.push({icon:'üî•',type:'pos',text:t.currentStreak+': '+currentStreak+' '+t.win+'s!'});
        if (currentStreak <= -2) autoInsights.push({icon:'‚ö†Ô∏è',type:'neg',text:t.streakAtRisk+': '+Math.abs(currentStreak)+' '+t.loss});
        
        // Milestones
        var milestones = [5,10,15,20,25,30,40,50,75,100,150,200,250,500];
        
        // üß¨ V6.0 - STRATEGY PERFORMANCE (Attribution)
        var strategyPerf = {
          TIER_PREMIUM: {trades:0, wins:0, r:0, pnl:0},
          TIER_ADVANCED: {trades:0, wins:0, r:0, pnl:0},
          SIGNAL_TIER: {trades:0, wins:0, r:0, pnl:0},
          TIER_BASIC: {trades:0, wins:0, r:0, pnl:0},
          UNKNOWN: {trades:0, wins:0, r:0, pnl:0}
        };
        
        // V6.1: Helper to detect strategy key (Sherlock Mode - same as getStrategyBadge)
        var detectStrategyKey = function(tr) {
          var fullText = [
            tr.setup_type, tr.setupType, tr.strategy, tr.entry_reason,
            tr.label, tr.signal_type, tr.trade_type, tr.setup,
            tr.entryReason, tr.type_setup, tr.reason, tr.signal
          ].filter(Boolean).join(' ').toUpperCase();
          
          if (fullText.indexOf('TIER_PREMIUM') !== -1) return 'TIER_PREMIUM';
          if (fullText.indexOf('TIER_ADVANCED') !== -1) return 'TIER_ADVANCED';
          if (fullText.indexOf('SIGNAL_TIER') !== -1) return 'SIGNAL_TIER';
          if (fullText.indexOf('TIER_BASIC') !== -1) return 'TIER_BASIC';
          return 'TIER_BASIC'; // V6.1: Default to TIER_BASIC instead of UNKNOWN
        };
        
        activeClosed.forEach(function(tr) {
          var key = detectStrategyKey(tr);
          strategyPerf[key].trades++;
          strategyPerf[key].r += (tr.r || 0);
          strategyPerf[key].pnl += (tr.pnl || 0);
          if (tr.pnl > 0.05) strategyPerf[key].wins++;
        });
        
        // Calculate WR for each strategy
        Object.keys(strategyPerf).forEach(function(key) {
          var sp = strategyPerf[key];
          sp.wr = sp.trades > 0 ? (sp.wins / sp.trades * 100) : 0;
          sp.avgR = sp.trades > 0 ? (sp.r / sp.trades) : 0;
        });
        
        // ‚öñÔ∏è V6.0 - LONG vs SHORT Performance
        var longTrades = activeClosed.filter(function(tr) { return tr.side === 'LONG'; });
        var shortTrades = activeClosed.filter(function(tr) { return tr.side === 'SHORT'; });
        
        var longStats = {
          trades: longTrades.length,
          wins: longTrades.filter(function(tr) { return tr.pnl > 0.05; }).length,
          r: longTrades.reduce(function(s,tr) { return s + (tr.r || 0); }, 0),
          pnl: longTrades.reduce(function(s,tr) { return s + (tr.pnl || 0); }, 0)
        };
        longStats.wr = longStats.trades > 0 ? (longStats.wins / longStats.trades * 100) : 0;
        
        var shortStats = {
          trades: shortTrades.length,
          wins: shortTrades.filter(function(tr) { return tr.pnl > 0.05; }).length,
          r: shortTrades.reduce(function(s,tr) { return s + (tr.r || 0); }, 0),
          pnl: shortTrades.reduce(function(s,tr) { return s + (tr.pnl || 0); }, 0)
        };
        shortStats.wr = shortStats.trades > 0 ? (shortStats.wins / shortStats.trades * 100) : 0;
        
        var totalTrades = longStats.trades + shortStats.trades;
        var longPct = totalTrades > 0 ? (longStats.trades / totalTrades * 100) : 50;
        var shortPct = 100 - longPct;
        
        // üí∏ V10.9 - COST ANALYSIS - Use Exchange data when available
        // V2.0: Use accurateStats only for crypto market
        var useAccurateCost = market !== 'hip3' ? accurateStats : null;
        var totalGrossProfit = useAccurateCost ? useAccurateCost.gross_pnl : activeClosed.filter(function(tr) { return tr.pnl > 0; }).reduce(function(s,tr) { return s + tr.pnl; }, 0);
        var totalFees = useAccurateCost ? useAccurateCost.total_fees : (activeStats.totalFees || activeClosed.reduce(function(s,tr) { return s + (tr.fee || 0); }, 0));
        var totalNetPnl = useAccurateCost ? useAccurateCost.net_pnl : (activeStats.totalPnl - totalFees);
        var feesRatio = totalGrossProfit > 0 ? (totalFees / totalGrossProfit * 100) : 0;
        var isHLCost = !!accurateStats;
        
        var sec = {background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border};
        var monthNames = [t.jan,t.feb,t.mar,t.apr,t.may,t.jun,t.jul,t.aug,t.sep,t.oct,t.nov,t.dec];
        
        return h('div',null,
          // BACKTEST Momentum Alpha (when sim selected)
          analyticsFilter === 'sim' && h('div',{style:{background:'linear-gradient(135deg, '+C.card+' 0%, '+C.bg+' 100%)',border:'1px solid '+C.accent+'40',borderRadius:14,padding:isMobile?14:20,marginBottom:16}},
            // Header
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:isMobile?'flex-start':'center',marginBottom:16,flexWrap:'wrap',gap:10}},
              h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                h('div',{style:{width:44,height:44,background:'linear-gradient(135deg, '+C.accent+', '+C.info+')',borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:22}},'üî±'),
                h('div',null,
                  h('div',{style:{fontSize:isMobile?16:20,fontWeight:800,color:C.text}},'Momentum Alpha'),
                  h('div',{style:{display:'flex',gap:6,marginTop:4,flexWrap:'wrap'}},
                    h('span',{style:{fontSize:9,padding:'2px 8px',background:C.accent+'20',color:C.accent,borderRadius:4,fontWeight:600}},'BACKTEST'),
                    h('span',{style:{fontSize:9,padding:'2px 8px',background:C.info+'20',color:C.info,borderRadius:4}},'2018-2026 | 7 symbols'),
                    h('span',{style:{fontSize:9,padding:'2px 8px',background:C.pos+'20',color:C.pos,borderRadius:4,fontWeight:700}},'Strategy Results')
                  )
                )
              ),
              h('button',{onClick:function(){var txt='üî± Trinity Backtest Results\n\n‚öñÔ∏è PF: '+btTotal.pf+'\nüíé +'+btTotal.totalR.toFixed(0)+'R\nüéØ WR: '+btTotal.wr+'%\nüìâ DD: -'+btTotal.dd+'%\nüìä '+btTotal.trades+' trades\n\n#TrinityBot #AlgoTrading';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{padding:'8px 16px',background:C.tw,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer',fontSize:11}},'ùïè '+t.share)
            ),
            // Hero metrics ‚Äî 2 rows
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:10,marginBottom:16}},
              [
                ['‚öñÔ∏è',t.profitFactor,btTotal.pf.toFixed(2),C.accent,true],
                ['üíé',t.totalR,'+'+btTotal.totalR.toFixed(0)+'R',C.pos,true],
                ['üéØ',t.winRate,btTotal.wr+'%',C.text,false],
                ['üìâ',t.maxDrawdown,'-'+btTotal.dd+'%',C.neg,false],
                ['üìä',t.totalTrades,btTotal.trades.toLocaleString(),C.text,false],
                ['‚ú®','Expectancy',btTotal.avgR.toFixed(3)+'R',btTotal.avgR>=0?C.pos:C.neg,false],
                ['üõ°Ô∏è','Risk Blocks',btTotal.guardianBlocks+' blocks',C.warn,false],
                ['üìà','Avg Win / Loss',btTotal.avgWinR.toFixed(2)+' / '+btTotal.avgLossR.toFixed(2),C.text,false]
              ].map(function(item,i){
                return h('div',{key:i,style:{background:item[4]?'linear-gradient(135deg, '+item[3]+'15, '+item[3]+'08)':C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',border:item[4]?'1px solid '+item[3]+'30':'1px solid '+C.border}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:2}},item[1]),
                  h('div',{style:{fontSize:9,marginBottom:4}},item[0]),
                  h('div',{style:{fontSize:item[4]?20:16,fontWeight:700,color:item[3]}},item[2])
                );
              })
            ),
            // Year-by-year R chart + PF overlay
            h('div',{style:{marginBottom:16}},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:10}},
                h('span',{style:{fontSize:12,fontWeight:600}},lang==='fr'?'R cumul√© par ann√©e':'Cumulative R by Year'),
                h('span',{style:{fontSize:9,color:C.textS}},lang==='fr'?'PF affich√© en haut':'PF shown on top')
              ),
              h('div',{style:{display:'flex',alignItems:'flex-end',gap:isMobile?4:8,height:120,padding:'0 4px'}},
                years.map(function(y){
                  var d = backtest[y];
                  var maxR = 1447;
                  var barH = Math.max((d.totalR / maxR) * 100, 5);
                  var isPartial = y === 2026;
                  return h('div',{key:y,style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:2}},
                    h('div',{style:{fontSize:isMobile?7:9,fontWeight:700,color:d.pf>=2.5?C.pos:d.pf>=2.0?C.accent:C.warn}},d.pf.toFixed(2)),
                    h('div',{style:{fontSize:isMobile?6:8,color:C.textS}},'+'+d.totalR.toFixed(0)+'R'),
                    h('div',{style:{width:'100%',height:barH+'%',minHeight:8,background:isPartial?'repeating-linear-gradient(45deg,'+C.accent+','+C.accent+' 3px,'+C.accent+'80 3px,'+C.accent+'80 6px)':d.pf>=2.5?C.pos:d.pf>=2.0?C.accent:C.warn,borderRadius:4,opacity:isPartial?0.7:1}}),
                    h('div',{style:{fontSize:isMobile?7:9,color:C.textS,marginTop:2}},String(y).slice(2))
                  );
                })
              )
            ),
            // Strategy breakdown + Symbol breakdown side by side
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:12}},
              // Strategy Attribution
              h('div',{style:{background:C.bg,borderRadius:10,padding:12}},
                h('div',{style:{fontSize:11,fontWeight:600,marginBottom:10,display:'flex',alignItems:'center',gap:6}},
                  h('span',null,'üß¨'),
                  h('span',null,lang==='fr'?'Performance par Setup':'Setup Performance')
                ),
                [{key:'SIGNAL',icon:'üì°',color:'#f97316',label:'SIGNAL'},{key:'ADVANCED',icon:'üî∑',color:'#06b6d4',label:'ADVANCED'},{key:'PREMIUM',icon:'‚≠ê',color:'#a855f7',label:'PREMIUM'},{key:'BASIC',icon:'üìä',color:'#6b7280',label:'BASIC'}].map(function(s){
                  var d = btSetups[s.key];
                  var maxPf = 6.42;
                  var barW = Math.min((d.pf / maxPf) * 100, 100);
                  return h('div',{key:s.key,style:{display:'flex',alignItems:'center',gap:8,marginBottom:6}},
                    h('span',{style:{fontSize:12,width:20,textAlign:'center'}},s.icon),
                    h('div',{style:{flex:1}},
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}},
                        h('span',{style:{fontWeight:600,color:s.color}},s.label),
                        h('span',{style:{color:C.textS}},d.trades+' | '+d.wr.toFixed(0)+'%')
                      ),
                      h('div',{style:{height:6,background:C.border,borderRadius:3,overflow:'hidden'}},
                        h('div',{style:{width:barW+'%',height:'100%',background:s.color,borderRadius:3}})
                      ),
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:9,color:C.textS,marginTop:1}},
                        h('span',null,'PF '+d.pf.toFixed(2)),
                        h('span',null,'+'+d.totalR.toFixed(0)+'R')
                      )
                    )
                  );
                })
              ),
              // Symbol breakdown
              h('div',{style:{background:C.bg,borderRadius:10,padding:12}},
                h('div',{style:{fontSize:11,fontWeight:600,marginBottom:10,display:'flex',alignItems:'center',gap:6}},
                  h('span',null,'ü™ô'),
                  h('span',null,lang==='fr'?'Performance par Symbole':'Symbol Performance')
                ),
                Object.keys(btSymbols).sort(function(a,b){return btSymbols[b].totalR-btSymbols[a].totalR;}).map(function(sym){
                  var d = btSymbols[sym];
                  var maxR = 1720;
                  var barW = Math.min((d.totalR / maxR) * 100, 100);
                  return h('div',{key:sym,style:{display:'flex',alignItems:'center',gap:8,marginBottom:6}},
                    cryptoLogo(sym, 20),
                    h('div',{style:{flex:1}},
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}},
                        h('span',{style:{fontWeight:600}},sym),
                        h('span',{style:{color:C.textS}},d.trades+' | '+d.wr.toFixed(0)+'%')
                      ),
                      h('div',{style:{height:6,background:C.border,borderRadius:3,overflow:'hidden'}},
                        h('div',{style:{width:barW+'%',height:'100%',background:C.accent,borderRadius:3}})
                      )
                    ),
                    h('span',{style:{fontSize:10,fontWeight:700,color:C.pos,minWidth:45,textAlign:'right'}},'+'+d.totalR.toFixed(0)+'R')
                  );
                })
              )
            )
          ),

          // ‚ïê‚ïê‚ïê V2.0: LIVE vs BACKTEST COMPARISON ‚ïê‚ïê‚ïê
          analyticsFilter==='live' && comparisonData && (function(){
            var live = comparisonData.overall || {};
            var deltaColor = function(lv,bv){return lv>=bv*0.9?C.pos:lv>=bv*0.7?C.warn:C.neg;};
            var deltaIcon = function(lv,bv){return lv>=bv*0.9?'‚úÖ':lv>=bv*0.7?'‚ö†Ô∏è':'üî¥';};
            var deltaPct = function(lv,bv){var d=bv>0?((lv-bv)/bv*100):0;return (d>=0?'+':'')+d.toFixed(0)+'%';};
            var liveSetups = comparisonData.bySetup || {};
            var liveSyms = comparisonData.bySymbol || {};
            var diags = [];
            var setupToBacktest={TIER_PREMIUM:'PREMIUM',TIER_ADVANCED:'ADVANCED',TIER_SIGNAL:'SIGNAL',TIER_BASIC:'BASIC'};
            ['TIER_PREMIUM','TIER_ADVANCED','TIER_SIGNAL','TIER_BASIC'].forEach(function(s){
              var btKey=setupToBacktest[s]||s; var ls = liveSetups[s]; var bs = btSetups[btKey]; var lbl=btKey;
              if(ls && bs && ls.trades>=5){
                if(ls.wr < bs.wr - 10) diags.push({type:'neg',text:lbl+': WR '+ls.wr.toFixed(0)+'% vs '+bs.wr.toFixed(0)+'% BT (-'+(bs.wr-ls.wr).toFixed(0)+'%)'});
                else if(ls.wr >= bs.wr) diags.push({type:'pos',text:lbl+': WR '+ls.wr.toFixed(0)+'% vs '+bs.wr.toFixed(0)+'% BT ‚Äî OK'});
              }
            });
            Object.keys(liveSyms).forEach(function(sym){
              var ls = liveSyms[sym];
              if(ls && ls.trades>=5 && ls.wr < 40) diags.push({type:'neg',text:sym+': WR faible '+ls.wr.toFixed(0)+'% ('+ls.trades+' trades)'});
            });
            return h('div',{style:{background:'linear-gradient(135deg, '+C.card+' 0%, '+C.infoL+' 100%)',border:'1px solid '+C.info+'40',borderRadius:14,padding:isMobile?14:20,marginBottom:16}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:16}},
                h('span',{style:{fontSize:18}},'üî¨'),
                h('span',{style:{fontSize:15,fontWeight:700}},'Live vs Backtest'),
                h('span',{style:{fontSize:10,padding:'3px 8px',background:C.liveL,borderRadius:6,color:C.live}},'LIVE'),
                h('span',{style:{fontSize:10,padding:'3px 8px',background:C.accentL,borderRadius:6,color:C.accent}},'v1.0')
              ),
              // 3 comparison cards
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:12,marginBottom:16}},
                [
                  {label:'Win Rate',lv:(live.wr||0),bv:btTotal.wr,fmt:function(v){return v.toFixed(1)+'%';}},
                  {label:'Profit Factor',lv:(live.pf||0),bv:btTotal.pf,fmt:function(v){return v.toFixed(2);}},
                  {label:'Avg R/Trade',lv:(live.avgR||0),bv:btTotal.avgR||0.5,fmt:function(v){return v.toFixed(3)+'R';}}
                ].map(function(m,i){
                  var dc = deltaColor(m.lv,m.bv);
                  return h('div',{key:i,style:{background:C.bg,borderRadius:10,padding:14,border:'1px solid '+C.border}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:8}},m.label),
                    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                      h('div',null,
                        h('div',{style:{fontSize:9,color:C.live,marginBottom:2}},'LIVE'),
                        h('div',{style:{fontSize:18,fontWeight:700,color:dc}},m.fmt(m.lv))
                      ),
                      h('div',{style:{fontSize:16,color:C.textS}},'vs'),
                      h('div',{style:{textAlign:'right'}},
                        h('div',{style:{fontSize:9,color:C.accent,marginBottom:2}},'BACKTEST'),
                        h('div',{style:{fontSize:18,fontWeight:700,color:C.textM}},m.fmt(m.bv))
                      )
                    ),
                    h('div',{style:{textAlign:'center',marginTop:8,fontSize:11,fontWeight:600,color:dc}},deltaIcon(m.lv,m.bv)+' '+deltaPct(m.lv,m.bv))
                  );
                })
              ),
              // Setup comparison bars
              h('div',{style:{marginBottom:16}},
                h('div',{style:{fontSize:12,fontWeight:600,marginBottom:10}},'Par Setup'),
                h('div',{style:{display:'flex',flexDirection:'column',gap:6}},
                  ['TIER_PREMIUM','TIER_ADVANCED','TIER_SIGNAL','TIER_BASIC'].map(function(s){
                    var btKeyMap={TIER_PREMIUM:'PREMIUM',TIER_ADVANCED:'ADVANCED',TIER_SIGNAL:'SIGNAL',TIER_BASIC:'BASIC'};
                    var ls = liveSetups[s] || {trades:0,wr:0,totalR:0};
                    var bs = btSetups[btKeyMap[s]||s] || {trades:0,wr:0,totalR:0};
                    var icons = {TIER_PREMIUM:'‚≠ê',TIER_ADVANCED:'üî∑',TIER_SIGNAL:'üì°',TIER_BASIC:'üìä'};
                    var labels = {TIER_PREMIUM:'PREMIUM',TIER_ADVANCED:'ADVANCED',TIER_SIGNAL:'SIGNAL',TIER_BASIC:'BASIC'};
                    var maxWr = Math.max(ls.wr||0,bs.wr||0,1);
                    return h('div',{key:s,style:{display:'flex',alignItems:'center',gap:8,padding:8,background:C.bg,borderRadius:6}},
                      h('div',{style:{width:24,textAlign:'center',fontSize:12}},icons[s]||''),
                      h('div',{style:{width:isMobile?60:80,fontSize:10,fontWeight:600}},labels[s]||s),
                      h('div',{style:{flex:1}},
                        h('div',{style:{height:6,background:C.border,borderRadius:3,position:'relative',marginBottom:2}},
                          h('div',{style:{position:'absolute',top:0,left:0,height:'100%',width:Math.min((ls.wr||0)/maxWr*100,100)+'%',background:C.live,borderRadius:3}})
                        ),
                        h('div',{style:{height:6,background:C.border,borderRadius:3,position:'relative'}},
                          h('div',{style:{position:'absolute',top:0,left:0,height:'100%',width:Math.min((bs.wr||0)/maxWr*100,100)+'%',background:C.accent,borderRadius:3,opacity:0.5}})
                        )
                      ),
                      h('div',{style:{width:isMobile?80:100,textAlign:'right',fontSize:10}},
                        h('span',{style:{color:C.live,fontWeight:600}},((ls.wr||0).toFixed(0))+'%'),
                        h('span',{style:{color:C.textS}},' / '),
                        h('span',{style:{color:C.accent}},((bs.wr||0).toFixed(0))+'%')
                      ),
                      h('div',{style:{width:40,textAlign:'right',fontSize:9,color:C.textS}},ls.trades||0)
                    );
                  })
                ),
                h('div',{style:{display:'flex',gap:12,marginTop:8,fontSize:9,color:C.textS}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:4}},h('div',{style:{width:12,height:4,background:C.live,borderRadius:2}}),'Live WR'),
                  h('div',{style:{display:'flex',alignItems:'center',gap:4}},h('div',{style:{width:12,height:4,background:C.accent,borderRadius:2,opacity:0.5}}),'Backtest WR')
                )
              ),
              // Symbol comparison grid
              h('div',{style:{marginBottom:diags.length>0?16:0}},
                h('div',{style:{fontSize:12,fontWeight:600,marginBottom:10}},'Par Symbole'),
                h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr 1fr':'repeat(auto-fill, minmax(140px, 1fr))',gap:6}},
                  Object.keys(liveSyms).sort(function(a,b){return (liveSyms[b].totalR||0)-(liveSyms[a].totalR||0);}).map(function(sym){
                    var ls = liveSyms[sym];
                    var btSym = btSymbols[sym];
                    var bWr = btSym ? btSym.wr : null;
                    var enoughData = ls.trades >= 5;
                    var dc = bWr && enoughData ? deltaColor(ls.wr, bWr) : C.textS;
                    return h('div',{key:sym,style:{background:C.bg,borderRadius:6,padding:8,border:'1px solid '+C.border}},
                      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}},
                        h('span',{style:{fontSize:11,fontWeight:700}},sym),
                        h('span',{style:{fontSize:9,color:C.textS}},ls.trades+' trades')
                      ),
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10}},
                        h('span',{style:{color:dc,fontWeight:600}},ls.wr.toFixed(0)+'%'),
                        bWr ? h('span',{style:{color:C.textS}},'vs '+bWr.toFixed(0)+'%') : h('span',{style:{color:C.textS,fontSize:8}},'N/A')
                      ),
                      h('div',{style:{fontSize:10,fontWeight:600,color:ls.totalR>=0?C.pos:C.neg,marginTop:2}},fmtR(ls.totalR))
                    );
                  })
                )
              ),
              // Diagnostics
              diags.length > 0 && h('div',null,
                h('div',{style:{fontSize:12,fontWeight:600,marginBottom:8}},'Diagnostic'),
                h('div',{style:{display:'flex',flexDirection:'column',gap:4}},
                  diags.map(function(d,i){
                    return h('div',{key:i,style:{display:'flex',alignItems:'center',gap:8,padding:8,background:d.type==='pos'?C.posL:C.negL,borderLeft:'3px solid '+(d.type==='pos'?C.pos:C.neg),borderRadius:4,fontSize:10}},
                      h('span',null,d.type==='pos'?'‚úÖ':'üî¥'),
                      h('span',null,d.text)
                    );
                  })
                )
              )
            );
          })(),

          // ‚ïê‚ïê‚ïê V2.0: SESSION ANALYSIS (Crypto only) ‚ïê‚ïê‚ïê
          analyticsFilter==='live' && market!=='hip3' && sessionsData && (function(){
            var sessionDefs = [
              {key:'asia',label:'Asia',icon:'üåè',hours:'0-8h UTC'},
              {key:'london',label:'London',icon:'üá¨üáß',hours:'8-13h UTC'},
              {key:'ny',label:'New York',icon:'üá∫üá∏',hours:'13-21h UTC'},
              {key:'offHours',label:'Off-Hours',icon:'üåô',hours:'21-0h UTC'}
            ];
            var bestSession = {key:'',r:-999};
            sessionDefs.forEach(function(sd){
              var s = sessionsData[sd.key];
              if(s && s.totalR > bestSession.r) bestSession = {key:sd.label,r:s.totalR,wr:s.wr};
            });
            return h('div',{style:{background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border,marginBottom:16}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                h('span',{style:{fontSize:14}},'üåç'),
                h('span',{style:{fontSize:13,fontWeight:600}},'Sessions de Trading')
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:10}},
                sessionDefs.map(function(sd){
                  var s = sessionsData[sd.key] || {trades:0,wr:0,totalR:0,avgR:0};
                  var wrColor = s.wr > 55 ? C.pos : s.wr > 45 ? C.warn : s.trades > 0 ? C.neg : C.textS;
                  return h('div',{key:sd.key,style:{background:C.bg,borderRadius:8,padding:12,border:'1px solid '+C.border}},
                    h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:8}},
                      h('span',{style:{fontSize:14}},sd.icon),
                      h('div',null,
                        h('div',{style:{fontSize:11,fontWeight:600}},sd.label),
                        h('div',{style:{fontSize:8,color:C.textS}},sd.hours)
                      )
                    ),
                    h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:4}},
                      h('div',null,h('div',{style:{fontSize:8,color:C.textS}},'Trades'),h('div',{style:{fontSize:13,fontWeight:700}},s.trades)),
                      h('div',null,h('div',{style:{fontSize:8,color:C.textS}},'WR'),h('div',{style:{fontSize:13,fontWeight:700,color:wrColor}},s.wr.toFixed(0)+'%')),
                      h('div',null,h('div',{style:{fontSize:8,color:C.textS}},'Total R'),h('div',{style:{fontSize:13,fontWeight:700,color:s.totalR>=0?C.pos:C.neg}},fmtR(s.totalR))),
                      h('div',null,h('div',{style:{fontSize:8,color:C.textS}},'Avg R'),h('div',{style:{fontSize:13,fontWeight:700,color:s.avgR>=0?C.pos:C.neg}},s.avgR.toFixed(2)+'R'))
                    )
                  );
                })
              ),
              bestSession.r > -999 && h('div',{style:{marginTop:10,padding:8,background:C.posL,borderRadius:6,fontSize:10,display:'flex',alignItems:'center',gap:6}},
                h('span',null,'üèÜ'),
                h('span',{style:{fontWeight:600}},'Meilleure session: '+bestSession.key+' (+'+bestSession.r.toFixed(1)+'R, WR '+bestSession.wr.toFixed(0)+'%)')
              )
            );
          })(),

          // ROW 1: Heatmap 24h + PnL Calendar
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1.5fr',gap:12,marginBottom:16}},
            // 24h Heatmap
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}},
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},h('span',{style:{fontSize:14}},'üî•'),h('span',{style:{fontSize:13,fontWeight:600}},t.heatmap24h)),
                h('button',{onClick:function(){var txt='üî± 24h Heatmap\n'+t.bestHour+': '+bestHourData.hour+'h (+'+bestHourData.r.toFixed(1)+'R)\n\n#TrinityBot';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{padding:'4px 10px',background:C.tw,border:'none',borderRadius:6,color:'#fff',fontSize:10,cursor:'pointer'}},'ùïè '+t.share)
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(6,1fr)':'repeat(8,1fr)',gap:4}},
                heatmap24h.map(function(hd,i){
                  var bg = hd.count === 0 ? C.bg : hd.r > 0 ? C.pos : hd.r < 0 ? C.neg : C.warn;
                  var opacity = hd.count === 0 ? 0.3 : Math.min(0.4 + Math.abs(hd.r) * 0.3, 1);
                  var isBest = bestHourData.hour === i && bestHourData.r > 0;
                  var isWorst = worstHourData.hour === i && worstHourData.r < 0;
                  return h('div',{key:i,title:i+'h: '+hd.count+' trades, '+fmtR(hd.r),style:{textAlign:'center',padding:6,borderRadius:4,background:bg,opacity:opacity,border:isBest?'2px solid '+C.pos:isWorst?'2px solid '+C.neg:'none'}},
                    h('div',{style:{fontSize:8,color:C.textM}},i+'h'),
                    hd.count > 0 && h('div',{style:{fontSize:9,fontWeight:600,color:hd.r>0?'#fff':'#fff'}},hd.r>0?'+'+hd.r.toFixed(1):hd.r.toFixed(1))
                  );
                })
              ),
              h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:10,fontSize:9}},
                h('span',{style:{color:C.neg}},'-R'),
                h('div',{style:{flex:1,height:4,margin:'0 8px',background:'linear-gradient(to right,'+C.neg+','+C.bg+','+C.pos+')',borderRadius:2}}),
                h('span',{style:{color:C.pos}},'+R')
              ),
              // Best/Worst hour
              h('div',{style:{display:'flex',gap:8,marginTop:12}},
                bestHourData.r !== -999 && h('div',{style:{flex:1,padding:8,background:C.posL,borderRadius:6,fontSize:10}},
                  h('div',{style:{color:C.textS}},t.bestHour),
                  h('div',{style:{fontWeight:700,color:C.pos}},bestHourData.hour+'h: +'+bestHourData.r.toFixed(1)+'R')
                ),
                worstHourData.r !== 999 && h('div',{style:{flex:1,padding:8,background:C.negL,borderRadius:6,fontSize:10}},
                  h('div',{style:{color:C.textS}},t.worstHour),
                  h('div',{style:{fontWeight:700,color:C.neg}},worstHourData.hour+'h: '+worstHourData.r.toFixed(1)+'R')
                )
              )
            ),

            // PnL Calendar
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}},
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontSize:14}},'üìÖ'),
                  h('span',{style:{fontSize:13,fontWeight:600}},t.pnlCalendar+' - '+monthNames[calMonth]+' '+calYear)
                ),
                // Month navigation buttons
                h('div',{style:{display:'flex',gap:4}},
                  h('button',{onClick:prevCalMonth,style:{padding:'4px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:12,cursor:'pointer'}},'‚óÄ'),
                  h('button',{onClick:nextCalMonth,disabled:isCurrentMonth,style:{padding:'4px 10px',background:isCurrentMonth?C.border:C.bg,border:'1px solid '+C.border,borderRadius:6,color:isCurrentMonth?C.textS:C.text,fontSize:12,cursor:isCurrentMonth?'not-allowed':'pointer'}},'‚ñ∂')
                )
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:isMobile?2:4,textAlign:'center'}},
                [t.sun,t.mon,t.tue,t.wed,t.thu,t.fri,t.sat].map(function(dn){return h('div',{key:dn,style:{fontSize:isMobile?8:9,color:C.textM,padding:isMobile?2:4}},dn);}),
                Array(firstDay).fill(null).map(function(_,i){return h('div',{key:'e'+i});}),
                calDays.map(function(cd){
                  var todayDate = new Date();
                  var isToday = cd.day === todayDate.getDate() && calMonth === todayDate.getMonth() && calYear === todayDate.getFullYear();
                  var hasTrades = cd.count > 0;
                  var bg = !hasTrades ? 'transparent' : cd.r > 0 ? C.posL : cd.r < 0 ? C.negL : C.warnL;
                  var border = isToday ? '2px solid '+C.pos : hasTrades ? '1px solid '+(cd.r>0?C.pos:cd.r<0?C.neg:C.warn) : '1px solid '+C.border;
                  return h('div',{key:cd.day,style:{padding:isMobile?3:6,borderRadius:6,background:bg,border:border}},
                    h('div',{style:{fontSize:isMobile?9:11,fontWeight:isToday?700:400}},cd.day),
                    hasTrades && h('div',{style:{fontSize:isMobile?7:8,color:cd.r>0?C.pos:C.neg,fontWeight:600}},cd.r>0?'+'+cd.r.toFixed(1):cd.r.toFixed(1))
                  );
                })
              )
            )
          ),

          // ROW 2: Advanced Metrics (6) + R Distribution + Streak Analysis
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1.5fr 1fr 1fr',gap:12,marginBottom:16}},
            // Advanced Metrics - 6 cards
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:14}},'üìà'),h('span',{style:{fontSize:13,fontWeight:600}},t.advanced)),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(3,1fr)',gap:8}},
                [['üìä',t.expectancy,expectancy.toFixed(2)+'R',expectancy>=0?C.pos:C.neg],
                 ['üìà',t.sharpeRatio,sharpe.toFixed(2),sharpe>=1?C.pos:sharpe>=0?C.warn:C.neg],
                 ['üìâ',t.sortinoRatio,sortino.toFixed(2),sortino>=1.5?C.pos:sortino>=0?C.warn:C.neg],
                 ['üí™',t.recoveryFactor,recovery.toFixed(2),recovery>=2?C.pos:C.warn],
                 ['üéØ',t.calmarRatio,calmar.toFixed(2),calmar>=1?C.pos:C.warn],
                 ['‚öñÔ∏è',t.avgRR,avgRRActual.toFixed(2)+':1',avgRRActual>=2?C.pos:C.warn]].map(function(item,i){
                  return h('div',{key:i,style:{background:C.bg,borderRadius:8,padding:10,textAlign:'center'}},
                    h('div',{style:{fontSize:12,marginBottom:4}},item[0]),
                    h('div',{style:{fontSize:9,color:C.textS,marginBottom:4}},item[1]),
                    h('div',{style:{fontSize:14,fontWeight:700,color:item[3]}},item[2])
                  );
                })
              )
            ),

            // R Distribution Histogram
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:14}},'üìä'),h('span',{style:{fontSize:13,fontWeight:600}},t.rDistribution)),
              h('div',{style:{display:'flex',alignItems:'flex-end',justifyContent:'space-around',height:80}},
                rValues.map(function(rv){
                  var count = rBuckets[rv] || 0;
                  var barHeight = maxBucket > 0 ? (count / maxBucket) * 100 : 0;
                  var barColor = rv < 0 ? C.neg : rv > 0 ? C.pos : C.warn;
                  return h('div',{key:rv,style:{display:'flex',flexDirection:'column',alignItems:'center',width:20}},
                    h('div',{style:{fontSize:8,color:C.textS,marginBottom:2}},count),
                    h('div',{style:{width:16,height:barHeight+'%',minHeight:count>0?4:0,background:barColor,borderRadius:2}}),
                    h('div',{style:{fontSize:8,color:C.textM,marginTop:4}},rv>0?'+'+rv:rv)
                  );
                })
              ),
              h('div',{style:{textAlign:'center',fontSize:9,color:C.textS,marginTop:8}},t.tradesAtR+' R')
            ),

            // Streak Analysis
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:14}},'üî•'),h('span',{style:{fontSize:13,fontWeight:600}},t.streakAnalysis)),
              h('div',{style:{display:'flex',flexDirection:'column',gap:10}},
                h('div',{style:{background:currentStreak>=0?C.posL:C.negL,padding:12,borderRadius:8,textAlign:'center'}},
                  h('div',{style:{fontSize:10,color:C.textS}},t.currentStreakLabel),
                  h('div',{style:{fontSize:24,fontWeight:800,color:currentStreak>=0?C.pos:C.neg}},(currentStreak>=0?'+':'')+currentStreak),
                  h('div',{style:{fontSize:10,color:C.textS}},currentStreak>=0?t.win+'s':t.loss)
                ),
                h('div',{style:{display:'flex',gap:8}},
                  h('div',{style:{flex:1,background:C.bg,padding:10,borderRadius:6,textAlign:'center'}},
                    h('div',{style:{fontSize:9,color:C.textS}},t.bestWinStreak),
                    h('div',{style:{fontSize:16,fontWeight:700,color:C.pos}},'+'+bestWinStreak)
                  ),
                  h('div',{style:{flex:1,background:C.bg,padding:10,borderRadius:6,textAlign:'center'}},
                    h('div',{style:{fontSize:9,color:C.textS}},t.bestLossStreak),
                    h('div',{style:{fontSize:16,fontWeight:700,color:C.neg}},'-'+worstLossStreak)
                  )
                )
              )
            )
          ),

          // ROW 3: Performance by Symbol + Auto Insights + Day of Week
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:12,marginBottom:16}},
            // Performance by Symbol - V10.9 uses Exchange data when available
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                h('span',{style:{fontSize:14}},'ü™ô'),
                h('span',{style:{fontSize:13,fontWeight:600}},t.perfBySymbol),
                market !== 'hip3' && accurateStats && accurateStats.by_coin && h('span',{style:{fontSize:9,color:'#A78BFA',marginLeft:4}},'üîó')
              ),
              h('div',{style:{display:'flex',flexDirection:'column',gap:8}},
                (market !== 'hip3' && accurateStats && accurateStats.by_coin ?
                  Object.keys(accurateStats.by_coin).sort(function(a,b){return (accurateStats.by_coin[b].net_pnl||0)-(accurateStats.by_coin[a].net_pnl||0);}).slice(0,5) :
                  Object.keys(symbolPerf).length > 0 ?
                    Object.keys(symbolPerf).sort(function(a,b){return (symbolPerf[b].r||0)-(symbolPerf[a].r||0);}).slice(0,7) :
                    (market === 'hip3' ? ['AAPL','TSLA','NVDA','AMD','AMZN','META','GOOGL'] : ['BTC','ETH','SOL','LINK','SEI','DOGE','SUI'])
                ).map(function(sym){
                  var hlData = market !== 'hip3' && accurateStats && accurateStats.by_coin && accurateStats.by_coin[sym];
                  var sp = hlData ? {
                    r: hlData.net_pnl || 0,
                    trades: hlData.fills || 0,
                    wr: (symbolPerf[sym] && symbolPerf[sym].wr) || 0
                  } : symbolPerf[sym];
                  // V2.0: sparkline equity curve per symbol
                  var sparkSvg = null;
                  if(equitySymData && equitySymData[sym] && equitySymData[sym].length >= 2){
                    var pts = equitySymData[sym];
                    var vals = pts.map(function(p){return p.cumR;});
                    var mn = Math.min.apply(null,vals); var mx = Math.max.apply(null,vals);
                    var range = mx-mn||1; var W=80; var H=24;
                    var path = vals.map(function(v,i){return (i===0?'M':'L')+(i/(vals.length-1)*W).toFixed(1)+','+(H-(v-mn)/range*H).toFixed(1);}).join(' ');
                    var lineColor = vals[vals.length-1]>=0?C.pos:C.neg;
                    sparkSvg = h('svg',{width:W,height:H,style:{flexShrink:0}},h('path',{d:path,fill:'none',stroke:lineColor,strokeWidth:1.5}));
                  }
                  return h('div',{key:sym,style:{display:'flex',alignItems:'center',gap:10,padding:10,background:hlData?'linear-gradient(135deg, '+C.bg+' 0%, rgba(139,92,246,0.08) 100%)':C.bg,borderRadius:8,border:hlData?'1px solid rgba(139,92,246,0.2)':'none'}},
                    cryptoLogo(sym, 32),
                    h('div',{style:{flex:1}},
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:11}},
                        h('span',{style:{fontWeight:600}},sym),
                        h('span',{style:{color:sp.r>=0?C.pos:C.neg,fontWeight:600}},hlData ? (sp.r>=0?'+':'')+('$'+sp.r.toFixed(2)) : fmtR(sp.r))
                      ),
                      h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:9,color:hlData?'#A78BFA':C.textS,marginTop:2}},
                        h('span',null,sp.trades+' '+(hlData?'fills':t.tradesCount.toLowerCase())),
                        h('span',null,sp.wr.toFixed(0)+'% '+t.wr)
                      )
                    ),
                    sparkSvg
                  );
                })
              )
            ),

            // Auto Insights
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:14}},'üí°'),h('span',{style:{fontSize:13,fontWeight:600}},t.autoInsights)),
              autoInsights.length === 0 
                ? h('div',{style:{textAlign:'center',padding:20,color:C.textS,fontSize:11}},t.noInsights)
                : h('div',{style:{display:'flex',flexDirection:'column',gap:6}},
                    autoInsights.slice(0,5).map(function(insight,i){
                      var bgColor = insight.type==='pos'?C.posL:insight.type==='neg'?C.negL:C.infoL;
                      var borderColor = insight.type==='pos'?C.pos:insight.type==='neg'?C.neg:C.info;
                      return h('div',{key:i,style:{display:'flex',alignItems:'center',gap:8,padding:8,background:bgColor,borderLeft:'3px solid '+borderColor,borderRadius:4,fontSize:10}},
                        h('span',null,insight.icon),
                        h('span',null,insight.text)
                      );
                    })
                  )
            ),

            // Day of Week Performance
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},h('span',{style:{fontSize:14}},'üìÖ'),h('span',{style:{fontSize:13,fontWeight:600}},t.perfComparison+' ('+t.week+')')),
              h('div',{style:{display:'flex',flexDirection:'column',gap:4}},
                dayStats.map(function(ds){
                  var isBest = bestDayData.day === ds.day && bestDayData.r > 0;
                  var isWorst = worstDayData.day === ds.day && worstDayData.r < 0;
                  var barWidth = ds.count > 0 ? Math.min(Math.abs(ds.r) * 20, 100) : 0;
                  return h('div',{key:ds.day,style:{display:'flex',alignItems:'center',gap:8,padding:6,background:isBest?C.posL:isWorst?C.negL:'transparent',borderRadius:4}},
                    h('div',{style:{width:30,fontSize:10,fontWeight:600}},ds.name),
                    h('div',{style:{flex:1,height:8,background:C.bg,borderRadius:4,overflow:'hidden'}},
                      ds.r !== 0 && h('div',{style:{width:barWidth+'%',height:'100%',background:ds.r>0?C.pos:C.neg,borderRadius:4}})
                    ),
                    h('div',{style:{width:45,textAlign:'right',fontSize:10,fontWeight:600,color:ds.r>0?C.pos:ds.r<0?C.neg:C.textS}},ds.r!==0?fmtR(ds.r):'--'),
                    h('div',{style:{width:20,textAlign:'right',fontSize:9,color:C.textS}},ds.count)
                  );
                })
              )
            )
          ),

          // üß¨ V6.0 - STRATEGY PERFORMANCE (Attribution)
          h('div',{style:Object.assign({},sec,{marginBottom:16})},
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{fontSize:16}},'üß¨'),
                h('span',{style:{fontSize:14,fontWeight:700}},t.strategyAttribution||'Strategy Attribution'),
                h('span',{style:{fontSize:10,padding:'3px 8px',background:C.liveL,borderRadius:6,color:C.live}},'LIVE')
              )
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(140px, 1fr))',gap:12}},
              [
                {key:'TIER_PREMIUM',icon:'‚≠ê',color:'#a855f7',bg:'#a855f720',label:'PREMIUM'},
                {key:'TIER_ADVANCED',icon:'üî∑',color:'#06b6d4',bg:'#06b6d420',label:'ADVANCED'},
                {key:'SIGNAL_TIER',icon:'üì°',color:'#f97316',bg:'#f9731620',label:'SIGNAL'},
                {key:'TIER_BASIC',icon:'üìä',color:'#6b7280',bg:'#6b728020',label:'BASIC'},
                {key:'UNKNOWN',icon:'‚ùì',color:'#4b5563',bg:'#4b556320',label:'OTHER'}
              ].map(function(strat) {
                var sp = strategyPerf[strat.key];
                if (sp.trades === 0) return null;
                return h('div',{key:strat.key,style:{background:strat.bg,border:'1px solid '+strat.color+'40',borderRadius:10,padding:14}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:8}},
                    h('span',{style:{fontSize:14}},strat.icon),
                    h('span',{style:{fontSize:12,fontWeight:700,color:strat.color}},strat.label)
                  ),
                  h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8}},
                    h('div',null,
                      h('div',{style:{fontSize:9,color:C.textS}},'Trades'),
                      h('div',{style:{fontSize:14,fontWeight:700}},sp.trades)
                    ),
                    h('div',null,
                      h('div',{style:{fontSize:9,color:C.textS}},'Win Rate'),
                      h('div',{style:{fontSize:14,fontWeight:700,color:sp.wr>=50?C.pos:C.neg}},sp.wr.toFixed(0)+'%')
                    ),
                    h('div',null,
                      h('div',{style:{fontSize:9,color:C.textS}},'Total R'),
                      h('div',{style:{fontSize:14,fontWeight:700,color:sp.r>=0?C.pos:C.neg}},fmtR(sp.r))
                    ),
                    h('div',null,
                      h('div',{style:{fontSize:9,color:C.textS}},'Avg R'),
                      h('div',{style:{fontSize:14,fontWeight:700,color:sp.avgR>=0?C.pos:C.neg}},sp.avgR.toFixed(2)+'R')
                    )
                  )
                );
              })
            )
          ),

          // ‚öñÔ∏è V6.0 - LONG vs SHORT Performance
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:12,marginBottom:16}},
            // Long vs Short Split
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                h('span',{style:{fontSize:14}},'‚öñÔ∏è'),
                h('span',{style:{fontSize:13,fontWeight:600}},t.longVsShort||'Long vs Short')
              ),
              // Visual Split Bar
              h('div',{style:{display:'flex',height:24,borderRadius:6,overflow:'hidden',marginBottom:12}},
                h('div',{style:{width:longPct+'%',background:C.pos,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:'#fff'}},
                  longPct > 20 ? 'üêÇ '+longPct.toFixed(0)+'%' : ''
                ),
                h('div',{style:{width:shortPct+'%',background:C.neg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:10,fontWeight:700,color:'#fff'}},
                  shortPct > 20 ? 'üêª '+shortPct.toFixed(0)+'%' : ''
                )
              ),
              // Stats comparison
              h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}},
                h('div',{style:{background:C.posL,padding:12,borderRadius:8,textAlign:'center'}},
                  h('div',{style:{fontSize:11,color:C.pos,fontWeight:600,marginBottom:4}},'üêÇ LONG'),
                  h('div',{style:{fontSize:18,fontWeight:700,color:longStats.r>=0?C.pos:C.neg}},fmtR(longStats.r)),
                  h('div',{style:{fontSize:10,color:C.textS}},longStats.trades+' trades | '+longStats.wr.toFixed(0)+'% WR')
                ),
                h('div',{style:{background:C.negL,padding:12,borderRadius:8,textAlign:'center'}},
                  h('div',{style:{fontSize:11,color:C.neg,fontWeight:600,marginBottom:4}},'üêª SHORT'),
                  h('div',{style:{fontSize:18,fontWeight:700,color:shortStats.r>=0?C.pos:C.neg}},fmtR(shortStats.r)),
                  h('div',{style:{fontSize:10,color:C.textS}},shortStats.trades+' trades | '+shortStats.wr.toFixed(0)+'% WR')
                )
              ),
              // Bias indicator
              totalTrades > 0 && h('div',{style:{marginTop:12,padding:8,background:C.bg,borderRadius:6,textAlign:'center',fontSize:11}},
                longStats.r > shortStats.r 
                  ? h('span',{style:{color:C.pos}},'üìä Long bias detected: Longs outperform by ',h('strong',null,fmtR(longStats.r - shortStats.r)))
                  : shortStats.r > longStats.r
                    ? h('span',{style:{color:C.neg}},'üìä Short bias detected: Shorts outperform by ',h('strong',null,fmtR(shortStats.r - longStats.r)))
                    : h('span',{style:{color:C.textS}},'üìä Balanced performance')
              )
            ),

            // üí∏ V10.9 - COST ANALYSIS with Exchange data
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                h('span',{style:{fontSize:14}},'üí∏'),
                h('span',{style:{fontSize:13,fontWeight:600}},t.analyticsCost||'Cost Analysis'),
                isHLCost && h('span',{style:{fontSize:9,color:'#A78BFA',marginLeft:4}},'üîó Exchange')
              ),
              // Waterfall: Gross ‚Üí Fees ‚Üí Net
              h('div',{style:{display:'flex',flexDirection:'column',gap:8,marginBottom:12}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:10,background:isHLCost?'linear-gradient(135deg, '+C.posL+' 0%, rgba(139,92,246,0.1) 100%)':C.posL,borderRadius:6,border:isHLCost?'1px solid rgba(139,92,246,0.2)':'none'}},
                  h('span',{style:{fontSize:11,color:C.pos}},t.grossProfit||'Gross Profit'),
                  h('span',{style:{fontSize:14,fontWeight:700,color:C.pos}},fmtPnl(totalGrossProfit))
                ),
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:10,background:isHLCost?'linear-gradient(135deg, '+C.warnL+' 0%, rgba(139,92,246,0.1) 100%)':C.warnL,borderRadius:6,border:isHLCost?'1px solid rgba(139,92,246,0.2)':'none'}},
                  h('span',{style:{fontSize:11,color:C.warn}},'‚àí Fees ('+feesRatio.toFixed(1)+'%)'),
                  h('span',{style:{fontSize:14,fontWeight:700,color:C.warn}},'-$'+totalFees.toFixed(2))
                ),
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:10,background:totalNetPnl>=0?C.posL:C.negL,borderRadius:6,border:'2px solid '+(totalNetPnl>=0?C.pos:C.neg)}},
                  h('span',{style:{fontSize:11,fontWeight:600,color:totalNetPnl>=0?C.pos:C.neg}},'= '+(t.netProfit||'Net Profit')),
                  h('span',{style:{fontSize:16,fontWeight:700,color:totalNetPnl>=0?C.pos:C.neg}},fmtPnl(totalNetPnl))
                )
              ),
              // Fees ratio indicator
              h('div',{style:{padding:10,background:C.bg,borderRadius:6}},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}},
                  h('span',{style:{fontSize:10,color:C.textS}},'Fees Impact'),
                  h('span',{style:{fontSize:11,fontWeight:600,color:feesRatio<5?C.pos:feesRatio<10?C.warn:C.neg}},feesRatio.toFixed(1)+'%')
                ),
                h('div',{style:{height:6,background:C.border,borderRadius:3,overflow:'hidden'}},
                  h('div',{style:{width:Math.min(feesRatio*5,100)+'%',height:'100%',background:feesRatio<5?C.pos:feesRatio<10?C.warn:C.neg,borderRadius:3}})
                ),
                h('div',{style:{marginTop:6,fontSize:9,color:C.textS,textAlign:'center'}},
                  feesRatio < 5 ? '‚úÖ Excellent - Fees < 5% of profits' :
                  feesRatio < 10 ? '‚ö†Ô∏è Moderate - Consider reducing frequency' :
                  'üö® High - Fees eating into profits'
                )
              )
            )
          ),

          // MILESTONES
          h('div',{style:sec},
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:16}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{fontSize:16}},'üèÖ'),
                h('span',{style:{fontSize:14,fontWeight:700}},t.milestones),
                h('span',{style:{fontSize:12,padding:'3px 8px',background:C.negL,borderRadius:6,color:C.live}},t.live+': '+fmtR(activeStats.totalR))
              ),
              h('span',{style:{fontSize:10,color:C.textS}},'‚ö° '+t.basedOnLive)
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(80px, 1fr))',gap:10}},
              milestones.map(function(m){
                var achieved = activeStats.totalR >= m;
                var progress = achieved ? 100 : Math.min((activeStats.totalR / m) * 100, 100);
                return h('div',{key:m,style:{background:achieved?C.posL:C.bg,border:'1px solid '+(achieved?C.pos:C.border),borderRadius:10,padding:12,textAlign:'center'}},
                  h('div',{style:{fontSize:16,fontWeight:700,color:achieved?C.pos:C.textS,marginBottom:6}},m+'R'),
                  h('div',{style:{height:4,background:C.border,borderRadius:2,overflow:'hidden',marginBottom:6}},
                    h('div',{style:{width:progress+'%',height:'100%',background:achieved?C.pos:C.accent,borderRadius:2}})
                  ),
                  achieved
                    ? h('button',{onClick:function(){var txt='üî± Milestone '+m+'R atteint! üéâ\n\n#TrinityBot';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{padding:'4px 8px',background:C.tw,border:'none',borderRadius:4,color:'#fff',fontSize:9,cursor:'pointer'}},'ùïè')
                    : h('span',{style:{fontSize:10,color:C.textS}},progress.toFixed(0)+'%')
                );
              })
            )
          ),

          // YEAR CARDS - LIVE + Backtest at bottom
          h('div',{style:Object.assign({},sec,{marginTop:16})},
            // Header with title and filter buttons
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:12,marginBottom:16}},
              h('div',null,
                h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:4}},
                  h('span',{style:{fontSize:16}},'üìä'),
                  h('span',{style:{fontSize:14,fontWeight:700}},t.perfLiveSimulation)
                ),
                h('div',{style:{fontSize:10,color:C.textS}},t.liveRealSince+(market==='hip3'?' 2026-02-10':' 2026-01-21')+' | v1.0 '+(market==='hip3'?'Stock':'Crypto')+' Backtest 2018-2026')
              ),
              h('div',{style:{display:'flex',gap:4,flexWrap:'wrap'}},
                h('button',{onClick:function(){setAnalyticsFilter('live');},style:{padding:'6px 12px',fontSize:10,fontWeight:600,background:analyticsFilter==='live'?C.live:'transparent',border:'1px solid '+(analyticsFilter==='live'?C.live:C.border),borderRadius:6,color:analyticsFilter==='live'?'#fff':C.textS,cursor:'pointer',display:'flex',alignItems:'center',gap:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:analyticsFilter==='live'?'#fff':C.live}}),t.live),
                h('button',{onClick:function(){setAnalyticsFilter('sim');},style:{padding:'6px 12px',fontSize:10,fontWeight:600,background:analyticsFilter==='sim'?C.accent:'transparent',border:'1px solid '+(analyticsFilter==='sim'?C.accent:C.border),borderRadius:6,color:analyticsFilter==='sim'?C.bg:C.textS,cursor:'pointer'}},'v1.0 '+(market==='hip3'?'Stock':'Crypto')+' 2018-2026'),
                years.map(function(y){
                  return h('button',{key:y,onClick:function(){setAnalyticsFilter(y);},style:{padding:'4px 8px',fontSize:9,background:analyticsFilter===y?C.info:'transparent',border:'1px solid '+(analyticsFilter===y?C.info:C.border),borderRadius:4,color:analyticsFilter===y?'#fff':C.textM,cursor:'pointer'}},y);
                })
              )
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(auto-fit, minmax(130px, 1fr))',gap:10}},
              // LIVE card ‚Äî prominent
              h('div',{style:{background:C.posL,border:'2px solid '+C.pos,borderRadius:10,padding:14,position:'relative'}},
                h('div',{style:{position:'absolute',top:8,right:8,fontSize:8,padding:'2px 6px',background:C.live,color:'#fff',borderRadius:4,display:'flex',alignItems:'center',gap:3}},h('span',{style:{width:5,height:5,borderRadius:'50%',background:'#fff',animation:'pulse 1s infinite'}}),t.live),
                h('div',{style:{fontSize:14,fontWeight:700,color:C.pos,marginBottom:10,marginTop:4}},t.since+(market==='hip3'?' 2026-02-10':' 2026-01-21')),
                h('div',{style:{display:'flex',flexDirection:'column',gap:4,fontSize:11}},
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},'PnL'),h('span',{style:{color:liveStats.roi>=0?C.pos:C.neg,fontWeight:600}},(liveStats.roi>=0?'+':'')+liveStats.roi.toFixed(1)+'%')),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.wr),h('span',{style:{fontWeight:600}},liveStats.wr.toFixed(1)+'%')),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.totalR),h('span',{style:{color:liveStats.totalR>=0?C.pos:C.neg,fontWeight:600}},fmtR(liveStats.totalR))),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.tradesCount),h('span',{style:{fontWeight:600}},liveStats.trades))
                )
              ),
              // Backtest Total card
              h('div',{style:{background:C.accentL,border:'2px solid '+C.accent,borderRadius:10,padding:14,position:'relative'}},
                h('div',{style:{position:'absolute',top:8,right:8,fontSize:8,padding:'2px 6px',background:C.accent,color:C.bg,borderRadius:4,fontWeight:600}},'v1.0'),
                h('div',{style:{fontSize:14,fontWeight:700,color:C.accent,marginBottom:10,marginTop:4}},'2018-2026'),
                h('div',{style:{display:'flex',flexDirection:'column',gap:4,fontSize:11}},
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},'PF'),h('span',{style:{color:C.pos,fontWeight:700}},btTotal.pf.toFixed(2))),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.wr),h('span',{style:{fontWeight:600}},btTotal.wr+'%')),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.totalR),h('span',{style:{color:C.pos,fontWeight:600}},'+'+btTotal.totalR.toFixed(0)+'R')),
                  h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.tradesCount),h('span',{style:{fontWeight:600}},btTotal.trades.toLocaleString()))
                )
              ),
              // Year cards
              years.slice().reverse().map(function(y){
                var d = backtest[y];
                var isSelected = analyticsFilter === y;
                var isPartial = y === 2026;
                var pfColor = d.pf >= 2.5 ? C.pos : d.pf >= 2.0 ? C.accent : C.warn;
                return h('div',{key:y,onClick:function(){setAnalyticsFilter(y);},style:{background:isSelected?C.infoL:C.bg,border:'1px solid '+(isSelected?C.info:C.border),borderRadius:10,padding:14,position:'relative',cursor:'pointer',opacity:analyticsFilter!=='live'&&analyticsFilter!=='sim'&&!isSelected?0.6:1}},
                  isPartial && h('div',{style:{position:'absolute',top:8,right:8,fontSize:7,padding:'2px 5px',background:C.warnL,color:C.warn,borderRadius:3}},'partial'),
                  h('div',{style:{fontSize:14,fontWeight:700,marginBottom:10,marginTop:4,color:isSelected?C.info:C.text}},y),
                  h('div',{style:{display:'flex',flexDirection:'column',gap:4,fontSize:11}},
                    h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},'PF'),h('span',{style:{color:pfColor,fontWeight:700}},d.pf.toFixed(2))),
                    h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.wr),h('span',{style:{fontWeight:600}},d.wr.toFixed(1)+'%')),
                    h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.totalR),h('span',{style:{color:C.pos,fontWeight:600}},'+'+d.totalR.toFixed(0)+'R')),
                    h('div',{style:{display:'flex',justifyContent:'space-between'}},h('span',{style:{color:C.textS}},t.tradesCount),h('span',{style:{fontWeight:600}},d.trades))
                  )
                );
              })
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // INSIGHTS TAB - Complete Implementation with improvements
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='insights' && (function(){
        // Section style
        var sec = {background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border};
        
        // All calculations from LIVE API data only (V2.0: market-aware)
        var liveTrades = activeClosed.filter(function(tr) { return tr.isLive; });
        
        // V7.1 FIX: Win/Loss bas√© sur PnL avec seuil $0.05 (m√™me logique que header)
        var STRICT_THRESHOLD = 0.05;
        var liveWins = liveTrades.filter(function(tr) { return (tr.pnl || 0) > STRICT_THRESHOLD; });
        var liveLosses = liveTrades.filter(function(tr) { return (tr.pnl || 0) < -STRICT_THRESHOLD; });
        var liveTotalR = liveTrades.reduce(function(sum, tr) { return sum + (tr.r || 0); }, 0);
        // V7.1 FIX: Win Rate excluant BE pour coh√©rence avec le header
        var liveTradesForWR = liveWins.length + liveLosses.length; // Exclut break-even
        var liveWR = liveTradesForWR > 0 ? (liveWins.length / liveTradesForWR * 100) : 0;
        
        // Milestones (always show)
        var milestoneTargets = [5, 10, 15, 20, 25, 30, 40, 50, 75, 100, 150, 200, 250, 500];
        
        // Waiting data placeholder
        var waitingCard = function(icon, title) {
          return h('div',{style:{background:C.bg,borderRadius:10,padding:20,textAlign:'center',opacity:0.6}},
            h('div',{style:{fontSize:24,marginBottom:8}},icon),
            h('div',{style:{fontSize:11,color:C.textS}},title),
            h('div',{style:{fontSize:13,fontWeight:600,color:C.textM,marginTop:4}},'--')
          );
        };
        
        // Empty state - show structure with waiting placeholders
        if (liveTrades.length === 0) {
          return h('div',{style:section},
            // LIVE Banner - Waiting
            h('div',{style:{background:C.warnL,borderRadius:12,padding:'12px 20px',marginBottom:20,display:'flex',alignItems:'center',justifyContent:'space-between',border:'1px solid '+C.warn}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{fontSize:16}},'‚è≥'),
                h('span',{style:{color:C.warn,fontWeight:600,fontSize:13}},t.noLiveTrades)
              ),
              h('div',{style:{fontSize:12,color:C.textS}},t.startTrading)
            ),
            
            // Alert - No trades
            h('div',{style:{background:C.bg,border:'1px solid '+C.border,borderRadius:10,padding:'10px 16px',display:'flex',alignItems:'center',gap:10,marginBottom:16}},
              h('span',{style:{fontSize:16}},'üì≠'),
              h('span',{style:{color:C.textS,fontWeight:600,fontSize:12}},t.alertNoTrades)
            ),
            
            // ROW 1: Best/Worst (empty) + Milestones (all 0%)
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1.5fr',gap:16,marginBottom:16}},
              // Best/Worst Card - Empty
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
                  h('span',{style:{fontSize:18}},'üèÜ'),
                  h('span',{style:{fontSize:15,fontWeight:700}},t.bestWorstLive)
                ),
                h('div',{style:{display:'flex',gap:12,marginBottom:12}},
                  h('div',{style:{flex:1,background:C.bg,borderRadius:10,padding:14,opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.bestDay),
                    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                      h('span',{style:{fontSize:20}},'üèÜ'),
                      h('span',{style:{fontSize:16,fontWeight:700,color:C.textM}},'--')
                    )
                  ),
                  h('div',{style:{flex:1,background:C.bg,borderRadius:10,padding:14,opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.worstDay),
                    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                      h('span',{style:{fontSize:20}},'üíÄ'),
                      h('span',{style:{fontSize:16,fontWeight:700,color:C.textM}},'--')
                    )
                  ),
                  h('div',{style:{flex:1,background:C.bg,borderRadius:10,padding:14,opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.bestHour),
                    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                      h('span',{style:{fontSize:20}},'üïê'),
                      h('span',{style:{fontSize:16,fontWeight:700,color:C.textM}},'--')
                    )
                  )
                ),
                h('div',{style:{background:C.bg,borderRadius:10,padding:14,maxWidth:140,opacity:0.5}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.worstHour),
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:20}},'üö´'),
                    h('span',{style:{fontSize:16,fontWeight:700,color:C.textM}},'--')
                  )
                )
              ),
              // Milestones Card - All at 0%
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:18}},'üéØ'),
                    h('span',{style:{fontSize:15,fontWeight:700}},t.milestones)
                  ),
                  h('div',{style:{fontSize:13,color:C.textS,fontWeight:700}},'LIVE: 0.0R')
                ),
                h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:10}},
                  milestoneTargets.map(function(target) {
                    return h('div',{key:target,style:{background:C.bg,borderRadius:8,padding:10,textAlign:'center',border:'1px solid '+C.border}},
                      h('div',{style:{fontSize:14,fontWeight:700,color:C.text}},target+'R'),
                      h('div',{style:{marginTop:4}},
                        h('div',{style:{width:'100%',height:3,background:C.border,borderRadius:2,overflow:'hidden'}},
                          h('div',{style:{width:'0%',height:'100%',background:C.pos}})
                        ),
                        h('div',{style:{fontSize:9,color:C.textS,marginTop:2}},'0%')
                      )
                    );
                  })
                )
              )
            ),
            
            // ROW 2: Advanced Insights (empty placeholders)
            h('div',{style:Object.assign({},sec,{padding:20,marginBottom:16})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
                h('span',{style:{fontSize:18}},'üí°'),
                h('span',{style:{fontSize:15,fontWeight:700}},t.advancedInsightsLive)
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:isMobile?8:12,marginBottom:12}},
                [['üìä',t.expectancy],['üìà',t.sharpeRatio],['üí∞',t.profitFactor],['üõ°Ô∏è',t.recoveryFactor],['‚öñÔ∏è',t.avgRR]].map(function(item,idx){
                  return h('div',{key:idx,style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',opacity:0.5,overflow:'hidden'}},
                    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},item[0]),h('span',{style:{fontSize:isMobile?8:10,color:C.textS,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},item[1])),
                    h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:C.textM}},'--')
                  );
                })
              ),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:isMobile?8:12}},
                [['üéØ',t.avgRPerTrade],['‚è±Ô∏è',t.avgDuration],['üìÖ',t.rPerWeek],['üî•',t.bestStreak],['üî•',t.currentSeries]].map(function(item,idx){
                  return h('div',{key:idx,style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',opacity:0.5,overflow:'hidden'}},
                    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},item[0]),h('span',{style:{fontSize:isMobile?8:10,color:C.textS,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},item[1])),
                    h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:C.textM}},'--')
                  );
                })
              )
            ),
            
            // ROW 3: Long vs Short + Weekly Progress (empty)
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},
              h('div',{style:Object.assign({},sec,{padding:isMobile?14:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:isMobile?12:16}},h('span',{style:{fontSize:isMobile?14:18}},'‚ÜïÔ∏è'),h('span',{style:{fontSize:isMobile?13:15,fontWeight:700}},t.longVsShort)),
                h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:isMobile?10:16}},
                  h('div',{style:{background:C.bg,borderRadius:12,padding:isMobile?12:16,textAlign:'center',opacity:0.5}},
                    h('div',{style:{fontSize:isMobile?10:12,fontWeight:600,color:C.textS,marginBottom:isMobile?4:8}},'üìà LONG'),
                    h('div',{style:{fontSize:isMobile?20:28,fontWeight:800,color:C.textM,marginBottom:4}},'--'),
                    h('div',{style:{fontSize:isMobile?9:11,color:C.textS}},'0 trades')
                  ),
                  h('div',{style:{background:C.bg,borderRadius:12,padding:isMobile?12:16,textAlign:'center',opacity:0.5}},
                    h('div',{style:{fontSize:isMobile?10:12,fontWeight:600,color:C.textS,marginBottom:isMobile?4:8}},'üìâ SHORT'),
                    h('div',{style:{fontSize:isMobile?20:28,fontWeight:800,color:C.textM,marginBottom:4}},'--'),
                    h('div',{style:{fontSize:isMobile?9:11,color:C.textS}},'0 trades')
                  )
                )
              ),
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üìä'),h('span',{style:{fontSize:15,fontWeight:700}},t.weeklyProgress)),
                h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:12}},
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center',opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.thisWeek),
                    h('div',{style:{fontSize:22,fontWeight:700,color:C.textM}},'--'),
                    h('div',{style:{fontSize:10,color:C.textS}},'0 trades')
                  ),
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center',opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.lastWeek),
                    h('div',{style:{fontSize:22,fontWeight:700,color:C.textM}},'--'),
                    h('div',{style:{fontSize:10,color:C.textS}},'0 trades')
                  ),
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center',opacity:0.5}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.vsLastWeek),
                    h('div',{style:{fontSize:22,fontWeight:700,color:C.textM}},'--'),
                    h('div',{style:{fontSize:10,color:C.textS}},'--')
                  )
                )
              )
            ),
            
            // ROW 4: Performance by On-Chain Regime
            h('div',{style:Object.assign({},sec,{padding:20,marginBottom:16})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:20}},h('span',{style:{fontSize:18}},'üìä'),h('span',{style:{fontSize:15,fontWeight:700}},t.perfByRegimeLive)),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:12}},
                OC_REGIMES.map(function(rg) {
                  var rgColor = ocRegimeColor(rg);
                  var rgBg = ocRegimeBg(rg);
                  var rgIcon = ocRegimeIcon(rg);
                  return h('div',{key:rg,style:{background:C.bg,borderRadius:12,padding:16,textAlign:'center',opacity:0.5}},
                    h('div',{style:{display:'inline-flex',alignItems:'center',gap:6,background:rgBg,padding:'5px 10px',borderRadius:20,marginBottom:12,opacity:0.6}},h('span',{style:{fontSize:12}},rgIcon),h('span',{style:{fontSize:10,fontWeight:700,color:rgColor}},ocRegimeLabel(rg))),
                    h('div',{style:{fontSize:28,fontWeight:800,color:C.textM,marginBottom:6}},'--'),
                    h('div',{style:{fontSize:11,color:C.textS}},'0 trades')
                  );
                })
              )
            ),
            
            // ROW 5: Symbol Insights (empty)
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:16}},
              h('div',{style:Object.assign({},sec,{padding:20,textAlign:'center'})},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üìà'),h('span',{style:{fontSize:15,fontWeight:700}},t.consistencyScore)),
                h('div',{style:{width:100,height:100,borderRadius:'50%',border:'8px solid '+C.border,display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px',opacity:0.5}},
                  h('div',null,h('div',{style:{fontSize:32,fontWeight:800,color:C.textM}},'--'),h('div',{style:{fontSize:12,color:C.textS}},'0%'))
                ),
                h('div',{style:{fontSize:12,color:C.textS}},'0/0 '+t.days)
              ),
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'‚ö†Ô∏è'),h('span',{style:{fontSize:15,fontWeight:700}},t.riskMetrics)),
                h('div',{style:{display:'flex',flexDirection:'column',gap:12}},
                  [t.maxConsecLosses,t.maxDrawdown,t.winRate+' LIVE'].map(function(label,idx){
                    return h('div',{key:idx,style:{background:C.bg,borderRadius:10,padding:14,display:'flex',justifyContent:'space-between',alignItems:'center',opacity:0.5}},
                      h('div',{style:{fontSize:10,color:C.textS}},label),
                      h('div',{style:{fontSize:24,fontWeight:800,color:C.textM}},'--')
                    );
                  })
                )
              ),
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'ü™ô'),h('span',{style:{fontSize:15,fontWeight:700}},t.symbolInsights)),
                h('div',{style:{display:'flex',flexDirection:'column',gap:10}},
                  (market === 'hip3' ? ['AAPL','TSLA','NVDA','AMD','AMZN','META','GOOGL','MSFT','PLTR','COIN','HOOD','MSTR'] : market === 'unified' ? ['BTC','ETH','SOL','AAPL','TSLA','NVDA'] : ['BTC','ETH','SOL','LINK','SEI','DOGE','SUI']).map(function(sym) {
                    return h('div',{key:sym,style:{background:C.bg,borderRadius:10,padding:12,display:'flex',alignItems:'center',gap:12,opacity:0.5}},
                      cryptoLogo(sym, 28),
                      h('div',{style:{flex:1}},
                        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},h('span',{style:{fontSize:13,fontWeight:600}},sym),h('span',{style:{fontSize:14,fontWeight:700,color:C.textM}},'--')),
                        h('div',{style:{fontSize:10,color:C.textS}},'0 trades')
                      )
                    );
                  })
                )
              )
            )
          );
        }
        
        // Day names
        var dayNamesFull = lang === 'fr' ? ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'] : ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        
        // Best/Worst Day calculation
        var dayPerf = [0,0,0,0,0,0,0];
        var dayCount = [0,0,0,0,0,0,0];
        liveTrades.forEach(function(tr) {
          var d = new Date(tr.exitTime || tr.entryTime).getDay();
          dayPerf[d] += tr.r || 0;
          dayCount[d]++;
        });
        var bestDayIdx = 0, worstDayIdx = 0;
        for (var di = 0; di < 7; di++) {
          if (dayPerf[di] > dayPerf[bestDayIdx]) bestDayIdx = di;
          if (dayPerf[di] < dayPerf[worstDayIdx]) worstDayIdx = di;
        }
        
        // Best/Worst Hour calculation
        var hourPerf = {};
        liveTrades.forEach(function(tr) {
          var hr = new Date(tr.entryTime).getHours();
          if (!hourPerf[hr]) hourPerf[hr] = 0;
          hourPerf[hr] += tr.r || 0;
        });
        var bestHourVal = -Infinity, worstHourVal = Infinity, bestHourNum = null, worstHourNum = null;
        Object.keys(hourPerf).forEach(function(hr) {
          if (hourPerf[hr] > bestHourVal) { bestHourVal = hourPerf[hr]; bestHourNum = parseInt(hr); }
          if (hourPerf[hr] < worstHourVal) { worstHourVal = hourPerf[hr]; worstHourNum = parseInt(hr); }
        });
        if (bestHourNum === null) bestHourNum = 0;
        if (worstHourNum === null) worstHourNum = 0;
        
        // Advanced metrics from LIVE data
        var avgWinR = liveWins.length > 0 ? liveWins.reduce(function(s,tr){return s+tr.r;},0) / liveWins.length : 0;
        var avgLossR = liveLosses.length > 0 ? Math.abs(liveLosses.reduce(function(s,tr){return s+tr.r;},0) / liveLosses.length) : 1;
        var liveExpectancy = liveTrades.length > 0 ? ((liveWR/100) * avgWinR) - ((1 - liveWR/100) * avgLossR) : 0;
        var liveAvgR = liveTrades.length > 0 ? liveTotalR / liveTrades.length : 0;
        
        // Profit Factor
        var grossProfit = liveWins.reduce(function(s,tr){return s+(tr.r||0);},0);
        var grossLoss = Math.abs(liveLosses.reduce(function(s,tr){return s+(tr.r||0);},0));
        var liveProfitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999 : 0;
        
        // Average Duration
        var totalDurationMs = 0, durationCount = 0;
        liveTrades.forEach(function(tr) {
          if (tr.exitTime && tr.entryTime) {
            totalDurationMs += new Date(tr.exitTime) - new Date(tr.entryTime);
            durationCount++;
          }
        });
        var avgDurationHours = durationCount > 0 ? (totalDurationMs / durationCount / 3600000) : 0;
        
        // Sharpe calculation
        var liveRs = liveTrades.map(function(tr) { return tr.r || 0; });
        var meanR = liveRs.length > 0 ? liveRs.reduce(function(a,b){return a+b;},0) / liveRs.length : 0;
        var variance = liveRs.length > 1 ? liveRs.reduce(function(sum, r) { return sum + Math.pow(r - meanR, 2); }, 0) / (liveRs.length - 1) : 0;
        var stdDev = Math.sqrt(variance);
        var liveSharpe = stdDev > 0 ? meanR / stdDev : 0;
        
        // Recovery Factor
        var liveRecovery = activeStats.maxDrawdown > 0 ? liveTotalR / activeStats.maxDrawdown : liveTotalR > 0 ? 999 : 0;
        
        // Avg R:R
        var liveAvgRR = avgLossR > 0 ? avgWinR / avgLossR : 0;
        
        // R per week (depuis le 21 janvier 2026)
        var liveStartDate = new Date('2026-01-21');
        var now = new Date();
        var weeksSinceLive = Math.max(1, (now - liveStartDate) / (7 * 24 * 60 * 60 * 1000));
        var rPerWeek = liveTotalR / weeksSinceLive;
        
        // Current streak & best streak from stats
        var currentStreak = activeStats.currentStreak || 0;
        var bestStreakVal = activeStats.bestStreak || 0;
        
        // Long vs Short performance
        var longTrades = liveTrades.filter(function(tr){return tr.side==='LONG';});
        var shortTrades = liveTrades.filter(function(tr){return tr.side==='SHORT';});
        var longWins = longTrades.filter(function(tr){return tr.r>0;});
        var shortWins = shortTrades.filter(function(tr){return tr.r>0;});
        var longR = longTrades.reduce(function(s,tr){return s+(tr.r||0);},0);
        var shortR = shortTrades.reduce(function(s,tr){return s+(tr.r||0);},0);
        var longWR = longTrades.length > 0 ? (longWins.length/longTrades.length*100) : 0;
        var shortWR = shortTrades.length > 0 ? (shortWins.length/shortTrades.length*100) : 0;
        
        // Weekly progress (this week vs last week)
        var thisWeekStart = new Date(); thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
        thisWeekStart.setHours(0,0,0,0);
        var lastWeekStart = new Date(thisWeekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
        var thisWeekTrades = liveTrades.filter(function(tr){return new Date(tr.exitTime||tr.entryTime) >= thisWeekStart;});
        var lastWeekTrades = liveTrades.filter(function(tr){var d=new Date(tr.exitTime||tr.entryTime); return d >= lastWeekStart && d < thisWeekStart;});
        var thisWeekR = thisWeekTrades.reduce(function(s,tr){return s+(tr.r||0);},0);
        var lastWeekR = lastWeekTrades.reduce(function(s,tr){return s+(tr.r||0);},0);
        var weeklyChange = thisWeekR - lastWeekR;
        
        // Smart Alerts
        var alerts = [];
        if (liveWR < 50 && liveTrades.length >= 5) alerts.push({type:'warning',icon:'‚ö†Ô∏è',text:t.alertLowWR+' ('+liveWR.toFixed(0)+'%)'});
        if (currentStreak <= -3) alerts.push({type:'danger',icon:'üî•',text:t.alertNegStreak+' ('+Math.abs(currentStreak)+' '+t.losses+')'});
        if (activeStats.maxDrawdown > settings.ddAlertThreshold) alerts.push({type:'danger',icon:'üìâ',text:t.alertHighDD+' ('+activeStats.maxDrawdown.toFixed(1)+'%)'});
        if (thisWeekTrades.length === 0) alerts.push({type:'info',icon:'üì≠',text:t.alertNoTrades});
        
        // V7.1 FIX: On-Chain Regime performance (uses global detectRegime)
        var regimePerf = {};
        OC_REGIMES.forEach(function(rg) {
          var rgTrades = liveTrades.filter(function(tr) { return detectRegime(tr) === rg; });
          var rgWins = rgTrades.filter(function(tr) { return tr.r > 0; });
          regimePerf[rg] = {
            trades: rgTrades.length,
            totalR: rgTrades.reduce(function(s,tr) { return s + (tr.r||0); }, 0),
            wr: rgTrades.length > 0 ? (rgWins.length / rgTrades.length * 100) : 0
          };
        });
        
        // Milestones (based on LIVE totalR)
        var milestoneTargets = [5, 10, 15, 20, 25, 30, 40, 50, 75, 100, 150, 200, 250, 500];
        
        return h('div',{style:section},
          // LIVE Banner
          h('div',{style:{background:C.posL,borderRadius:12,padding:'12px 20px',marginBottom:12,display:'flex',alignItems:'center',justifyContent:'space-between',border:'1px solid '+C.pos}},
            h('div',{style:{display:'flex',alignItems:'center',gap:10}},
              h('span',{style:{fontSize:16}},'‚ö°'),
              h('span',{style:{color:C.pos,fontWeight:600,fontSize:13}},t.basedOnLive)
            ),
            h('div',{style:{fontSize:12,color:C.textS}},liveTrades.length+' trades ‚Ä¢ '+fmtR(liveTotalR)+' total')
          ),
          
          // V7.0: COMPACT MILESTONE BAR (Next Goal Only)
          (function(){
            var nextTarget = milestoneTargets.find(function(m) { return liveTotalR < m; }) || milestoneTargets[milestoneTargets.length-1];
            var prevTarget = milestoneTargets.filter(function(m) { return liveTotalR >= m; }).pop() || 0;
            var progress = nextTarget > prevTarget ? ((liveTotalR - prevTarget) / (nextTarget - prevTarget)) * 100 : 100;
            var achieved = liveTotalR >= nextTarget;
            return h('div',{style:{background:C.card,borderRadius:10,padding:'10px 16px',marginBottom:12,display:'flex',alignItems:'center',gap:16,border:'1px solid '+C.border}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:14}},'üéØ'),
                h('span',{style:{fontSize:12,fontWeight:600,color:C.textS}},t.nextMilestone||'Next Goal')
              ),
              h('div',{style:{flex:1,display:'flex',alignItems:'center',gap:12}},
                h('div',{style:{flex:1,height:8,background:C.bg,borderRadius:4,overflow:'hidden'}},
                  h('div',{style:{width:Math.min(progress,100)+'%',height:'100%',background:achieved?C.pos:'linear-gradient(90deg,'+C.accent+','+C.pos+')',borderRadius:4,transition:'width .3s'}})
                ),
                h('span',{style:{fontSize:14,fontWeight:700,color:achieved?C.pos:C.accent,minWidth:50}},nextTarget+'R'),
                h('span',{style:{fontSize:11,color:C.textS,padding:'2px 8px',background:C.bg,borderRadius:4}},progress.toFixed(0)+'%')
              ),
              achieved && h('span',{style:{fontSize:14}},'‚úÖ')
            );
          })(),
          
          // Smart Alerts (if any)
          alerts.length > 0 && h('div',{style:{marginBottom:16,display:'flex',flexDirection:'column',gap:8}},
            alerts.map(function(alert,idx) {
              var bgCol = alert.type==='danger'?C.negL:alert.type==='warning'?C.warnL:C.bg;
              var borderCol = alert.type==='danger'?C.neg:alert.type==='warning'?C.warn:C.border;
              var textCol = alert.type==='danger'?C.neg:alert.type==='warning'?C.warn:C.textS;
              return h('div',{key:idx,style:{background:bgCol,border:'1px solid '+borderCol,borderRadius:10,padding:'10px 16px',display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{fontSize:16}},alert.icon),
                h('span',{style:{color:textCol,fontWeight:600,fontSize:12}},alert.text)
              );
            })
          ),
          
          // ROW 1: Best/Worst + DURATION vs PnL SCATTER PLOT (V7.0)
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1.5fr',gap:16,marginBottom:16}},
            // Best/Worst Card
            h('div',{style:Object.assign({},sec,{padding:20})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
                h('span',{style:{fontSize:18}},'üèÜ'),
                h('span',{style:{fontSize:15,fontWeight:700}},t.bestWorstLive)
              ),
              h('div',{style:{display:'flex',gap:12,marginBottom:12}},
                h('div',{style:{flex:1,background:C.posL,borderRadius:10,padding:14}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.bestDay),
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:20}},'üèÜ'),
                    h('span',{style:{fontSize:16,fontWeight:700,color:C.pos}},dayNamesFull[bestDayIdx])
                  )
                ),
                h('div',{style:{flex:1,background:C.negL,borderRadius:10,padding:14}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.worstDay),
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:20}},'üíÄ'),
                    h('span',{style:{fontSize:16,fontWeight:700,color:C.neg}},dayNamesFull[worstDayIdx])
                  )
                ),
                h('div',{style:{flex:1,background:C.posL,borderRadius:10,padding:14}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.bestHour),
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:20}},'üïê'),
                    h('span',{style:{fontSize:16,fontWeight:700,color:C.pos}},bestHourNum+':00')
                  )
                )
              ),
              h('div',{style:{background:C.negL,borderRadius:10,padding:14,maxWidth:140}},
                h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.worstHour),
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontSize:20}},'üö´'),
                  h('span',{style:{fontSize:16,fontWeight:700,color:C.neg}},worstHourNum+':00')
                )
              )
            ),
            // V7.0: DURATION vs PnL SCATTER PLOT
            (function(){
              // Calculate duration data for each trade
              var scatterData = liveTrades.filter(function(tr) {
                return tr.exitTime && tr.entryTime;
              }).map(function(tr) {
                var durationMs = new Date(tr.exitTime) - new Date(tr.entryTime);
                var durationHours = durationMs / 3600000;
                return { duration: durationHours, r: tr.r || 0, symbol: tr.symbol, isWin: (tr.r || 0) > 0 };
              });
              
              // Calculate stats
              var maxDuration = scatterData.length > 0 ? Math.max.apply(null, scatterData.map(function(d){return d.duration;})) : 24;
              var maxR = scatterData.length > 0 ? Math.max.apply(null, scatterData.map(function(d){return Math.abs(d.r);})) : 3;
              maxDuration = Math.max(maxDuration, 1);
              maxR = Math.max(maxR, 1);
              
              // Quick vs Long stats
              var quickTrades = scatterData.filter(function(d){return d.duration < 2;});
              var longDurationTrades = scatterData.filter(function(d){return d.duration >= 6;});
              var quickWinRate = quickTrades.length > 0 ? (quickTrades.filter(function(d){return d.isWin;}).length / quickTrades.length * 100) : 0;
              var longWinRate = longDurationTrades.length > 0 ? (longDurationTrades.filter(function(d){return d.isWin;}).length / longDurationTrades.length * 100) : 0;
              var quickAvgR = quickTrades.length > 0 ? quickTrades.reduce(function(s,d){return s+d.r;},0) / quickTrades.length : 0;
              var longAvgR = longDurationTrades.length > 0 ? longDurationTrades.reduce(function(s,d){return s+d.r;},0) / longDurationTrades.length : 0;
              
              var chartW = 320, chartH = 140;
              
              return h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:18}},'üìâ'),
                    h('span',{style:{fontSize:15,fontWeight:700}},t.durationVsPnl||'Duration vs PnL')
                  ),
                  h('div',{style:{display:'flex',gap:12,fontSize:10}},
                    h('span',{style:{display:'flex',alignItems:'center',gap:4}},h('span',{style:{width:8,height:8,borderRadius:'50%',background:C.pos}}),t.scatterWins||'Wins'),
                    h('span',{style:{display:'flex',alignItems:'center',gap:4}},h('span',{style:{width:8,height:8,borderRadius:'50%',background:C.neg}}),t.scatterLosses||'Losses')
                  )
                ),
                // Scatter Plot Area
                h('div',{style:{position:'relative',height:chartH+30,background:C.bg,borderRadius:10,padding:'10px 10px 20px 35px',overflow:'hidden'}},
                  // Y-axis labels
                  h('div',{style:{position:'absolute',left:0,top:10,bottom:20,width:30,display:'flex',flexDirection:'column',justifyContent:'space-between',alignItems:'flex-end',paddingRight:4}},
                    h('span',{style:{fontSize:9,color:C.textS}},'+'+maxR.toFixed(1)+'R'),
                    h('span',{style:{fontSize:9,color:C.warn,fontWeight:600}},'0R'),
                    h('span',{style:{fontSize:9,color:C.textS}},'-'+maxR.toFixed(1)+'R')
                  ),
                  // Zero line
                  h('div',{style:{position:'absolute',left:35,right:10,top:'50%',height:1,background:C.warn,opacity:0.5}}),
                  // Scatter points
                  scatterData.map(function(point, idx) {
                    var x = (point.duration / maxDuration) * (chartW - 20);
                    var y = chartH/2 - (point.r / maxR) * (chartH/2 - 10);
                    return h('div',{key:idx,title:point.symbol+': '+point.duration.toFixed(1)+'h ‚Üí '+point.r.toFixed(2)+'R',style:{
                      position:'absolute',
                      left: (35 + Math.min(x, chartW-20)) + 'px',
                      top: (10 + Math.max(5, Math.min(y, chartH-5))) + 'px',
                      width:10,height:10,
                      borderRadius:'50%',
                      background: point.isWin ? C.pos : C.neg,
                      opacity: 0.8,
                      border: '1px solid ' + (point.isWin ? '#166534' : '#991b1b'),
                      cursor:'pointer',
                      transition:'transform .15s',
                      transform:'translate(-50%,-50%)'
                    }});
                  }),
                  // X-axis labels
                  h('div',{style:{position:'absolute',left:35,right:10,bottom:0,height:20,display:'flex',justifyContent:'space-between',alignItems:'center'}},
                    h('span',{style:{fontSize:9,color:C.textS}},'0h'),
                    h('span',{style:{fontSize:9,color:C.textS}},(maxDuration/2).toFixed(0)+'h'),
                    h('span',{style:{fontSize:9,color:C.textS}},maxDuration.toFixed(0)+'h')
                  )
                ),
                // Quick Stats Row
                h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginTop:12}},
                  h('div',{style:{background:C.bg,borderRadius:8,padding:10,textAlign:'center'}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.quickWins||'Quick (<2h)'),
                    h('div',{style:{fontSize:14,fontWeight:700,color:quickAvgR>=0?C.pos:C.neg}},quickAvgR.toFixed(2)+'R'),
                    h('div',{style:{fontSize:9,color:C.textS}},quickTrades.length+' trades ‚Ä¢ '+quickWinRate.toFixed(0)+'% WR')
                  ),
                  h('div',{style:{background:C.bg,borderRadius:8,padding:10,textAlign:'center'}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.longWins||'Long (>6h)'),
                    h('div',{style:{fontSize:14,fontWeight:700,color:longAvgR>=0?C.pos:C.neg}},longAvgR.toFixed(2)+'R'),
                    h('div',{style:{fontSize:9,color:C.textS}},longDurationTrades.length+' trades ‚Ä¢ '+longWinRate.toFixed(0)+'% WR')
                  )
                )
              );
            })()
          ),
          
          // ROW 2: Advanced Insights (10 metrics)
          h('div',{style:Object.assign({},sec,{padding:20,marginBottom:16})},
            h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
              h('span',{style:{fontSize:18}},'üí°'),
              h('span',{style:{fontSize:15,fontWeight:700}},t.advancedInsightsLive)
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:isMobile?8:12,marginBottom:12}},
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üìä'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.expectancy)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveExpectancy>=0?C.pos:C.neg}},liveExpectancy.toFixed(2)+'R')
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üìà'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.sharpeRatio)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveSharpe>=1?C.pos:liveSharpe>=0?C.warn:C.neg}},liveSharpe.toFixed(2))
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üí∞'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.profitFactor)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveProfitFactor>=1.5?C.pos:liveProfitFactor>=1?C.warn:C.neg}},liveProfitFactor>=100?'‚àû':liveProfitFactor.toFixed(2))
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üõ°Ô∏è'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.recoveryFactor)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveRecovery>=2?C.pos:C.warn}},liveRecovery>=100?'‚àû':liveRecovery.toFixed(2))
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'‚öñÔ∏è'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.avgRR)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveAvgRR>=2?C.pos:C.warn}},liveAvgRR.toFixed(1))
              )
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:isMobile?8:12}},
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üéØ'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.avgRPerTrade)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:liveAvgR>=0?C.pos:C.neg}},liveAvgR.toFixed(2)+'R')
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'‚è±Ô∏è'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.avgDuration)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:C.text}},avgDurationHours>=1?(avgDurationHours.toFixed(1)+'h'):(Math.round(avgDurationHours*60)+'m'))
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üìÖ'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.rPerWeek)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:rPerWeek>=0?C.pos:C.neg}},rPerWeek.toFixed(1)+'R')
              ),
              h('div',{style:{background:C.bg,borderRadius:10,padding:isMobile?10:14,textAlign:'center',overflow:'hidden'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:4,marginBottom:isMobile?4:8}},h('span',{style:{fontSize:isMobile?12:14}},'üî•'),h('span',{style:{fontSize:isMobile?8:10,color:C.textS}},t.bestStreak)),
                h('div',{style:{fontSize:isMobile?14:18,fontWeight:700,color:C.pos}},bestStreakVal+' '+t.wins)
              ),
              h('div',{style:{background:currentStreak>=3?C.posL:currentStreak<=-2?C.negL:C.bg,borderRadius:10,padding:14,textAlign:'center',border:currentStreak>=3?'1px solid '+C.pos:currentStreak<=-2?'1px solid '+C.neg:'none'}},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:6,marginBottom:8}},h('span',{style:{fontSize:14}},currentStreak>=0?'üî•':'‚ùÑÔ∏è'),h('span',{style:{fontSize:10,color:C.textS}},t.currentSeries)),
                h('div',{style:{fontSize:18,fontWeight:700,color:currentStreak>=0?C.pos:C.neg}},Math.abs(currentStreak)+' '+(currentStreak>=0?t.wins:t.losses))
              )
            )
          ),
          
          // ROW 3: Long vs Short + Weekly Progress
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},
            h('div',{style:Object.assign({},sec,{padding:20})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'‚ÜïÔ∏è'),h('span',{style:{fontSize:15,fontWeight:700}},t.longVsShort)),
              h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}},
                h('div',{style:{background:C.posL,borderRadius:12,padding:16,textAlign:'center',border:'1px solid '+C.pos+'40'}},
                  h('div',{style:{fontSize:12,fontWeight:600,color:C.pos,marginBottom:8}},'üìà LONG'),
                  h('div',{style:{fontSize:28,fontWeight:800,color:longR>=0?C.pos:C.neg,marginBottom:4}},fmtR(longR)),
                  h('div',{style:{fontSize:11,color:C.textS}},longTrades.length+' trades ‚Ä¢ '+longWR.toFixed(0)+'% WR')
                ),
                h('div',{style:{background:C.negL,borderRadius:12,padding:16,textAlign:'center',border:'1px solid '+C.neg+'40'}},
                  h('div',{style:{fontSize:12,fontWeight:600,color:C.neg,marginBottom:8}},'üìâ SHORT'),
                  h('div',{style:{fontSize:28,fontWeight:800,color:shortR>=0?C.pos:C.neg,marginBottom:4}},fmtR(shortR)),
                  h('div',{style:{fontSize:11,color:C.textS}},shortTrades.length+' trades ‚Ä¢ '+shortWR.toFixed(0)+'% WR')
                )
              )
            ),
            h('div',{style:Object.assign({},sec,{padding:20})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üìä'),h('span',{style:{fontSize:15,fontWeight:700}},t.weeklyProgress)),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:12}},
                h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.thisWeek),
                  h('div',{style:{fontSize:22,fontWeight:700,color:thisWeekR>=0?C.pos:C.neg}},fmtR(thisWeekR)),
                  h('div',{style:{fontSize:10,color:C.textS}},thisWeekTrades.length+' trades')
                ),
                h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.lastWeek),
                  h('div',{style:{fontSize:22,fontWeight:700,color:lastWeekR>=0?C.pos:C.neg}},fmtR(lastWeekR)),
                  h('div',{style:{fontSize:10,color:C.textS}},lastWeekTrades.length+' trades')
                ),
                h('div',{style:{background:weeklyChange>=0?C.posL:C.negL,borderRadius:10,padding:14,textAlign:'center',border:'1px solid '+(weeklyChange>=0?C.pos:C.neg)+'40'}},
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.vsLastWeek),
                  h('div',{style:{fontSize:22,fontWeight:700,color:weeklyChange>=0?C.pos:C.neg}},(weeklyChange>=0?'+':'')+weeklyChange.toFixed(1)+'R'),
                  h('div',{style:{fontSize:10,color:weeklyChange>=0?C.pos:C.neg}},weeklyChange>=0?'‚Üë '+t.improvement:'‚Üì '+t.decline)
                )
              )
            )
          ),
          
          // ROW 4: Performance by On-Chain Regime
          h('div',{style:Object.assign({},sec,{padding:20,marginBottom:16})},
            h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:20}},h('span',{style:{fontSize:18}},'üìä'),h('span',{style:{fontSize:15,fontWeight:700}},t.perfByRegimeLive)),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(5,1fr)',gap:12}},
              OC_REGIMES.map(function(rg) {
                var rp = regimePerf[rg] || {trades:0,totalR:0,wr:0};
                var rgColor = ocRegimeColor(rg);
                var rgBg = ocRegimeBg(rg);
                var rgIcon = ocRegimeIcon(rg);
                return h('div',{key:rg,style:{background:C.bg,borderRadius:12,padding:16,textAlign:'center'}},
                  h('div',{style:{display:'inline-flex',alignItems:'center',gap:6,background:rgBg,padding:'5px 10px',borderRadius:20,marginBottom:12}},h('span',{style:{fontSize:12}},rgIcon),h('span',{style:{fontSize:10,fontWeight:700,color:rgColor}},ocRegimeLabel(rg))),
                  h('div',{style:{fontSize:28,fontWeight:800,color:rp.totalR>=0?C.pos:C.neg,marginBottom:6}},fmtR(rp.totalR)),
                  h('div',{style:{fontSize:11,color:C.textS}},rp.trades+' trades ‚Ä¢ '+rp.wr.toFixed(0)+'% WR')
                );
              })
            )
          ),
          
          // ROW 5: Hourly Heatmap + Top Trades
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1.5fr 1fr',gap:16,marginBottom:16}},
            h('div',{style:Object.assign({},sec,{padding:20})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üïê'),h('span',{style:{fontSize:15,fontWeight:700}},t.hourlyHeatmap)),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(6,1fr)':'repeat(12,1fr)',gap:4}},
                Array.from({length:24},function(_,hr){
                  var hrR = hourPerf[hr] || 0;
                  var hrCount = liveTrades.filter(function(tr){return new Date(tr.entryTime).getHours()===hr;}).length;
                  var hourVals = Object.values(hourPerf);
                  var maxR = hourVals.length > 0 ? Math.max.apply(null, hourVals.map(function(v){return Math.abs(v);})) : 1;
                  var intensity = maxR > 0 ? Math.min(1, Math.abs(hrR) / maxR) : 0;
                  var bgColor = hrCount === 0 ? C.bg : hrR > 0 ? 'rgba(16,185,129,'+(0.2+intensity*0.6)+')' : hrR < 0 ? 'rgba(239,68,68,'+(0.2+intensity*0.6)+')' : C.warnL;
                  var isBest = hr === bestHourNum && hrR > 0;
                  var isWorst = hr === worstHourNum && hrR < 0;
                  return h('div',{key:hr,title:hr+':00 - '+fmtR(hrR)+' ('+hrCount+' trades)',style:{background:bgColor,borderRadius:6,padding:8,textAlign:'center',border:isBest?'2px solid '+C.pos:isWorst?'2px solid '+C.neg:'none'}},
                    h('div',{style:{fontSize:10,color:C.textS,marginBottom:2}},hr+'h'),
                    h('div',{style:{fontSize:12,fontWeight:600,color:hrR>=0?C.pos:C.neg}},hrR!==0?fmtR(hrR):'-')
                  );
                })
              )
            ),
            h('div',{style:Object.assign({},sec,{padding:20})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üèÜ'),h('span',{style:{fontSize:15,fontWeight:700}},t.topTrades)),
              h('div',{style:{marginBottom:16}},
                h('div',{style:{fontSize:11,color:C.pos,fontWeight:600,marginBottom:8}},t.top3Best),
                liveTrades.slice().sort(function(a,b){return b.r-a.r;}).slice(0,3).map(function(tr,idx){
                  return h('div',{key:idx,style:{display:'flex',alignItems:'center',gap:10,padding:8,background:C.posL,borderRadius:8,marginBottom:6,border:'1px solid '+C.pos+'40'}},
                    h('div',{style:{fontSize:14,fontWeight:700,color:C.pos}},'#'+(idx+1)),
                    cryptoLogo(tr.symbol, 24),
                    h('div',{style:{flex:1}},h('div',{style:{fontSize:12,fontWeight:600}},tr.symbol+' '+tr.side),h('div',{style:{fontSize:10,color:C.textS}},new Date(tr.exitTime||tr.entryTime).toLocaleDateString())),
                    h('div',{style:{fontSize:16,fontWeight:700,color:C.pos}},fmtR(tr.r))
                  );
                })
              ),
              h('div',null,
                h('div',{style:{fontSize:11,color:C.neg,fontWeight:600,marginBottom:8}},t.top3Worst),
                liveTrades.slice().sort(function(a,b){return a.r-b.r;}).slice(0,3).map(function(tr,idx){
                  return h('div',{key:idx,style:{display:'flex',alignItems:'center',gap:10,padding:8,background:C.negL,borderRadius:8,marginBottom:6,border:'1px solid '+C.neg+'40'}},
                    h('div',{style:{fontSize:14,fontWeight:700,color:C.neg}},'#'+(idx+1)),
                    cryptoLogo(tr.symbol, 24),
                    h('div',{style:{flex:1}},h('div',{style:{fontSize:12,fontWeight:600}},tr.symbol+' '+tr.side),h('div',{style:{fontSize:10,color:C.textS}},new Date(tr.exitTime||tr.entryTime).toLocaleDateString())),
                    h('div',{style:{fontSize:16,fontWeight:700,color:C.neg}},fmtR(tr.r))
                  );
                })
              )
            )
          ),
          
          // ROW 6: Consistency + Risk + Symbol
          (function(){
            var positiveDays = 0, totalDays = 0;
            var dailyR = {};
            liveTrades.forEach(function(tr) { var day = (tr.exitTime || tr.entryTime).split('T')[0]; if (!dailyR[day]) dailyR[day] = 0; dailyR[day] += tr.r || 0; });
            Object.keys(dailyR).forEach(function(day) { totalDays++; if (dailyR[day] > 0) positiveDays++; });
            var consistencyPct = totalDays > 0 ? (positiveDays / totalDays * 100) : 0;
            var consistencyGrade = consistencyPct >= 70 ? 'A' : consistencyPct >= 60 ? 'B' : consistencyPct >= 50 ? 'C' : consistencyPct >= 40 ? 'D' : 'F';
            var consistencyColor = consistencyPct >= 60 ? C.pos : consistencyPct >= 40 ? C.warn : C.neg;
            var maxConsecLoss = 0, currentConsec = 0;
            liveTrades.forEach(function(tr) { if (tr.r < 0) { currentConsec++; maxConsecLoss = Math.max(maxConsecLoss, currentConsec); } else currentConsec = 0; });
            var symbolPerfData = {};
            var insightSymbols = liveTrades.reduce(function(acc, tr) { if (tr.symbol && acc.indexOf(tr.symbol) === -1) acc.push(tr.symbol); return acc; }, []);
            insightSymbols.forEach(function(sym) { var symTrades = liveTrades.filter(function(tr){return tr.symbol===sym;}); var symWins = symTrades.filter(function(tr){return tr.r>0;}); symbolPerfData[sym] = { trades: symTrades.length, totalR: symTrades.reduce(function(s,tr){return s+(tr.r||0);},0), wr: symTrades.length > 0 ? (symWins.length/symTrades.length*100) : 0 }; });
            var bestSymbol = insightSymbols.length > 0 ? insightSymbols.reduce(function(best,sym){ return symbolPerfData[sym].totalR > symbolPerfData[best].totalR ? sym : best; }, insightSymbols[0]) : '';
            return h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:16,marginBottom:16}},
              h('div',{style:Object.assign({},sec,{padding:20,textAlign:'center'})},
                h('div',{style:{display:'flex',alignItems:'center',justifyContent:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üìà'),h('span',{style:{fontSize:15,fontWeight:700}},t.consistencyScore)),
                h('div',{style:{width:100,height:100,borderRadius:'50%',border:'8px solid '+consistencyColor,display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 16px'}},
                  h('div',null,h('div',{style:{fontSize:32,fontWeight:800,color:consistencyColor}},consistencyGrade),h('div',{style:{fontSize:12,color:C.textS}},consistencyPct.toFixed(0)+'%'))
                ),
                h('div',{style:{fontSize:12,color:C.textS}},positiveDays+'/'+totalDays+' '+t.days+' '+t.win)
              ),
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'‚ö†Ô∏è'),h('span',{style:{fontSize:15,fontWeight:700}},t.riskMetrics)),
                h('div',{style:{display:'flex',flexDirection:'column',gap:12}},
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,display:'flex',justifyContent:'space-between',alignItems:'center'}},h('div',null,h('div',{style:{fontSize:10,color:C.textS}},t.maxConsecLosses)),h('div',{style:{fontSize:24,fontWeight:800,color:maxConsecLoss>=3?C.neg:C.warn}},maxConsecLoss)),
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,display:'flex',justifyContent:'space-between',alignItems:'center'}},h('div',null,h('div',{style:{fontSize:10,color:C.textS}},t.maxDrawdown)),h('div',{style:{fontSize:24,fontWeight:800,color:C.neg}},'-'+activeStats.maxDrawdown.toFixed(1)+'%')),
                  h('div',{style:{background:C.bg,borderRadius:10,padding:14,display:'flex',justifyContent:'space-between',alignItems:'center'}},h('div',null,h('div',{style:{fontSize:10,color:C.textS}},t.winRate+' LIVE')),h('div',{style:{fontSize:24,fontWeight:800,color:liveWR>=50?C.pos:C.neg}},liveWR.toFixed(0)+'%'))
                )
              ),
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'ü™ô'),h('span',{style:{fontSize:15,fontWeight:700}},t.symbolInsights)),
                h('div',{style:{display:'flex',flexDirection:'column',gap:10}},
                  insightSymbols.map(function(sym) {
                    var sp = symbolPerfData[sym]; var isBest = sym === bestSymbol && sp.trades > 0;
                    return h('div',{key:sym,style:{background:isBest?C.posL:C.bg,borderRadius:10,padding:12,display:'flex',alignItems:'center',gap:12,border:isBest?'1px solid '+C.pos:'none'}},
                      cryptoLogo(sym, 28),
                      h('div',{style:{flex:1}},h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},h('span',{style:{fontSize:13,fontWeight:600}},sym),h('span',{style:{fontSize:14,fontWeight:700,color:sp.totalR>=0?C.pos:C.neg}},fmtR(sp.totalR))),h('div',{style:{fontSize:10,color:C.textS}},sp.trades+' trades ‚Ä¢ '+sp.wr.toFixed(0)+'% WR')),
                      isBest && h('span',{style:{fontSize:12,background:C.pos,color:'#fff',padding:'2px 8px',borderRadius:10,fontWeight:600}},'BEST')
                    );
                  })
                )
              )
            );
          })(),
          
          // ROW 7: Session + Score Distribution
          (function(){
            var sessionPerf = {asia:{r:0,count:0,wins:0},eu:{r:0,count:0,wins:0},us:{r:0,count:0,wins:0}};
            liveTrades.forEach(function(tr) { var hr = new Date(tr.entryTime).getUTCHours(); var session = hr < 8 ? 'asia' : hr < 16 ? 'eu' : 'us'; sessionPerf[session].r += tr.r || 0; sessionPerf[session].count++; if (tr.r > 0) sessionPerf[session].wins++; });
            
            // V7.0: IMPROVED SCORE DISTRIBUTION - More granular ranges
            var scoreRanges = [
              {range:'0-5',min:0,max:5,count:0,color:'#ef4444'},
              {range:'6-10',min:6,max:10,count:0,color:'#f97316'},
              {range:'11-14',min:11,max:14,count:0,color:'#eab308'},
              {range:'15-17',min:15,max:17,count:0,color:'#84cc16'},
              {range:'18-20',min:18,max:20,count:0,color:'#22c55e'},
              {range:'21-22',min:21,max:22,count:0,color:'#10b981'}
            ];
            var totalScore = 0, scoreCount = 0;
            liveTrades.forEach(function(tr) { 
              var sc = tr.score || 0; 
              totalScore += sc; 
              scoreCount++; 
              scoreRanges.forEach(function(r) {
                if (sc >= r.min && sc <= r.max) r.count++;
              });
            });
            var avgScoreVal = scoreCount > 0 ? totalScore / scoreCount : 0;
            var maxScoreVal = liveTrades.length > 0 ? Math.max.apply(null, liveTrades.map(function(tr){return tr.score||0;})) : 0;
            var minScoreVal = liveTrades.length > 0 ? Math.min.apply(null, liveTrades.map(function(tr){return tr.score||0;})) : 0;
            var maxCount = Math.max.apply(null, scoreRanges.map(function(r){return r.count;})) || 1;
            
            return h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1.5fr',gap:16}},
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},h('span',{style:{fontSize:18}},'üåç'),h('span',{style:{fontSize:15,fontWeight:700}},t.sessionPerf)),
                h('div',{style:{display:'flex',flexDirection:'column',gap:12}},
                  [['asia',t.asiaSession,'üåè','0-8h UTC'],['eu',t.euSession,'üåç','8-16h UTC'],['us',t.usSession,'üåé','16-24h UTC']].map(function(item) {
                    var key = item[0], label = item[1], icon = item[2], hours = item[3];
                    var sp = sessionPerf[key]; var wr = sp.count > 0 ? (sp.wins / sp.count * 100) : 0;
                    return h('div',{key:key,style:{background:C.bg,borderRadius:10,padding:14,display:'flex',alignItems:'center',gap:12}},
                      h('span',{style:{fontSize:24}},icon),
                      h('div',{style:{flex:1}},h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},h('span',{style:{fontSize:13,fontWeight:600}},label),h('span',{style:{fontSize:16,fontWeight:700,color:sp.r>=0?C.pos:C.neg}},fmtR(sp.r))),h('div',{style:{fontSize:10,color:C.textS}},hours+' ‚Ä¢ '+sp.count+' trades ‚Ä¢ '+wr.toFixed(0)+'% WR'))
                    );
                  })
                )
              ),
              // V7.0: IMPROVED SCORE DISTRIBUTION HISTOGRAM
              h('div',{style:Object.assign({},sec,{padding:20})},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:8}},h('span',{style:{fontSize:18}},'üéØ'),h('span',{style:{fontSize:15,fontWeight:700}},t.scoreDistribution)),
                  h('div',{style:{display:'flex',gap:12,fontSize:10}},
                    h('span',{style:{padding:'2px 8px',background:C.bg,borderRadius:4,color:C.textS}},'Avg: ',h('strong',{style:{color:C.accent}},avgScoreVal.toFixed(1))),
                    h('span',{style:{padding:'2px 8px',background:C.posL,borderRadius:4,color:C.pos}},'Max: '+maxScoreVal),
                    h('span',{style:{padding:'2px 8px',background:C.negL,borderRadius:4,color:C.neg}},'Min: '+minScoreVal)
                  )
                ),
                // Histogram bars with gradient
                h('div',{style:{position:'relative',height:130,background:C.bg,borderRadius:10,padding:'10px 10px 25px 10px',display:'flex',alignItems:'flex-end',gap:6}},
                  // Y-axis grid lines
                  [0.25,0.5,0.75,1].map(function(pct,i) {
                    return h('div',{key:i,style:{position:'absolute',left:10,right:10,bottom:(25 + pct*90)+'px',height:1,background:C.border,opacity:0.3}});
                  }),
                  // Bars
                  scoreRanges.map(function(r,idx) {
                    var barH = maxCount > 0 ? (r.count / maxCount) * 90 : 0;
                    var hasData = r.count > 0;
                    return h('div',{key:r.range,style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',position:'relative',zIndex:1}},
                      // Count label on top of bar
                      hasData && h('div',{style:{fontSize:10,fontWeight:700,color:r.color,marginBottom:2}},r.count),
                      // Bar
                      h('div',{style:{
                        width:'100%',
                        height: barH + 'px',
                        minHeight: hasData ? 8 : 0,
                        background: hasData ? 'linear-gradient(180deg, '+r.color+' 0%, '+r.color+'80 100%)' : 'transparent',
                        borderRadius:'4px 4px 0 0',
                        boxShadow: hasData ? '0 2px 8px '+r.color+'40' : 'none',
                        transition: 'height .3s ease'
                      }}),
                      // X-axis label
                      h('div',{style:{position:'absolute',bottom:-20,fontSize:9,color:C.textS,fontWeight:500}},r.range)
                    );
                  })
                ),
                // Legend
                h('div',{style:{display:'flex',justifyContent:'center',gap:4,marginTop:12}},
                  h('span',{style:{fontSize:9,color:C.neg}},'‚Üê Low Score'),
                  h('div',{style:{flex:1,height:4,borderRadius:2,background:'linear-gradient(90deg, #ef4444, #f97316, #eab308, #84cc16, #22c55e, #10b981)'}}),
                  h('span',{style:{fontSize:9,color:C.pos}},'High Score ‚Üí')
                ),
                h('div',{style:{textAlign:'center',marginTop:6,fontSize:10,color:C.textS}},t.trinityScore+' (0-100 pts)')
              )
            );
          })()
        );
      })(),


      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ACHIEVEMENTS TAB - ZONE 3: Visual Render (uses achievementsData from Zone 2)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='achievements' && (function(){
        var sec = {background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border};
        var rarityColors = {
          common: {bg:'#22c55e20',border:'#22c55e',text:'#22c55e'},
          rare: {bg:'#3b82f620',border:'#3b82f6',text:'#3b82f6'},
          epic: {bg:'#a855f720',border:'#a855f7',text:'#a855f7'},
          legendary: {bg:'#f9731620',border:'#f97316',text:'#f97316'},
          mythic: {bg:'#ef444420',border:'#ef4444',text:'#ef4444'}
        };
        var catNames = {streaks:t.streaksCategory||'Streaks',milestones:t.milestonesCategory||'Milestones',volume:t.volumeCategory||'Volume',performance:t.performanceCategory||'Performance',time:t.timeCategory||'Time',symbol:t.symbolCategory||'Symbols',special:t.specialCategory||'Special'};
        var catIcons = {streaks:'üî•',milestones:'üéØ',volume:'üìà',performance:'üí™',time:'‚è∞',symbol:'ü™ô',special:'‚ú®'};
        
        // Extract from achievementsData (computed in useMemo at top of App)
        var achievements = achievementsData.achievements;
        var unlockedAchievements = achievementsData.unlocked;
        var lockedAchievements = achievementsData.locked;
        var totalPoints = achievementsData.totalPoints;
        var currentLevel = achievementsData.currentLevel;
        var nextLevel = achievementsData.nextLevel;
        var levelProgress = achievementsData.levelProgress;
        var liveTrades = achievementsData.liveTrades;
        var liveTotalR = achievementsData.liveTotalR;
        
        // Lazy rendering
        var LOCKED_PREVIEW_COUNT = 12;
        var visibleLocked = showAllAchievements ? lockedAchievements : lockedAchievements.slice(0, LOCKED_PREVIEW_COUNT);
        var hiddenCount = lockedAchievements.length - LOCKED_PREVIEW_COUNT;
        
        var shareAchievement = function(ach) {
          var text = 'üèÜ Achievement Unlocked: ' + ach.icon + ' ' + ach.name + '!\nüìä Trinity Bot LIVE\n‚úÖ ' + ach.desc + '\nüíé ' + ach.points + ' pts\n\n#TrinityBot #Trading';
          window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
        };
        var shareAllAchievements = function() {
          var text = 'üèÜ Trinity Bot Achievements\n\n‚úÖ ' + unlockedAchievements.length + '/' + achievements.length + ' unlocked\nüíé ' + totalPoints + ' points\nüìä ' + liveTrades.length + ' LIVE trades\nüí∞ ' + liveTotalR.toFixed(1) + 'R\n\n#TrinityBot #Crypto';
          window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(text), '_blank');
        };
        
        var renderAchievement = function(ach, isLocked) {
          var rc = rarityColors[ach.rarity] || rarityColors.common;
          return h('div',{key:ach.id,style:{background:isLocked?C.bg:rc.bg,borderRadius:12,padding:14,border:'1px solid '+(isLocked?C.border:rc.border),opacity:isLocked?0.6:1,position:'relative'}},
            h('div',{style:{position:'absolute',top:6,right:6,fontSize:8,fontWeight:700,color:rc.text,background:rc.bg,padding:'2px 6px',borderRadius:8,border:'1px solid '+rc.border,textTransform:'uppercase'}},(ach.rarity||'common').slice(0,3)),
            h('div',{style:{fontSize:32,textAlign:'center',marginBottom:6,filter:isLocked?'grayscale(1)':'none'}},ach.icon),
            h('div',{style:{fontSize:13,fontWeight:700,textAlign:'center',marginBottom:2,color:isLocked?C.textS:C.text}},ach.name),
            h('div',{style:{fontSize:9,color:C.textS,textAlign:'center',marginBottom:6,minHeight:24}},ach.desc),
            isLocked ? h('div',null,
              h('div',{style:{width:'100%',height:4,background:C.border,borderRadius:2,overflow:'hidden',marginBottom:3}},
                h('div',{style:{width:(ach.progress||0)+'%',height:'100%',background:rc.border}})
              ),
              h('div',{style:{fontSize:9,color:C.textS,textAlign:'center'}},ach.current+'/'+ach.target)
            ) : h('button',{onClick:function(){shareAchievement(ach);},style:{width:'100%',background:'#1DA1F2',color:'#fff',border:'none',borderRadius:6,padding:'6px 10px',fontSize:10,fontWeight:600,cursor:'pointer'}},'ùïè Share'),
            h('div',{style:{position:'absolute',bottom:6,left:6,fontSize:9,color:rc.text,fontWeight:600}},'+'+ach.points)
          );
        };
        
        return h('div',{style:section},
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20,flexWrap:'wrap',gap:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12}},
              h('span',{style:{fontSize:28}},'üèÜ'),
              h('div',null,
                h('div',{style:{fontSize:20,fontWeight:700}},(t.achievements||'Achievements')+' ('+achievements.length+')'),
                h('div',{style:{fontSize:12,color:C.textS}},unlockedAchievements.length+'/'+achievements.length+' '+(t.unlocked||'unlocked')+' ‚Ä¢ '+totalPoints.toLocaleString()+' pts')
              )
            ),
            h('div',{style:{display:'flex',alignItems:'center',gap:10}},
              h('div',{style:{background:C.posL,borderRadius:8,padding:'6px 12px',border:'1px solid '+C.pos,fontSize:11,color:C.pos}},'‚ö° LIVE'),
              h('button',{onClick:shareAllAchievements,style:{background:'#1DA1F2',color:'#fff',border:'none',borderRadius:8,padding:'8px 14px',fontSize:11,fontWeight:600,cursor:'pointer'}},'ùïè '+(t.shareAll||'Share All'))
            )
          ),
          h('div',{style:{background:'linear-gradient(135deg, '+currentLevel.color+'20 0%, '+C.card+' 100%)',borderRadius:14,padding:16,marginBottom:16,border:'2px solid '+currentLevel.color+'60',position:'relative',overflow:'hidden'}},
            h('div',{style:{position:'absolute',top:-15,right:-15,fontSize:60,opacity:0.1}},currentLevel.icon),
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
              h('div',{style:{display:'flex',alignItems:'center',gap:10}},
                h('div',null,
                  h('div',{style:{fontSize:9,color:C.textS,textTransform:'uppercase',letterSpacing:1}},'TRADER LEVEL'),
                  h('div',{style:{fontSize:22,fontWeight:800,color:currentLevel.color}},currentLevel.icon+' '+currentLevel.name)
                )
              ),
              h('div',{style:{textAlign:'right'}},
                h('div',{style:{fontSize:10,color:C.textS}},'Next: '+nextLevel.icon+' '+nextLevel.name),
                h('div',{style:{fontSize:11,color:C.textM}},totalPoints.toLocaleString()+' / '+nextLevel.min.toLocaleString()+' pts')
              )
            ),
            h('div',{style:{width:'100%',height:10,background:C.bg,borderRadius:5,overflow:'hidden'}},
              h('div',{style:{width:levelProgress+'%',height:'100%',background:'linear-gradient(90deg, '+currentLevel.color+', '+nextLevel.color+')',borderRadius:5}})
            )
          ),
          h('div',{style:Object.assign({},sec,{padding:14,marginBottom:16})},
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2, 1fr)':'repeat(auto-fit, minmax(140px, 1fr))',gap:8}},
              Object.keys(catNames).map(function(cat) {
                var catAchs = achievements.filter(function(a){return a.cat===cat;});
                var catUnlocked = catAchs.filter(function(a){return a.check;}).length;
                var pct = catAchs.length > 0 ? (catUnlocked/catAchs.length*100) : 0;
                return h('div',{key:cat,style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontSize:14}},catIcons[cat]),
                  h('div',{style:{flex:1}},
                    h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,marginBottom:2}},
                      h('span',{style:{color:C.textS}},catNames[cat]),
                      h('span',{style:{color:pct===100?C.pos:C.textM}},catUnlocked+'/'+catAchs.length)
                    ),
                    h('div',{style:{height:4,background:C.bg,borderRadius:2,overflow:'hidden'}},
                      h('div',{style:{width:pct+'%',height:'100%',background:pct===100?C.pos:C.accent}})
                    )
                  )
                );
              })
            )
          ),
          unlockedAchievements.length > 0 && h('div',{style:{marginBottom:20}},
            h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
              h('span',{style:{fontSize:16}},'‚úÖ'),
              h('span',{style:{fontSize:15,fontWeight:700}},(t.unlocked||'Unlocked')+' ('+unlockedAchievements.length+')')
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2, 1fr)':'repeat(auto-fill, minmax(150px, 1fr))',gap:isMobile?8:10}},
              unlockedAchievements.map(function(ach){return renderAchievement(ach, false);})
            )
          ),
          lockedAchievements.length > 0 && h('div',null,
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:16}},'üîí'),
                h('span',{style:{fontSize:15,fontWeight:700}},(t.locked||'Locked')+' ('+lockedAchievements.length+')'),
                !showAllAchievements && hiddenCount > 0 && h('span',{style:{fontSize:11,color:C.textS,marginLeft:8}},'('+(lang==='fr'?'Proches du d√©blocage':'Closest to unlock')+')')
              ),
              !showAllAchievements && hiddenCount > 0 && h('button',{onClick:function(){setShowAllAchievements(true);},style:{background:C.bg,border:'1px solid '+C.border,borderRadius:8,padding:'6px 12px',fontSize:11,color:C.textS,cursor:'pointer'}},'‚ö†Ô∏è '+(lang==='fr'?'Voir tous':'Show all')+' (+'+hiddenCount+')')
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2, 1fr)':'repeat(auto-fill, minmax(150px, 1fr))',gap:isMobile?8:10}},
              visibleLocked.map(function(ach){return renderAchievement(ach, true);})
            ),
            showAllAchievements && h('div',{style:{textAlign:'center',marginTop:16}},
              h('button',{onClick:function(){setShowAllAchievements(false);},style:{background:C.bg,border:'1px solid '+C.border,borderRadius:8,padding:'8px 16px',fontSize:12,color:C.textS,cursor:'pointer'}},'üîº '+(lang==='fr'?'R√©duire la liste':'Collapse list'))
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // JOURNAL TAB - ENHANCED with 6 improvements
      // 1. Stats per Setup 2. Timeline View 3. Search Bar 4. Mini-chart 5. Persistent Notes 6. Tags
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='journal' && (function(){
        var sec = {background:C.card,borderRadius:12,padding:20,border:'1px solid '+C.border};
        
        // Get all closed trades for journal (V2.0: market-aware)
        var allJournalTrades = activeClosed.slice().sort(function(a,b){ return new Date(b.exitTime||b.entryTime) - new Date(a.exitTime||a.entryTime); });
        
        // Filter by period
        var now = new Date();
        var todayStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        var weekStart = new Date(todayStart); weekStart.setDate(weekStart.getDate() - 7);
        var monthStart = new Date(todayStart); monthStart.setMonth(monthStart.getMonth() - 1);
        
        var filteredByPeriod = allJournalTrades.filter(function(tr){
          var trDate = new Date(tr.exitTime || tr.entryTime);
          if (journalPeriod === 'today') return trDate >= todayStart;
          if (journalPeriod === 'week') return trDate >= weekStart;
          if (journalPeriod === 'month') return trDate >= monthStart;
          return true;
        });
        
        // Filter by result
        var filteredByResult = filteredByPeriod.filter(function(tr){
          if (journalFilter === 'wins') return tr.r > 0;
          if (journalFilter === 'losses') return tr.r < 0;
          return true;
        });
        
        // Filter by symbol
        var filteredBySymbol = filteredByResult.filter(function(tr){
          if (journalSymbol === 'all') return true;
          return tr.symbol === journalSymbol;
        });
        
        // Filter by search (symbol, notes, tags)
        var journalTrades = filteredBySymbol.filter(function(tr){
          if (!journalSearch) return true;
          var q = journalSearch.toLowerCase();
          var inSymbol = (tr.symbol||'').toLowerCase().indexOf(q) >= 0;
          var inNote = (journalNotes[tr.id]||'').toLowerCase().indexOf(q) >= 0;
          var inTags = (journalTags[tr.id]||[]).some(function(tag){ return tag.toLowerCase().indexOf(q) >= 0; });
          var inDate = (tr.exitTime||tr.entryTime||'').toLowerCase().indexOf(q) >= 0;
          return inSymbol || inNote || inTags || inDate;
        });
        
        // Get unique symbols for filter
        var uniqueSymbols = [];
        allJournalTrades.forEach(function(tr){
          if (uniqueSymbols.indexOf(tr.symbol) === -1) uniqueSymbols.push(tr.symbol);
        });
        
        // Calculate journal stats
        var journalStatsData = {
          totalTrades: journalTrades.length,
          wins: journalTrades.filter(function(tr){ return tr.r > 0; }).length,
          losses: journalTrades.filter(function(tr){ return tr.r < 0; }).length,
          avgScore: journalTrades.length > 0 ? journalTrades.reduce(function(s,tr){ return s + (tr.score||0); },0) / journalTrades.length : 0,
          totalR: journalTrades.reduce(function(s,tr){ return s + (tr.r||0); },0),
          bestTrade: journalTrades.length > 0 ? journalTrades.reduce(function(best,tr){ return tr.r > best.r ? tr : best; }, journalTrades[0]) : null,
          worstTrade: journalTrades.length > 0 ? journalTrades.reduce(function(worst,tr){ return tr.r < worst.r ? tr : worst; }, journalTrades[0]) : null
        };
        
        // ‚ïê‚ïê‚ïê SETUP STATS CALCULATION ‚ïê‚ïê‚ïê
        var calcSetupStats = function(filterFn, label) {
          var filtered = allJournalTrades.filter(filterFn);
          var wins = filtered.filter(function(tr){ return tr.r > 0; }).length;
          var total = filtered.length;
          var avgR = total > 0 ? filtered.reduce(function(s,tr){ return s + (tr.r||0); },0) / total : 0;
          return { label: label, trades: total, wr: total > 0 ? (wins/total*100) : 0, avgR: avgR };
        };
        
        // --- Win Rate by Setup Type (from entry_reason / setup_type) ---
        var getSetupType = function(tr) {
          var reason = (tr.entryReason || '').toUpperCase();
          if (reason.indexOf('TIER_PREMIUM') !== -1) return 'TIER_PREMIUM';
          if (reason.indexOf('TIER_ADVANCED') !== -1) return 'TIER_ADVANCED';
          if (reason.indexOf('SIGNAL_TIER') !== -1) return 'TIER_SIGNAL';
          if (reason.indexOf('TIER_BASIC') !== -1) return 'TIER_BASIC';
          return 'TIER_BASIC';
        };
        var setupTypeStats = [
          calcSetupStats(function(tr){ return getSetupType(tr) === 'TIER_PREMIUM'; }, 'PREMIUM'),
          calcSetupStats(function(tr){ return getSetupType(tr) === 'TIER_ADVANCED'; }, 'ADVANCED'),
          calcSetupStats(function(tr){ return getSetupType(tr) === 'TIER_SIGNAL'; }, 'SIGNAL'),
          calcSetupStats(function(tr){ return getSetupType(tr) === 'TIER_BASIC'; }, 'BASIC')
        ].filter(function(s){ return s.trades > 0; });

        // --- Win Rate by Score (grouped ranges) ---
        var scoreStats = [
          calcSetupStats(function(tr){ return tr.score >= 14; }, '14-16'),
          calcSetupStats(function(tr){ return tr.score >= 11 && tr.score < 14; }, '11-13'),
          calcSetupStats(function(tr){ return tr.score >= 8 && tr.score < 11; }, '8-10'),
          calcSetupStats(function(tr){ return tr.score > 0 && tr.score < 8; }, '< 8')
        ].filter(function(s){ return s.trades > 0; });

        // --- Win Rate Long vs Short ---
        var sideStats = [
          calcSetupStats(function(tr){ return tr.side === 'LONG'; }, 'LONG'),
          calcSetupStats(function(tr){ return tr.side === 'SHORT'; }, 'SHORT')
        ].filter(function(s){ return s.trades > 0; });

        // --- Win Rate by Symbol ---
        // V2.1: Dynamic symbol list from actual trades (market-aware)
        var symbolList = activeClosed.reduce(function(acc, tr) {
          var sym = (tr.symbol||'').replace('-PERP','').replace('/USDT','').replace('USDT','');
          if (sym && acc.indexOf(sym) === -1) acc.push(sym);
          return acc;
        }, []);
        if (symbolList.length === 0) {
          symbolList = market === 'hip3' ? ['AAPL','TSLA','NVDA','AMD','AMZN','META','GOOGL','MSFT','PLTR','COIN','HOOD','MSTR'] : ['BTC','ETH','SOL','LINK','SEI','DOGE','SUI'];
        }
        var symbolStats = symbolList.map(function(sym){
          return calcSetupStats(function(tr){ return (tr.symbol||'').indexOf(sym) !== -1; }, sym);
        }).filter(function(s){ return s.trades > 0; });
        
        // Helper to get channel signal text
        var getChannelText = function(score) {
          if (!score) return t.neutral;
          if (score >= 4) return t.strongBullish;
          if (score >= 2) return t.bullish;
          if (score <= -4) return t.strongBearish;
          if (score <= -2) return t.bearish;
          return t.neutral;
        };

        // Helper to get signal level text
        var getSignalText = function(level) {
          if (!level) return '--';
          var signalLevels = {1:'Level 1', 2:'Level 2', 3:'Level 3', 4:'Level 4'};
          return signalLevels[level] || 'Level ' + level;
        };
        
        // Helper to get setup note based on score and conditions
        var getSetupNote = function(tr) {
          if (tr.score >= 18) return t.perfectSetup;
          if (tr.score >= 15) return t.cleanEntry;
          if (tr.gapDetected) return t.gapFill;
          return '';
        };
        
        // Crypto + Stock logos (jsDelivr CDN + Clearbit)
        var cryptoLogos = {
          BTC: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/bitcoin/large.png',
          ETH: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/ethereum/large.png',
          SOL: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/solana/large.png',
          LINK: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/chainlink/large.png',
          SEI: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/sei-network/large.png',
          DOGE: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/dogecoin/large.png',
          SUI: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/sui/large.png',
          XRP: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/ripple/large.png',
          ADA: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/cardano/large.png',
          AVAX: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/avalanche-2/large.png',
          MATIC: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/matic-network/large.png',
          DOT: 'https://cdn.jsdelivr.net/gh/simplr-sh/coin-logos/images/polkadot/large.png',
          AAPL:'https://logo.clearbit.com/apple.com',AMD:'https://logo.clearbit.com/amd.com',
          AMZN:'https://logo.clearbit.com/amazon.com',COIN:'https://logo.clearbit.com/coinbase.com',
          GOOGL:'https://logo.clearbit.com/google.com',HOOD:'https://logo.clearbit.com/robinhood.com',
          META:'https://logo.clearbit.com/meta.com',MSFT:'https://logo.clearbit.com/microsoft.com',
          MSTR:'https://logo.clearbit.com/microstrategy.com',NVDA:'https://logo.clearbit.com/nvidia.com',
          PLTR:'https://logo.clearbit.com/palantir.com',TSLA:'https://logo.clearbit.com/tesla.com'
        };
        
        // Suggested tags
        var suggestedTagsList = ['perfect','revenge','fomo','patient','missed-tp','early-exit','oversize','news'];
        
        // Share trade (safe - without private strategy details)
        var shareTrade = function(tr) {
          var emoji = tr.r >= 0 ? '‚úÖ' : '‚ùå';
          var txt = 'üî± Trinity Bot - Trade ' + (tr.r >= 0 ? 'Win' : 'Loss') + '\n\n';
          txt += tr.side + ' #' + tr.symbol + '\n';
          txt += 'üìä Score: ' + (tr.score || 0) + '/16\n';
          txt += 'üí∞ ' + (tr.r >= 0 ? '+' : '') + (tr.r || 0).toFixed(1) + 'R | ' + (tr.pnlPercent >= 0 ? '+' : '') + (tr.pnlPercent || 0).toFixed(2) + '%\n';
          txt += '\n#TrinityBot #Crypto #Trading';
          window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(txt), '_blank');
        };
        
        // Add tag to trade
        var addTagToTrade = function(tradeId, tag) {
          var current = journalTags[tradeId] || [];
          if (current.indexOf(tag) === -1) {
            var updated = Object.assign({}, journalTags);
            updated[tradeId] = current.concat([tag]);
            setJournalTags(updated);
          }
        };
        
        // Remove tag from trade
        var removeTagFromTrade = function(tradeId, tag) {
          var current = journalTags[tradeId] || [];
          var updated = Object.assign({}, journalTags);
          updated[tradeId] = current.filter(function(t){ return t !== tag; });
          setJournalTags(updated);
        };
        
        // ‚ïê‚ïê‚ïê MINI CHART COMPONENT (multi-TP + BE) ‚ïê‚ïê‚ïê
        var renderMiniChart = function(tr) {
          var entry = tr.entryPrice || 0;
          var exit = tr.exitPrice || entry;
          var stop = tr.stopLoss || (tr.side === 'LONG' ? entry * 0.98 : entry * 1.02);

          // Parse ALL TPs
          var mcTargets = tr.targets || [];
          var mcTpList = [];
          for (var mci = 0; mci < mcTargets.length; mci++) {
            var mcTpVal = parseFloat(mcTargets[mci] || 0);
            if (mcTpVal > 0) mcTpList.push(mcTpVal);
          }
          if (mcTpList.length === 0) {
            var mcSingleTp = tr.takeProfit || (tr.side === 'LONG' ? entry * 1.04 : entry * 0.96);
            if (mcSingleTp > 0) mcTpList.push(mcSingleTp);
          }

          var prices = [entry, exit, stop].concat(mcTpList).filter(function(p){ return p > 0; });
          var minP = Math.min.apply(null, prices) * 0.998;
          var maxP = Math.max.apply(null, prices) * 1.002;
          var range = maxP - minP || 1;

          var toY = function(p) { return 100 - ((p - minP) / range * 100); };
          var isWin = tr.r >= 0;
          var mcTpColors = ['#22c55e', '#10b981', '#059669'];

          return h('div',{style:{background:C.bg,borderRadius:10,padding:12,marginBottom:16}},
            h('div',{style:{fontSize:10,color:C.textS,marginBottom:8,fontWeight:600}},t.miniChart),
            h('svg',{viewBox:'0 0 200 100',style:{width:'100%',height:80}},
              // Entry line
              h('line',{x1:0,y1:toY(entry),x2:200,y2:toY(entry),stroke:C.textS,strokeWidth:0.5,strokeDasharray:'4,4'}),
              // Stop loss line
              h('line',{x1:0,y1:toY(stop),x2:200,y2:toY(stop),stroke:C.neg,strokeWidth:1,strokeDasharray:'3,3'}),
              // ALL TP lines
              mcTpList.map(function(tpv,tpi){
                return h('line',{key:'tp'+tpi,x1:0,y1:toY(tpv),x2:200,y2:toY(tpv),stroke:mcTpColors[tpi]||C.pos,strokeWidth:1,strokeDasharray:'3,3'});
              }),
              // Price path
              h('path',{d:'M 20 '+toY(entry)+' Q 60 '+(toY(entry)+(isWin?-15:15))+' 100 '+toY((entry+exit)/2)+' Q 140 '+(toY(exit)+(isWin?-10:10))+' 180 '+toY(exit), fill:'none',stroke:isWin?C.pos:C.neg,strokeWidth:2}),
              // Entry point
              h('circle',{cx:20,cy:toY(entry),r:5,fill:C.accent}),
              h('text',{x:28,y:toY(entry)+4,fill:C.textS,fontSize:8},t.entryPoint),
              // Exit point
              h('circle',{cx:180,cy:toY(exit),r:5,fill:isWin?C.pos:C.neg}),
              h('text',{x:155,y:toY(exit)+4,fill:C.textS,fontSize:8},t.exitPoint),
              // Labels
              h('text',{x:5,y:toY(stop)+3,fill:C.neg,fontSize:7},'SL'),
              mcTpList.map(function(tpv,tpi){
                return h('text',{key:'tpl'+tpi,x:5,y:toY(tpv)+3,fill:mcTpColors[tpi]||C.pos,fontSize:7},'TP'+(mcTpList.length>1?(tpi+1):''));
              })
            ),
            h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:8,fontSize:9,color:C.textS}},
              h('span',null,'$'+entry.toLocaleString()),
              h('span',null,t.priceRange+': $'+(maxP-minP).toFixed(2)),
              h('span',null,'$'+exit.toLocaleString())
            )
          );
        };
        
        // ‚ïê‚ïê‚ïê SETUP STATS BAR ‚ïê‚ïê‚ïê
        var renderStatBar = function(stats, title, colorFn) {
          if (stats.length === 0) return h('div',{style:{color:C.textS,fontSize:11,padding:10}},t.noDataYet);
          var maxTrades = Math.max.apply(null, stats.map(function(s){ return s.trades; }));
          return h('div',{style:{marginBottom:16}},
            h('div',{style:{fontSize:11,fontWeight:600,color:C.textS,marginBottom:8}},title),
            stats.map(function(s,i){
              var barColor = colorFn ? colorFn(s) : (s.wr >= 60 ? C.pos : s.wr >= 40 ? C.warn : C.neg);
              return h('div',{key:i,style:{display:'flex',alignItems:'center',gap:8,marginBottom:6}},
                h('div',{style:{width:60,fontSize:10,color:C.textS}},s.label),
                h('div',{style:{flex:1,height:20,background:C.bg,borderRadius:4,overflow:'hidden',position:'relative'}},
                  h('div',{style:{width:(s.trades/maxTrades*100)+'%',height:'100%',background:barColor+'40',borderRadius:4}}),
                  h('div',{style:{position:'absolute',top:0,left:0,right:0,bottom:0,display:'flex',alignItems:'center',justifyContent:'space-between',padding:'0 8px',fontSize:9}},
                    h('span',{style:{color:C.text}},s.trades+' '+t.tradesCount2),
                    h('span',{style:{color:barColor,fontWeight:700}},s.wr.toFixed(0)+'% WR'),
                    h('span',{style:{color:s.avgR>=0?C.pos:C.neg}},(s.avgR>=0?'+':'')+s.avgR.toFixed(1)+'R')
                  )
                )
              );
            })
          );
        };
        
        // ‚ïê‚ïê‚ïê TIMELINE VIEW ‚ïê‚ïê‚ïê
        var renderTimelineView = function() {
          if (journalTrades.length === 0) {
            return h('div',{style:{textAlign:'center',padding:40,color:C.textS}},t.timelineEmpty);
          }
          
          // Group trades by date
          var groupedByDate = {};
          journalTrades.forEach(function(tr){
            var date = (tr.exitTime||tr.entryTime||'').slice(0,10);
            if (!groupedByDate[date]) groupedByDate[date] = [];
            groupedByDate[date].push(tr);
          });
          
          var dates = Object.keys(groupedByDate).sort().reverse();
          
          return h('div',{style:{position:'relative',paddingLeft:30}},
            // Timeline line
            h('div',{style:{position:'absolute',left:10,top:0,bottom:0,width:2,background:C.border}}),
            dates.map(function(date,di){
              var trades = groupedByDate[date];
              var dayPnl = trades.reduce(function(s,tr){ return s + (tr.r||0); },0);
              var dayWins = trades.filter(function(tr){ return tr.r > 0; }).length;
              
              return h('div',{key:date,style:{marginBottom:24}},
                // Date marker
                h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12}},
                  h('div',{style:{width:20,height:20,borderRadius:'50%',background:dayPnl>=0?C.pos:C.neg,marginLeft:-9,border:'3px solid '+C.card}}),
                  h('div',{style:{fontSize:13,fontWeight:700}},date),
                  h('div',{style:{fontSize:11,color:dayPnl>=0?C.pos:C.neg}},(dayPnl>=0?'+':'')+dayPnl.toFixed(1)+'R'),
                  h('div',{style:{fontSize:10,color:C.textS}},dayWins+'/'+trades.length+' wins')
                ),
                // Trades for this date
                h('div',{style:{display:'flex',flexWrap:'wrap',gap:8}},
                  trades.map(function(tr,ti){
                    var isWin = tr.r >= 0;
                    return h('div',{key:ti,onClick:function(){setExpandedTrade(expandedTrade===tr.id?null:tr.id);setJournalView('cards');},style:{padding:'8px 12px',background:C.card,borderRadius:8,border:'1px solid '+(isWin?C.pos:C.neg)+'40',cursor:'pointer',minWidth:100}},
                      h('div',{style:{display:'flex',alignItems:'center',gap:6}},
                        h('span',{style:{fontSize:11,fontWeight:700}},tr.symbol),
                        h('span',{style:{fontSize:9,padding:'2px 4px',background:tr.side==='LONG'?C.pos:C.neg,color:'#fff',borderRadius:3}},tr.side)
                      ),
                      h('div',{style:{fontSize:13,fontWeight:700,color:isWin?C.pos:C.neg,marginTop:4}},(isWin?'+':'')+(tr.r||0).toFixed(1)+'R')
                    );
                  })
                )
              );
            })
          );
        };
        
        // ‚ïê‚ïê‚ïê CARD VIEW (existing but enhanced) ‚ïê‚ïê‚ïê
        var renderCardView = function() {
          if (journalTrades.length === 0) {
            return h('div',{style:{textAlign:'center',padding:60}},
              h('div',{style:{fontSize:48,marginBottom:16}},'üì≠'),
              h('div',{style:{fontSize:16,fontWeight:600,color:C.textS,marginBottom:8}},t.journalEmpty),
              h('div',{style:{fontSize:12,color:C.textM}},t.startTradingJournal)
            );
          }
          
          return h('div',{style:{display:'flex',flexDirection:'column',gap:16}},
            journalTrades.map(function(tr,idx){
              var isExpanded = expandedTrade === tr.id;
              var isWin = tr.r >= 0;
              var borderColor = isWin ? C.pos : C.neg;
              var tradeDate = new Date(tr.exitTime || tr.entryTime);
              var dateStr = tradeDate.toISOString().slice(0,10) + ' ' + tradeDate.toTimeString().slice(0,5);
              var logo = cryptoLogos[tr.symbol] || cryptoLogos.BTC;
              var note = journalNotes[tr.id] || '';
              var tags = journalTags[tr.id] || [];
              var setupNote = getSetupNote(tr);
              
              return h('div',{key:tr.id || idx,style:{background:C.card,borderRadius:16,border:'2px solid '+borderColor+'40',overflow:'hidden'}},
                // Main trade info row (always visible)
                h('div',{onClick:function(){setExpandedTrade(isExpanded?null:tr.id);},style:{padding:20,cursor:'pointer'}},
                  h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
                    // Left: Symbol + Side + Stats
                    h('div',{style:{display:'flex',alignItems:'center',gap:16}},
                      // Crypto logo
                      h('div',{style:{width:48,height:48,borderRadius:12,background:C.bg,display:'flex',alignItems:'center',justifyContent:'center',overflow:'hidden'}},
                        h('img',{src:logo,alt:tr.symbol,style:{width:32,height:32},onError:function(e){e.target.style.display='none';}})
                      ),
                      // Symbol + Side
                      h('div',null,
                        h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                          h('span',{style:{fontSize:18,fontWeight:700}},tr.symbol),
                          h('span',{style:{padding:'3px 8px',background:tr.side==='LONG'?C.pos:C.neg,color:'#fff',borderRadius:4,fontSize:10,fontWeight:700}},tr.side)
                        ),
                        h('div',{style:{fontSize:11,color:C.textS,marginTop:4}},dateStr),
                        // Tags preview
                        tags.length > 0 && h('div',{style:{display:'flex',gap:4,marginTop:4,flexWrap:'wrap'}},
                          tags.slice(0,3).map(function(tag,ti){
                            return h('span',{key:ti,style:{padding:'2px 6px',background:C.accent+'20',color:C.accent,borderRadius:4,fontSize:8}},tag);
                          }),
                          tags.length > 3 && h('span',{style:{fontSize:8,color:C.textS}},'+'+(tags.length-3))
                        )
                      ),
                      // R + PnL
                      h('div',{style:{display:'flex',alignItems:'center',gap:12,marginLeft:16}},
                        h('span',{style:{fontSize:20,fontWeight:700,color:isWin?C.pos:C.neg}},(isWin?'+':'')+(tr.r||0).toFixed(1)+'R'),
                        h('span',{style:{fontSize:14,color:isWin?C.pos:C.neg}},((tr.pnlPercent||0)>=0?'+':'')+(tr.pnlPercent||0).toFixed(2)+'%'),
                        !hide && h('span',{style:{padding:'4px 10px',background:isWin?C.pos:C.neg,color:'#fff',borderRadius:6,fontSize:12,fontWeight:700}},(tr.pnl>=0?'+':'')+'$'+Math.abs(tr.pnl||0).toFixed(2))
                      )
                    ),
                    // Right: Score + LIVE badge + Chart
                    h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                      // üÜï V10.0: Fills indicator for aggregated trades
                      tr.tp_count && tr.tp_count > 1 && h('span',{style:{padding:'4px 8px',background:C.info+'20',color:C.info,borderRadius:6,fontSize:10,fontWeight:600}},'üéØ '+tr.tp_count),
                      h('span',{style:{padding:'4px 10px',background:C.bg,borderRadius:6,fontSize:12,fontWeight:600,color:C.textS}},(tr.score||0)+'/16'),
                      tr.isLive && h('span',{style:{padding:'4px 10px',background:'linear-gradient(135deg, #22c55e, #16a34a)',borderRadius:6,fontSize:10,fontWeight:700,color:'#fff'}},'LIVE'),
                      // üÜï V10.0: Chart button
                      h('button',{onClick:function(e){e.stopPropagation();openTradeChart(tr);},style:{width:32,height:32,background:C.info+'20',border:'1px solid '+C.info+'40',borderRadius:6,cursor:'pointer',fontSize:12,color:C.info},title:lang==='fr'?'Voir le graphique':'View chart'},'üìä'),
                      h('button',{onClick:function(e){e.stopPropagation();setChartFullscreen(tr);},style:{width:32,height:32,background:C.accent+'20',border:'1px solid '+C.accent+'40',borderRadius:6,cursor:'pointer',fontSize:12,color:C.accent},title:'Fullscreen chart'},'‚õ∂'),
                      h('span',{style:{fontSize:20,color:C.textS,transform:isExpanded?'rotate(180deg)':'rotate(0deg)',transition:'transform 0.2s'}},'‚ñº')
                    )
                  )
                ),
                
                // Expanded details
                isExpanded && h('div',{style:{borderTop:'1px solid '+C.border,padding:20,background:C.bg+'80'}},
                  // Mini Chart
                  renderMiniChart(tr),
                  
                  // Strategy Details (Private)
                  h('div',{style:{marginBottom:16}},
                    h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
                      h('span',{style:{fontSize:14}},'üîí'),
                      h('span',{style:{fontSize:12,fontWeight:600,color:C.warn}},t.strategyDetails)
                    ),
                    h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:12}},
                      // Signal Level
                      h('div',{style:{background:C.card,padding:12,borderRadius:10}},
                        h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.fibLevel),
                        h('div',{style:{fontSize:16,fontWeight:700}},getSignalText(tr.signalLevel))
                      ),
                      // Channel Signal
                      h('div',{style:{background:C.card,padding:12,borderRadius:10}},
                        h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.channelSignal),
                        h('div',{style:{fontSize:14,fontWeight:700,color:tr.channelSignal>0?C.pos:tr.channelSignal<0?C.neg:C.textS}},getChannelText(tr.channelSignal))
                      ),
                      // Gap Detected
                      h('div',{style:{background:C.card,padding:12,borderRadius:10}},
                        h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.gapSignal),
                        h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                          h('span',{style:{width:20,height:20,borderRadius:4,background:tr.gapDetected?C.pos:C.neg+'40',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:12}},tr.gapDetected?'‚úì':'‚úó')
                        )
                      ),
                      // Confluence
                      h('div',{style:{background:C.card,padding:12,borderRadius:10}},
                        h('div',{style:{fontSize:10,color:C.textS,marginBottom:4}},t.confluence),
                        h('div',{style:{fontSize:16,fontWeight:700,color:C.accent}},(tr.confluence||3)+'/4')
                      )
                    )
                  ),
                  
                  // Setup Note
                  setupNote && h('div',{style:{background:C.card,padding:12,borderRadius:10,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
                    h('span',{style:{fontSize:14}},'üìù'),
                    h('span',{style:{fontSize:12,color:C.textS}},setupNote)
                  ),
                  
                  // Trade Details - On-Chain Regime
                  h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:12,marginBottom:16}},
                    [{l:t.entry,v:'$'+(tr.entryPrice||0).toLocaleString()},{l:t.exit,v:'$'+(tr.exitPrice||0).toLocaleString()},{l:t.duration,v:tr.duration||'--'},{l:t.regime,v:ocRegimeLabel(detectRegime(tr))}].map(function(item,i){
                      return h('div',{key:i,style:{background:C.card,padding:10,borderRadius:8}},
                        h('div',{style:{fontSize:9,color:C.textS}},item.l),
                        h('div',{style:{fontSize:12,fontWeight:600}},item.v)
                      );
                    })
                  ),
                  
                  // Tags Section
                  h('div',{style:{marginBottom:16}},
                    h('div',{style:{fontSize:11,fontWeight:600,color:C.textS,marginBottom:8}},t.tags),
                    h('div',{style:{display:'flex',flexWrap:'wrap',gap:6,marginBottom:8}},
                      tags.map(function(tag,ti){
                        return h('span',{key:ti,style:{padding:'4px 8px',background:C.accent+'20',color:C.accent,borderRadius:6,fontSize:10,display:'flex',alignItems:'center',gap:4}},
                          tag,
                          h('span',{onClick:function(e){e.stopPropagation();removeTagFromTrade(tr.id,tag);},style:{cursor:'pointer',opacity:0.6}},'√ó')
                        );
                      }),
                      h('input',{id:'tag-input-'+tr.id,type:'text',placeholder:t.addTagPlaceholder,onKeyDown:function(e){
                        if(e.key==='Enter' && e.target.value.trim()){
                          addTagToTrade(tr.id,e.target.value.trim().toLowerCase());
                          e.target.value='';
                        }
                      },style:{padding:'4px 8px',background:'transparent',border:'1px dashed '+C.border,borderRadius:6,color:C.text,fontSize:10,width:80}})
                    ),
                    // Suggested tags
                    h('div',{style:{display:'flex',gap:4,flexWrap:'wrap'}},
                      h('span',{style:{fontSize:9,color:C.textS,marginRight:4}},t.suggestedTags+':'),
                      suggestedTagsList.filter(function(st){ return tags.indexOf(st) === -1; }).slice(0,5).map(function(st,si){
                        return h('span',{key:si,onClick:function(){addTagToTrade(tr.id,st);},style:{padding:'2px 6px',background:C.bg,border:'1px solid '+C.border,borderRadius:4,fontSize:9,color:C.textS,cursor:'pointer'}},'+'+st);
                      })
                    )
                  ),
                  
                  // Personal Notes
                  h('div',{style:{marginBottom:16}},
                    h('div',{style:{fontSize:11,fontWeight:600,color:C.textS,marginBottom:8}},t.tradeNotes),
                    editingNote === tr.id
                      ? h('div',{style:{display:'flex',gap:8}},
                          h('textarea',{id:'note-'+tr.id,defaultValue:note,placeholder:t.addNote,style:{flex:1,padding:12,background:C.card,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:12,minHeight:60,resize:'vertical'}}),
                          h('button',{onClick:function(){
                            var el = document.getElementById('note-'+tr.id);
                            if(el){
                              setJournalNotes(Object.assign({},journalNotes,{[tr.id]:el.value}));
                            }
                            setEditingNote(null);
                          },style:{padding:'8px 16px',background:C.pos,border:'none',borderRadius:8,color:'#fff',fontSize:11,fontWeight:600,cursor:'pointer'}},t.saveNote)
                        )
                      : h('div',{onClick:function(){setEditingNote(tr.id);},style:{padding:12,background:C.card,border:'1px dashed '+C.border,borderRadius:8,color:note?C.text:C.textS,fontSize:12,cursor:'pointer',minHeight:40}},
                          note || t.addNote
                        )
                  ),
                  
                  // üÜï V10.0: Fills breakdown for aggregated trades
                  tr.fills && tr.fills.length > 1 && h('div',{style:{marginBottom:16,padding:12,background:C.card,borderRadius:10,border:'1px solid '+C.info+'30'}},
                    h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:10}},
                      h('span',{style:{fontSize:12}},'üéØ'),
                      h('span',{style:{fontSize:11,fontWeight:600,color:C.info}},lang==='fr'?'Ex√©cutions du trade ('+tr.fills.length+')':'Trade Fills ('+tr.fills.length+')')
                    ),
                    h('div',{style:{display:'flex',flexDirection:'column',gap:6}},
                      tr.fills.map(function(fill, fidx){
                        var fillColor = fill.fill_type==='entry' ? C.info : (fill.pnl>=0?C.pos:C.neg);
                        var fillIcon = fill.fill_type==='entry' ? 'üéØ' : (fill.pnl>=0?'‚úÖ':'‚ùå');
                        return h('div',{key:fidx,style:{display:'flex',alignItems:'center',gap:10,padding:'6px 10px',background:C.bg,borderRadius:6,borderLeft:'3px solid '+fillColor}},
                          h('span',{style:{fontSize:11}},fillIcon),
                          h('span',{style:{fontSize:10,fontWeight:600,color:fillColor,minWidth:50}},fill.fill_type==='entry'?'ENTRY':(fill.fill_type==='partial'?'TP'+(fidx):'EXIT')),
                          h('span',{style:{fontSize:10,color:C.textS}},'$'+(fill.price||0).toLocaleString(undefined,{maximumFractionDigits:2})),
                          fill.pnl !== undefined && fill.fill_type !== 'entry' && h('span',{style:{fontSize:10,fontWeight:600,color:fill.pnl>=0?C.pos:C.neg,marginLeft:'auto'}},fmtPnl(fill.pnl)),
                          fill.time && h('span',{style:{fontSize:9,color:C.textM,marginLeft:8}},(fill.time||'').split('T')[1]?.slice(0,8)||'')
                        );
                      })
                    )
                  ),
                  
                  // Action buttons
                  h('div',{style:{display:'flex',gap:10}},
                    h('button',{onClick:function(e){e.stopPropagation();openTradeChart(tr);},style:{padding:14,background:C.info+'20',border:'1px solid '+C.info+'40',borderRadius:10,color:C.info,fontSize:13,fontWeight:700,cursor:'pointer'}},'üìä '+(lang==='fr'?'Graphique':'Chart')),
                    h('button',{onClick:function(e){e.stopPropagation();setChartFullscreen(tr);},style:{padding:14,background:C.accent+'20',border:'1px solid '+C.accent+'40',borderRadius:10,color:C.accent,fontSize:13,fontWeight:700,cursor:'pointer'},title:'Fullscreen'},'‚õ∂ Full'),
                    h('button',{onClick:function(e){e.stopPropagation();shareTrade(tr);},style:{flex:1,padding:14,background:'linear-gradient(135deg, #1da1f2, #0d8ecf)',border:'none',borderRadius:10,color:'#fff',fontSize:13,fontWeight:700,cursor:'pointer'}},'ùïè '+t.shareSafe),
                    h('button',{onClick:function(e){e.stopPropagation();notify('info','Screenshot feature coming soon');},style:{padding:14,background:C.accent,border:'none',borderRadius:10,color:'#fff',fontSize:13,fontWeight:700,cursor:'pointer'}},'üì∏')
                  )
                )
              );
            })
          );
        };
        
        return h('div',{style:section},
          // ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24,flexWrap:'wrap',gap:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:16}},
              h('span',{style:{fontSize:isMobile?24:32}},'üìì'),
              h('div',null,
                h('div',{style:{fontSize:isMobile?18:22,fontWeight:700}},t.journalTitle),
                h('div',{style:{fontSize:12,color:C.textS,marginTop:4}},journalTrades.length + ' ' + t.trades)
              )
            ),
            h('div',{style:{display:'flex',gap:isMobile?4:8,flexWrap:'wrap'}},
              // View toggle
              h('button',{onClick:function(){setJournalView('cards');},style:{padding:isMobile?'6px 8px':'8px 12px',background:journalView==='cards'?C.accent+'20':C.bg,border:'1px solid '+(journalView==='cards'?C.accent:C.border),borderRadius:8,color:journalView==='cards'?C.accent:C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer'}},isMobile?'üÉè':'üÉè '+t.cardView),
              h('button',{onClick:function(){setJournalView('timeline');},style:{padding:isMobile?'6px 8px':'8px 12px',background:journalView==='timeline'?C.accent+'20':C.bg,border:'1px solid '+(journalView==='timeline'?C.accent:C.border),borderRadius:8,color:journalView==='timeline'?C.accent:C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer'}},isMobile?'üìÖ':'üìÖ '+t.timelineView),
              h('button',{onClick:function(){setJournalView('stats');},style:{padding:isMobile?'6px 8px':'8px 12px',background:journalView==='stats'?C.accent+'20':C.bg,border:'1px solid '+(journalView==='stats'?C.accent:C.border),borderRadius:8,color:journalView==='stats'?C.accent:C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer'}},isMobile?'üìä':'üìä '+t.statsView),
              h('button',{onClick:function(){
                var csv = 'Date,Symbol,Side,R,PnL%,Score,Signal,Channel,Gap,Tags,Notes\\n';
                journalTrades.forEach(function(tr){
                  var trTags = (journalTags[tr.id]||[]).join(';');
                  var trNote = (journalNotes[tr.id]||'').replace(/[\\n,]/g,' ');
                  csv += (tr.exitTime||tr.entryTime)+','+tr.symbol+','+tr.side+','+(tr.r||0)+','+(tr.pnlPercent||0)+','+(tr.score||0)+','+(tr.signalLevel||'')+','+(tr.channelSignal||'')+','+(tr.gapDetected?'Yes':'No')+',"'+trTags+'","'+trNote+'"\\n';
                });
                var blob = new Blob([csv],{type:'text/csv'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'trinity-journal-'+new Date().toISOString().slice(0,10)+'.csv';
                a.click();
              },style:{padding:isMobile?'6px 8px':'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer'}},isMobile?'üì•':'üì• '+t.exportJournal)
            )
          ),
          
          // ‚ïê‚ïê‚ïê SEARCH BAR ‚ïê‚ïê‚ïê
          h('div',{style:{marginBottom:20}},
            h('div',{style:{position:'relative'}},
              h('input',{type:'text',value:journalSearch,onChange:function(e){setJournalSearch(e.target.value);},placeholder:t.searchTrades,style:{width:'100%',padding:'12px 16px 12px 40px',background:C.card,border:'1px solid '+C.border,borderRadius:10,color:C.text,fontSize:13}}),
              h('span',{style:{position:'absolute',left:14,top:'50%',transform:'translateY(-50%)',fontSize:16,color:C.textS}},'üîç'),
              journalSearch && h('span',{onClick:function(){setJournalSearch('');},style:{position:'absolute',right:14,top:'50%',transform:'translateY(-50%)',cursor:'pointer',color:C.textS}},'‚úï')
            )
          ),
          
          // ‚ïê‚ïê‚ïê PRIVACY NOTE ‚ïê‚ïê‚ïê
          h('div',{style:{background:C.warn+'15',border:'1px solid '+C.warn+'40',borderRadius:10,padding:'12px 16px',marginBottom:20,display:'flex',alignItems:'center',gap:12}},
            h('span',{style:{fontSize:18}},'üîí'),
            h('span',{style:{fontSize:12,color:C.warn}},t.journalPrivacyNote)
          ),
          
          // ‚ïê‚ïê‚ïê FILTERS & STATS ROW ‚ïê‚ïê‚ïê
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'2fr 1fr',gap:20,marginBottom:24}},
            // Filters
            h('div',{style:Object.assign({},sec,{padding:isMobile?12:16})},
              h('div',{style:{fontSize:12,fontWeight:600,color:C.textS,marginBottom:12}},t.journalFilters),
              h('div',{style:{display:'flex',gap:isMobile?4:8,flexWrap:'wrap'}},
                // Period filters
                [{k:'all',l:t.allTrades},{k:'today',l:t.todayTrades},{k:'week',l:t.weekTrades},{k:'month',l:t.monthTrades}].map(function(f){
                  return h('button',{key:f.k,onClick:function(){setJournalPeriod(f.k);},style:{padding:isMobile?'6px 10px':'6px 12px',minHeight:isMobile?34:28,background:journalPeriod===f.k?C.accent:C.bg,border:'1px solid '+(journalPeriod===f.k?C.accent:C.border),borderRadius:6,color:journalPeriod===f.k?'#fff':C.textS,fontSize:isMobile?10:10,fontWeight:600,cursor:'pointer'}},f.l);
                }),
                !isMobile && h('span',{style:{width:1,height:24,background:C.border,margin:'0 4px'}}),
                // Result filters
                [{k:'all',l:t.showAll,c:C.accent},{k:'wins',l:t.showWins,c:C.pos},{k:'losses',l:t.showLosses,c:C.neg}].map(function(f){
                  return h('button',{key:f.k,onClick:function(){setJournalFilter(f.k);},style:{padding:isMobile?'6px 10px':'6px 12px',minHeight:isMobile?34:28,background:journalFilter===f.k?f.c+'20':C.bg,border:'1px solid '+(journalFilter===f.k?f.c:C.border),borderRadius:6,color:journalFilter===f.k?f.c:C.textS,fontSize:isMobile?10:10,fontWeight:600,cursor:'pointer'}},f.l);
                }),
                !isMobile && h('span',{style:{width:1,height:24,background:C.border,margin:'0 4px'}}),
                // Symbol filter
                h('select',{value:journalSymbol,onChange:function(e){setJournalSymbol(e.target.value);},style:{padding:isMobile?'4px 8px':'6px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:isMobile?9:10,cursor:'pointer'}},
                  h('option',{value:'all'},t.allSymbols),
                  uniqueSymbols.map(function(s){ return h('option',{key:s,value:s},s); })
                )
              )
            ),
            // Quick Stats
            h('div',{style:Object.assign({},sec,{padding:16})},
              h('div',{style:{fontSize:12,fontWeight:600,color:C.textS,marginBottom:12}},t.journalStats),
              h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:8}},
                [{l:t.wins,v:journalStatsData.wins,c:C.pos},{l:t.losses,v:journalStatsData.losses,c:C.neg},{l:t.avgScore,v:journalStatsData.avgScore.toFixed(0)+'/16',c:C.accent},{l:t.totalR,v:(journalStatsData.totalR>=0?'+':'')+journalStatsData.totalR.toFixed(1)+'R',c:journalStatsData.totalR>=0?C.pos:C.neg}].map(function(s,i){
                  return h('div',{key:i,style:{textAlign:'center'}},
                    h('div',{style:{fontSize:16,fontWeight:700,color:s.c}},s.v),
                    h('div',{style:{fontSize:9,color:C.textS}},s.l)
                  );
                })
              )
            )
          ),
          
          // ‚ïê‚ïê‚ïê SETUP STATS (Collapsible) ‚ïê‚ïê‚ïê
          h('div',{style:Object.assign({},sec,{marginBottom:24})},
            h('div',{onClick:function(){setShowSetupStats(!showSetupStats);},style:{display:'flex',justifyContent:'space-between',alignItems:'center',cursor:'pointer'}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:16}},'üìä'),
                h('span',{style:{fontSize:14,fontWeight:600}},t.setupStats)
              ),
              h('span',{style:{fontSize:14,color:C.textS,transform:showSetupStats?'rotate(180deg)':'rotate(0deg)',transition:'transform 0.2s'}},'‚ñº')
            ),
            showSetupStats && h('div',{style:{marginTop:16,display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(2,1fr)',gap:20}},
              // Setup Type Stats
              h('div',null,renderStatBar(setupTypeStats, t.wrBySetup, function(s){ return s.label==='PREMIUM'?'#9333ea':s.label==='ADVANCED'?'#06b6d4':s.label==='SIGNAL'?'#f97316':C.accent; })),
              // Score Stats
              h('div',null,renderStatBar(scoreStats, t.wrByScore, function(s){ return s.label==='14-16'?C.pos:s.label==='11-13'?C.accent:C.warn; })),
              // Side Stats
              h('div',null,renderStatBar(sideStats, t.wrBySide, function(s){ return s.label==='LONG'?C.pos:C.neg; })),
              // Symbol Stats
              h('div',null,renderStatBar(symbolStats, t.wrBySymbol, function(s){ return C.accent; }))
            )
          ),
          
          // ‚ïê‚ïê‚ïê CONTENT VIEW ‚ïê‚ïê‚ïê
          journalView === 'cards' && renderCardView(),
          journalView === 'timeline' && renderTimelineView(),
          journalView === 'stats' && h('div',{style:{textAlign:'center',padding:40}},
            h('div',{style:{fontSize:48,marginBottom:16}},'üìä'),
            h('div',{style:{fontSize:14,color:C.textS}},t.setupStats+' - '+t.noDataYet),
            h('div',{style:{marginTop:20}},
              h('button',{onClick:function(){setJournalView('cards');},style:{padding:'12px 24px',background:C.accent,border:'none',borderRadius:10,color:'#fff',fontWeight:600,cursor:'pointer'}},t.cardView)
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // MONITOR TAB - System Monitoring Dashboard
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='monitor' && (function(){
        var sec = {background:C.card,borderRadius:12,padding:16,border:'1px solid '+C.border};
        var m = monitorStatus.last_metrics || {};
        // Formater timestamp en heure de Paris
        var toParisTime = function(ts) {
          if (!ts) return '';
          try { return new Date(ts.endsWith('Z')?ts:ts+'Z').toLocaleTimeString('fr-FR',{timeZone:'Europe/Paris',hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
          catch(e) { return ts.substring(11,19); }
        };
        var statusColor = monitorStatus.system_status === 'ONLINE' ? C.pos : monitorStatus.system_status === 'CRITICAL' ? C.neg : C.warn;
        var statusIcon = monitorStatus.system_status === 'ONLINE' ? 'üü¢' : monitorStatus.system_status === 'CRITICAL' ? 'üî¥' : 'üü°';

        // Gauge component
        function Gauge(props) {
          var pct = Math.min(100, Math.max(0, props.pct || 0));
          var color = pct > 80 ? C.neg : pct > 60 ? C.warn : C.pos;
          if (props.invert) color = pct > 80 ? C.pos : pct > 60 ? C.warn : C.neg;
          return h('div',{style:Object.assign({},sec,{textAlign:'center',padding:12})},
            h('div',{style:{position:'relative',width:80,height:80,margin:'0 auto 8px'}},
              h('svg',{viewBox:'0 0 36 36',style:{width:80,height:80,transform:'rotate(-90deg)'}},
                h('circle',{cx:18,cy:18,r:15.5,fill:'none',stroke:C.border,strokeWidth:2.5}),
                h('circle',{cx:18,cy:18,r:15.5,fill:'none',stroke:color,strokeWidth:2.5,strokeDasharray:pct+' 100',strokeLinecap:'round'})
              ),
              h('div',{style:{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%,-50%)',fontSize:14,fontWeight:700,color:C.text}},
                props.value
              )
            ),
            h('div',{style:{fontSize:11,color:C.textS}},props.label)
          );
        }

        return h('div',{style:{maxWidth:1400,margin:'0 auto',padding:20}},
          // Header with system status
          h('div',{style:Object.assign({},sec,{marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:10})},
            h('div',{style:{display:'flex',alignItems:'center',gap:12}},
              h('span',{style:{fontSize:24}},'üõ°Ô∏è'),
              h('div',null,
                h('div',{style:{fontSize:18,fontWeight:700,color:C.text}},t.monitorTitle),
                h('div',{style:{fontSize:11,color:C.textS}},t.monitorCycle+' #'+monitorStatus.cycle_count+' | '+t.monitorUptime+': '+Math.floor((monitorStatus.uptime_seconds||0)/3600)+'h '+Math.floor(((monitorStatus.uptime_seconds||0)%3600)/60)+'min')
              )
            ),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('span',{style:{fontSize:16}},statusIcon),
              h('span',{style:{fontSize:14,fontWeight:700,color:statusColor}},monitorStatus.system_status || 'UNKNOWN')
            )
          ),

          // Gauges row
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(3,1fr)':'repeat(6,1fr)',gap:10,marginBottom:16}},
            h(Gauge,{pct:m.cpu_percent||0,value:(m.cpu_percent||0).toFixed(1)+'%',label:t.monitorCpu}),
            h(Gauge,{pct:m.ram_limit_mb?((m.ram_usage_mb||0)/(m.ram_limit_mb)*100):0,value:Math.round(m.ram_usage_mb||0)+'MB',label:t.monitorRam}),
            h(Gauge,{pct:m.disk_usage_percent||0,value:(m.disk_usage_percent||0).toFixed(1)+'%',label:t.monitorDisk}),
            h(Gauge,{pct:Math.min(100,(m.api_latency_ms||0)/50),value:(m.api_latency_ms||0)+'ms',label:t.monitorLatency}),
            h(Gauge,{pct:Math.min(100,(m.error_rate_per_hour||0)*5),value:m.error_rate_per_hour||0,label:t.monitorErrorsH}),
            h(Gauge,{pct:m.open_positions_count?((m.open_positions_count||0)/6*100):0,value:m.open_positions_count||0,label:t.monitorPositions,invert:true})
          ),

          // Status badges row
          h('div',{style:{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap'}},
            h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:m.bot_heartbeat_ok?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:m.bot_heartbeat_ok?C.pos:C.neg}},m.bot_heartbeat_ok?t.monitorHeartbeatOk:t.monitorBotFrozen),
            h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:!m.position_drift?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:!m.position_drift?C.pos:C.neg}},!m.position_drift?t.monitorPosSync:t.monitorDriftAlert),
            h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:m.order_integrity_ok?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:m.order_integrity_ok?C.pos:C.neg}},m.order_integrity_ok?t.monitorSlTpOk:t.monitorOrdersIncomplete),
            h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:!m.balance_drift?'rgba(34,197,94,.15)':'rgba(234,179,8,.15)',color:!m.balance_drift?C.pos:C.warn}},!m.balance_drift?t.monitorBalanceOk:t.monitorBalanceDrift)
          ),

          // V2.3: Services Health & Last Scan
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},
            // Crypto Services
            h('div',{style:Object.assign({},sec,{borderLeft:'3px solid '+C.pos})},
              h('div',{style:{fontSize:13,fontWeight:700,color:C.text,marginBottom:10}},'üü¢ Crypto Services'),
              (function(){
                var sv = servicesHealth.crypto||{};
                var ls = lastScan.crypto;
                var items = [
                  {name:'PostgreSQL',s:sv.postgres},
                  {name:'Redis',s:sv.redis},
                  {name:'Exchange',s:sv.hyperliquid}
                ];
                return h('div',null,
                  items.map(function(item){
                    var ok = item.s && item.s.status==='connected';
                    var lat = item.s && item.s.latency!==undefined ? item.s.latency+'ms' : '--';
                    return h('div',{key:item.name,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid '+C.border}},
                      h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                        h('span',{style:{width:8,height:8,borderRadius:'50%',background:ok?C.pos:C.neg,display:'inline-block'}}),
                        h('span',{style:{fontSize:12,color:C.text}},item.name)
                      ),
                      h('span',{style:{fontSize:11,fontWeight:600,color:ok?C.pos:C.neg}},lat)
                    );
                  }),
                  ls && h('div',{style:{marginTop:8,padding:'6px 8px',background:C.bg,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}},
                    h('span',{style:{color:C.textS}},'Last Scan'),
                    h('span',{style:{color:ls.elapsed_seconds<30?C.pos:ls.elapsed_seconds<60?C.warn:C.neg,fontWeight:600}},ls.elapsed_seconds+'s ago')
                  )
                );
              })()
            ),
            // HIP-3 Services
            h('div',{style:Object.assign({},sec,{borderLeft:'3px solid '+C.info})},
              h('div',{style:{fontSize:13,fontWeight:700,color:C.text,marginBottom:10}},'üîµ HIP-3 Services'),
              (function(){
                var sv = servicesHealth.hip3||{};
                var ls = lastScan.hip3;
                var items = [
                  {name:'PostgreSQL',s:sv.postgres},
                  {name:'Exchange',s:sv.hyperliquid}
                ];
                return h('div',null,
                  items.map(function(item){
                    var ok = item.s && item.s.status==='connected';
                    var lat = item.s && item.s.latency!==undefined ? item.s.latency+'ms' : '--';
                    return h('div',{key:item.name,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'6px 0',borderBottom:'1px solid '+C.border}},
                      h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                        h('span',{style:{width:8,height:8,borderRadius:'50%',background:ok?C.pos:C.neg,display:'inline-block'}}),
                        h('span',{style:{fontSize:12,color:C.text}},item.name)
                      ),
                      h('span',{style:{fontSize:11,fontWeight:600,color:ok?C.pos:C.neg}},lat)
                    );
                  }),
                  ls && h('div',{style:{marginTop:8,padding:'6px 8px',background:C.bg,borderRadius:6,display:'flex',justifyContent:'space-between',fontSize:11}},
                    h('span',{style:{color:C.textS}},'Last Scan'),
                    h('span',{style:{color:ls.elapsed_seconds<30?C.pos:ls.elapsed_seconds<60?C.warn:C.neg,fontWeight:600}},ls.elapsed_seconds+'s ago')
                  )
                );
              })()
            )
          ),

          // Two columns: Drift + Alerts
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},

            // Position Drift
            h('div',{style:sec},
              h('div',{style:{fontSize:14,fontWeight:700,color:C.text,marginBottom:12}},'üì° '+t.monitorPosDrift),
              monitorDrift && monitorDrift.position_drift ? h('div',null,
                h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:12}},
                  h('div',null,
                    h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.monitorBotApi),
                    (monitorDrift.position_drift.db_positions||[]).map(function(p,i){
                      return h('div',{key:'db'+i,style:{fontSize:11,padding:'4px 8px',background:C.bg,borderRadius:6,marginBottom:4}},
                        h('span',{style:{color:p.side==='LONG'?C.pos:C.neg}},p.side),' ',p.symbol,' ',p.size
                      );
                    })
                  ),
                  h('div',null,
                    h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.monitorExchange),
                    (monitorDrift.position_drift.exchange_positions||[]).map(function(p,i){
                      return h('div',{key:'ex'+i,style:{fontSize:11,padding:'4px 8px',background:C.bg,borderRadius:6,marginBottom:4}},
                        h('span',{style:{color:p.side==='LONG'?C.pos:C.neg}},p.side),' ',p.symbol,' ',p.size.toFixed(4)
                      );
                    })
                  )
                ),
                monitorDrift.position_drift.has_drift && h('div',{style:{padding:8,background:'rgba(239,68,68,.1)',borderRadius:8,fontSize:11,color:C.neg}},
                  (monitorDrift.position_drift.drifts||[]).map(function(d,i){
                    return h('div',{key:'d'+i},'['+d.severity+'] '+d.symbol+': '+d.detail);
                  })
                ),
                !monitorDrift.position_drift.has_drift && h('div',{style:{textAlign:'center',padding:16,color:C.pos,fontSize:12}},t.monitorPosSync2)
              ) : h('div',{style:{textAlign:'center',padding:20,color:C.textS,fontSize:12}},t.monitorLoading)
            ),

            // Alerts History
            h('div',{style:sec},
              h('div',{style:{fontSize:14,fontWeight:700,color:C.text,marginBottom:12}},'üö® '+t.monitorRecentAlerts),
              monitorAlerts.length > 0 ?
                h('div',{style:{maxHeight:300,overflowY:'auto'}},
                  monitorAlerts.slice(0,15).map(function(a,i){
                    var sevColor = a.severity==='CRITICAL'?C.neg:a.severity==='ERROR'?'#f97316':a.severity==='WARNING'?C.warn:C.pos;
                    return h('div',{key:'a'+i,style:{padding:'8px 10px',borderBottom:'1px solid '+C.border,fontSize:11}},
                      h('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:2}},
                        h('span',{style:{fontWeight:600,color:sevColor}},a.title),
                        h('span',{style:{color:C.textM,fontSize:10}},toParisTime(a.timestamp))
                      ),
                      h('div',{style:{color:C.textS,whiteSpace:'pre-wrap'}},a.message?a.message.substring(0,120):'')
                    );
                  })
                ) : h('div',{style:{textAlign:'center',padding:20,color:C.textS,fontSize:12}},t.monitorNoAlerts)
            )
          ),

          // Balance reconciliation
          monitorDrift && monitorDrift.balance_reconciliation && h('div',{style:Object.assign({},sec,{marginBottom:16})},
            h('div',{style:{fontSize:14,fontWeight:700,color:C.text,marginBottom:10}},'üí∞ '+t.monitorBalanceRecon),
            h('div',{style:{display:'flex',gap:20,fontSize:12}},
              h('span',{style:{color:C.textS}},'Bot: ',h('span',{style:{color:C.text,fontWeight:600}},'$'+(monitorDrift.balance_reconciliation.balance_db||0).toFixed(2))),
              h('span',{style:{color:C.textS}},'Exchange: ',h('span',{style:{color:C.text,fontWeight:600}},'$'+(monitorDrift.balance_reconciliation.balance_exchange||0).toFixed(2))),
              h('span',{style:{color:monitorDrift.balance_reconciliation.has_drift?C.neg:C.pos,fontWeight:600}},t.monitorDeviation+': '+(monitorDrift.balance_reconciliation.drift_percent||0).toFixed(2)+'%')
            )
          ),

          // Error Console (Matrix style)
          h('div',{style:Object.assign({},sec,{marginBottom:16,background:'#0a0a0a',border:'1px solid #1a3a1a'})},
            h('div',{style:{fontSize:14,fontWeight:700,color:'#00ff41',marginBottom:10}},'> '+t.monitorErrorConsole),
            h('div',{style:{maxHeight:200,overflowY:'auto',fontFamily:'monospace',fontSize:11}},
              monitorErrors.length > 0 ?
                monitorErrors.slice(0,20).map(function(e,i){
                  return h('div',{key:'e'+i,style:{padding:'3px 0',color:e.is_critical?'#ff4444':'#00cc33',borderBottom:'1px solid #0d1a0d'}},
                    h('span',{style:{color:'#006611'}},toParisTime(e.timestamp)),
                    ' ',e.line
                  );
                }) : h('div',{style:{color:'#006611',padding:10}},t.monitorNoErrors)
            )
          ),

          // Kill Switch + Restart
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16}},
            // Kill Switch
            h('div',{style:Object.assign({},sec,{border:'1px solid rgba(239,68,68,.3)'})},
              h('div',{style:{fontSize:14,fontWeight:700,color:C.neg,marginBottom:10}},'üõë '+t.monitorKillSwitch),
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:12}},t.monitorKillDesc),
              !showKill ? h('button',{onClick:function(){setShowKill(true);},style:{padding:'10px 20px',background:'rgba(239,68,68,.15)',border:'1px solid '+C.neg,borderRadius:8,color:C.neg,fontWeight:600,cursor:'pointer',fontSize:12}},t.monitorEmergencyStop)
              : h('div',null,
                  h('input',{type:'text',value:killConfirm,onChange:function(e){setKillConfirm(e.target.value);},placeholder:'Tapez STOP',style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,width:120,marginRight:8,fontSize:12}}),
                  h('button',{
                    onClick:function(){
                      if(killConfirm==='STOP'){
                        fetch(CONFIG.MONITOR_API_URL+'/api/monitor/kill-switch?confirm=CONFIRM_STOP',{method:'POST'})
                          .then(function(r){return r.json();})
                          .then(function(d){alert(d.success?'Bot arr√™t√©':'Echec: '+d.detail);})
                          .catch(function(e){alert('Erreur: '+e);});
                        setShowKill(false);setKillConfirm('');
                      } else { alert('Tapez exactement STOP'); }
                    },
                    disabled:killConfirm!=='STOP',
                    style:{padding:'8px 16px',background:killConfirm==='STOP'?C.neg:'#333',border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:killConfirm==='STOP'?'pointer':'not-allowed',fontSize:12}
                  },t.monitorConfirm),
                  h('button',{onClick:function(){setShowKill(false);setKillConfirm('');},style:{padding:'8px 12px',background:'transparent',border:'none',color:C.textS,cursor:'pointer',marginLeft:8,fontSize:12}},t.monitorCancel)
                )
            ),
            // Restart
            h('div',{style:sec},
              h('div',{style:{fontSize:14,fontWeight:700,color:C.warn,marginBottom:10}},'üîÑ '+t.monitorRestartBot),
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:12}},t.monitorRestartDesc),
              h('button',{onClick:function(){
                if(confirm('Confirmer le red√©marrage du bot ?')){
                  fetch(CONFIG.MONITOR_API_URL+'/api/monitor/restart-bot?confirm=CONFIRM_RESTART',{method:'POST'})
                    .then(function(r){return r.json();})
                    .then(function(d){alert(d.success?'Bot red√©marr√©':'Echec: '+(d.detail||'erreur'));})
                    .catch(function(e){alert('Erreur: '+e);});
                }
              },style:{padding:'10px 20px',background:'rgba(234,179,8,.15)',border:'1px solid '+C.warn,borderRadius:8,color:C.warn,fontWeight:600,cursor:'pointer',fontSize:12}},t.monitorRestartBtn)
            )
          ),

          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          // HIP-3 STOCKS MONITORING SECTION
          // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          h('div',{style:{marginTop:24,marginBottom:8,borderTop:'2px solid '+C.border,paddingTop:20}},
            h('div',{style:Object.assign({},sec,{marginBottom:16,display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:10})},
              h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                h('span',{style:{fontSize:24}},'üìä'),
                h('div',null,
                  h('div',{style:{fontSize:18,fontWeight:700,color:C.text}},t.monitorHip3Title),
                  h('div',{style:{fontSize:11,color:C.textS}},'Tokenized Stocks (DEX xyz)')
                )
              ),
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:16}},m.hip3_bot_alive?'üü¢':'üî¥'),
                h('span',{style:{fontSize:14,fontWeight:700,color:m.hip3_bot_alive?C.pos:C.neg}},m.hip3_bot_alive?'ONLINE':'OFFLINE')
              )
            ),

            // HIP-3 Gauges row
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(3,1fr)':'repeat(6,1fr)',gap:10,marginBottom:16}},
              h(Gauge,{pct:m.hip3_cpu_percent||0,value:(m.hip3_cpu_percent||0).toFixed(1)+'%',label:t.monitorCpu}),
              h(Gauge,{pct:m.hip3_ram_usage_mb?((m.hip3_ram_usage_mb||0)/512*100):0,value:Math.round(m.hip3_ram_usage_mb||0)+'MB',label:t.monitorRam}),
              h(Gauge,{pct:m.disk_usage_percent||0,value:(m.disk_usage_percent||0).toFixed(1)+'%',label:t.monitorDisk}),
              h(Gauge,{pct:Math.min(100,(m.hip3_api_latency_ms||0)/50),value:(m.hip3_api_latency_ms||0)+'ms',label:t.monitorLatency}),
              h(Gauge,{pct:Math.min(100,(m.error_rate_per_hour||0)*5),value:m.error_rate_per_hour||0,label:t.monitorErrorsH}),
              h(Gauge,{pct:m.hip3_positions_count?((m.hip3_positions_count||0)/5*100):0,value:m.hip3_positions_count||0,label:t.monitorPositions,invert:true})
            ),

            // HIP-3 Status badges
            h('div',{style:{display:'flex',gap:8,marginBottom:16,flexWrap:'wrap'}},
              h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:m.hip3_bot_alive?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:m.hip3_bot_alive?C.pos:C.neg}},m.hip3_bot_alive?t.monitorHip3Heartbeat:t.monitorHip3Dead),
              h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:!m.hip3_position_drift?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:!m.hip3_position_drift?C.pos:C.neg}},!m.hip3_position_drift?t.monitorHip3PosSync:t.monitorHip3Drift),
              h('span',{style:{padding:'4px 12px',borderRadius:20,fontSize:11,fontWeight:600,background:m.hip3_order_integrity_ok!==false?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:m.hip3_order_integrity_ok!==false?C.pos:C.neg}},m.hip3_order_integrity_ok!==false?t.monitorHip3OrdersOk:t.monitorHip3OrdersBad)
            ),

            // HIP-3 Two columns: Drift + Balance
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},

              // HIP-3 Position Drift
              h('div',{style:sec},
                h('div',{style:{fontSize:14,fontWeight:700,color:C.text,marginBottom:12}},'üì° '+t.monitorHip3PosDrift),
                monitorHip3Drift && monitorHip3Drift.position_drift ? h('div',null,
                  h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:12}},
                    h('div',null,
                      h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.monitorBotApi),
                      (monitorHip3Drift.position_drift.db_positions||[]).map(function(p,i){
                        return h('div',{key:'h3db'+i,style:{fontSize:11,padding:'4px 8px',background:C.bg,borderRadius:6,marginBottom:4}},
                          h('span',{style:{color:p.side==='LONG'?C.pos:C.neg}},p.side),' ',p.symbol,' ',p.size
                        );
                      })
                    ),
                    h('div',null,
                      h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.monitorExchange),
                      (monitorHip3Drift.position_drift.exchange_positions||[]).map(function(p,i){
                        return h('div',{key:'h3ex'+i,style:{fontSize:11,padding:'4px 8px',background:C.bg,borderRadius:6,marginBottom:4}},
                          h('span',{style:{color:p.side==='LONG'?C.pos:C.neg}},p.side),' ',p.symbol,' ',p.size.toFixed(4)
                        );
                      })
                    )
                  ),
                  monitorHip3Drift.position_drift.has_drift && h('div',{style:{padding:8,background:'rgba(239,68,68,.1)',borderRadius:8,fontSize:11,color:C.neg}},
                    (monitorHip3Drift.position_drift.drifts||[]).map(function(d,i){
                      return h('div',{key:'h3d'+i},'['+d.severity+'] '+d.symbol+': '+d.detail);
                    })
                  ),
                  !monitorHip3Drift.position_drift.has_drift && h('div',{style:{textAlign:'center',padding:16,color:C.pos,fontSize:12}},t.monitorPosSync2)
                ) : h('div',{style:{textAlign:'center',padding:20,color:C.textS,fontSize:12}},t.monitorLoading)
              ),

              // HIP-3 Balance Reconciliation
              h('div',{style:sec},
                h('div',{style:{fontSize:14,fontWeight:700,color:C.text,marginBottom:12}},'üí∞ '+t.monitorHip3BalanceRecon),
                monitorHip3Drift && monitorHip3Drift.balance_reconciliation ? h('div',null,
                  h('div',{style:{display:'flex',gap:20,fontSize:12,flexWrap:'wrap'}},
                    h('span',{style:{color:C.textS}},'Bot: ',h('span',{style:{color:C.text,fontWeight:600}},'$'+(monitorHip3Drift.balance_reconciliation.balance_db||0).toFixed(2))),
                    h('span',{style:{color:C.textS}},'Exchange: ',h('span',{style:{color:C.text,fontWeight:600}},'$'+(monitorHip3Drift.balance_reconciliation.balance_exchange||0).toFixed(2))),
                    h('span',{style:{color:monitorHip3Drift.balance_reconciliation.has_drift?C.neg:C.pos,fontWeight:600}},t.monitorDeviation+': '+(monitorHip3Drift.balance_reconciliation.drift_percent||0).toFixed(2)+'%')
                  )
                ) : h('div',{style:{textAlign:'center',padding:20,color:C.textS,fontSize:12}},t.monitorLoading)
              )
            ),

            // HIP-3 Kill Switch + Restart
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16}},
              // HIP-3 Kill Switch
              h('div',{style:Object.assign({},sec,{border:'1px solid rgba(239,68,68,.3)'})},
                h('div',{style:{fontSize:14,fontWeight:700,color:C.neg,marginBottom:10}},'üõë '+t.monitorHip3KillSwitch),
                h('div',{style:{fontSize:11,color:C.textS,marginBottom:12}},t.monitorHip3KillDesc),
                !showHip3Kill ? h('button',{onClick:function(){setShowHip3Kill(true);},style:{padding:'10px 20px',background:'rgba(239,68,68,.15)',border:'1px solid '+C.neg,borderRadius:8,color:C.neg,fontWeight:600,cursor:'pointer',fontSize:12}},t.monitorEmergencyStop)
                : h('div',null,
                    h('input',{type:'text',value:hip3KillConfirm,onChange:function(e){setHip3KillConfirm(e.target.value);},placeholder:'Tapez STOP',style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,width:120,marginRight:8,fontSize:12}}),
                    h('button',{
                      onClick:function(){
                        if(hip3KillConfirm==='STOP'){
                          fetch(CONFIG.MONITOR_API_URL+'/api/monitor/hip3/kill-switch?confirm=CONFIRM_STOP',{method:'POST'})
                            .then(function(r){return r.json();})
                            .then(function(d){alert(d.success?'Bot HIP-3 arr√™t√©':'Echec: '+d.detail);})
                            .catch(function(e){alert('Erreur: '+e);});
                          setShowHip3Kill(false);setHip3KillConfirm('');
                        } else { alert('Tapez exactement STOP'); }
                      },
                      disabled:hip3KillConfirm!=='STOP',
                      style:{padding:'8px 16px',background:hip3KillConfirm==='STOP'?C.neg:'#333',border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:hip3KillConfirm==='STOP'?'pointer':'not-allowed',fontSize:12}
                    },t.monitorConfirm),
                    h('button',{onClick:function(){setShowHip3Kill(false);setHip3KillConfirm('');},style:{padding:'8px 12px',background:'transparent',border:'none',color:C.textS,cursor:'pointer',marginLeft:8,fontSize:12}},t.monitorCancel)
                  )
              ),
              // HIP-3 Restart
              h('div',{style:sec},
                h('div',{style:{fontSize:14,fontWeight:700,color:C.warn,marginBottom:10}},'üîÑ '+t.monitorHip3Restart),
                h('div',{style:{fontSize:11,color:C.textS,marginBottom:12}},t.monitorHip3RestartDesc),
                h('button',{onClick:function(){
                  if(confirm('Confirmer le red√©marrage du bot HIP-3 ?')){
                    fetch(CONFIG.MONITOR_API_URL+'/api/monitor/hip3/restart-bot?confirm=CONFIRM_RESTART',{method:'POST'})
                      .then(function(r){return r.json();})
                      .then(function(d){alert(d.success?'Bot HIP-3 red√©marr√©':'Echec: '+(d.detail||'erreur'));})
                      .catch(function(e){alert('Erreur: '+e);});
                  }
                },style:{padding:'10px 20px',background:'rgba(234,179,8,.15)',border:'1px solid '+C.warn,borderRadius:8,color:C.warn,fontWeight:600,cursor:'pointer',fontSize:12}},t.monitorHip3RestartBtn)
              )
            )
          )
        );
      })(),

      // OTHER TABS (social, export)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SOCIAL TAB - Complete Social Hub with all features
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='social' && (function(){
        var sec = {background:C.card,borderRadius:12,padding:20,border:'1px solid '+C.border};
        
        // Get trades for sharing
        var shareTrades = activeClosed.slice().sort(function(a,b){ return new Date(b.exitTime||b.entryTime) - new Date(a.exitTime||a.entryTime); }).slice(0,20);
        
        // Calculate social stats
        var thisMonthPosts = socialHistory.filter(function(p){
          return new Date(p.date).getMonth() === new Date().getMonth();
        }).length;
        var lastPostDate = socialHistory.length > 0 ? socialHistory[0].date : null;
        
        // Default templates
        var defaultTemplates = [
          {id:'win',name:'Win Trade',content:'üî± Trinity Bot Trade\\n\\n{side} #{symbol}\\nüìä Score: {score}/16\\nüí∞ {r}R | {pnlPercent}%\\n\\n#TrinityBot #Trading'},
          {id:'loss',name:'Loss Trade',content:'üî± Trinity Bot Trade\\n\\n{side} #{symbol}\\nüìä Score: {score}/16\\nüìâ {r}R | {pnlPercent}%\\n\\nLearning from this one! üí™\\n#TrinityBot'},
          {id:'stats',name:'Weekly Stats',content:'üî± Trinity Bot Weekly Report\\n\\nüìà Trades: {totalTrades}\\n‚úÖ Win Rate: {winRate}%\\nüí∞ Total R: {totalR}R\\nüî• Streak: {streak}\\n\\n#TrinityBot #Trading'},
          {id:'milestone',name:'Milestone',content:'üéâ New Milestone!\\n\\nüî± Trinity Bot just hit {milestone}!\\n\\n#TrinityBot #Achievement'}
        ];
        
        // Generate post content from template and data
        var generatePostContent = function(template, data) {
          var content = template;
          Object.keys(data).forEach(function(key){
            content = content.replace(new RegExp('{'+key+'}','g'), data[key]);
          });
          return content;
        };
        
        // Get selected trade data
        var selectedTrade = selectedTradeForShare ? shareTrades.find(function(tr){ return tr.id === selectedTradeForShare; }) : null;
        
        // Generate trade post content
        var getTradePostContent = function(tr, templateContent) {
          if (!tr) return '';
          var data = {
            symbol: tr.symbol || 'BTC',
            side: tr.side || 'LONG',
            r: (tr.r >= 0 ? '+' : '') + (tr.r || 0).toFixed(1),
            pnlPercent: (tr.pnlPercent >= 0 ? '+' : '') + (tr.pnlPercent || 0).toFixed(2),
            score: tr.score || 0,
            regime: ocRegimeLabel(detectRegime(tr)),
            entry: tr.entryPrice ? '$' + tr.entryPrice.toLocaleString() : '--',
            exit: tr.exitPrice ? '$' + tr.exitPrice.toLocaleString() : '--',
            date: tr.exitTime ? new Date(tr.exitTime).toLocaleDateString() : '--'
          };
          return generatePostContent(templateContent || defaultTemplates[tr.r >= 0 ? 0 : 1].content, data);
        };
        
        // Generate stats content
        var getStatsPostContent = function(period) {
          var now = new Date();
          var startDate = new Date();
          if (period === 'week') startDate.setDate(startDate.getDate() - 7);
          else if (period === 'month') startDate.setMonth(startDate.getMonth() - 1);
          else startDate = new Date(0);
          
          var periodTrades = activeClosed.filter(function(tr){
            return new Date(tr.exitTime || tr.entryTime) >= startDate;
          });
          var wins = periodTrades.filter(function(tr){ return tr.r > 0; }).length;
          var winRate = periodTrades.length > 0 ? (wins / periodTrades.length * 100).toFixed(0) : 0;
          var totalR = periodTrades.reduce(function(s,tr){ return s + (tr.r||0); }, 0);
          
          var data = {
            totalTrades: periodTrades.length,
            winRate: winRate,
            totalR: (totalR >= 0 ? '+' : '') + totalR.toFixed(1),
            streak: streak,
            period: period === 'week' ? t.thisWeek : period === 'month' ? t.thisMonth : t.all
          };
          return generatePostContent(defaultTemplates[2].content, data);
        };
        
        // Post to platform
        var postToPlatform = function(platform, content) {
          if (platform === 'twitter') {
            // Twitter via IFTTT webhook relay
            if (twitterWebhook) {
              fetch(twitterWebhook, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content: content.slice(0,280)}) // Twitter limit
              }).then(function(r){
                if(r.ok) notify('success', t.postSent + ' (Twitter via IFTTT)');
                else notify('error', t.postFailed);
              }).catch(function(){ notify('error', t.postFailed); });
            } else {
              // Fallback: open Twitter intent if no IFTTT configured
              window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(content), '_blank');
            }
          } else if (platform === 'discord' && settings.discordWebhook) {
            fetch(settings.discordWebhook, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({content: content})
            }).then(function(r){
              if(r.ok) notify('success', t.postSent);
              else notify('error', t.postFailed);
            }).catch(function(){ notify('error', t.postFailed); });
          } else if (platform === 'telegram' && telegramBotToken && telegramChatId) {
            fetch('https://api.telegram.org/bot'+telegramBotToken+'/sendMessage', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({chat_id: telegramChatId, text: content, parse_mode: 'HTML'})
            }).then(function(r){
              if(r.ok) notify('success', t.postSent);
              else notify('error', t.postFailed);
            }).catch(function(){ notify('error', t.postFailed); });
          }
          
          // Add to history
          var newHistory = [{
            id: Date.now(),
            date: new Date().toISOString(),
            platform: platform,
            content: content.slice(0,100)+'...'
          }].concat(socialHistory.slice(0,49));
          setSocialHistory(newHistory);
        };
        
        // Test Telegram connection
        var testTelegram = function() {
          if (!telegramBotToken || !telegramChatId) {
            notify('error', t.telegramFailed);
            return;
          }
          fetch('https://api.telegram.org/bot'+telegramBotToken+'/sendMessage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: telegramChatId, text: 'üî± Trinity Bot - Test Connection OK!'})
          }).then(function(r){
            if(r.ok) notify('success', t.telegramOk);
            else notify('error', t.telegramFailed);
          }).catch(function(){ notify('error', t.telegramFailed); });
        };
        
        // Render Trade Card SVG
        var renderTradeCard = function(tr) {
          if (!tr) return null;
          var isWin = tr.r >= 0;
          var bgGrad = isWin ? 'url(#winGrad)' : 'url(#lossGrad)';
          
          return h('svg',{viewBox:'0 0 400 220',style:{width:'100%',maxWidth:400,borderRadius:16,boxShadow:'0 8px 32px rgba(0,0,0,0.3)'}},
            h('defs',null,
              h('linearGradient',{id:'winGrad',x1:'0%',y1:'0%',x2:'100%',y2:'100%'},
                h('stop',{offset:'0%',style:{stopColor:'#1a1a2e'}}),
                h('stop',{offset:'100%',style:{stopColor:'#16213e'}})
              ),
              h('linearGradient',{id:'lossGrad',x1:'0%',y1:'0%',x2:'100%',y2:'100%'},
                h('stop',{offset:'0%',style:{stopColor:'#1a1a2e'}}),
                h('stop',{offset:'100%',style:{stopColor:'#2d1f1f'}})
              ),
              h('linearGradient',{id:'accentGrad',x1:'0%',y1:'0%',x2:'100%',y2:'0%'},
                h('stop',{offset:'0%',style:{stopColor:'#8b5cf6'}}),
                h('stop',{offset:'100%',style:{stopColor:'#6366f1'}})
              )
            ),
            // Background
            h('rect',{width:400,height:220,fill:bgGrad,rx:16}),
            // Header gradient bar
            h('rect',{y:0,width:400,height:4,fill:'url(#accentGrad)'}),
            // Trinity Logo & Title
            h('text',{x:20,y:35,fill:'#fff',fontSize:18,fontWeight:'bold'},'üî± Trinity Bot'),
            h('text',{x:340,y:35,fill:isWin?'#22c55e':'#ef4444',fontSize:14,fontWeight:'bold',textAnchor:'end'},isWin?'WIN':'LOSS'),
            // Symbol & Side
            h('text',{x:20,y:75,fill:'#fff',fontSize:28,fontWeight:'bold'},tr.symbol),
            h('rect',{x:120,y:58,width:60,height:24,fill:tr.side==='LONG'?'#22c55e':'#ef4444',rx:4}),
            h('text',{x:150,y:75,fill:'#fff',fontSize:12,fontWeight:'bold',textAnchor:'middle'},tr.side),
            // Main stats
            h('text',{x:20,y:120,fill:isWin?'#22c55e':'#ef4444',fontSize:36,fontWeight:'bold'},(isWin?'+':'')+(tr.r||0).toFixed(1)+'R'),
            h('text',{x:20,y:145,fill:'#9ca3af',fontSize:14},((tr.pnlPercent||0)>=0?'+':'')+(tr.pnlPercent||0).toFixed(2)+'%'),
            // Score
            h('rect',{x:280,y:95,width:100,height:55,fill:'rgba(139,92,246,0.2)',rx:8}),
            h('text',{x:330,y:120,fill:'#8b5cf6',fontSize:12,textAnchor:'middle'},'SCORE'),
            h('text',{x:330,y:142,fill:'#fff',fontSize:20,fontWeight:'bold',textAnchor:'middle'},(tr.score||0)+'/16'),
            // Footer
            h('line',{x1:20,y1:170,x2:380,y2:170,stroke:'#374151',strokeWidth:1}),
            h('text',{x:20,y:195,fill:'#6b7280',fontSize:11},tr.exitTime ? new Date(tr.exitTime).toLocaleDateString() : '--'),
            h('text',{x:200,y:195,fill:'#6b7280',fontSize:11,textAnchor:'middle'},'Entry: $'+(tr.entryPrice||0).toLocaleString()),
            h('text',{x:380,y:195,fill:'#6b7280',fontSize:11,textAnchor:'end'},'Exit: $'+(tr.exitPrice||0).toLocaleString()),
            // LIVE badge
            tr.isLive && h('g',null,
              h('rect',{x:320,y:20,width:60,height:20,fill:'#22c55e',rx:4}),
              h('text',{x:350,y:34,fill:'#fff',fontSize:10,fontWeight:'bold',textAnchor:'middle'},'LIVE')
            )
          );
        };
        
        // Render Twitter Preview
        var renderTwitterPreview = function(content) {
          return h('div',{style:{background:'#15202b',borderRadius:16,padding:isMobile?12:16,border:'1px solid #38444d',maxWidth:isMobile?'100%':500}},
            h('div',{style:{display:'flex',gap:12}},
              h('div',{style:{width:48,height:48,borderRadius:'50%',background:'linear-gradient(135deg, #8b5cf6, #6366f1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}},'üî±'),
              h('div',{style:{flex:1}},
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontWeight:700,color:'#fff'}},'Trinity Bot'),
                  h('span',{style:{color:'#8899a6',fontSize:14}},'@TrinityBot')
                ),
                h('div',{style:{color:'#fff',marginTop:8,whiteSpace:'pre-wrap',fontSize:15,lineHeight:1.4}},content),
                h('div',{style:{display:'flex',gap:40,marginTop:16,color:'#8899a6'}},
                  h('span',null,'üí¨ 0'),h('span',null,'üîÅ 0'),h('span',null,'‚ù§Ô∏è 0'),h('span',null,'üìä 0')
                )
              )
            )
          );
        };
        
        // Render Discord Preview
        var renderDiscordPreview = function(content) {
          return h('div',{style:{background:'#36393f',borderRadius:8,padding:isMobile?12:16,maxWidth:isMobile?'100%':500}},
            h('div',{style:{display:'flex',gap:12}},
              h('div',{style:{width:40,height:40,borderRadius:'50%',background:'linear-gradient(135deg, #8b5cf6, #6366f1)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:16}},'üî±'),
              h('div',null,
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontWeight:600,color:'#fff'}},'Trinity Bot'),
                  h('span',{style:{background:'#5865f2',color:'#fff',fontSize:10,padding:'2px 4px',borderRadius:3}},'BOT'),
                  h('span',{style:{color:'#72767d',fontSize:12}},'Today at '+new Date().toLocaleTimeString().slice(0,5))
                ),
                h('div',{style:{color:'#dcddde',marginTop:4,whiteSpace:'pre-wrap',fontSize:14}},content)
              )
            )
          );
        };
        
        // Sub-tabs
        var subTabs = [
          {id:'share',icon:'üì§',label:t.shareCenter},
          {id:'templates',icon:'üìù',label:t.templatesTitle},
          {id:'history',icon:'üìú',label:t.historyTitle},
          {id:'settings',icon:'‚öôÔ∏è',label:t.settings}
        ];
        
        return h('div',{style:section},
          // Header
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}},
            h('div',{style:{display:'flex',alignItems:'center',gap:16}},
              h('span',{style:{fontSize:32}},'üì±'),
              h('div',null,
                h('div',{style:{fontSize:22,fontWeight:700}},t.socialHub),
                h('div',{style:{fontSize:12,color:C.textS,marginTop:4}},thisMonthPosts+' '+t.postsThisMonth)
              )
            )
          ),
          
          // Privacy reminder
          h('div',{style:{background:C.accent+'15',border:'1px solid '+C.accent+'40',borderRadius:10,padding:'12px 16px',marginBottom:20,display:'flex',alignItems:'center',gap:12}},
            h('span',{style:{fontSize:18}},'üîí'),
            h('span',{style:{fontSize:12,color:C.accent}},t.privacyReminder)
          ),
          
          // Sub-tabs
          h('div',{style:{display:'flex',gap:8,marginBottom:24,flexWrap:'wrap'}},
            subTabs.map(function(st){
              return h('button',{key:st.id,onClick:function(){setSocialTab(st.id);},style:{padding:isMobile?'8px 10px':'10px 16px',minHeight:44,background:socialTab===st.id?C.accent:C.card,border:'1px solid '+(socialTab===st.id?C.accent:C.border),borderRadius:10,color:socialTab===st.id?'#fff':C.textS,fontSize:isMobile?11:12,fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',gap:6}},st.icon+' '+st.label);
            })
          ),
          
          // ‚ïê‚ïê‚ïê SHARE TAB ‚ïê‚ïê‚ïê
          socialTab === 'share' && h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:20}},
            // Left: Trade selection & Quick share
            h('div',null,
              // Quick Share Stats
              h('div',{style:Object.assign({},sec,{marginBottom:20})},
                h('div',{style:{fontSize:14,fontWeight:600,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
                  h('span',null,'üìä'),t.quickShare+' - '+t.stats
                ),
                h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:10}},
                  [{p:'week',l:t.statsWeek},{p:'month',l:t.statsMonth},{p:'all',l:t.statsAllTime}].map(function(item){
                    return h('button',{key:item.p,onClick:function(){
                      var content = getStatsPostContent(item.p);
                      setSocialPreview({type:'stats',content:content});
                    },style:{padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:10,cursor:'pointer'}},
                      h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},item.l),
                      h('div',{style:{fontSize:20,marginTop:4}},'üìà')
                    );
                  })
                )
              ),
              
              // Trade Selection
              h('div',{style:sec},
                h('div',{style:{fontSize:14,fontWeight:600,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
                  h('span',null,'üíπ'),t.shareTrade
                ),
                h('div',{style:{maxHeight:300,overflowY:'auto'}},
                  shareTrades.length === 0 
                    ? h('div',{style:{textAlign:'center',padding:20,color:C.textS}},t.noTrades)
                    : shareTrades.map(function(tr){
                        var isSelected = selectedTradeForShare === tr.id;
                        var isWin = tr.r >= 0;
                        return h('div',{key:tr.id,onClick:function(){
                          setSelectedTradeForShare(tr.id);
                          setSocialPreview({type:'trade',content:getTradePostContent(tr),trade:tr});
                        },style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:12,background:isSelected?C.accent+'20':C.bg,border:'1px solid '+(isSelected?C.accent:C.border),borderRadius:10,marginBottom:8,cursor:'pointer'}},
                          h('div',{style:{display:'flex',alignItems:'center',gap:12}},
                            h('span',{style:{fontSize:18}},isWin?'‚úÖ':'‚ùå'),
                            h('div',null,
                              h('div',{style:{fontWeight:600}},tr.symbol+' '+tr.side),
                              h('div',{style:{fontSize:11,color:C.textS}},tr.exitTime?new Date(tr.exitTime).toLocaleDateString():'--')
                            )
                          ),
                          h('div',{style:{textAlign:'right'}},
                            h('div',{style:{fontWeight:700,color:isWin?C.pos:C.neg}},(isWin?'+':'')+(tr.r||0).toFixed(1)+'R'),
                            h('div',{style:{fontSize:11,color:C.textS}},(tr.score||0)+'/16')
                          )
                        );
                      })
                )
              )
            ),
            
            // Right: Preview & Actions
            h('div',null,
              // Preview
              h('div',{style:Object.assign({},sec,{marginBottom:20})},
                h('div',{style:{fontSize:14,fontWeight:600,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
                  h('span',null,'üëÅÔ∏è'),t.postPreview
                ),
                !socialPreview 
                  ? h('div',{style:{textAlign:'center',padding:40,color:C.textS}},
                      h('div',{style:{fontSize:32,marginBottom:8}},'üì§'),
                      h('div',null,t.selectTradePrompt)
                    )
                  : h('div',null,
                      // Trade Card (if trade selected)
                      socialPreview.type === 'trade' && socialPreview.trade && h('div',{style:{marginBottom:16}},
                        h('div',{style:{fontSize:12,fontWeight:600,color:C.textS,marginBottom:8}},t.tradeCard),
                        renderTradeCard(socialPreview.trade)
                      ),
                      // Twitter preview
                      h('div',{style:{marginBottom:16}},
                        h('div',{style:{fontSize:12,fontWeight:600,color:C.textS,marginBottom:8}},t.previewTwitter),
                        renderTwitterPreview(socialPreview.content)
                      ),
                      // Character count
                      h('div',{style:{fontSize:11,color:socialPreview.content.length>280?C.neg:C.textS,textAlign:'right'}},
                        socialPreview.content.length+'/280 '+t.characterCount
                      )
                    )
              ),
              
              // Action buttons
              socialPreview && h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:10}},
                h('button',{onClick:function(){postToPlatform('twitter',socialPreview.content);},style:{padding:14,background:'#1da1f2',border:'none',borderRadius:10,color:'#fff',fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:6}},'ùïè '+t.postToX),
                h('button',{onClick:function(){postToPlatform('discord',socialPreview.content);},style:{padding:14,background:'#5865f2',border:'none',borderRadius:10,color:'#fff',fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:6}},'üí¨ Discord'),
                h('button',{onClick:function(){postToPlatform('telegram',socialPreview.content);},style:{padding:14,background:'#0088cc',border:'none',borderRadius:10,color:'#fff',fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:6}},'‚úàÔ∏è Telegram'),
                h('button',{onClick:function(){navigator.clipboard.writeText(socialPreview.content);notify('success',t.copied);},style:{padding:14,background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,fontWeight:600,cursor:'pointer',gridColumn:'span 3'}},'üìã '+t.copyToClipboard)
              )
            )
          ),
          
          // ‚ïê‚ïê‚ïê TEMPLATES TAB ‚ïê‚ïê‚ïê
          socialTab === 'templates' && h('div',null,
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:20}},
              // Default templates
              h('div',{style:sec},
                h('div',{style:{fontSize:14,fontWeight:600,marginBottom:16}},t.defaultTemplates),
                defaultTemplates.map(function(tmpl){
                  return h('div',{key:tmpl.id,style:{padding:12,background:C.bg,borderRadius:10,marginBottom:8,cursor:'pointer'},onClick:function(){
                    setSocialPreview({type:'template',content:tmpl.content});
                  }},
                    h('div',{style:{fontWeight:600,marginBottom:4}},tmpl.name),
                    h('div',{style:{fontSize:11,color:C.textS,whiteSpace:'pre-wrap'}},tmpl.content.slice(0,80)+'...')
                  );
                })
              ),
              
              // Custom templates
              h('div',{style:sec},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}},
                  h('div',{style:{fontSize:14,fontWeight:600}},t.templatesTitle),
                  h('button',{onClick:function(){setEditingTemplate({id:Date.now(),name:'',content:''});},style:{padding:'6px 12px',background:C.accent,border:'none',borderRadius:6,color:'#fff',fontSize:11,fontWeight:600,cursor:'pointer'}},'+'+t.createTemplate)
                ),
                socialTemplates.length === 0
                  ? h('div',{style:{textAlign:'center',padding:20,color:C.textS}},t.noTemplates)
                  : socialTemplates.map(function(tmpl){
                      return h('div',{key:tmpl.id,style:{padding:12,background:C.bg,borderRadius:10,marginBottom:8,display:'flex',justifyContent:'space-between',alignItems:'center'}},
                        h('div',{onClick:function(){setSocialPreview({type:'template',content:tmpl.content});},style:{cursor:'pointer',flex:1}},
                          h('div',{style:{fontWeight:600}},tmpl.name),
                          h('div',{style:{fontSize:11,color:C.textS}},tmpl.content.slice(0,50)+'...')
                        ),
                        h('div',{style:{display:'flex',gap:4}},
                          h('button',{onClick:function(){setEditingTemplate(tmpl);},style:{padding:'4px 8px',background:C.accent+'20',border:'none',borderRadius:4,color:C.accent,fontSize:10,cursor:'pointer'}},'‚úèÔ∏è'),
                          h('button',{onClick:function(){setSocialTemplates(socialTemplates.filter(function(t){return t.id!==tmpl.id;}));},style:{padding:'4px 8px',background:C.neg+'20',border:'none',borderRadius:4,color:C.neg,fontSize:10,cursor:'pointer'}},'üóëÔ∏è')
                        )
                      );
                    }),
                // Template editor
                editingTemplate && h('div',{style:{marginTop:16,padding:16,background:C.bg,borderRadius:10,border:'1px solid '+C.accent}},
                  h('div',{style:{marginBottom:12}},
                    h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.templateName),
                    h('input',{type:'text',value:editingTemplate.name,onChange:function(e){setEditingTemplate(Object.assign({},editingTemplate,{name:e.target.value}));},style:{width:'100%',padding:10,background:C.card,border:'1px solid '+C.border,borderRadius:8,color:C.text}})
                  ),
                  h('div',{style:{marginBottom:12}},
                    h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.templateContent),
                    h('textarea',{value:editingTemplate.content,onChange:function(e){setEditingTemplate(Object.assign({},editingTemplate,{content:e.target.value}));},style:{width:'100%',padding:10,background:C.card,border:'1px solid '+C.border,borderRadius:8,color:C.text,minHeight:100,resize:'vertical'}})
                  ),
                  h('div',{style:{fontSize:10,color:C.textS,marginBottom:12}},
                    t.templateVars+': {symbol}, {side}, {r}, {pnlPercent}, {score}, {entry}, {exit}, {date}'
                  ),
                  h('div',{style:{display:'flex',gap:8}},
                    h('button',{onClick:function(){
                      if (editingTemplate.name && editingTemplate.content) {
                        var exists = socialTemplates.find(function(t){return t.id===editingTemplate.id;});
                        if (exists) {
                          setSocialTemplates(socialTemplates.map(function(t){return t.id===editingTemplate.id?editingTemplate:t;}));
                        } else {
                          setSocialTemplates(socialTemplates.concat([editingTemplate]));
                        }
                        setEditingTemplate(null);
                        notify('success',t.templateSaved);
                      }
                    },style:{flex:1,padding:10,background:C.pos,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer'}},t.save),
                    h('button',{onClick:function(){setEditingTemplate(null);},style:{padding:10,background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.textS,cursor:'pointer'}},t.cancel)
                  )
                )
              )
            )
          ),
          
          // ‚ïê‚ïê‚ïê HISTORY TAB ‚ïê‚ïê‚ïê
          socialTab === 'history' && h('div',{style:sec},
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}},
              h('div',{style:{fontSize:14,fontWeight:600}},t.historyTitle+' ('+socialHistory.length+')'),
              socialHistory.length > 0 && h('button',{onClick:function(){if(confirm(t.confirmDelete)){setSocialHistory([]);}},style:{padding:'6px 12px',background:C.neg+'20',border:'none',borderRadius:6,color:C.neg,fontSize:11,cursor:'pointer'}},t.deleteHistory)
            ),
            socialHistory.length === 0
              ? h('div',{style:{textAlign:'center',padding:40,color:C.textS}},
                  h('div',{style:{fontSize:32,marginBottom:8}},'üì≠'),
                  h('div',null,t.noHistory)
                )
              : h('div',{style:{maxHeight:400,overflowY:'auto'}},
                  socialHistory.map(function(post){
                    var platformIcon = post.platform==='twitter'?'ùïè':post.platform==='discord'?'üí¨':'‚úàÔ∏è';
                    var platformColor = post.platform==='twitter'?'#1da1f2':post.platform==='discord'?'#5865f2':'#0088cc';
                    return h('div',{key:post.id,style:{display:'flex',alignItems:'center',gap:12,padding:12,background:C.bg,borderRadius:10,marginBottom:8}},
                      h('div',{style:{width:36,height:36,borderRadius:8,background:platformColor,display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:16}},platformIcon),
                      h('div',{style:{flex:1}},
                        h('div',{style:{fontSize:12,color:C.textS}},new Date(post.date).toLocaleString()),
                        h('div',{style:{fontSize:13,color:C.text,marginTop:2}},post.content)
                      )
                    );
                  })
                )
          ),
          
          // ‚ïê‚ïê‚ïê SETTINGS TAB ‚ïê‚ïê‚ïê
          socialTab === 'settings' && h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:20}},
            // Platform configs
            h('div',null,
              // Twitter/X via IFTTT
              h('div',{style:Object.assign({},sec,{marginBottom:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:16}},
                  h('div',{style:{width:40,height:40,borderRadius:10,background:'#000',display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,color:'#fff',fontWeight:700}},'ùïè'),
                  h('div',null,
                    h('div',{style:{fontWeight:600}},t.twitterViaIfttt),
                    h('div',{style:{fontSize:11,color:twitterWebhook?C.pos:C.textS}},twitterWebhook?t.twitterEnabled:t.twitterDisabled)
                  )
                ),
                // IFTTT Guide (collapsible)
                h('div',{style:{background:C.bg,borderRadius:10,padding:12,marginBottom:12}},
                  h('div',{style:{fontSize:11,color:C.accent,marginBottom:8,fontWeight:600}},'‚ÑπÔ∏è '+t.iftttSetupGuide),
                  h('div',{style:{fontSize:10,color:C.textS,lineHeight:1.6}},
                    h('div',{style:{marginBottom:4}},'1Ô∏è‚É£ '+t.iftttStep1),
                    h('div',{style:{marginBottom:4}},'2Ô∏è‚É£ '+t.iftttStep2),
                    h('div',{style:{marginBottom:4}},'3Ô∏è‚É£ '+t.iftttStep3),
                    h('div',{style:{marginBottom:4}},'4Ô∏è‚É£ '+t.iftttStep4)
                  ),
                  h('div',{style:{fontSize:9,color:C.warn,marginTop:8,fontStyle:'italic'}},t.iftttNote)
                ),
                h('input',{type:'text',value:twitterWebhook,onChange:function(e){setTwitterWebhook(e.target.value);},placeholder:'Discord Webhook URL (for IFTTT relay)',style:{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,marginBottom:10}}),
                h('button',{onClick:function(){
                  if(!twitterWebhook) return notify('error',t.webhookFailed);
                  fetch(twitterWebhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:'üî± Trinity Bot - Twitter Relay Test! (via IFTTT)'})})
                    .then(function(r){notify(r.ok?'success':'error',r.ok?t.webhookOk:t.webhookFailed);})
                    .catch(function(){notify('error',t.webhookFailed);});
                },style:{width:'100%',padding:12,background:'#000',border:'none',borderRadius:10,color:'#fff',fontWeight:600,cursor:'pointer'}},'ùïè '+t.testWebhook)
              ),
              
              // Discord
              h('div',{style:Object.assign({},sec,{marginBottom:20})},
                h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:16}},
                  h('div',{style:{width:40,height:40,borderRadius:10,background:'#5865f2',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}},'üí¨'),
                  h('div',null,
                    h('div',{style:{fontWeight:600}},t.discord),
                    h('div',{style:{fontSize:11,color:settings.discordWebhook?C.pos:C.textS}},settings.discordWebhook?t.webhookConfigured:t.webhookNotConfigured)
                  )
                ),
                h('input',{type:'text',value:settings.discordWebhook||'',onChange:function(e){setSettings(Object.assign({},settings,{discordWebhook:e.target.value}));},placeholder:t.discordWebhook,style:{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,marginBottom:10}}),
                h('button',{onClick:function(){
                  if(!settings.discordWebhook) return notify('error',t.webhookFailed);
                  fetch(settings.discordWebhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:'üî± Trinity Bot - Test Webhook OK!'})})
                    .then(function(r){notify(r.ok?'success':'error',r.ok?t.webhookOk:t.webhookFailed);})
                    .catch(function(){notify('error',t.webhookFailed);});
                },style:{width:'100%',padding:12,background:'#5865f2',border:'none',borderRadius:10,color:'#fff',fontWeight:600,cursor:'pointer'}},t.testWebhook)
              ),
              
              // Telegram
              h('div',{style:sec},
                h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:16}},
                  h('div',{style:{width:40,height:40,borderRadius:10,background:'#0088cc',display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}},'‚úàÔ∏è'),
                  h('div',null,
                    h('div',{style:{fontWeight:600}},t.telegramConfig),
                    h('div',{style:{fontSize:11,color:telegramBotToken&&telegramChatId?C.pos:C.textS}},telegramBotToken&&telegramChatId?t.connectedStatus:t.disconnectedStatus)
                  )
                ),
                h('input',{type:'text',value:telegramBotToken,onChange:function(e){setTelegramBotToken(e.target.value);},placeholder:t.botToken,style:{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,marginBottom:10}}),
                h('input',{type:'text',value:telegramChatId,onChange:function(e){setTelegramChatId(e.target.value);},placeholder:t.chatId,style:{width:'100%',padding:12,background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,marginBottom:10}}),
                h('button',{onClick:testTelegram,style:{width:'100%',padding:12,background:'#0088cc',border:'none',borderRadius:10,color:'#fff',fontWeight:600,cursor:'pointer'}},t.testTelegram)
              )
            ),
            
            // Auto-posting settings
            h('div',{style:sec},
              h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:20}},
                h('div',{style:{width:40,height:40,borderRadius:10,background:C.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:20}},'ü§ñ'),
                h('div',null,
                  h('div',{style:{fontWeight:600}},t.autoPostTitle),
                  h('div',{style:{fontSize:11,color:autoPostSettings.enabled?C.pos:C.textS}},autoPostSettings.enabled?t.connectedStatus:t.disconnectedStatus)
                )
              ),
              // Enable toggle
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
                h('span',null,t.autoPostEnabled),
                h('button',{onClick:function(){setAutoPostSettings(Object.assign({},autoPostSettings,{enabled:!autoPostSettings.enabled}));},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:autoPostSettings.enabled?C.pos:C.border,cursor:'pointer',position:'relative'}},
                  h('span',{style:{position:'absolute',top:2,left:autoPostSettings.enabled?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s'}})
                )
              ),
              // Post on wins
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
                h('span',null,t.postOnWins),
                h('button',{onClick:function(){setAutoPostSettings(Object.assign({},autoPostSettings,{onWin:!autoPostSettings.onWin}));},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:autoPostSettings.onWin?C.pos:C.border,cursor:'pointer',position:'relative'}},
                  h('span',{style:{position:'absolute',top:2,left:autoPostSettings.onWin?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s'}})
                )
              ),
              // Post on losses
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
                h('span',null,t.postOnLosses),
                h('button',{onClick:function(){setAutoPostSettings(Object.assign({},autoPostSettings,{onLoss:!autoPostSettings.onLoss}));},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:autoPostSettings.onLoss?C.neg:C.border,cursor:'pointer',position:'relative'}},
                  h('span',{style:{position:'absolute',top:2,left:autoPostSettings.onLoss?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s'}})
                )
              ),
              // Min R filter
              h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
                h('span',null,t.minRToPost),
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('button',{onClick:function(){setAutoPostSettings(Object.assign({},autoPostSettings,{minR:Math.max(0,autoPostSettings.minR-0.5)}));},style:{width:28,height:28,background:C.bg,border:'1px solid '+C.border,borderRadius:6,cursor:'pointer'}},'-'),
                  h('span',{style:{width:40,textAlign:'center',fontWeight:700}},autoPostSettings.minR+'R'),
                  h('button',{onClick:function(){setAutoPostSettings(Object.assign({},autoPostSettings,{minR:autoPostSettings.minR+0.5}));},style:{width:28,height:28,background:C.bg,border:'1px solid '+C.border,borderRadius:6,cursor:'pointer'}},'+')
                )
              ),
              // Platform selection
              h('div',{style:{padding:'12px 0'}},
                h('div',{style:{marginBottom:8}},t.selectPlatforms),
                h('div',{style:{display:'flex',gap:8,flexWrap:'wrap'}},
                  ['twitter','discord','telegram'].map(function(p){
                    var isSelected = autoPostSettings.platforms.indexOf(p) >= 0;
                    var bgColor = p==='twitter'?'#000':p==='discord'?'#5865f2':'#0088cc';
                    var icon = p==='twitter'?'ùïè':p==='discord'?'üí¨':'‚úàÔ∏è';
                    var label = p==='twitter'?'Twitter/X':p==='discord'?'Discord':'Telegram';
                    return h('button',{key:p,onClick:function(){
                      var platforms = isSelected 
                        ? autoPostSettings.platforms.filter(function(x){return x!==p;})
                        : autoPostSettings.platforms.concat([p]);
                      setAutoPostSettings(Object.assign({},autoPostSettings,{platforms:platforms}));
                    },style:{padding:'8px 16px',background:isSelected?bgColor:C.bg,border:'1px solid '+C.border,borderRadius:8,color:isSelected?'#fff':C.textS,fontWeight:600,cursor:'pointer'}},
                      icon+' '+label
                    );
                  })
                )
              )
            )
          )
        );
      })(),

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // EXPORT TAB
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      tab==='export' && h('div',null,
        // Header
        h('div',{style:Object.assign({},section,{marginBottom:20})},
          h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:8}},
            h('span',{style:{fontSize:28}},'üì§'),
            h('span',{style:{fontSize:24,fontWeight:700}},t.exportTitle)
          ),
          h('div',{style:{fontSize:13,color:C.textS}},'Export your trading data in various formats')
        ),

        // Period selector
        h('div',{style:Object.assign({},section,{marginBottom:20})},
          h('div',{style:{fontSize:14,fontWeight:600,marginBottom:12}},t.exportByPeriod),
          h('div',{style:{display:'flex',gap:8,flexWrap:'wrap',marginBottom:16}},
            [['all',t.allTime],['30',t.last30],['90',t.last90],['year',t.thisYear],['custom',t.customRange]].map(function(item){
              return h('button',{key:item[0],onClick:function(){setExportPeriod(item[0]);},style:{padding:'8px 16px',background:exportPeriod===item[0]?C.accent:C.bg,border:'1px solid '+(exportPeriod===item[0]?C.accent:C.border),borderRadius:8,color:exportPeriod===item[0]?C.bg:C.text,fontSize:12,fontWeight:600,cursor:'pointer'}},item[1]);
            })
          ),
          exportPeriod==='custom' && h('div',{style:{display:'flex',gap:12,flexWrap:'wrap'}},
            h('div',null,
              h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.startDate),
              h('input',{type:'date',value:exportStart,onChange:function(e){setExportStart(e.target.value);},style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text}})
            ),
            h('div',null,
              h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.endDate),
              h('input',{type:'date',value:exportEnd,onChange:function(e){setExportEnd(e.target.value);},style:{padding:'8px 12px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text}})
            )
          )
        ),

        // Export cards grid
        h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(2,1fr)',gap:16,marginBottom:20}},
          
          // CSV Export
          h('div',{style:Object.assign({},card,{cursor:'pointer',transition:'transform .2s',border:exportLoading==='csv'?'2px solid '+C.accent:'1px solid '+C.border}),onClick:function(){if(!exportLoading)exportTradesCsv();}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12}},
              h('div',{style:{width:48,height:48,background:C.posL,borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'üìä'),
              h('div',null,
                h('div',{style:{fontWeight:700}},t.exportCsvTrades),
                h('div',{style:{fontSize:11,color:C.textS}},activeClosed.length+' trades')
              )
            ),
            h('div',{style:{fontSize:12,color:C.textS,marginBottom:12}},t.exportCsvDesc),
            h('button',{style:{width:'100%',padding:10,background:exportLoading==='csv'?C.warnL:C.accent,border:'none',borderRadius:8,color:exportLoading==='csv'?C.warn:C.bg,fontWeight:600,cursor:'pointer'}},exportLoading==='csv'?'‚è≥ '+t.generating:'‚¨áÔ∏è '+t.downloadCsv)
          ),

          // JSON Export
          h('div',{style:Object.assign({},card,{cursor:'pointer',transition:'transform .2s',border:exportLoading==='json'?'2px solid '+C.accent:'1px solid '+C.border}),onClick:function(){if(!exportLoading)exportJson();}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12}},
              h('div',{style:{width:48,height:48,background:C.infoL,borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'üìã'),
              h('div',null,
                h('div',{style:{fontWeight:700}},t.exportJson),
                h('div',{style:{fontSize:11,color:C.textS}},t.structuredData)
              )
            ),
            h('div',{style:{fontSize:12,color:C.textS,marginBottom:12}},t.exportJsonDesc),
            h('button',{style:{width:'100%',padding:10,background:exportLoading==='json'?C.warnL:C.info,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer'}},exportLoading==='json'?'‚è≥ '+t.generating:'‚¨áÔ∏è '+t.downloadJson)
          ),

          // PDF Report
          h('div',{style:Object.assign({},card,{cursor:'pointer',transition:'transform .2s',border:exportLoading==='pdf'?'2px solid '+C.accent:'1px solid '+C.border}),onClick:function(){if(!exportLoading)generatePdfReport();}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12}},
              h('div',{style:{width:48,height:48,background:C.negL,borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'üìÑ'),
              h('div',null,
                h('div',{style:{fontWeight:700}},t.exportPdf),
                h('div',{style:{fontSize:11,color:C.textS}},t.htmlReport)
              )
            ),
            h('div',{style:{fontSize:12,color:C.textS,marginBottom:12}},t.exportPdfDesc),
            h('button',{style:{width:'100%',padding:10,background:exportLoading==='pdf'?C.warnL:C.neg,border:'none',borderRadius:8,color:'#fff',fontWeight:600,cursor:'pointer'}},exportLoading==='pdf'?'‚è≥ '+t.generating:'üìÑ '+t.generateReport)
          ),

          // Full Backup
          h('div',{style:Object.assign({},card,{cursor:'pointer',transition:'transform .2s',border:exportLoading==='backup'?'2px solid '+C.accent:'1px solid '+C.border}),onClick:function(){if(!exportLoading)exportBackup();}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:12}},
              h('div',{style:{width:48,height:48,background:C.warnL,borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'üíæ'),
              h('div',null,
                h('div',{style:{fontWeight:700}},t.exportBackup),
                h('div',{style:{fontSize:11,color:C.textS}},t.allSettings)
              )
            ),
            h('div',{style:{fontSize:12,color:C.textS,marginBottom:8}},t.backupIncludes+':'),
            h('div',{style:{display:'flex',flexWrap:'wrap',gap:4,marginBottom:12}},
              ['‚öôÔ∏è '+t.settingsData,'üìì '+t.journalData,'üì± '+t.socialData].map(function(item,i){
                return h('span',{key:i,style:{fontSize:10,padding:'2px 8px',background:C.bg,borderRadius:4,color:C.textS}},item);
              })
            ),
            h('button',{style:{width:'100%',padding:10,background:exportLoading==='backup'?C.warnL:C.warn,border:'none',borderRadius:8,color:'#000',fontWeight:600,cursor:'pointer'}},exportLoading==='backup'?'‚è≥ '+t.generating:'üíæ '+t.downloadBackup)
          )
        ),

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üèõÔ∏è DGFIP CERTIFIED FISCAL EXPORT MODULE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        h('div',{style:Object.assign({},section,{marginBottom:20,border:'2px solid '+(theme==='light'||theme==='paper'?'#3b82f6':'#1e3a5f'),background:theme==='light'||theme==='paper'?'linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%)':'linear-gradient(135deg,#0f172a 0%,#1e293b 100%)'})},
          // Header
          h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:20}},
            h('div',{style:{width:48,height:48,background:'linear-gradient(135deg,#3b82f6,#1d4ed8)',borderRadius:12,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24}},'üèõÔ∏è'),
            h('div',null,
              h('div',{style:{fontSize:18,fontWeight:700,color:C.text}},t.fiscalTitle || 'Fiscalit√© & Conformit√© (DGFIP)'),
              h('div',{style:{fontSize:12,color:C.textS}},t.fiscalSubtitle || 'Export certifi√© pour administration fiscale')
            ),
            h('div',{style:{marginLeft:'auto',padding:'4px 12px',background:'rgba(34,197,94,0.2)',borderRadius:20,fontSize:11,fontWeight:600,color:'#22c55e'}},'üîí Audit Grade')
          ),
          
          // Period Selection
          h('div',{style:{marginBottom:20}},
            h('div',{style:{fontSize:13,fontWeight:600,marginBottom:10,color:C.text}},t.fiscalPeriod || 'P√©riode Fiscale'),
            h('div',{style:{display:'flex',gap:8,flexWrap:'wrap',marginBottom:12}},
              [
                ['year', t.fiscalYear || 'Ann√©e Fiscale N-1 (2024)', 'üìÖ'],
                ['ytd', t.fiscalYtd || 'Year to Date', 'üìà'],
                ['lastMonth', t.fiscalLastMonth || 'Mois Dernier', 'üóìÔ∏è'],
                ['custom', t.fiscalCustom || 'Personnalis√©', '‚öôÔ∏è']
              ].map(function(item) {
                var isActive = fiscalPeriodPreset === item[0];
                return h('button',{
                  key: item[0],
                  onClick: function() { setFiscalPeriodPreset(item[0]); },
                  style: {
                    padding: '10px 16px',
                    background: isActive ? 'linear-gradient(135deg,#3b82f6,#1d4ed8)' : C.bg,
                    border: '1px solid ' + (isActive ? 'transparent' : C.border),
                    borderRadius: 10,
                    color: isActive ? '#fff' : C.text,
                    fontSize: 12,
                    fontWeight: 600,
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 6,
                    transition: 'all .2s'
                  }
                }, item[2] + ' ' + item[1]);
              })
            ),
            // Custom date range
            fiscalPeriodPreset === 'custom' && h('div',{style:{display:'flex',flexDirection:isMobile?'column':'row',gap:isMobile?8:12,flexWrap:'wrap',padding:12,background:C.bg,borderRadius:8,marginTop:8}},
              h('div',null,
                h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.startDate || 'Date D√©but'),
                h('input',{type:'date',value:fiscalCustomStart,onChange:function(e){setFiscalCustomStart(e.target.value);},style:{padding:'8px 12px',background:C.card,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:13}})
              ),
              h('div',null,
                h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.endDate || 'Date Fin'),
                h('input',{type:'date',value:fiscalCustomEnd,onChange:function(e){setFiscalCustomEnd(e.target.value);},style:{padding:'8px 12px',background:C.card,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:13}})
              )
            )
          ),
          
          // Expert Mode Toggle
          h('div',{style:{padding:16,background:C.bg,borderRadius:12,marginBottom:20}},
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
              h('div',null,
                h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                  h('span',{style:{fontSize:14}},'‚ö°'),
                  h('span',{style:{fontWeight:600,color:C.text}},t.fiscalExpertMode || 'Mode Expert'),
                  h('span',{style:{fontSize:11,padding:'2px 8px',background:fiscalAggregateFunding?'rgba(34,197,94,0.2)':'rgba(239,68,68,0.2)',borderRadius:10,color:fiscalAggregateFunding?'#22c55e':'#ef4444',fontWeight:600}},fiscalAggregateFunding?'ON':'OFF')
                ),
                h('div',{style:{fontSize:12,color:C.textS,marginTop:4}},t.fiscalAggregate || 'Regrouper le Funding Journalier')
              ),
              h('button',{
                onClick: function() { setFiscalAggregateFunding(!fiscalAggregateFunding); },
                style: {
                  width: 52,
                  height: 28,
                  borderRadius: 14,
                  border: 'none',
                  background: fiscalAggregateFunding ? '#22c55e' : C.border,
                  cursor: 'pointer',
                  position: 'relative',
                  transition: 'background .2s'
                }
              },
                h('span',{style:{position:'absolute',top:2,left:fiscalAggregateFunding?26:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'}})
              )
            ),
            h('div',{style:{fontSize:11,color:C.textS,marginTop:8,padding:'8px 12px',background:theme==='light'||theme==='paper'?'rgba(59,130,246,0.05)':'rgba(59,130,246,0.1)',borderRadius:8,borderLeft:'3px solid #3b82f6'}},
              'üí° ' + (t.fiscalAggregateDesc || 'R√©duit le volume de 95% en sommant les micro-paiements horaires par jour')
            )
          ),
          
          // Generate Button
          h('div',{style:{marginBottom:20}},
            h('button',{
              onClick: function() { if(!fiscalExportStep) generateFiscalExport(); },
              disabled: !!fiscalExportStep,
              style: {
                width: '100%',
                padding: 16,
                background: fiscalExportStep ? 'linear-gradient(135deg,#64748b,#475569)' : 'linear-gradient(135deg,#22c55e,#16a34a)',
                border: 'none',
                borderRadius: 12,
                color: '#fff',
                fontSize: 15,
                fontWeight: 700,
                cursor: fiscalExportStep ? 'wait' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 10,
                boxShadow: fiscalExportStep ? 'none' : '0 4px 14px rgba(34,197,94,0.4)',
                transition: 'all .2s'
              }
            },
              fiscalExportStep ? h('span',{style:{display:'flex',alignItems:'center',gap:10}},
                h('span',{style:{animation:'spin 1s linear infinite',display:'inline-block'}},'‚è≥'),
                fiscalExportStep === 'fetching' ? (t.fiscalFetching || 'R√©cup√©ration des donn√©es...') :
                fiscalExportStep === 'converting' ? (t.fiscalConverting || 'Conversion EUR (Oracle)...') :
                fiscalExportStep === 'signing' ? (t.fiscalSigning || 'Signature SHA-256...') :
                (t.fiscalDone || '‚úÖ Export pr√™t!')
              ) : h('span',null,'üîê ' + (t.fiscalGenerate || 'G√âN√âRER EXPORT CERTIFI√â (.CSV)'))
            ),
            // Progress steps indicator
            fiscalExportStep && h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:12,padding:'0 20px'}},
              ['fetching','converting','signing','done'].map(function(step, idx) {
                var isActive = fiscalExportStep === step;
                var isPast = ['fetching','converting','signing','done'].indexOf(fiscalExportStep) > idx;
                return h('div',{key:step,style:{display:'flex',alignItems:'center',gap:6}},
                  h('div',{style:{width:24,height:24,borderRadius:12,background:isPast?'#22c55e':isActive?'#3b82f6':C.border,display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,color:'#fff',fontWeight:600}},
                    isPast ? '‚úì' : (idx + 1)
                  ),
                  idx < 3 && h('div',{style:{width:40,height:2,background:isPast?'#22c55e':C.border}})
                );
              })
            )
          ),
          
          // Export History Table
          h('div',{style:{marginBottom:20}},
            h('div',{style:{fontSize:13,fontWeight:600,marginBottom:10,display:'flex',alignItems:'center',gap:8}},
              h('span',null,'üìã'),
              h('span',null,t.fiscalHistory || 'Historique & Preuve')
            ),
            fiscalExportHistory.length > 0 ? h('div',{style:{overflowX:'auto'}},
              h('table',{style:{width:'100%',borderCollapse:'collapse',fontSize:12}},
                h('thead',null,
                  h('tr',{style:{background:C.bg}},
                    h('th',{style:{padding:10,textAlign:'left',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600}},t.fiscalDate || 'Date'),
                    h('th',{style:{padding:10,textAlign:'left',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600}},t.fiscalPeriodCol || 'P√©riode'),
                    h('th',{style:{padding:10,textAlign:'left',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600}},'Trades'),
                    h('th',{style:{padding:10,textAlign:'left',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600}},'PnL EUR'),
                    h('th',{style:{padding:10,textAlign:'left',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600,maxWidth:200}},t.fiscalHash || 'Hash SHA-256'),
                    h('th',{style:{padding:10,textAlign:'center',borderBottom:'1px solid '+C.border,color:C.textS,fontWeight:600}},t.fiscalAction || 'Action')
                  )
                ),
                h('tbody',null,
                  fiscalExportHistory.map(function(exp, idx) {
                    return h('tr',{key:idx,style:{background:idx%2===0?'transparent':C.bg}},
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,color:C.text}},exp.date.slice(0,10)),
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,color:C.text}},exp.period),
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,color:C.text}},exp.trades),
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,color:exp.pnlEur>=0?'#22c55e':'#ef4444',fontWeight:600}},exp.pnlEur + ' ‚Ç¨'),
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,fontFamily:'monospace',fontSize:10,color:C.textS,maxWidth:200,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},exp.hash.slice(0,24) + '...'),
                      h('td',{style:{padding:10,borderBottom:'1px solid '+C.border,textAlign:'center'}},
                        h('button',{
                          onClick: function() { 
                            navigator.clipboard.writeText(exp.hash);
                            notify('success', t.copied || 'Copi√©!');
                          },
                          style:{padding:'4px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,fontSize:11,cursor:'pointer',color:C.text}
                        },'üìã Hash')
                      )
                    );
                  })
                )
              )
            ) : h('div',{style:{padding:24,textAlign:'center',background:C.bg,borderRadius:8,color:C.textS}},
              h('div',{style:{fontSize:32,marginBottom:8}},'üì≠'),
              h('div',null,t.fiscalNoHistory || 'Aucun export certifi√©')
            )
          ),
          
          // Legal Disclaimer
          h('div',{style:{padding:14,background:theme==='light'||theme==='paper'?'rgba(234,179,8,0.05)':'rgba(234,179,8,0.1)',borderRadius:10,border:'1px solid rgba(234,179,8,0.3)'}},
            h('div',{style:{display:'flex',gap:10}},
              h('span',{style:{fontSize:18}},'‚öñÔ∏è'),
              h('div',{style:{fontSize:11,color:C.textS,lineHeight:1.5}},
                t.fiscalDisclaimer || 'CERTIFICATION: Ce document est g√©n√©r√© algorithmiquement bas√© sur la blockchain et les donn√©es exchange. La signature SHA-256 garantit qu\'il n\'a pas √©t√© alt√©r√© apr√®s g√©n√©ration. Trinity ne remplace pas un expert-comptable agr√©√©.'
              )
            )
          )
        ),

        // Tax Report Section
        h('div',{style:Object.assign({},section,{marginBottom:20})},
          h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:16}},
            h('span',{style:{fontSize:20}},'üßæ'),
            h('span',{style:{fontSize:16,fontWeight:700}},t.exportTax)
          ),
          h('div',{style:{display:'flex',gap:16,flexWrap:'wrap',alignItems:'flex-end'}},
            h('div',null,
              h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.taxYear),
              h('select',{value:taxYear,onChange:function(e){setTaxYear(parseInt(e.target.value));},style:{padding:'10px 16px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:14}},
                [2024,2025,2026].map(function(y){return h('option',{key:y,value:y},y);})
              )
            ),
            h('div',null,
              h('label',{style:{fontSize:11,color:C.textS,display:'block',marginBottom:4}},t.taxFormat),
              h('select',{value:taxFormat,onChange:function(e){setTaxFormat(e.target.value);},style:{padding:'10px 16px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,color:C.text,fontSize:14}},
                h('option',{value:'generic'},t.taxGeneric),
                h('option',{value:'french'},t.taxFrench)
              )
            ),
            h('button',{onClick:function(){if(!exportLoading)exportTaxReport();},style:{padding:'10px 24px',background:exportLoading==='tax'?C.warnL:C.accent,border:'none',borderRadius:8,color:exportLoading==='tax'?C.warn:C.bg,fontWeight:600,cursor:'pointer'}},exportLoading==='tax'?'‚è≥ '+t.generating:'üßæ '+t.exportTax)
          )
        ),

        // Import Section
        h('div',{style:section},
          h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:16}},
            h('span',{style:{fontSize:20}},'üì•'),
            h('span',{style:{fontSize:16,fontWeight:700}},t.importBackup)
          ),
          h('div',{style:{border:'2px dashed '+C.border,borderRadius:12,padding:32,textAlign:'center',background:C.bg}},
            h('div',{style:{fontSize:32,marginBottom:8}},'üìÅ'),
            h('div',{style:{marginBottom:12,color:C.textS}},t.selectFile+' '+t.dragDrop),
            h('input',{type:'file',accept:'.json',onChange:function(e){if(e.target.files[0]){if(confirm(t.confirmImport)){importBackup(e.target.files[0]);}}},style:{display:'none'},id:'import-file'}),
            h('label',{htmlFor:'import-file',style:{display:'inline-block',padding:'12px 24px',background:C.card,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontWeight:600}},'üìÇ '+t.selectFile)
          ),
          h('div',{style:{marginTop:12,fontSize:11,color:C.textS,textAlign:'center'}},'‚ö†Ô∏è '+t.confirmImport.split('.')[0])
        )
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ON-CHAIN REGIME TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    tab==='onchain' && (function(){
      // Detailed metrics from REST cache (fetched on tab open via global)
      var ocCache = window._ocCache || {};
      var metrics = ocCache.metrics || {};
      var details = ocCache.details || {};
      var effects = ocCache.effects || {};
      var lastUpdate = ocCache.last_update || null;

      // Read from bot status (fetchAll), with REST cache fallback
      var regime = activeBot.onchain_regime || ocCache.regime || 'NEUTRAL';
      var score = activeBot.onchain_score != null ? activeBot.onchain_score : (ocCache.score != null ? ocCache.score : 0);
      var enabled = activeBot.onchain_enabled || ocCache.enabled || false;

      // Trigger async fetch for detailed metrics (stores in global, no hooks)
      // Refresh every 60s while tab is open
      var ocStale = !window._ocLastFetch || (Date.now() - window._ocLastFetch > 60000);
      if (!window._ocFetching && ocStale) {
        window._ocFetching = true;
        fetchApi('/api/onchain/status')
          .then(function(d){ window._ocCache = d; window._ocFetching = false; window._ocLastFetch = Date.now(); })
          .catch(function(){ window._ocFetching = false; window._ocLastFetch = Date.now(); });
      }

      // Regime colors
      var regimeColors = {
        'EXTREME_FEAR': '#22c55e',
        'FEAR': '#86efac',
        'NEUTRAL': '#94a3b8',
        'GREED': '#fbbf24',
        'EXTREME_GREED': '#ef4444'
      };
      var regimeLabels = {
        'EXTREME_FEAR': 'EXTREME FEAR',
        'FEAR': 'FEAR',
        'NEUTRAL': 'NEUTRAL',
        'GREED': 'GREED',
        'EXTREME_GREED': 'EXTREME GREED'
      };
      var regimeDescriptions = {
        'EXTREME_FEAR': t.onchainInd10,
        'FEAR': t.onchainInd10,
        'NEUTRAL': t.onchainNeutralDesc,
        'GREED': t.onchainInd10Dist,
        'EXTREME_GREED': t.onchainInd10Dist
      };
      var regimeColor = regimeColors[regime] || C.textS;

      // Regime effects on trading parameters
      var regimeEffects = {
        'EXTREME_FEAR': {risk:1.2, tp:1.2, longBonus:2, shortPenalty:1},
        'FEAR': {risk:1.1, tp:1.1, longBonus:1, shortPenalty:0},
        'NEUTRAL': {risk:1.0, tp:1.0, longBonus:0, shortPenalty:0},
        'GREED': {risk:0.8, tp:0.7, longBonus:-1, shortPenalty:-1},
        'EXTREME_GREED': {risk:0.6, tp:0.6, longBonus:-3, shortPenalty:-3}
      };
      var currentEffects = regimeEffects[regime] || regimeEffects['NEUTRAL'];

      // Metric display config
      var metricConfig = [
        {key:'metric_1', label:t.onchainInd1, range:'0-100', desc:t.onchainDescInd1},
        {key:'metric_2', label:t.onchainInd2, range:'0-100', desc:t.onchainDescInd2},
        {key:'metric_3', label:t.onchainInd3, range:'-1 to 7+', desc:t.onchainDescInd3},
        {key:'metric_4', label:t.onchainInd4, range:'0.9-1.1', desc:t.onchainDescInd4},
        {key:'metric_5', label:t.onchainInd5, range:'-0.5 to 1', desc:t.onchainDescInd5},
        {key:'metric_6', label:t.onchainInd6, range:'0-5', desc:t.onchainDescInd6},
        {key:'metric_7', label:t.onchainInd7, range:'0-0.05', desc:t.onchainDescInd7},
        {key:'metric_8', label:t.onchainInd8b, range:'-10K to 10K', desc:t.onchainDescInd8b},
        {key:'metric_9', label:t.onchainInd9, range:'0.5-2.5', desc:t.onchainDescInd9}
      ];

      // Score bar position (-30 to +30 range mapped to 0-100%)
      var scorePercent = Math.max(0, Math.min(100, ((score + 30) / 60) * 100));

      // Score color helper for individual metrics
      function scoreColor(s) {
        if (s <= -2) return '#22c55e';
        if (s === -1) return '#86efac';
        if (s === 0) return '#94a3b8';
        if (s === 1) return '#fbbf24';
        if (s >= 2) return '#ef4444';
        return C.textS;
      }
      function scoreLabel(s) {
        if (s <= -2) return t.onchainScoreFear;
        if (s === -1) return t.onchainScoreCautious;
        if (s === 0) return t.onchainScoreNeutral;
        if (s === 1) return t.onchainScoreWarm;
        if (s >= 2) return t.onchainScoreGreed;
        return '?';
      }

      // No loading state needed ‚Äî WS data is always available

      return h('div',{style:{overflowX:'hidden',maxWidth:'100%'}},
        // Header
        h('div',{style:Object.assign({},section,{marginBottom:20})},
          h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:12}},
            h('div',{style:{display:'flex',alignItems:'center',gap:12}},
              h('span',{style:{fontSize:28}},'üîó'),
              h('span',{style:{fontSize:24,fontWeight:700}},t.onchainTitle)
            ),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('div',{style:{width:10,height:10,borderRadius:5,background:enabled?'#22c55e':'#ef4444'}}),
              h('span',{style:{fontSize:12,color:C.textS}},enabled?t.onchainActive:'DISABLED'),
              lastUpdate && h('span',{style:{fontSize:11,color:C.textS,marginLeft:8}},'| '+t.onchainLastUpdate+': '+new Date(lastUpdate).toLocaleTimeString())
            )
          ),
          h('div',{style:{fontSize:13,color:C.textS,marginTop:8}},t.onchainSubtitle)
        ),

        // Row 1: Regime Gauge + Composite Score
        h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},

          // Regime Gauge card
          h('div',{style:Object.assign({},section,{textAlign:'center',position:'relative',overflow:'hidden'})},
            h('div',{style:{position:'absolute',top:0,left:0,right:0,height:4,background:regimeColor}}),
            h('div',{style:{fontSize:13,fontWeight:600,color:C.textS,marginBottom:12,marginTop:8}},t.onchainCurrentRegime),
            h('div',{style:{fontSize:36,fontWeight:800,color:regimeColor,letterSpacing:2,marginBottom:8}},regimeLabels[regime]||regime),
            h('div',{style:{fontSize:13,color:C.textS,marginBottom:16}},regimeDescriptions[regime]||''),
            // Regime scale
            h('div',{style:{display:'flex',justifyContent:'center',gap:4,marginBottom:8}},
              ['EXTREME_FEAR','FEAR','NEUTRAL','GREED','EXTREME_GREED'].map(function(r){
                var isActive = r === regime;
                return h('div',{key:r,style:{width:isActive?48:32,height:8,borderRadius:4,background:isActive?regimeColors[r]:regimeColors[r]+'40',transition:'all .3s'}});
              })
            ),
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,color:C.textS,padding:'0 8px'}},
              h('span',null,t.onchainBuy),
              h('span',null,t.onchainSell)
            )
          ),

          // Composite Score card
          h('div',{style:Object.assign({},section,{textAlign:'center'})},
            h('div',{style:{fontSize:13,fontWeight:600,color:C.textS,marginBottom:12}},t.onchainCompositeScore),
            h('div',{style:{fontSize:56,fontWeight:800,color:regimeColor,marginBottom:4}},score > 0 ? '+'+score : score),
            h('div',{style:{fontSize:12,color:C.textS,marginBottom:16}},t.onchainScoreRange),
            // Score bar
            h('div',{style:{position:'relative',height:12,background:C.bg,borderRadius:6,overflow:'hidden',marginBottom:8}},
              // Gradient background
              h('div',{style:{position:'absolute',top:0,left:0,right:0,bottom:0,background:'linear-gradient(90deg, #22c55e, #86efac, #94a3b8, #fbbf24, #ef4444)',opacity:0.3,borderRadius:6}}),
              // Pointer
              h('div',{style:{position:'absolute',top:-2,left:'calc('+scorePercent+'% - 8px)',width:16,height:16,borderRadius:8,background:regimeColor,border:'2px solid '+C.card,boxShadow:'0 2px 6px rgba(0,0,0,.3)',transition:'left .5s'}})
            ),
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,color:C.textS}},
              h('span',null,'-30 ('+t.onchainFearLabel+')'),
              h('span',null,'0'),
              h('span',null,'+30 ('+t.onchainGreedLabel+')')
            )
          )
        ),

        // Row 2: Effects on trading
        h('div',{style:Object.assign({},section,{marginBottom:16})},
          h('div',{style:{fontSize:14,fontWeight:700,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
            h('span',null,'‚ö°'),
            h('span',null,t.onchainEffects)
          ),
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(2,1fr)':'repeat(4,1fr)',gap:12}},
            // Risk mult
            h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.onchainRiskMult),
              h('div',{style:{fontSize:24,fontWeight:700,color:currentEffects.risk>1?'#22c55e':currentEffects.risk<1?'#ef4444':C.textS}},'x'+currentEffects.risk.toFixed(1)),
              h('div',{style:{fontSize:10,color:C.textS}},currentEffects.risk>1?t.onchainSizeBoosted:t.onchainSizeReduced)
            ),
            // TP mult
            h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},t.onchainTpMult),
              h('div',{style:{fontSize:24,fontWeight:700,color:currentEffects.tp>1?'#22c55e':currentEffects.tp<1?'#ef4444':C.textS}},'x'+currentEffects.tp.toFixed(2)),
              h('div',{style:{fontSize:10,color:C.textS}},currentEffects.tp>1?t.onchainTargetsExtended:t.onchainTargetsTightened)
            ),
            // Long score bonus
            h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},'Long '+t.onchainScoreBonus),
              h('div',{style:{fontSize:24,fontWeight:700,color:currentEffects.longBonus>0?'#22c55e':currentEffects.longBonus<0?'#ef4444':C.textS}},(currentEffects.longBonus>=0?'+':'')+currentEffects.longBonus),
              h('div',{style:{fontSize:10,color:C.textS}},currentEffects.longBonus>0?t.onchainLongsFavored:t.onchainLongsPenalized)
            ),
            // Short score bonus
            h('div',{style:{background:C.bg,borderRadius:10,padding:14,textAlign:'center'}},
              h('div',{style:{fontSize:11,color:C.textS,marginBottom:4}},'Short '+t.onchainScoreBonus),
              h('div',{style:{fontSize:24,fontWeight:700,color:currentEffects.shortPenalty<0?'#22c55e':currentEffects.shortPenalty>0?'#ef4444':C.textS}},(currentEffects.shortPenalty>=0?'+':'')+currentEffects.shortPenalty),
              h('div',{style:{fontSize:10,color:C.textS}},currentEffects.shortPenalty<0?t.onchainShortsFavored:t.onchainShortsPenalized)
            )
          ),
          // Feature flags
          effects && Object.keys(effects).length > 0 && h('div',{style:{display:'flex',flexWrap:'wrap',gap:8,marginTop:12}},
            Object.keys(effects).map(function(k){
              var label = k.replace(/_/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});
              return h('span',{key:k,style:{padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:600,background:effects[k]?'rgba(34,197,94,.15)':'rgba(239,68,68,.15)',color:effects[k]?'#22c55e':'#ef4444'}},
                (effects[k]?'ON':'OFF')+' '+label
              );
            })
          )
        ),

        // Row 3: Individual Metrics Grid
        h('div',{style:Object.assign({},section,{marginBottom:16})},
          h('div',{style:{fontSize:14,fontWeight:700,marginBottom:16,display:'flex',alignItems:'center',gap:8}},
            h('span',null,'üìä'),
            h('span',null,t.onchainMetrics)
          ),
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'repeat(3,1fr)',gap:12}},
            metricConfig.map(function(mc){
              var rawVal = metrics[mc.key];
              var metricScore = details[mc.key];
              var hasData = rawVal !== undefined && rawVal !== null;

              return h('div',{key:mc.key,style:{background:C.bg,borderRadius:10,padding:14,borderLeft:'3px solid '+(hasData?scoreColor(metricScore||0):C.border)}},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}},
                  h('div',{style:{fontSize:13,fontWeight:600,color:C.text}},mc.label),
                  hasData && metricScore !== undefined && h('span',{style:{padding:'2px 8px',borderRadius:4,fontSize:10,fontWeight:700,background:scoreColor(metricScore)+'20',color:scoreColor(metricScore)}},
                    (metricScore>=0?'+':'')+metricScore+' '+scoreLabel(metricScore)
                  )
                ),
                h('div',{style:{fontSize:22,fontWeight:700,color:hasData?C.text:C.textS,marginBottom:4}},
                  hasData ? (typeof rawVal === 'number' ? (Math.abs(rawVal)<0.01 ? rawVal.toExponential(2) : rawVal<100 ? rawVal.toFixed(4) : rawVal.toFixed(1)) : String(rawVal)) : '--'
                ),
                h('div',{style:{fontSize:10,color:C.textS}},mc.desc+' ('+mc.range+')')
              );
            })
          )
        ),

        // Row 4: Composite Index Spotlight (if available)
        metrics.metric_1 !== undefined && h('div',{style:Object.assign({},section,{marginBottom:16,background:'linear-gradient(135deg,'+C.card+','+C.bg+')'})},
          h('div',{style:{display:'flex',alignItems:'center',gap:16,flexWrap:'wrap'}},
            h('div',{style:{flex:'0 0 auto'}},
              h('div',{style:{width:100,height:100,borderRadius:50,border:'4px solid '+(metrics.metric_1<30?'#22c55e':metrics.metric_1>70?'#ef4444':'#fbbf24'),display:'flex',alignItems:'center',justifyContent:'center',flexDirection:'column'}},
                h('div',{style:{fontSize:28,fontWeight:800,color:metrics.metric_1<30?'#22c55e':metrics.metric_1>70?'#ef4444':'#fbbf24'}},Math.round(metrics.metric_1)),
                h('div',{style:{fontSize:9,color:C.textS,fontWeight:600}},'/ 100')
              )
            ),
            h('div',{style:{flex:1,minWidth:200}},
              h('div',{style:{fontSize:18,fontWeight:700,marginBottom:4}},t.onchainInd1Title),
              h('div',{style:{fontSize:13,color:C.textS,marginBottom:8}},t.onchainInd1Desc),
              h('div',{style:{height:8,background:C.bg,borderRadius:4,overflow:'hidden'}},
                h('div',{style:{width:metrics.metric_1+'%',height:'100%',borderRadius:4,background:'linear-gradient(90deg, #22c55e, #86efac, #fbbf24, #ef4444)',transition:'width .5s'}})
              ),
              h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,color:C.textS,marginTop:4}},
                h('span',null,t.onchainBuyZone),
                h('span',null,t.onchainNeutralZone),
                h('span',null,t.onchainSellZone)
              )
            )
          )
        ),

        // Cycle Top Warning Card
        (function(){
          var pi = (ocCache.cycle_indicator) || {};
          var gap = pi.gap_pct;
          var level = pi.warning_level || 'SAFE';
          var signalA = pi.signal_a;
          var signalB = pi.signal_b;
          var btcPrice = pi.btc_price;
          if (!signalA) return null;

          var levelColors = {
            'SAFE': {bg:'rgba(34,197,94,0.1)', border:'rgba(34,197,94,0.3)', text:'#22c55e', icon:'üü¢'},
            'WATCH': {bg:'rgba(234,179,8,0.1)', border:'rgba(234,179,8,0.3)', text:'#eab308', icon:'üü°'},
            'WARNING': {bg:'rgba(249,115,22,0.1)', border:'rgba(249,115,22,0.3)', text:'#f97316', icon:'üü†'},
            'DANGER': {bg:'rgba(239,68,68,0.1)', border:'rgba(239,68,68,0.3)', text:'#ef4444', icon:'üî¥'},
            'CROSSED': {bg:'rgba(239,68,68,0.2)', border:'rgba(239,68,68,0.5)', text:'#ef4444', icon:'üíÄ'}
          };
          var lc = levelColors[level] || levelColors['SAFE'];

          return h('div',{style:{background:C.card,borderRadius:12,padding:16,marginBottom:16,border:'1px solid '+lc.border}},
            h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:12}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:20}},lc.icon),
                h('span',{style:{fontSize:16,fontWeight:700}},t.onchainInd8),
                h('span',{style:{fontSize:11,padding:'2px 8px',borderRadius:8,background:lc.bg,color:lc.text,fontWeight:600}},level)
              ),
              h('span',{style:{fontSize:12,color:C.textS}},t.onchainInd8History)
            ),
            // Signals and gap
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr 1fr':'1fr 1fr 1fr 1fr',gap:12,marginBottom:12}},
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:11,color:C.textS}},t.onchainBtcPrice),
                h('div',{style:{fontSize:14,fontWeight:700}},'$'+(btcPrice?btcPrice.toLocaleString():'‚Äî'))
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:11,color:C.textS}},'Signal A'),
                h('div',{style:{fontSize:14,fontWeight:700,color:'#3b82f6'}},'$'+(signalA?signalA.toLocaleString():'‚Äî'))
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:11,color:C.textS}},'Signal B'),
                h('div',{style:{fontSize:14,fontWeight:700,color:'#ef4444'}},'$'+(signalB?signalB.toLocaleString():'‚Äî'))
              ),
              h('div',{style:{textAlign:'center'}},
                h('div',{style:{fontSize:11,color:C.textS}},t.onchainGap),
                h('div',{style:{fontSize:14,fontWeight:700,color:lc.text}},gap!=null?gap.toFixed(1)+'%':'‚Äî')
              )
            ),
            // Gap visual bar
            h('div',{style:{position:'relative',height:12,background:C.bg,borderRadius:6,overflow:'hidden'}},
              // Gradient from danger (left) to safe (right)
              h('div',{style:{width:'100%',height:'100%',background:'linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e)',opacity:0.3}}),
              // Marker for current gap position (0-30% range mapped to bar)
              gap!=null && h('div',{style:{position:'absolute',top:0,left:Math.min(100,Math.max(0,(gap/30)*100))+'%',width:3,height:'100%',background:'#fff',borderRadius:2,boxShadow:'0 0 4px rgba(255,255,255,0.5)'}})
            ),
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,color:C.textS,marginTop:4}},
              h('span',null,t.onchainInd8Crossed),
              h('span',null,t.onchainInd8WarningZone),
              h('span',null,t.onchainInd8Safe)
            ),
            // Alert message for dangerous levels
            level !== 'SAFE' && level !== 'WATCH' && h('div',{style:{marginTop:8,padding:8,background:lc.bg,borderRadius:8,fontSize:12,color:lc.text,fontWeight:600,textAlign:'center'}},
              level === 'CROSSED' ? '\uD83D\uDC80 '+t.onchainInd8AlertCrossed :
              level === 'DANGER' ? '\uD83D\uDD34 '+t.onchainInd8AlertDanger :
              '\uD83D\uDFE0 '+t.onchainInd8AlertWarning
            )
          );
        })(),

        // Info box
        !enabled && h('div',{style:{background:'rgba(234,179,8,0.1)',border:'1px solid rgba(234,179,8,0.3)',borderRadius:12,padding:16,textAlign:'center'}},
          h('div',{style:{fontSize:24,marginBottom:8}},'‚ö†Ô∏è'),
          h('div',{style:{fontSize:14,fontWeight:600,color:'#eab308',marginBottom:4}},t.onchainDisabled),
          h('div',{style:{fontSize:12,color:C.textS}},t.onchainEnableHint)
        )
      );
    })(),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRINITY ALTSEASON INDEX (TAI) TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    tab==='altseason' && (function(){
      // NO hooks ‚Äî use global cache pattern (same as on-chain tab)
      var taiCache = window._taiCache || null;
      var taiData = taiCache;
      var taiLoading = !taiCache && !window._taiFetchDone;
      var coinData = window._coinScannerCache || null;

      // Trigger async fetch for TAI + Coin Scanner (stores in global, 60s cache TTL)
      var _taiStale = !window._taiCache || (Date.now() - (window._taiLastFetch || 0)) > 60000;
      if (!window._taiFetching && _taiStale) {
        window._taiFetching = true;
        var monitorUrl = CONFIG.MONITOR_API_URL;
        if (monitorUrl) {
          Promise.all([
            fetch(monitorUrl+'/api/monitor/altseason').then(function(r){return r.json();}).catch(function(){return null;}),
            fetch(monitorUrl+'/api/monitor/coin-scanner').then(function(r){return r.json();}).catch(function(){return null;})
          ]).then(function(results){
            if(results[0] && !results[0].error) window._taiCache = results[0];
            if(results[1] && !results[1].error) window._coinScannerCache = results[1];
            window._taiFetching = false;
            window._taiFetchDone = true;
            window._taiLastFetch = Date.now();
          }).catch(function(){ window._taiFetching = false; window._taiFetchDone = true; });
        } else {
          window._taiFetching = false;
          window._taiFetchDone = true;
        }
      }

      var section = {background:C.card,borderRadius:16,padding:isMobile?14:20,border:'1px solid '+C.border,marginBottom:16};

      // Phase colors & emojis
      var phaseColors = {
        'PHASE_1':'#8B0000','PHASE_2':'#FF8C00','PHASE_3':'#FFD700',
        'PHASE_4':'#32CD32','PHASE_5':'#00FF00','PHASE_6':'#FF0000'
      };
      var phaseEmojis = {
        'PHASE_1':'\uD83D\uDD34','PHASE_2':'\uD83D\uDFE0','PHASE_3':'\uD83D\uDFE1',
        'PHASE_4':'\uD83D\uDFE2','PHASE_5':'\uD83D\uDC9A','PHASE_6':'\uD83D\uDEA8'
      };
      var phaseLabels = {
        'PHASE_1':t.altseasonPhase1,'PHASE_2':t.altseasonPhase2,
        'PHASE_3':t.altseasonPhase3,'PHASE_4':t.altseasonPhase4,
        'PHASE_5':t.altseasonPhase5,'PHASE_6':t.altseasonPhase6
      };

      // Indicator labels for the grid
      var indicatorMeta = {
        'ind_a':{label:'Indicator A',icon:'\uD83D\uDCCA',desc:'Market structure metric'},
        'ind_b':{label:'Indicator B',icon:'\uD83D\uDCC9',desc:'Trend momentum'},
        'ind_c':{label:'Indicator C',icon:'\uD83C\uDFAF',desc:'Composite dominance'},
        'ind_d':{label:'Indicator D',icon:'\uD83D\uDD04',desc:'Pair ratio signal'},
        'ind_e':{label:'Indicator E',icon:'\uD83C\uDFC6',desc:'Breadth measure'},
        'ind_f':{label:'Indicator F',icon:'\uD83D\uDCCA',desc:'Trend direction'},
        'ind_g':{label:'Indicator G',icon:'\uD83D\uDCB5',desc:'Flow analysis'},
        'ind_h':{label:'Indicator H',icon:'\uD83D\uDCC8',desc:'Volume distribution'},
        'ind_i':{label:'Indicator I',icon:'\uD83D\uDE28',desc:'Sentiment gauge'},
        'ind_j':{label:'Indicator J',icon:'\uD83C\uDFE6',desc:'Equity correlation'},
        'ind_k':{label:'Indicator K',icon:'\u26A1',desc:'Volatility proxy'},
        'ind_l':{label:'Indicator L',icon:'\uD83D\uDCB2',desc:'Currency strength'},
        'ind_m':{label:'Indicator M',icon:'\uD83D\uDCC0',desc:'Risk appetite'},
        'ind_n':{label:'Indicator N',icon:'\uD83C\uDF0A',desc:'Liquidity conditions'}
      };

      // Indicator weights for display
      var weights = {
        'ind_a':8.2,'ind_b':6.5,'ind_c':9.1,'ind_d':7.3,
        'ind_e':5.8,'ind_f':7.4,'ind_g':6.9,'ind_h':8.5,
        'ind_i':5.2,'ind_j':7.8,'ind_k':9.3,'ind_l':6.1,'ind_m':4.6,'ind_n':7.3
      };

      // Playbook par phase
      var phasePlaybook = {
        'PHASE_1':{alloc:'80-100% Cash reserves | 0-20% Major assets | 0% Speculative',actions:['Stay in cash','Monitor key moving averages','Research future trends']},
        'PHASE_2':{alloc:'60-80% Major assets | 10-20% Secondary assets | 10-20% Cash reserves',actions:['Accumulate majors','Research emerging sectors','Avoid chasing pumps']},
        'PHASE_3':{alloc:'40-50% Major assets | 30-40% Growth assets | 10-20% Cash reserves',actions:['DCA into quality assets','Monitor key ratio signals','Build watchlist']},
        'PHASE_4':{alloc:'25-35% Major assets | 50-65% Growth assets | 5-10% Cash reserves',actions:['Increase growth exposure','Focus on strong sectors','Set trailing stops']},
        'PHASE_5':{alloc:'15-25% Major assets | 65-80% Growth assets | 5-10% Cash reserves',actions:['Maximum exposure','Diversify across sectors','Tighten trailing stops']},
        'PHASE_6':{alloc:'20-30% Major assets | 20-30% Select growth | 40-60% Cash reserves',actions:['Take profits 50%+','Rotate to safety','No new speculative entries']}
      };

      // Score color helper
      function scoreColor(v){
        if(v>=70) return '#22c55e';
        if(v>=50) return '#eab308';
        if(v>=30) return '#f97316';
        return '#ef4444';
      }

      // Loading
      if(taiLoading){
        return h('div',{style:{textAlign:'center',padding:60,color:C.textS}},
          h('div',{style:{fontSize:48,marginBottom:16,animation:'pulse 2s infinite'}},'\uD83C\uDF0A'),
          h('div',{style:{fontSize:16}},t.altseasonLoading)
        );
      }

      // No data
      if(!taiData){
        return h('div',{style:{textAlign:'center',padding:60,color:C.textS}},
          h('div',{style:{fontSize:48,marginBottom:16}},'\u26A0\uFE0F'),
          h('div',{style:{fontSize:16}},t.altseasonNoData)
        );
      }

      var score = taiData.score || 0;
      var phase = taiData.phase || 'UNKNOWN';
      var signal = taiData.signal || {};
      var subScores = taiData.sub_scores || {};
      var rawData = taiData.raw_data || {};
      var exitWarnings = taiData.exit_warnings || [];
      var confidence = taiData.confidence || 'LOW';
      var history24h = taiData.history_24h || [];
      var indicatorsAvail = taiData.indicators_available || 0;
      var indicatorsTotal = taiData.indicators_total || 13;
      var btcTrendScore = taiData.btc_trend_score;
      var timestamp = taiData.timestamp;
      var phaseColor = phaseColors[phase] || '#808080';
      var playbook = phasePlaybook[phase] || {};

      // Coin scanner data
      var csData = window._coinScannerCache || null;
      var buySignals = csData ? (csData.buy_signals || []) : [];
      var sellSignals = csData ? (csData.sell_signals || []) : [];
      var breakouts = csData ? (csData.individual_breakouts || []) : [];
      var trending = csData ? (csData.trending || []) : [];
      var sectors = csData ? (csData.sectors || {}) : {};

      return h('div',{style:{maxWidth:1200,margin:'0 auto'}},

        // Header
        h('div',{style:Object.assign({},section,{background:'linear-gradient(135deg,'+C.card+','+phaseColor+'15)',borderLeft:'4px solid '+phaseColor})},
          h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:12}},
            h('div',null,
              h('div',{style:{display:'flex',alignItems:'center',gap:12,marginBottom:4}},
                h('span',{style:{fontSize:28}},'\uD83C\uDF0A'),
                h('span',{style:{fontSize:22,fontWeight:800,color:C.text}},t.altseasonTitle)
              ),
              h('div',{style:{fontSize:13,color:C.textS}},
                t.altseasonConfidence+': ',
                h('span',{style:{fontWeight:700,color:confidence==='HIGH'?'#22c55e':confidence==='MEDIUM'?'#eab308':'#ef4444'}},confidence),
                ' ('+indicatorsAvail+'/'+indicatorsTotal+')',
                timestamp && h('span',{style:{marginLeft:12,fontSize:11}},' | '+t.altseasonLastUpdate+': '+new Date(timestamp).toLocaleTimeString())
              )
            ),
            h('div',{style:{textAlign:'center'}},
              h('div',{style:{fontSize:11,fontWeight:600,color:C.textS,marginBottom:2}},t.altseasonScore),
              h('div',{style:{fontSize:48,fontWeight:900,color:scoreColor(score),lineHeight:1}},Math.round(score)),
              h('div',{style:{fontSize:11,color:C.textS}},'/100')
            )
          )
        ),

        // Phase Timeline (top, prominent)
        h('div',{style:Object.assign({},section,{padding:0,overflow:'visible',borderRadius:12})},
          h('div',{className:'tai-timeline'},
            [
              {id:'PHASE_1',range:'0-20'},
              {id:'PHASE_2',range:'20-35'},
              {id:'PHASE_3',range:'35-50'},
              {id:'PHASE_4',range:'50-65'},
              {id:'PHASE_5',range:'65-85'},
              {id:'PHASE_6',range:'85-100'}
            ].map(function(p){
              var isActive = p.id === phase;
              var bg = phaseColors[p.id];
              var pb = phasePlaybook[p.id] || {};
              return h('div',{key:p.id,className:'tai-phase',style:{
                flex:1,padding:isActive?(isMobile?'12px 2px':'14px 6px'):(isMobile?'8px 2px':'10px 6px'),textAlign:'center',
                background:isActive ? bg : bg+'12',
                position:'relative',
                borderBottom:isActive ? '3px solid #fff' : '3px solid transparent',
                transform:isActive ? 'scale(1.05)' : 'scale(1)',
                zIndex:isActive ? 2 : 1,
                boxShadow:isActive ? '0 0 20px '+bg+'60' : 'none',
                transition:'all .3s'
              }},
                h('div',{style:{fontSize:isActive?20:12,marginBottom:2}},phaseEmojis[p.id]||''),
                h('div',{style:{fontSize:isMobile?8:10,fontWeight:isActive?800:400,color:isActive?'#fff':C.textS,marginTop:2,textTransform:'uppercase',letterSpacing:isActive?1:0}},
                  phaseLabels[p.id]||p.id
                ),
                h('div',{style:{fontSize:8,color:isActive?'rgba(255,255,255,.8)':C.textS,marginTop:1}},p.range),
                isActive && h('div',{style:{position:'absolute',bottom:-1,left:'50%',transform:'translateX(-50)',width:0,height:0,borderLeft:'6px solid transparent',borderRight:'6px solid transparent',borderBottom:'6px solid '+C.bg}}),
                // Tooltip with playbook
                !isMobile && h('div',{className:'tai-tip'},
                  h('div',{style:{fontSize:12,fontWeight:700,color:bg,marginBottom:6}},
                    (phaseEmojis[p.id]||'')+' '+(phaseLabels[p.id]||p.id)
                  ),
                  h('div',{style:{fontSize:10,color:'#94a3b8',marginBottom:4}},p.range+' pts'),
                  pb.alloc && h('div',{style:{fontSize:10,fontWeight:600,color:'#e2e8f0',marginBottom:8,padding:'4px 8px',background:bg+'20',borderRadius:4,borderLeft:'2px solid '+bg}},pb.alloc),
                  (pb.actions||[]).map(function(a,i){
                    return h('div',{key:i,style:{fontSize:10,color:'#cbd5e1',padding:'2px 0',lineHeight:1.4}},
                      (isActive?'\u25B6':'  \u2022')+' '+a
                    );
                  })
                )
              );
            })
          )
        ),

        // Row 1: Phase Gauge + Signal + Playbook
        h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},

          // Phase card
          h('div',{style:Object.assign({},section,{textAlign:'center',position:'relative',overflow:'hidden',marginBottom:0})},
            h('div',{style:{position:'absolute',top:0,left:0,right:0,height:4,background:phaseColor}}),
            h('div',{style:{fontSize:13,fontWeight:600,color:C.textS,marginBottom:12,marginTop:8}},t.altseasonPhase),
            h('div',{style:{fontSize:32,fontWeight:800,color:phaseColor,letterSpacing:1,marginBottom:8}},
              (phaseEmojis[phase]||'')+' '+(phaseLabels[phase]||phase)
            ),

            // Phase scale bar
            h('div',{style:{display:'flex',gap:3,marginBottom:8,justifyContent:'center'}},
              ['PHASE_1','PHASE_2','PHASE_3','PHASE_4','PHASE_5','PHASE_6'].map(function(p){
                var isActive = p === phase;
                return h('div',{key:p,title:phaseLabels[p]||p,style:{
                  width:isActive?48:28,height:10,borderRadius:5,
                  background:isActive?phaseColors[p]:(phaseColors[p]||'#555')+'40',
                  transition:'all .3s',cursor:'default'
                }});
              })
            ),
            h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:9,color:C.textS,padding:'0 16px'}},
              h('span',null,t.altseasonBearLabel),h('span',null,t.altseasonAltLabel)
            ),

            // Score gauge SVG ‚Äî speedometer style (arc curving upward)
            h('div',{style:{marginTop:16}},
              (function(){
                var pct = score / 100;
                var r = 60;
                var cx = 80, cy = 82;
                function polar(angleDeg){
                  var rad = angleDeg * Math.PI / 180;
                  return {x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad)};
                }
                // SVG y-axis is flipped: 180¬∞=left, 270¬∞=TOP, 360¬∞=right
                // Needle goes from 180¬∞ (score=0, BEAR) to 360¬∞ (score=100, ALT) clockwise through top
                var needleAngle = 180 + (pct * 180);
                var needle = polar(needleAngle);
                var arcStart = polar(180);  // left: (20, 82)
                // Colored background segments (clockwise, sweep=1)
                var segments = [
                  {from:180,to:216,color:'#ef4444'}, // 0-20: red
                  {from:216,to:243,color:'#f97316'}, // 20-35: orange
                  {from:243,to:270,color:'#eab308'}, // 35-50: yellow
                  {from:270,to:297,color:'#22c55e'}, // 50-65: green
                  {from:297,to:333,color:'#10b981'}, // 65-85: emerald
                  {from:333,to:360,color:'#8b5cf6'}  // 85-100: purple
                ];
                var bgPaths = segments.map(function(seg){
                  var s = polar(seg.from);
                  var e = polar(seg.to);
                  return h('path',{key:seg.from,d:'M '+s.x+' '+s.y+' A '+r+' '+r+' 0 0 1 '+e.x+' '+e.y,fill:'none',stroke:seg.color+'30',strokeWidth:12,strokeLinecap:'butt'});
                });
                // Active fill arc from left to needle (clockwise, sweep=1, always small arc)
                var fillArc = pct > 0.005 ? h('path',{d:'M '+arcStart.x+' '+arcStart.y+' A '+r+' '+r+' 0 0 1 '+needle.x+' '+needle.y,fill:'none',stroke:scoreColor(score),strokeWidth:12,strokeLinecap:'round'}) : null;
                return h('svg',{viewBox:'0 0 160 95',style:{width:'100%',maxWidth:220,margin:'0 auto',display:'block'}},
                  bgPaths,
                  fillArc,
                  h('circle',{cx:needle.x,cy:needle.y,r:7,fill:scoreColor(score),stroke:'#fff',strokeWidth:2,opacity:0.9}),
                  h('text',{x:cx,y:cy-18,textAnchor:'middle',fontSize:28,fontWeight:800,fill:scoreColor(score)},Math.round(score))
                );
              })()
            )
          ),

          // Signal + Playbook + Exit Warnings
          h('div',{style:{display:'flex',flexDirection:'column',gap:12}},

            // Signal box
            h('div',{style:Object.assign({},section,{marginBottom:0,textAlign:'center'})},
              h('div',{style:{fontSize:13,fontWeight:600,color:C.textS,marginBottom:8}},t.altseasonSignal),
              h('div',{style:{fontSize:28,marginBottom:4}},signal.emoji||'\u26AA'),
              h('div',{style:{fontSize:20,fontWeight:800,color:phaseColor,marginBottom:4}},signal.action||'--'),
              h('div',{style:{fontSize:12,color:C.textS}},
                t.altseasonUrgency+': ',
                h('span',{style:{fontWeight:700,color:signal.urgency==='HIGH'?'#ef4444':signal.urgency==='MEDIUM'?'#eab308':'#22c55e'}},signal.urgency||'--')
              )
            ),

            // Playbook card (QUOI FAIRE MAINTENANT)
            h('div',{style:Object.assign({},section,{marginBottom:0,background:'linear-gradient(135deg,'+C.card+','+phaseColor+'08)',borderLeft:'3px solid '+phaseColor})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:8}},
                h('span',{style:{fontSize:16}},'\uD83C\uDFAF'),
                h('span',{style:{fontSize:13,fontWeight:700,color:C.text}},t.altseasonPlaybookTitle)
              ),
              playbook.alloc && h('div',{style:{fontSize:11,color:'#fff',fontWeight:700,marginBottom:8,padding:'6px 10px',background:phaseColor+'40',borderRadius:6,border:'1px solid '+phaseColor+'60'}},playbook.alloc),
              (playbook.actions||[]).map(function(a,i){
                return h('div',{key:i,style:{fontSize:11,color:C.textS,padding:'2px 0'}},'\u2022 '+a);
              })
            ),

            // Exit Warnings
            exitWarnings.length > 0 && h('div',{style:Object.assign({},section,{marginBottom:0,background:'rgba(239,68,68,0.1)',borderColor:'rgba(239,68,68,0.4)'})},
              h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:8}},
                h('span',{style:{fontSize:20}},'\uD83D\uDEA8'),
                h('span',{style:{fontSize:14,fontWeight:700,color:'#ef4444'}},t.altseasonExitWarnings)
              ),
              exitWarnings.map(function(w,i){
                return h('div',{key:i,style:{padding:'6px 10px',marginTop:4,background:'rgba(239,68,68,0.08)',borderRadius:6,fontSize:12,color:'#fca5a5'}},'\u26A0\uFE0F '+w);
              })
            )
          )
        ),

        // Row 1b: BTC Trend Filter + Raw Data
        h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16,marginBottom:16}},
          // BTC Trend Filter
          h('div',{style:Object.assign({},section,{marginBottom:0})},
            h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:10}},
              h('span',{style:{fontSize:16}},'\u20BF'),
              h('span',{style:{fontSize:13,fontWeight:700,color:C.text}},t.altseasonBtcTrendFilter)
            ),
            h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,fontSize:12}},
              rawData.btc_price!=null && h('div',{style:{color:C.text}},'\uD83D\uDCB0 BTC: $'+rawData.btc_price.toFixed(0)),
              rawData.btc_ema200!=null && h('div',{style:{color:C.text}},'\uD83D\uDCC8 MA-200: $'+rawData.btc_ema200.toFixed(0)),
              btcTrendScore!=null && h('div',{style:{color:btcTrendScore>=50?'#22c55e':'#ef4444',fontWeight:700}},
                (btcTrendScore>=50?'\uD83D\uDFE2 BULL':'\uD83D\uDD34 BEAR')+' ('+btcTrendScore.toFixed(0)+')'
              ),
              rawData.btc_change_90d!=null && h('div',{style:{color:rawData.btc_change_90d>=0?'#22c55e':'#ef4444'}},'90j: '+(rawData.btc_change_90d>=0?'+':'')+rawData.btc_change_90d.toFixed(1)+'%')
            ),
            btcTrendScore!=null && h('div',{style:{marginTop:8}},
              h('div',{style:{fontSize:10,color:C.textS,marginBottom:2}},t.altseasonBullBearScore),
              h('div',{style:{height:6,background:C.border,borderRadius:3,overflow:'hidden'}},
                h('div',{style:{width:btcTrendScore+'%',height:'100%',background:btcTrendScore>=50?'#22c55e':'#ef4444',borderRadius:3}})
              )
            )
          ),

          // Raw data highlights
          h('div',{style:Object.assign({},section,{marginBottom:0})},
            h('div',{style:{fontSize:13,fontWeight:600,color:C.textS,marginBottom:10}},'\uD83D\uDCCA '+t.altseasonMarketData),
            h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:6,fontSize:12}},
              rawData.btc_dominance!=null && h('div',{style:{color:C.text}},'\u20BF BTC.D: '+rawData.btc_dominance.toFixed(1)+'%'),
              rawData.eth_btc!=null && h('div',{style:{color:C.text}},'\u039E Ratio D: '+rawData.eth_btc.toFixed(4)),
              rawData.stablecoin_share!=null && h('div',{style:{color:C.text}},'\uD83D\uDCB5 Metric E: '+rawData.stablecoin_share.toFixed(1)+'%'),
              rawData.fear_greed!=null && h('div',{style:{color:C.text}},'\uD83D\uDE28 Sentiment: '+rawData.fear_greed+' ('+(rawData.fear_greed_label||'')+')'),
              rawData.vix!=null && h('div',{style:{color:rawData.vix>30?'#ef4444':rawData.vix<20?'#22c55e':C.text}},'\u26A1 Metric F: '+rawData.vix.toFixed(1)),
              rawData.dxy!=null && h('div',{style:{color:C.text}},'\uD83D\uDCB2 DXY: '+rawData.dxy.toFixed(1)),
              rawData.spx!=null && h('div',{style:{color:C.text}},'\uD83C\uDFE6 SPX: '+rawData.spx.toFixed(0)),
              rawData.top50_beating_btc_pct!=null && h('div',{style:{color:C.text}},'\uD83C\uDFC6 Top50>BTC: '+(rawData.top50_beating_btc_pct*100).toFixed(0)+'%'),
              rawData.rs2k_spx_ratio!=null && h('div',{style:{color:C.text}},'\uD83D\uDCC0 RS2K/SPX: '+rawData.rs2k_spx_ratio.toFixed(3)),
              rawData.combined_dominance!=null && h('div',{style:{color:C.text}},'\uD83C\uDFAF Combined: '+rawData.combined_dominance.toFixed(1)+'%')
            )
          )
        ),

        // Row 2: Sub-Indicators Grid (14 indicators with RS2K)
        h('div',{style:section},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
            h('span',{style:{fontSize:20}},'\uD83D\uDD2C'),
            h('span',{style:{fontSize:16,fontWeight:700,color:C.text}},t.altseasonIndicators),
            h('span',{style:{fontSize:11,color:C.textS,marginLeft:8}},t.altseasonWeightsOpt)
          ),
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:10}},
            Object.keys(indicatorMeta).map(function(key){
              var meta = indicatorMeta[key];
              var val = subScores[key];
              var w = weights[key] || 0;
              var hasVal = val !== null && val !== undefined;
              var barColor = hasVal ? scoreColor(val) : C.border;
              var isKey = w >= 10;

              return h('div',{key:key,style:{background:C.bg,borderRadius:10,padding:12,borderLeft:'3px solid '+barColor,position:'relative',boxShadow:isKey?'0 0 0 1px '+barColor+'40':'none'}},
                h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}},
                  h('div',{style:{display:'flex',alignItems:'center',gap:4}},
                    h('span',{style:{fontSize:14}},meta.icon),
                    h('span',{style:{fontSize:12,fontWeight:isKey?700:600,color:C.text}},meta.label),
                    isKey && h('span',{style:{fontSize:8,background:barColor+'30',color:barColor,padding:'1px 4px',borderRadius:3,marginLeft:4,fontWeight:700}},'KEY')
                  ),
                  h('span',{style:{fontSize:10,color:C.textS,fontWeight:600}},w.toFixed(1)+'%')
                ),
                h('div',{style:{fontSize:24,fontWeight:800,color:hasVal?barColor:C.textS,marginBottom:4}},
                  hasVal ? Math.round(val) : '--'
                ),
                // Progress bar
                h('div',{style:{height:4,background:C.border,borderRadius:2,overflow:'hidden'}},
                  hasVal && h('div',{style:{width:(val||0)+'%',height:'100%',background:barColor,borderRadius:2,transition:'width .5s'}})
                ),
                h('div',{style:{fontSize:9,color:C.textS,marginTop:4}},meta.desc)
              );
            })
          )
        ),

        // Row 3: Coin Scanner ‚Äî BUY signals + Breakouts + Trending
        (buySignals.length > 0 || breakouts.length > 0 || trending.length > 0) && h('div',{style:section},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
            h('span',{style:{fontSize:20}},'\uD83D\uDE80'),
            h('span',{style:{fontSize:16,fontWeight:700,color:C.text}},t.altseasonCoinScanner),
            csData && csData.timestamp && h('span',{style:{fontSize:10,color:C.textS,marginLeft:8}},new Date(csData.timestamp).toLocaleTimeString())
          ),

          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr',gap:16}},

            // BUY signals
            buySignals.length > 0 && h('div',null,
              h('div',{style:{fontSize:13,fontWeight:700,color:'#22c55e',marginBottom:8}},'\uD83D\uDFE2 '+t.altseasonBuySignals+' ('+buySignals.length+')'),
              buySignals.slice(0,5).map(function(s,i){
                return h('div',{key:i,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 10px',marginBottom:4,background:C.bg,borderRadius:8,borderLeft:'3px solid #22c55e'}},
                  h('div',null,
                    h('span',{style:{fontSize:13,fontWeight:700,color:C.text}},s.symbol),
                    h('span',{style:{fontSize:10,color:C.textS,marginLeft:6}},s.name||''),
                    s.market_cap_rank && h('span',{style:{fontSize:9,color:C.textS,marginLeft:4}},'#'+s.market_cap_rank)
                  ),
                  h('div',{style:{textAlign:'right'}},
                    h('div',{style:{fontSize:12,fontWeight:700,color:'#22c55e'}},s.strength+'/100'),
                    h('div',{style:{fontSize:10,color:s.change_7d>=0?'#22c55e':'#ef4444'}},(s.change_7d>=0?'+':'')+s.change_7d.toFixed(0)+'% 7j')
                  )
                );
              })
            ),

            // SELL signals
            sellSignals.length > 0 && h('div',null,
              h('div',{style:{fontSize:13,fontWeight:700,color:'#ef4444',marginBottom:8}},'\uD83D\uDD34 '+t.altseasonSellSignals+' ('+sellSignals.length+')'),
              sellSignals.slice(0,5).map(function(s,i){
                return h('div',{key:i,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 10px',marginBottom:4,background:C.bg,borderRadius:8,borderLeft:'3px solid #ef4444'}},
                  h('div',null,
                    h('span',{style:{fontSize:13,fontWeight:700,color:C.text}},s.symbol),
                    h('span',{style:{fontSize:10,color:C.textS,marginLeft:6}},s.name||'')
                  ),
                  h('div',{style:{textAlign:'right'}},
                    h('div',{style:{fontSize:12,fontWeight:700,color:'#ef4444'}},t.altseasonUrgencyLabel+': '+(s.urgency_score||0)),
                    h('div',{style:{fontSize:10,color:'#ef4444'}},s.change_7d.toFixed(0)+'% 7j')
                  )
                );
              })
            )
          ),

          // Breakouts individuels (decorreleles)
          breakouts.length > 0 && h('div',{style:{marginTop:16}},
            h('div',{style:{fontSize:13,fontWeight:700,color:'#f97316',marginBottom:8}},'\uD83D\uDD25 '+t.altseasonBreakouts),
            h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'1fr':'1fr 1fr 1fr',gap:8}},
              breakouts.slice(0,6).map(function(bo,i){
                return h('div',{key:i,style:{background:C.bg,borderRadius:10,padding:10,borderLeft:'3px solid #f97316'}},
                  h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:4}},
                    h('span',{style:{fontSize:14,fontWeight:700,color:C.text}},bo.symbol),
                    h('span',{style:{fontSize:11,fontWeight:700,color:'#f97316'}},'+'+bo.outperform_7d+'% vs marche')
                  ),
                  h('div',{style:{fontSize:11,color:C.textS}},bo.name),
                  h('div',{style:{fontSize:11,color:'#22c55e',marginTop:2}},'7j: +'+(bo.change_7d||0).toFixed(0)+'% | 24h: '+(bo.change_24h>=0?'+':'')+(bo.change_24h||0).toFixed(0)+'%'),
                  (bo.reasons||[]).slice(0,2).map(function(r,j){
                    return h('div',{key:j,style:{fontSize:9,color:C.textS,marginTop:2}},'\u2022 '+r);
                  })
                );
              })
            )
          ),

          // Trending coins
          trending.length > 0 && h('div',{style:{marginTop:16}},
            h('div',{style:{fontSize:13,fontWeight:700,color:'#8b5cf6',marginBottom:8}},'\uD83D\uDD25 '+t.altseasonTrending),
            h('div',{style:{display:'flex',flexWrap:'wrap',gap:6}},
              trending.slice(0,8).map(function(tc,i){
                return h('div',{key:i,style:{background:C.bg,borderRadius:8,padding:'4px 10px',fontSize:11,color:C.text,border:'1px solid '+C.border}},
                  h('span',{style:{fontWeight:700}},tc.symbol),
                  tc.market_cap_rank && h('span',{style:{color:C.textS,marginLeft:4}},'#'+tc.market_cap_rank)
                );
              })
            )
          ),

          // Sectors
          Object.keys(sectors).length > 0 && h('div',{style:{marginTop:16}},
            h('div',{style:{fontSize:13,fontWeight:700,color:C.text,marginBottom:8}},'\uD83C\uDFED '+t.altseasonSectors),
            h('div',{style:{display:'flex',flexWrap:'wrap',gap:6}},
              Object.keys(sectors).map(function(sk){
                var s = sectors[sk];
                var sColor = s.status==='SURGING'?'#ef4444':s.status==='HOT'?'#f97316':'#666';
                return h('div',{key:sk,style:{background:sColor+'15',borderRadius:8,padding:'6px 12px',fontSize:12,color:sColor,border:'1px solid '+sColor+'40',fontWeight:600}},
                  sk+': '+(s.change_24h>=0?'+':'')+s.change_24h.toFixed(1)+'%'+(s.status!=='NORMAL'?' '+s.status:'')
                );
              })
            )
          )
        ),

        // Row 4: Score History (24h sparkline)
        history24h.length > 0 && h('div',{style:section},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
            h('span',{style:{fontSize:18}},'\uD83D\uDCC8'),
            h('span',{style:{fontSize:15,fontWeight:700,color:C.text}},t.altseasonHistory)
          ),
          (function(){
            var w = 600, barH = 100, barW = Math.floor(w / Math.max(history24h.length,1));
            var maxS = 100;
            return h('svg',{viewBox:'0 0 '+w+' '+(barH+20),style:{width:'100%',maxWidth:w}},
              history24h.map(function(pt,i){
                var bh = (pt.score / maxS) * barH;
                var col = scoreColor(pt.score);
                return h('g',{key:i},
                  h('rect',{x:i*barW+1,y:barH-bh,width:Math.max(barW-2,2),height:bh,fill:col,rx:2,opacity:0.8}),
                  (i % 4 === 0) && h('text',{x:i*barW+barW/2,y:barH+14,textAnchor:'middle',fontSize:8,fill:C.textS},pt.hour+'h')
                );
              }),
              h('line',{x1:0,y1:barH-50,x2:w,y2:barH-50,stroke:C.border,strokeDasharray:'4,4',strokeWidth:1}),
              h('text',{x:w-4,y:barH-52,textAnchor:'end',fontSize:8,fill:C.textS},'50')
            );
          })()
        ),

        // Row: ALEPH Watchlist Tracker
        (function(){
          var wl = csData ? (csData.watchlist || {}) : {};
          var aleph = wl['aleph-im'];
          if(!aleph) return null;
          var p = aleph.price || 0;
          var c24 = aleph.change_24h || 0;
          var c7 = aleph.change_7d || 0;
          var c30 = aleph.change_30d || 0;
          var athRec = aleph.ath_recovery_pct || 0;
          var refAth = aleph.ref_ath || 0.87;
          var exitAction = aleph.exit_action || 'HOLD';
          var exitNote = aleph.exit_note || '';
          var exitPct = aleph.exit_sell_pct || 0;
          var nextT = aleph.next_target;
          var inPD = aleph.in_price_discovery;
          var peak = aleph.peak_price || 0;
          var trailing = aleph.trailing_stop_pct || 30;
          var aiMom = aleph.ai_momentum || '';
          var aiPerf = aleph.ai_sector_perf || 0;
          var priceAlerts = aleph.price_alerts || [];
          var actionColor = exitAction==='SELL'?'#ef4444':exitAction==='PREPARE'?'#eab308':'#22c55e';
          var actionEmoji = exitAction==='SELL'?'\uD83D\uDCB0':exitAction==='PREPARE'?'\uD83D\uDD14':'\uD83D\uDCAA';

          return h('div',{style:Object.assign({},section,{background:'linear-gradient(135deg,'+C.card+',#8b5cf610)',borderLeft:'4px solid #8b5cf6'})},
            h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:12,flexWrap:'wrap'}},
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:22}},'\uD83D\uDC8E'),
                h('span',{style:{fontSize:17,fontWeight:800,color:C.text}},'ALEPH Tracker'),
                h('span',{style:{fontSize:11,color:'#8b5cf6',fontWeight:600}},'Aleph Cloud | AI/Cloud')
              ),
              h('div',{style:{textAlign:'right'}},
                h('div',{style:{fontSize:22,fontWeight:800,color:c24>=0?'#22c55e':'#ef4444'}},'$'+p.toFixed(4)),
                h('div',{style:{fontSize:10,color:C.textS}},t.altseasonAthRecovery+': '+athRec.toFixed(1)+'%')
              )
            ),
            // Price changes
            h('div',{style:{display:'flex',gap:16,marginBottom:12,flexWrap:'wrap'}},
              ['24h','7j','30j'].map(function(label,i){
                var val = [c24,c7,c30][i];
                return h('div',{key:label,style:{fontSize:12,color:val>=0?'#22c55e':'#ef4444',fontWeight:600}},
                  label+': '+(val>=0?'+':'')+val.toFixed(1)+'%'
                );
              }),
              aiPerf !== 0 && h('div',{style:{fontSize:12,color:aiPerf>5?'#22c55e':'#94a3b8',fontWeight:600}},
                '\uD83E\uDD16 AI: '+(aiPerf>=0?'+':'')+aiPerf.toFixed(1)+'%'
              )
            ),
            // Exit strategy
            h('div',{style:{background:actionColor+'15',border:'1px solid '+actionColor+'40',borderRadius:8,padding:10,marginBottom:12}},
              h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:4}},
                h('span',{style:{fontSize:14}},actionEmoji),
                h('span',{style:{fontSize:13,fontWeight:700,color:actionColor}},exitAction),
                exitPct > 0 && h('span',{style:{fontSize:11,color:'#fff',background:actionColor,padding:'1px 6px',borderRadius:4,marginLeft:6}},exitPct+'% du bag')
              ),
              h('div',{style:{fontSize:11,color:C.text}},exitNote)
            ),
            // ATH Recovery Progress
            h('div',{style:{marginBottom:12}},
              h('div',{style:{display:'flex',justifyContent:'space-between',fontSize:10,color:C.textS,marginBottom:4}},
                h('span',null,'$0'),h('span',null,'ATH $'+refAth.toFixed(2)),h('span',null,'\uD83D\uDE80')
              ),
              h('div',{style:{height:8,background:C.border,borderRadius:4,overflow:'hidden',position:'relative'}},
                h('div',{style:{width:Math.min(athRec,150)*(100/150)+'%',height:'100%',background:athRec>=100?'linear-gradient(90deg,#22c55e,#8b5cf6)':'linear-gradient(90deg,#ef4444,#eab308,#22c55e)',borderRadius:4,transition:'width 1s'}}),
                h('div',{style:{position:'absolute',top:-2,left:'66.7%',width:2,height:12,background:'#fff',opacity:0.5}})
              ),
              h('div',{style:{display:'flex',justifyContent:'space-between',marginTop:3,fontSize:8,color:C.textS}},
                priceAlerts.slice(0,5).map(function(a){
                  return h('span',{key:a.label,style:{color:a.reached?'#22c55e':C.textS,fontWeight:a.reached?700:400}},
                    (a.reached?'\u2705':'\u26AA')+' '+((a.pct_of_ath||0))+'%'
                  );
                })
              )
            ),
            // Next target
            nextT && h('div',{style:{fontSize:11,color:C.textS,marginBottom:8}},
              '\uD83C\uDFAF '+t.altseasonNextTarget+': ',
              h('span',{style:{color:'#eab308',fontWeight:600}},nextT.label),
              ' \u2014 $'+(nextT.target_price||0).toFixed(3)+' (+'+(nextT.distance_pct||0).toFixed(0)+'%)'
            ),
            // Price discovery
            inPD && h('div',{style:{background:'#8b5cf620',border:'1px solid #8b5cf6',borderRadius:8,padding:8,fontSize:11,marginBottom:4}},
              '\uD83D\uDE80 '+t.altseasonPriceDiscovery+' | Peak: $'+peak.toFixed(4)+' | Trailing: -'+trailing.toFixed(0)+'%'
            ),
            aiMom && h('div',{style:{fontSize:11,color:'#22c55e',marginTop:4}},'\uD83E\uDD16 '+aiMom)
          );
        })(),

        // Info footer
        h('div',{style:{textAlign:'center',padding:12,fontSize:11,color:C.textS}},
          '\uD83C\uDF0A '+t.altseasonFooter
        )
      );
    })(),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FUNDING HARVESTER TAB
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    tab==='funding' && (function(){
      // State for funding data
      var fundingData = window._fundingData || {status:null,stats:null,position:null,loading:true,error:null,lastFetch:0};
      window._fundingData = fundingData;

      // Fetch funding data every 30s
      var now = Date.now();
      if(now - fundingData.lastFetch > 30000) {
        fundingData.lastFetch = now;
        fundingData.loading = !fundingData.status;
        var headers = new Headers();
        headers.set('Authorization', 'Basic ' + btoa(CONFIG.API_USER+':' + CONFIG.API_PASS));

        Promise.all([
          fetch(CONFIG.FUNDING_API_URL + '/api/funding/status', {headers:headers}).then(function(r){return r.ok?r.json():null;}).catch(function(){return null;}),
          fetch(CONFIG.FUNDING_API_URL + '/api/funding/stats', {headers:headers}).then(function(r){return r.ok?r.json():null;}).catch(function(){return null;}),
          fetch(CONFIG.FUNDING_API_URL + '/api/funding/position', {headers:headers}).then(function(r){return r.ok?r.json():null;}).catch(function(){return null;})
        ]).then(function(results){
          fundingData.status = results[0];
          fundingData.stats = results[1];
          fundingData.position = results[2];
          fundingData.loading = false;
          fundingData.error = null;
          if(typeof forceUpdate === 'function') forceUpdate();
        }).catch(function(err){
          fundingData.error = 'Connection error';
          fundingData.loading = false;
        });
      }

      var s = fundingData.status;
      var st = fundingData.stats;
      var p = fundingData.position;

      // Card helper
      function card(title, content, opts) {
        opts = opts || {};
        return h('div',{style:{background:C.card,borderRadius:12,padding:20,border:'1px solid '+C.border,flex:opts.flex||'1 1 300px',minWidth:280}},
          h('div',{style:{fontSize:13,color:C.textS,marginBottom:12,fontWeight:600}},title),
          content
        );
      }

      function statRow(label, value, color) {
        return h('div',{style:{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:'1px solid '+C.border}},
          h('span',{style:{color:C.textS,fontSize:13}},label),
          h('span',{style:{color:color||C.text,fontSize:14,fontWeight:700}},value)
        );
      }

      if(fundingData.loading && !s) {
        return h('div',{style:{padding:40,textAlign:'center',color:C.textS}},t.fundingLoading);
      }

      if(fundingData.error && !s) {
        return h('div',{style:{padding:40,textAlign:'center'}},
          h('div',{style:{fontSize:48,marginBottom:16}},'\uD83C\uDF3E'),
          h('div',{style:{color:C.neg,fontSize:16,fontWeight:600}},t.fundingOffline),
          h('div',{style:{color:C.textS,fontSize:13,marginTop:8}},t.fundingServiceDown+' '+CONFIG.FUNDING_API_URL)
        );
      }

      var isDryRun = s && s.dry_run;
      var isRunning = s && s.is_running;
      var hasPosition = p && p.has_position;
      var marketMode = s && s.market_hours ? t.fundingMarketHours : t.fundingOffHours;
      var modeColor = s && s.market_hours ? C.warn : C.pos;

      return h('div',{style:{display:'flex',flexDirection:'column',gap:20,padding:'0 0 40px',overflowX:'hidden',maxWidth:'100%'}},
        // Header
        h('div',{style:{display:'flex',alignItems:'center',gap:12,flexWrap:'wrap'}},
          h('span',{style:{fontSize:28}},'\uD83C\uDF3E'),
          h('span',{style:{fontSize:20,fontWeight:700,color:C.text}},t.fundingTitle),
          isDryRun && h('span',{style:{background:'#ff980020',color:'#ff9800',padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:700}},'DRY RUN'),
          !isDryRun && isRunning && h('span',{style:{background:C.posL,color:C.pos,padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:700}},'LIVE'),
          h('span',{style:{background:modeColor+'20',color:modeColor,padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:700}},marketMode),
          s && s.hours_to_open != null && !s.market_hours && h('span',{style:{color:C.textS,fontSize:12}},s.hours_to_open+'h '+t.fundingToMarketOpen)
        ),

        // Row 1: Status + Stats
        h('div',{style:{display:'flex',gap:16,flexWrap:'wrap'}},
          // Status card
          card(t.fundingStatus, h('div',null,
            statRow(t.fundingRunning, isRunning ? t.fundingYes : t.fundingNo, isRunning ? C.pos : C.neg),
            statRow(t.mode, isDryRun ? 'DRY RUN' : 'LIVE', isDryRun ? C.warn : C.pos),
            statRow('Session', marketMode, modeColor),
            s && s.available_capital != null && statRow(t.fundingAvailCapital, '$'+s.available_capital.toFixed(2), C.pos),
            st && st.uptime_hours != null && statRow(t.uptime, st.uptime_hours.toFixed(1)+'h', C.text)
          )),

          // Earnings card
          card(t.fundingEarnings, h('div',null,
            st && statRow(t.fundingTotalFunding, '$'+(st.total_funding_earned||0).toFixed(4), st.total_funding_earned>0?C.pos:C.text),
            st && statRow(t.fundingTotalFees, '$'+(st.total_fees_paid||0).toFixed(4), C.neg),
            st && statRow(t.fundingNetProfit, '$'+(st.net_profit||0).toFixed(4), st.net_profit>0?C.pos:C.neg),
            st && st.projected_daily != null && statRow(t.fundingProjectedDay, '$'+st.projected_daily.toFixed(4), C.textS),
            st && st.projected_monthly != null && statRow(t.fundingProjectedMonth, '$'+st.projected_monthly.toFixed(2), st.projected_monthly>0?C.pos:C.textS)
          )),

          // Position card
          card(t.fundingPosition, hasPosition ? h('div',null,
            statRow(t.fundingAsset, p.coin, C.accent),
            statRow(t.fundingSpot, '+'+p.spot_size.toFixed(4)+' ('+p.spot_pair+')', C.pos),
            statRow(t.fundingPerp, p.perp_size.toFixed(4)+' short', C.neg),
            statRow(t.fundingNotional, '$'+p.spot_notional.toFixed(2), C.text),
            statRow(t.fundingEarned, '$'+p.funding_earned.toFixed(4), p.funding_earned>0?C.pos:C.neg),
            statRow(t.fundingDuration, p.duration_str||'--', C.textS),
            p.consecutive_negative_hours > 0 && statRow(t.fundingNegHours, p.consecutive_negative_hours+'h', C.warn)
          ) : h('div',{style:{textAlign:'center',padding:20}},
            h('div',{style:{fontSize:32,marginBottom:8}},'--'),
            h('div',{style:{color:C.textS,fontSize:13}},t.fundingNoPosition),
            h('div',{style:{color:C.textS,fontSize:11,marginTop:4}},t.fundingWaiting)
          ))
        ),

        // Row 2: Funding rates
        s && s.funding_rates && s.funding_rates.length > 0 && card(t.fundingLiveRates, h('div',null,
          h('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:4,padding:'4px 0',borderBottom:'1px solid '+C.border,marginBottom:8}},
            h('span',{style:{fontSize:11,color:C.textS,fontWeight:600}},t.fundingAsset),
            h('span',{style:{fontSize:11,color:C.textS,fontWeight:600,textAlign:'right'}},t.fundingRateH),
            h('span',{style:{fontSize:11,color:C.textS,fontWeight:600,textAlign:'right'}},'APY'),
            h('span',{style:{fontSize:11,color:C.textS,fontWeight:600,textAlign:'right'}},t.fundingDirection)
          ),
          s.funding_rates.map(function(r){
            var rColor = r.rate_hourly > 0 ? C.pos : C.neg;
            return h('div',{key:r.coin,style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr 1fr',gap:4,padding:'6px 0',borderBottom:'1px solid '+C.border+'40'}},
              h('span',{style:{fontSize:13,fontWeight:600,color:C.text}},r.coin),
              h('span',{style:{fontSize:13,color:rColor,textAlign:'right',fontWeight:700}},r.rate_pct.toFixed(4)+'%'),
              h('span',{style:{fontSize:13,color:rColor,textAlign:'right'}},r.apy.toFixed(1)+'%'),
              h('span',{style:{fontSize:11,color:C.textS,textAlign:'right'}},r.direction==='shorts_receive'?t.fundingShortsRcv:t.fundingLongsRcv)
            );
          })
        ),{flex:'1 1 100%'})
      );
    })(),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SETTINGS MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    showSettings && h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000},onClick:function(){setShowSettings(false);}},
      h('div',{style:{background:C.card,borderRadius:isMobile?16:20,padding:isMobile?16:24,width:isMobile?'95%':480,maxWidth:480,maxHeight:isMobile?'80vh':'90vh',overflow:'auto',border:'1px solid '+C.border},onClick:function(e){e.stopPropagation();}},
        // Header
        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:12}},
            h('span',{style:{fontSize:24}},'‚öôÔ∏è'),
            h('span',{style:{fontSize:20,fontWeight:700}},t.settings)
          ),
          h('button',{onClick:function(){setShowSettings(false);},style:{width:44,height:44,background:'transparent',border:'none',fontSize:22,cursor:'pointer',color:C.textS,display:'flex',alignItems:'center',justifyContent:'center'}},'√ó')
        ),
        
        // Appearance section
        h('div',{style:{marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
            h('span',{style:{fontSize:14}},'üé®'),
            h('span',{style:{fontSize:12,color:C.accent,fontWeight:600}},t.appearance)
          ),
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.darkMode),
            h('button',{onClick:function(){setTheme(theme==='dark'?'light':'dark');},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:theme==='dark'?C.accent:C.border,cursor:'pointer',position:'relative'}},
              h('span',{style:{position:'absolute',top:2,left:theme==='dark'?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s',display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}},theme==='dark'?'üåô':'‚òÄÔ∏è')
            )
          )
        ),
        
        // Goals section
        h('div',{style:{marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
            h('span',{style:{fontSize:14}},'üéØ'),
            h('span',{style:{fontSize:12,color:C.accent,fontWeight:600}},t.goals)
          ),
          // Daily R Goal
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.dailyRGoal),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{dailyRGoal:Math.max(1,settings.dailyRGoal-1)}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'-'),
              h('span',{style:{width:40,textAlign:'center',fontWeight:700}},settings.dailyRGoal),
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{dailyRGoal:settings.dailyRGoal+1}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'+')
            )
          ),
          // Weekly R Goal
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.weeklyRGoal),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{weeklyRGoal:Math.max(1,settings.weeklyRGoal-1)}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'-'),
              h('span',{style:{width:40,textAlign:'center',fontWeight:700}},settings.weeklyRGoal),
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{weeklyRGoal:settings.weeklyRGoal+1}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'+')
            )
          ),
          // DD Alert Threshold
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.ddAlertThreshold),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{ddAlertThreshold:Math.max(1,settings.ddAlertThreshold-1)}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'-'),
              h('span',{style:{width:40,textAlign:'center',fontWeight:700}},settings.ddAlertThreshold),
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{ddAlertThreshold:settings.ddAlertThreshold+1}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'+')
            )
          )
        ),
          // Refresh Interval
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,'‚è±Ô∏è Refresh Interval (s)'),
            h('div',{style:{display:'flex',alignItems:'center',gap:8}},
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{refreshInterval:Math.max(1,(settings.refreshInterval||5)-1)}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'-'),
              h('span',{style:{width:40,textAlign:'center',fontWeight:700}},settings.refreshInterval||5),
              h('button',{onClick:function(){setSettings(Object.assign({},settings,{refreshInterval:(settings.refreshInterval||5)+1}));},style:{width:isMobile?44:32,height:isMobile?44:32,background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:16}},'+')
            )
          ),
        // Social section
        h('div',{style:{marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:16}},
            h('span',{style:{fontSize:14}},'üîî'),
            h('span',{style:{fontSize:12,color:C.accent,fontWeight:600}},t.social)
          ),
          // Sound Effects
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.soundEffects),
            h('button',{onClick:function(){setSettings(Object.assign({},settings,{soundEffects:!settings.soundEffects}));},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:settings.soundEffects?C.accent:C.border,cursor:'pointer',position:'relative'}},
              h('span',{style:{position:'absolute',top:2,left:settings.soundEffects?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12}},settings.soundEffects?'üîä':'üîá')
            )
          ),
          // Twitter/X Integration
          h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t.twitterIntegration),
            h('button',{onClick:function(){setShowSettings(false);setShowTwitter(true);},style:{padding:'8px 16px',background:C.bg,border:'1px solid '+C.border,borderRadius:8,cursor:'pointer',fontSize:12,fontWeight:600,color:C.text}},t.configure)
          ),
          // Discord
          h('div',{style:{padding:'12px 0'}},
            h('div',{style:{display:'flex',alignItems:'center',gap:8,marginBottom:12}},
              h('span',{style:{fontSize:14}},'üéÆ'),
              h('span',null,t.discord)
            ),
            h('input',{type:'text',placeholder:t.discordWebhook,value:settings.discordWebhook,onChange:function(e){setSettings(Object.assign({},settings,{discordWebhook:e.target.value}));},style:{width:'100%',padding:'12px 16px',background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,fontSize:14,marginBottom:12}}),
            h('button',{onClick:function(){if(settings.discordWebhook){fetch(settings.discordWebhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:'üî± Trinity Bot Test - Webhook OK!'})}).then(function(){notify('success',t.webhookOk);}).catch(function(){notify('error',t.webhookFailed);});}},style:{width:'100%',padding:'12px',background:C.bg,border:'1px solid '+C.border,borderRadius:10,cursor:'pointer',fontSize:14,color:C.text}},'üß™ '+t.testWebhook)
          )
        ),
        
        // Save button
        h('button',{onClick:function(){fetchApi('/api/settings',{method:'POST',body:JSON.stringify(settings)}).then(function(){notify('success',t.save+' OK');setShowSettings(false);}).catch(function(){notify('success',t.save+' OK');setShowSettings(false);});},style:{width:'100%',padding:16,background:C.accent,border:'none',borderRadius:12,color:C.bg,fontSize:16,fontWeight:700,cursor:'pointer'}},t.save)
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TWITTER/X MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    showTwitter && h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:2000},onClick:function(){setShowTwitter(false);}},
      h('div',{style:{background:C.card,borderRadius:isMobile?16:20,padding:isMobile?16:24,width:isMobile?'95%':480,maxWidth:480,maxHeight:isMobile?'80vh':'90vh',overflow:'auto',border:'1px solid '+C.border},onClick:function(e){e.stopPropagation();}},
        // Header
        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:12}},
            h('span',{style:{fontSize:20,fontWeight:800,color:C.text}},'ùïè'),
            h('span',{style:{fontSize:20,fontWeight:700}},t.twitterIntegration)
          ),
          h('button',{onClick:function(){setShowTwitter(false);},style:{width:44,height:44,background:'transparent',border:'none',fontSize:22,cursor:'pointer',color:C.textS,display:'flex',alignItems:'center',justifyContent:'center'}},'√ó')
        ),
        
        // Private Strategy notice
        h('div',{style:{background:C.warnL,border:'1px solid '+C.warn,borderRadius:12,padding:16,marginBottom:24}},
          h('div',{style:{display:'flex',alignItems:'center',gap:10}},
            h('span',{style:{fontSize:20}},'üîí'),
            h('div',null,
              h('div',{style:{fontWeight:700,color:C.warn}},t.privateStrategy),
              h('div',{style:{fontSize:12,color:C.textS}},t.privateStrategyDesc)
            )
          )
        ),
        
        // Auto-posting toggle
        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 0',borderBottom:'1px solid '+C.border}},
          h('div',null,
            h('div',{style:{fontWeight:600}},t.autoPosting),
            h('div',{style:{fontSize:12,color:C.textS}},t.autoPostingDesc)
          ),
          h('button',{onClick:function(){setTwitterConfig(Object.assign({},twitterConfig,{autoPosting:!twitterConfig.autoPosting}));},style:{width:48,height:28,borderRadius:14,border:'none',margin:'8px 0',background:twitterConfig.autoPosting?C.accent:C.border,cursor:'pointer',position:'relative'}},
            h('span',{style:{position:'absolute',top:2,left:twitterConfig.autoPosting?22:2,width:24,height:24,borderRadius:12,background:'#fff',transition:'left .2s'}})
          )
        ),
        
        // Checkboxes
        ['postOnOpen','postOnClose','postAchievements','postMilestones','hideAmounts'].map(function(key){
          var labelKeys = {postOnOpen:'postOnOpen',postOnClose:'postOnClose',postAchievements:'postAchievements',postMilestones:'postMilestones',hideAmounts:'hideAmountsInPosts'};
          return h('div',{key:key,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border}},
            h('span',null,t[labelKeys[key]]),
            h('button',{onClick:function(){var update={};update[key]=!twitterConfig[key];setTwitterConfig(Object.assign({},twitterConfig,update));},style:{width:24,height:24,borderRadius:6,border:'2px solid '+(twitterConfig[key]?C.accent:C.border),background:twitterConfig[key]?C.accent:'transparent',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',color:'#fff',fontSize:14}},twitterConfig[key]?'‚úì':'')
          );
        }),
        
        // Hashtags
        h('div',{style:{padding:'16px 0'}},
          h('div',{style:{fontSize:12,color:C.textS,marginBottom:8}},t.hashtags),
          h('input',{type:'text',value:twitterConfig.hashtags,onChange:function(e){setTwitterConfig(Object.assign({},twitterConfig,{hashtags:e.target.value}));},style:{width:'100%',padding:'12px 16px',background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,fontSize:14}})
        ),
        
        // Save button
        h('button',{onClick:function(){localStorage.setItem('trinity_twitter_config',JSON.stringify(twitterConfig));fetchApi('/api/twitter/config',{method:'POST',body:JSON.stringify(twitterConfig)}).then(function(){notify('success',t.save+' OK');setShowTwitter(false);}).catch(function(e){console.error('Twitter config save failed:',e);notify('error','Save failed');});},style:{width:'100%',padding:16,background:C.accent,border:'none',borderRadius:12,color:theme==='dark'?'#000':'#fff',fontSize:16,fontWeight:700,cursor:'pointer'}},t.save)
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üÜï V10.0: TRADE CHART MODAL - TradingView Lightweight Charts
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    showChartModal && chartTrade && h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,.85)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:3000},onClick:function(){setShowChartModal(false);setChartTrade(null);}},
      h('div',{style:{background:C.card,borderRadius:isMobile?12:20,width:isMobile?'98%':'90%',maxWidth:900,maxHeight:isMobile?'85vh':'95vh',overflow:'hidden',border:'1px solid '+C.border,display:'flex',flexDirection:'column'},onClick:function(e){e.stopPropagation();}},
        // Header
        h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:isMobile?'10px 12px':'16px 24px',borderBottom:'1px solid '+C.border,background:C.bg}},
          h('div',{style:{display:'flex',alignItems:'center',gap:isMobile?8:12,flex:1,minWidth:0}},
            cryptoLogo(chartTrade.symbol, isMobile?28:36),
            h('div',{style:{minWidth:0}},
              h('div',{style:{fontSize:isMobile?14:18,fontWeight:700}},chartTrade.symbol+' '+chartTrade.side),
              !isMobile && h('div',{style:{fontSize:12,color:C.textS}},(lang==='fr'?'D√©tails du Trade':'Trade Details')+' ‚Ä¢ '+(chartTrade.tp_count||1)+' '+(lang==='fr'?'ex√©cution(s)':'fill(s)'))
            )
          ),
          h('div',{style:{display:'flex',alignItems:'center',gap:8,flexShrink:0}},
            h('div',{style:{textAlign:'right'}},
              h('div',{style:{fontSize:isMobile?16:24,fontWeight:800,color:chartTrade.r>=0?C.pos:C.neg}},fmtR(chartTrade.r)),
              !isMobile && h('div',{style:{fontSize:14,color:chartTrade.pnl>=0?C.pos:C.neg}},fmtPnl(chartTrade.pnl))
            ),
            h('button',{onClick:function(){setShowChartModal(false);setChartTrade(null);},style:{width:36,height:36,background:C.neg,border:'none',borderRadius:8,fontSize:18,cursor:'pointer',color:'#fff',flexShrink:0}},'√ó')
          )
        ),
        
        // Chart Container
        h('div',{style:{flex:1,minHeight:350,padding:16,overflow:'hidden'}},
          chartLoading 
            ? h('div',{style:{height:300,display:'flex',alignItems:'center',justifyContent:'center',color:C.textS}},
                h('div',{style:{textAlign:'center'}},
                  h('div',{style:{fontSize:24,marginBottom:8}},'üìä'),
                  h('div',null,lang==='fr'?'Chargement du graphique...':'Loading chart...')
                )
              )
            : h('div',{
                id:'tradingview-chart-container',
                key:'modal-chart-'+chartShowEMA+'-'+chartShowVolume,
                ref:function(el){
                  if(!el){
                    if(window._chartModalInst){try{window._chartModalInst._disposed=true;window._chartModalInst.remove();}catch(e){}window._chartModalInst=null;}
                    return;
                  }
                  if(el._chartCreated) return;
                  if(chartCandles.length > 0 && typeof LightweightCharts !== 'undefined'){
                    el._chartCreated = true;

                    var chart = LightweightCharts.createChart(el, {
                      autoSize: true,
                      layout: {
                        background: { type: 'solid', color: C.bg },
                        textColor: C.text,
                      },
                      grid: {
                        vertLines: { color: C.border },
                        horzLines: { color: C.border },
                      },
                      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                      rightPriceScale: { borderColor: C.border },
                      timeScale: { borderColor: C.border, timeVisible: true },
                    });

                    var candleSeries = chart.addCandlestickSeries({
                      upColor: '#22c55e',
                      downColor: '#ef4444',
                      borderUpColor: '#22c55e',
                      borderDownColor: '#ef4444',
                      wickUpColor: '#22c55e',
                      wickDownColor: '#ef4444',
                    });

                    candleSeries.setData(chartCandles);

                    addChartOverlays(chart, chartCandles, chartShowVolume, chartShowEMA);

                    var markers = [];

                    if(chartTrade.entryTime){
                      var entryTime = Math.floor(new Date(chartTrade.entryTime).getTime() / 1000);
                      markers.push({
                        time: entryTime,
                        position: chartTrade.side==='LONG' ? 'belowBar' : 'aboveBar',
                        color: '#3b82f6',
                        shape: chartTrade.side==='LONG' ? 'arrowUp' : 'arrowDown',
                        text: 'Entry $'+(chartTrade.entryPrice||0).toLocaleString()
                      });
                    }

                    if(chartTrade.fills && chartTrade.fills.length > 0){
                      chartTrade.fills.forEach(function(fill, idx){
                        if(fill.fill_type !== 'entry' && fill.time){
                          var exitTime = Math.floor(new Date(fill.time).getTime() / 1000);
                          var exitColor = fill.pnl >= 0 ? '#22c55e' : '#ef4444';
                          markers.push({
                            time: exitTime,
                            position: chartTrade.side==='LONG' ? 'aboveBar' : 'belowBar',
                            color: exitColor,
                            shape: 'circle',
                            text: (fill.fill_type==='exit'?'Exit':'TP'+(idx))+' $'+(fill.price||0).toLocaleString()
                          });
                        }
                      });
                    } else if(chartTrade.exitTime){
                      var exitTime = Math.floor(new Date(chartTrade.exitTime).getTime() / 1000);
                      var exitColor = chartTrade.r >= 0 ? '#22c55e' : '#ef4444';
                      markers.push({
                        time: exitTime,
                        position: chartTrade.side==='LONG' ? 'aboveBar' : 'belowBar',
                        color: exitColor,
                        shape: 'circle',
                        text: 'Exit $'+(chartTrade.exitPrice||0).toLocaleString()
                      });
                    }

                    markers.sort(function(a,b){return a.time-b.time;});
                    candleSeries.setMarkers(markers);

                    try {
                      var entryTimestamp = chartTrade.entryTime ? Math.floor(new Date(chartTrade.entryTime).getTime() / 1000) : null;
                      var exitTimestamp = chartTrade.exitTime ? Math.floor(new Date(chartTrade.exitTime).getTime() / 1000) : null;

                      if (entryTimestamp && exitTimestamp) {
                        var duration = exitTimestamp - entryTimestamp;
                        var padding = Math.max(duration * 0.5, 3600);
                        chart.timeScale().setVisibleRange({ from: entryTimestamp - padding, to: exitTimestamp + padding });
                      } else if (entryTimestamp && chartTrade.status === 'open') {
                        var now = Math.floor(Date.now() / 1000);
                        chart.timeScale().setVisibleRange({ from: Math.min(entryTimestamp - 3600, now - 86400), to: now + 3600 });
                      } else {
                        chart.timeScale().fitContent();
                      }
                    } catch (zoomErr) {
                      chart.timeScale().fitContent();
                    }
                    window._chartModalInst = chart;
                  }
                },
                'data-chart':'1',
                style:{width:'100%',height:'100%',background:C.bg,borderRadius:12}
              })
        ),
        
        // Trade Details Grid
        h('div',{style:{padding:'0 24px 16px',borderTop:'1px solid '+C.border,paddingTop:16}},
          h('div',{style:{display:'grid',gridTemplateColumns:isMobile?'repeat(3,1fr)':'repeat(6,1fr)',gap:12,marginBottom:16}},
            [{l:lang==='fr'?'Entr√©e':'Entry',v:fmtPrice(chartTrade.entryPrice),c:C.info},{l:lang==='fr'?'Sortie':'Exit',v:fmtPrice(chartTrade.exitPrice||chartTrade.currentPrice),c:chartTrade.r>=0?C.pos:C.neg},{l:'Score',v:(chartTrade.score||'--')+'/16',c:C.accent},{l:'R√©gime',v:ocRegimeLabel(detectRegime(chartTrade)),c:ocRegimeColor(detectRegime(chartTrade))},{l:'Dur√©e',v:chartTrade.duration||'--',c:C.textS},{l:'TPs',v:(chartTrade.tp_count||1)+'x',c:C.info}].map(function(item,i){
              return h('div',{key:i,style:{background:C.bg,padding:10,borderRadius:8,textAlign:'center'}},
                h('div',{style:{fontSize:9,color:C.textS,marginBottom:2}},item.l),
                h('div',{style:{fontSize:13,fontWeight:700,color:item.c}},item.v)
              );
            })
          ),
          
          // Fills breakdown (if aggregated trade with multiple TPs)
          chartTrade.fills && chartTrade.fills.length > 1 && h('div',{style:{marginBottom:16}},
            h('div',{style:{fontSize:11,fontWeight:600,color:C.textS,marginBottom:8}},lang==='fr'?'üéØ Ex√©cutions ('+chartTrade.fills.length+')':'üéØ Fills ('+chartTrade.fills.length+')'),
            h('div',{style:{display:'flex',flexDirection:'column',gap:6}},
              chartTrade.fills.map(function(fill, idx){
                var fillColor = fill.fill_type==='entry' ? C.info : (fill.pnl>=0?C.pos:C.neg);
                var fillIcon = fill.fill_type==='entry' ? 'üéØ' : (fill.pnl>=0?'‚úÖ':'‚ùå');
                return h('div',{key:idx,style:{display:'flex',alignItems:'center',gap:12,padding:'8px 12px',background:C.bg,borderRadius:8,borderLeft:'3px solid '+fillColor}},
                  h('span',{style:{fontSize:12}},fillIcon),
                  h('span',{style:{fontSize:11,fontWeight:600,color:fillColor,width:60}},fill.fill_type.toUpperCase()),
                  h('span',{style:{fontSize:11,color:C.textS}},'$'+(fill.price||0).toLocaleString()),
                  fill.pnl !== undefined && h('span',{style:{fontSize:11,fontWeight:600,color:fill.pnl>=0?C.pos:C.neg,marginLeft:'auto'}},fmtPnl(fill.pnl)),
                  fill.time && h('span',{style:{fontSize:9,color:C.textM}},(fill.time||'').replace('T',' ').slice(0,16))
                );
              })
            )
          ),
          
          // Action buttons
          h('div',{style:{display:'flex',gap:12}},
            h('button',{onClick:function(){var txt='üî± Trinity Trade\n\n'+chartTrade.side+' '+chartTrade.symbol+'\nüìä Score: '+(chartTrade.score||0)+'/16\nüí∞ '+fmtR(chartTrade.r)+' | '+fmtPnl(chartTrade.pnl)+'\n‚è± '+(chartTrade.duration||'--')+'\nüéØ '+(chartTrade.tp_count||1)+' fill(s)\n\n#TrinityBot #Trading';window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(txt),'_blank');},style:{flex:1,padding:12,background:C.tw,border:'none',borderRadius:10,color:'#fff',fontSize:13,fontWeight:700,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}},'ùïè '+(lang==='fr'?'Partager':'Share')),
            h('button',{onClick:function(){setShowChartModal(false);setChartTrade(null);},style:{padding:'12px 24px',background:C.bg,border:'1px solid '+C.border,borderRadius:10,color:C.text,fontSize:13,fontWeight:600,cursor:'pointer'}},lang==='fr'?'Fermer':'Close')
          )
        )
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V2.0 PHASE 3: LOGS PANEL (Sidebar Desktop / Slide-up Mobile)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Toggle button (floating)
    !showLogsPanel && h('button',{onClick:function(){setShowLogsPanel(true);},style:{position:'fixed',right:12,bottom:isMobile?70:20,zIndex:1050,width:44,height:44,borderRadius:'50%',background:C.card,border:'1px solid '+C.border,color:C.accent,fontSize:18,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 2px 12px rgba(0,0,0,.3)'}},'üìú'),
    // Panel overlay (mobile)
    showLogsPanel && isMobile && h('div',{onClick:function(){setShowLogsPanel(false);},style:{position:'fixed',inset:0,background:'rgba(0,0,0,.5)',zIndex:1090}}),
    // Panel
    h('div',{className:'logs-panel'+(showLogsPanel?' open':''),style:{background:C.card,borderLeft:isMobile?'none':'1px solid '+C.border,display:'flex',flexDirection:'column'}},
      // Header
      h('div',{style:{padding:'12px 16px',borderBottom:'1px solid '+C.border,display:'flex',justifyContent:'space-between',alignItems:'center'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:8}},
          h('span',{style:{fontSize:16}},'üìú'),
          h('span',{style:{fontSize:14,fontWeight:700}},t.liveLogs),
          h('span',{style:{width:8,height:8,borderRadius:'50%',background:activeConnected?C.pos:C.neg,animation:activeConnected?'pulse 1s infinite':'none'}})
        ),
        h('button',{onClick:function(){setShowLogsPanel(false);},style:{background:'transparent',border:'none',color:C.textS,fontSize:18,cursor:'pointer'}},'√ó')
      ),
      // Source filter
      h('div',{style:{padding:'8px 16px',display:'flex',gap:4,borderBottom:'1px solid '+C.border}},
        ['all','crypto','hip3'].map(function(src){
          var label = src==='all'?(lang==='fr'?'Tout':'All'):src==='crypto'?'üü¢ Crypto':'üîµ HIP-3';
          var isActive = logsPanelSource===src;
          return h('button',{key:src,onClick:function(){setLogsPanelSource(src);},style:{padding:'4px 10px',fontSize:10,fontWeight:600,background:isActive?C.accent+'20':'transparent',border:'1px solid '+(isActive?C.accent:C.border),borderRadius:6,color:isActive?C.accent:C.textS,cursor:'pointer'}},label);
        })
      ),
      // Log entries
      h('div',{style:{flex:1,overflow:'auto',padding:12,fontFamily:'Monaco,Consolas,monospace',fontSize:11,lineHeight:1.6}},
        (function(){
          var panelLogs = logsPanelSource==='crypto'?logs:logsPanelSource==='hip3'?hip3Logs:logs.concat(hip3Logs).sort(function(a,b){return (b.ts||'').localeCompare(a.ts||'');});
          return panelLogs.length===0
            ? h('div',{style:{textAlign:'center',padding:40,color:C.textS}},h('div',{style:{fontSize:24,marginBottom:8}},'üì≠'),t.waitingLogs)
            : panelLogs.slice(0,300).map(function(log,i){
                var lvl=log.lvl||'INFO';
                var lvlColor=lvl==='ERROR'||lvl==='CRITICAL'?'#ef4444':lvl==='SUCCESS'?'#22c55e':lvl==='WARNING'||lvl==='WARN'?'#eab308':lvl==='DEBUG'?'#8b5cf6':'#22d3ee';
                var ts=log.ts?(log.ts.includes('T')?log.ts.split('T')[1].slice(0,8):log.ts):'';
                var srcBadge=log.source==='hip3'?'üîµ':'üü¢';
                return h('div',{key:i,style:{marginBottom:2,padding:'3px 6px',borderRadius:4,background:lvl==='ERROR'?'rgba(239,68,68,.1)':'transparent',display:'flex',gap:6,alignItems:'flex-start'}},
                  h('span',{style:{fontSize:9,opacity:.7}},srcBadge),
                  h('span',{style:{color:'#4b5563',minWidth:55,fontSize:10,fontFamily:'monospace'}},ts),
                  h('span',{style:{color:lvlColor,fontWeight:600,minWidth:50,fontSize:10}},'['+lvl+']'),
                  h('span',{style:{color:C.text,flex:1,wordBreak:'break-word'}},log.msg)
                );
              });
        })()
      ),
      // Footer
      h('div',{style:{padding:'8px 16px',borderTop:'1px solid '+C.border,display:'flex',justifyContent:'space-between',alignItems:'center'}},
        h('span',{style:{fontSize:10,color:C.textS}},(logsPanelSource==='crypto'?logs.length:logsPanelSource==='hip3'?hip3Logs.length:logs.length+hip3Logs.length)+' logs'),
        h('button',{onClick:function(){if(logsPanelSource==='hip3'){setHip3Logs([]);}else if(logsPanelSource==='crypto'){setLogs([]);}else{setLogs([]);setHip3Logs([]);}},style:{padding:'4px 8px',fontSize:9,background:'transparent',border:'1px solid '+C.border,borderRadius:4,color:C.textS,cursor:'pointer'}},'Clear')
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V2.0 PHASE 3: PANIC BUTTON (Floating + Slide-to-Confirm)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Floating panic button (visible when positions open)
    activeOpenPos.length > 0 && !showPanicModal && h('button',{onClick:function(){setShowPanicModal(true);setPanicSliderVal(0);},style:{position:'fixed',left:12,bottom:isMobile?70:20,zIndex:1050,width:48,height:48,borderRadius:'50%',background:'linear-gradient(135deg,#dc2626,#991b1b)',border:'2px solid #ef4444',color:'#fff',fontSize:20,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',animation:'panicPulse 2s infinite',boxShadow:'0 2px 12px rgba(239,68,68,.4)'}},'üõë'),
    // Panic Modal overlay
    showPanicModal && h('div',{style:{position:'fixed',inset:0,background:'rgba(0,0,0,.7)',zIndex:1200,display:'flex',alignItems:'center',justifyContent:'center',padding:20}},
      h('div',{style:{background:C.card,borderRadius:20,padding:24,maxWidth:420,width:'100%',border:'2px solid #ef4444',boxShadow:'0 0 40px rgba(239,68,68,.3)'}},
        // Header
        h('div',{style:{textAlign:'center',marginBottom:20}},
          h('div',{style:{fontSize:48,marginBottom:8}},'üö®'),
          h('div',{style:{fontSize:20,fontWeight:800,color:'#ef4444'}},lang==='fr'?'ARR√äT D\'URGENCE':'EMERGENCY STOP'),
          h('div',{style:{fontSize:12,color:C.textS,marginTop:8}},lang==='fr'?'Arr√™ter les 2 bots et fermer TOUTES les '+activeOpenPos.length+' positions':'Kill both bots and close ALL '+activeOpenPos.length+' positions')
        ),
        // Position summary
        h('div',{style:{background:'rgba(239,68,68,.1)',borderRadius:12,padding:12,marginBottom:20,border:'1px solid rgba(239,68,68,.3)'}},
          h('div',{style:{display:'flex',justifyContent:'space-between',marginBottom:8}},
            h('span',{style:{fontSize:11,color:C.textS}},lang==='fr'?'Positions ouvertes':'Open positions'),
            h('span',{style:{fontSize:13,fontWeight:700,color:'#ef4444'}},activeOpenPos.length)
          ),
          activeOpenPos.slice(0,5).map(function(pos,i){
            return h('div',{key:i,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'4px 0',borderTop:i>0?'1px solid rgba(239,68,68,.15)':'none'}},
              h('span',{style:{fontSize:11,fontWeight:600}},pos.symbol+' '+pos.side),
              h('span',{style:{fontSize:11,color:(pos.pnl||0)>=0?C.pos:C.neg}},fmtR(pos.r||0))
            );
          }),
          activeOpenPos.length > 5 && h('div',{style:{fontSize:10,color:C.textS,textAlign:'center',marginTop:4}},'+'+(activeOpenPos.length-5)+(lang==='fr'?' de plus...':' more...'))
        ),
        // Slide to confirm (mobile) / Click to confirm (desktop)
        isMobile
          ? h('div',null,
              h('div',{style:{fontSize:10,color:C.textS,textAlign:'center',marginBottom:8}},lang==='fr'?'Glissez pour confirmer l\'arr√™t d\'urgence':'Slide to confirm emergency stop'),
              h('div',{className:'panic-slider-track',style:{background:'rgba(239,68,68,.15)',border:'1px solid rgba(239,68,68,.4)'},
                onTouchStart:function(e){
                  var track=e.currentTarget;var lastPct=0;
                  var handleTouch=function(ev){
                    var rect=track.getBoundingClientRect();
                    var x=ev.touches[0].clientX-rect.left;lastPct=Math.max(0,Math.min(100,(x/rect.width)*100));
                    setPanicSliderVal(lastPct);
                  };
                  var endTouch=function(){
                    document.removeEventListener('touchmove',handleTouch);document.removeEventListener('touchend',endTouch);
                    if(lastPct>=90){
                      setPanicFiring(true);
                      Promise.all([
                        fetch(CONFIG.MONITOR_API_URL+'/api/monitor/kill-switch?confirm=CONFIRM_STOP',{method:'POST'}).catch(function(){}),
                        fetch(CONFIG.MONITOR_API_URL+'/api/monitor/hip3/kill-switch?confirm=CONFIRM_STOP',{method:'POST'}).catch(function(){})
                      ]).then(function(){
                        notify('error',lang==='fr'?'üõë URGENCE: Les 2 bots arr√™t√©s!':'üõë EMERGENCY: Both bots killed!');
                        setTimeout(function(){setShowPanicModal(false);setPanicFiring(false);setPanicSliderVal(0);fetchAll();fetchAllHip3();},2000);
                      });
                    } else { setPanicSliderVal(0); }
                  };
                  document.addEventListener('touchmove',handleTouch);document.addEventListener('touchend',endTouch);
                }},
                h('div',{className:'panic-slider-fill',style:{width:panicSliderVal+'%',background:'linear-gradient(90deg,rgba(239,68,68,.3),rgba(239,68,68,.6))'}}),
                h('div',{className:'panic-slider-thumb',style:{left:'calc('+panicSliderVal+'% - 24px)',background:panicSliderVal>=90?'#dc2626':'#ef4444',boxShadow:'0 0 12px rgba(239,68,68,.5)'}},
                  panicFiring?h('span',{style:{animation:'spin 1s linear infinite',fontSize:18}},'‚è≥'):h('span',{style:{fontSize:18}},'üõë')
                ),
                h('div',{style:{position:'absolute',width:'100%',textAlign:'center',top:'50%',transform:'translateY(-50%)',fontSize:12,fontWeight:700,color:'rgba(239,68,68,.6)',pointerEvents:'none'}},panicSliderVal>=90?(lang==='fr'?'REL√ÇCHER POUR ARR√äTER':'RELEASE TO KILL'):(lang==='fr'?'>>> GLISSER POUR ARR√äTER >>>':'>>> SLIDE TO KILL >>>'))
              )
            )
          : h('div',{style:{display:'flex',gap:10}},
              h('button',{onClick:function(){
                setPanicFiring(true);
                Promise.all([
                  fetch(CONFIG.MONITOR_API_URL+'/api/monitor/kill-switch?confirm=CONFIRM_STOP',{method:'POST'}).catch(function(){}),
                  fetch(CONFIG.MONITOR_API_URL+'/api/monitor/hip3/kill-switch?confirm=CONFIRM_STOP',{method:'POST'}).catch(function(){})
                ]).then(function(){
                  notify('error',lang==='fr'?'üõë URGENCE: Les 2 bots arr√™t√©s!':'üõë EMERGENCY: Both bots killed!');
                  setTimeout(function(){setShowPanicModal(false);setPanicFiring(false);setPanicSliderVal(0);fetchAll();fetchAllHip3();},2000);
                });
              },disabled:panicFiring,style:{flex:1,padding:14,background:panicFiring?'#666':'linear-gradient(135deg,#dc2626,#991b1b)',border:'none',borderRadius:12,color:'#fff',fontSize:15,fontWeight:800,cursor:panicFiring?'wait':'pointer',letterSpacing:1}},panicFiring?(lang==='fr'?'ARR√äT EN COURS...':'KILLING...'):(lang==='fr'?'CONFIRMER ARR√äT TOTAL':'CONFIRM KILL ALL')),
              h('button',{onClick:function(){setShowPanicModal(false);setPanicSliderVal(0);},style:{padding:'14px 20px',background:C.bg,border:'1px solid '+C.border,borderRadius:12,color:C.text,fontSize:13,fontWeight:600,cursor:'pointer'}},t.cancel)
            )
      )
    ),

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // V2.0 PHASE 3: FULLSCREEN CHART MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    chartFullscreen && h('div',{style:{position:'fixed',inset:0,background:'rgba(0,0,0,.95)',zIndex:1300,display:'flex',flexDirection:'column'}},
      // Header ‚Äî mobile: close button always visible, details hidden
      h('div',{style:{padding:isMobile?'8px 12px':'12px 20px',display:'flex',justifyContent:'space-between',alignItems:'center',borderBottom:'1px solid '+C.border,flexShrink:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:8,minWidth:0,flex:1,overflow:'hidden'}},
          cryptoLogo(chartFullscreen.symbol,isMobile?22:28),
          h('span',{style:{fontSize:isMobile?14:18,fontWeight:700,color:C.text,whiteSpace:'nowrap'}},chartFullscreen.symbol),
          h('span',{style:{padding:'2px 6px',borderRadius:4,fontSize:isMobile?9:10,fontWeight:600,background:chartFullscreen.side==='LONG'?C.posL:C.negL,color:chartFullscreen.side==='LONG'?C.pos:C.neg,whiteSpace:'nowrap',flexShrink:0}},chartFullscreen.side),
          chartFullscreen.r !== undefined && h('span',{style:{fontSize:isMobile?13:16,fontWeight:700,color:(chartFullscreen.r||0)>=0?C.pos:C.neg,whiteSpace:'nowrap',flexShrink:0}},fmtR(chartFullscreen.r))
        ),
        h('div',{style:{display:'flex',alignItems:'center',gap:8,flexShrink:0}},
          // Trade details ‚Äî desktop only
          !isMobile && chartFullscreen.entryPrice && h('div',{style:{display:'flex',gap:12,fontSize:11,color:C.textS}},
            h('span',null,t.entry+': ',h('b',{style:{color:C.text}},fmtPrice(chartFullscreen.entryPrice))),
            chartFullscreen.stopLoss && h('span',null,'SL: ',h('b',{style:{color:C.neg}},fmtPrice(chartFullscreen.stopLoss))),
            chartFullscreen.targets && chartFullscreen.targets[0] && h('span',null,'TP: ',h('b',{style:{color:C.pos}},fmtPrice(chartFullscreen.targets[0])))
          ),
          h('button',{onClick:function(){setChartFullscreen(null);},style:{background:C.neg,border:'none',borderRadius:8,padding:isMobile?'8px 14px':'6px 14px',color:'#fff',fontSize:isMobile?14:13,fontWeight:700,cursor:'pointer',whiteSpace:'nowrap'}},'‚úï '+(isMobile?'':t.close))
        )
      ),
      // V2.3: Chart toolbar ‚Äî timeframe selector + overlay toggles
      h('div',{style:{padding:isMobile?'4px 8px':'6px 20px',display:'flex',alignItems:'center',gap:isMobile?4:8,borderBottom:'1px solid '+C.border,flexWrap:'nowrap',overflowX:'auto',flexShrink:0}},
        ['5m','15m','1h','4h'].map(function(tf){
          var isAct = chartTimeframe===tf;
          return h('button',{key:tf,onClick:function(){setChartTimeframe(tf);},style:{padding:isMobile?'4px 8px':'4px 10px',background:isAct?C.accent:C.bg,border:'1px solid '+(isAct?C.accent:C.border),borderRadius:6,color:isAct?'#fff':C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer',flexShrink:0}},tf);
        }),
        h('div',{style:{width:1,height:16,background:C.border,flexShrink:0}}),
        h('button',{onClick:function(){setChartShowEMA(!chartShowEMA);},style:{padding:isMobile?'4px 8px':'4px 10px',background:chartShowEMA?'rgba(139,92,246,0.2)':C.bg,border:'1px solid '+(chartShowEMA?'#8b5cf6':C.border),borderRadius:6,color:chartShowEMA?'#8b5cf6':C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer',flexShrink:0}},'EMA'),
        h('button',{onClick:function(){setChartShowVolume(!chartShowVolume);},style:{padding:isMobile?'4px 8px':'4px 10px',background:chartShowVolume?'rgba(99,102,241,0.2)':C.bg,border:'1px solid '+(chartShowVolume?'#6366f1':C.border),borderRadius:6,color:chartShowVolume?'#6366f1':C.textS,fontSize:isMobile?10:11,fontWeight:600,cursor:'pointer',flexShrink:0}},'Vol'),
        !isMobile && chartShowEMA && h('div',{style:{marginLeft:'auto',display:'flex',gap:12,fontSize:10}},
          h('span',{style:{color:'#f59e0b'}},'‚Äî EMA 20'),
          h('span',{style:{color:'#8b5cf6'}},'‚Äî EMA 50')
        )
      ),
      // Chart area ‚Äî LightweightCharts fullscreen (managed by useEffect, stable ref)
      h('div',{style:{flex:1,padding:isMobile?4:20,overflow:'hidden',position:'relative'}},
        h('div',{
          ref:fsChartRef,
          'data-chart':'1',
          style:{width:'100%',height:'100%',background:C.bg,borderRadius:12,border:'1px solid '+C.border,overflow:'hidden'}
        })
      ),
      // Footer with trade info
      h('div',{style:{padding:'10px 20px',borderTop:'1px solid '+C.border,display:'flex',justifyContent:'space-between',alignItems:'center'}},
        h('div',{style:{display:'flex',gap:16,fontSize:11}},
          chartFullscreen.score && h('span',{style:{color:C.textS}},'Score: '+chartFullscreen.score+'/16'),
          chartFullscreen.regime && h('span',{style:{color:ocRegimeColor(detectRegime(chartFullscreen))}},'Regime: '+ocRegimeLabel(detectRegime(chartFullscreen))),
          chartFullscreen.setup_type && h('span',{style:{color:C.textS}},'Setup: '+chartFullscreen.setup_type)
        ),
        h('span',{style:{fontSize:10,color:C.textM}},'Press ESC to close')
      )
    ),

    // MOBILE BOTTOM NAV ‚Äî V2.0: with market badge
    isMobile && h('nav',{style:{position:'fixed',bottom:0,left:0,right:0,background:C.card,borderTop:'1px solid '+C.border,padding:'6px 0 max(6px, env(safe-area-inset-bottom))',zIndex:1000,display:'flex',justifyContent:'space-around',alignItems:'center'}},
      [['overview','üìä'],['trades','üìà'],['analytics','üìâ'],['journal','üìì'],['botControl','ü§ñ'],['monitor','üõ°Ô∏è']].map(function(item){
        var id=item[0],icon=item[1];
        return h('button',{key:id,onClick:function(){setTab(id);},style:{background:'transparent',border:'none',padding:'6px 8px',minHeight:50,minWidth:44,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:2,cursor:'pointer',color:tab===id?C.accent:C.textS}},
          h('span',{style:{fontSize:20}},icon),
          h('span',{style:{fontSize:9,fontWeight:tab===id?600:400}},t[id]||id)
        );
      })
    ),

    // FOOTER
    h('footer',{style:{borderTop:'1px solid '+C.border,padding:'16px 24px',display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:16}},
      h('div',{style:{display:'flex',alignItems:'center',gap:16}},
        h('span',{style:{fontSize:12,color:C.textS}},'üî± Trinity '+CONFIG.VERSION),
        h('span',{style:pill(C.pos,C.posL)},
          h('span',{style:{width:6,height:6,borderRadius:'50%',background:connected?C.pos:C.neg}}),
          'üü¢ Crypto'
        ),
        h('span',{style:pill(hip3Connected?C.info:C.neg,hip3Connected?C.infoL:C.negL)},
          h('span',{style:{width:6,height:6,borderRadius:'50%',background:hip3Connected?C.info:C.neg}}),
          'üîµ HIP-3'
        ),
        h('span',{style:{fontSize:12,color:C.textM}},'üîí '+t.privateStrategy)
      ),
      h('div',{style:{display:'flex',alignItems:'center',gap:16}},
        (function(){
          var ocR = activeBot.onchain_regime || 'NEUTRAL';
          var ocColor = ocR==='EXTREME_FEAR'?'#22c55e':ocR==='FEAR'?'#86efac':ocR==='GREED'?'#fbbf24':ocR==='EXTREME_GREED'?'#ef4444':'#94a3b8';
          var ocBg = ocR==='EXTREME_FEAR'?'#22c55e22':ocR==='FEAR'?'#86efac22':ocR==='GREED'?'#fbbf2422':ocR==='EXTREME_GREED'?'#ef444422':'#94a3b822';
          var ocIcon = ocR==='EXTREME_FEAR'?'üü¢':ocR==='FEAR'?'üíö':ocR==='GREED'?'üü°':ocR==='EXTREME_GREED'?'üî¥':'‚ö™';
          var ocLabel = ocR==='EXTREME_FEAR'?'EXT.FEAR':ocR==='FEAR'?'FEAR':ocR==='GREED'?'GREED':ocR==='EXTREME_GREED'?'EXT.GREED':'NEUTRAL';
          return h('span',{style:pill(ocColor,ocBg)},ocIcon,' '+ocLabel);
        })(),
        h('span',{style:{fontSize:12,color:C.textM}},t.liveSince+': '+CONFIG.LIVE_START)
      )
    )
  );
}

// Mount
if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(function(){});}
ReactDOM.createRoot(document.getElementById('root')).render(h(App));
</script>
</body>
</html>
